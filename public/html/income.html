<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Income Tax Calculator - AI Powered</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Chart.js Library with all chart types -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <!-- Google reCAPTCHA v3 - Site key will be loaded dynamically from WordPress config -->
    <script id="recaptcha-loader"></script>
    <script>
        if (typeof Chart !== 'undefined') {
            console.log('Chart.js loaded. Available chart types:', Object.keys(Chart.registry.controllers));
        }
    </script>
    <script>
        const API_CONFIG = {
            // External API base URL (direct mode). When embedded in WordPress + ukpa-calculator-builder plugin,
            // requests to this base URL are transparently proxied through WP (so no API token is exposed).
            baseUrl: (typeof window !== 'undefined' && window.ukpa_api_data && window.ukpa_api_data.external_api_base_url)
                ? window.ukpa_api_data.external_api_base_url
                : 'http://localhost:3002/ana/api/external',

            // DO NOT hardcode secrets in HTML. For direct (non-WP) testing, set window.UKPA_EXTERNAL_API_TOKEN
            // before this script runs, e.g. via an inline script tag or build-time injection.
            validation: (typeof window !== 'undefined' && window.UKPA_EXTERNAL_API_TOKEN) ? window.UKPA_EXTERNAL_API_TOKEN : ''
        };

        // If we detect the WordPress plugin runtime, transparently proxy all fetches targeting the External API
        // through admin-ajax.php?action=ukpa_external_proxy (server-side token + CSRF handling).
        (function setupWpExternalApiProxy() {
            try {
                // Prefer same-window data, but allow iframe embeds to read parent.ukpa_api_data (same-origin only).
                const wp = window.ukpa_api_data || (window.parent && window.parent.ukpa_api_data) || {};
                if (!wp.ajaxurl) return;

                const originalFetch = window.fetch.bind(window);
                const base = new URL(API_CONFIG.baseUrl, window.location.href);

                window.fetch = async function(input, init) {
                    const urlStr = typeof input === 'string' ? input : (input && input.url ? input.url : null);
                    if (!urlStr) return originalFetch(input, init);

                    let target;
                    try {
                        target = new URL(urlStr, window.location.href);
                    } catch (e) {
                        return originalFetch(input, init);
                    }

                    // Only proxy calls to the configured external API base URL
                    if (target.origin !== base.origin) return originalFetch(input, init);
                    if (!target.pathname.startsWith(base.pathname)) return originalFetch(input, init);

                    const path = target.pathname.slice(base.pathname.length) || '/';
                    const method = (init && init.method) ? String(init.method).toUpperCase() : 'GET';

                    // Preserve JSON payload if present
                    let payload = null;
                    if (init && init.body) {
                        try {
                            payload = typeof init.body === 'string' ? JSON.parse(init.body) : init.body;
                        } catch (e) {
                            // If body isn't JSON, pass it as-is; WP proxy will forward string body
                            payload = init.body;
                        }
                    }

                    const proxyResp = await originalFetch(`${wp.ajaxurl}?action=ukpa_external_proxy`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            nonce: wp.nonce || '',
                            method,
                            path,
                            query: target.search || '',
                            payload
                        }),
                        credentials: 'same-origin'
                    });

                    const proxyText = await proxyResp.text();
                    let proxyJson = null;
                    try { proxyJson = JSON.parse(proxyText); } catch (e) {}

                    // Expected shape: { success: true, data: { code, isJson, body } }
                    if (!proxyJson || proxyJson.success !== true || !proxyJson.data) {
                        return new Response(proxyText, {
                            status: proxyResp.status,
                            headers: { 'Content-Type': 'application/json' }
                        });
                    }

                    const status = proxyJson.data.code || 200;
                    const body = proxyJson.data.body;
                    const isJson = proxyJson.data.isJson === true;

                    return new Response(isJson ? JSON.stringify(body) : String(body), {
                        status,
                        headers: { 'Content-Type': isJson ? 'application/json' : 'text/plain' }
                    });
                };
            } catch (e) {
                // If proxy setup fails, fall back to direct fetch.
            }
        })();

        let state = {
            taxYear: '2025',
            propertyIncome: '',
            employmentIncome: '',
            tradingIncome: '',
            savingIncome: '',
            dividendIncome: '',
            expandNonSavingIncome: false,
            calculations: [],
            selectedConsultation: null,
            currentCalculation: null,
            aiMode: false, // Start in simple mode 
            chartInstance: null,
            isCalculating: false, // Prevent multiple simultaneous calculations
            calculatingStartTime: null, // Track when calculation started (for timeout safety)
            isInitialLoad: true, // Track if this is the initial page load (don't show loader on initial calculation)
            isFetchingAIInsights: false, // Prevent multiple simultaneous AI insights requests
            hasUsedAIMode: false, // Track if user has tried AI mode
            annotationTimer: null, // Timer for showing annotations
            annotationCount: 0, // Track how many annotations have been shown
            annotationTimers: [], // Store timer IDs for cleanup
            pendingTab: null, // Store tab name when user clicks disabled tab in simple mode
            storageConsent: null, // Track user's consent for localStorage: true = consented, false = rejected, null = not asked
            storageConsentResolve: null, // Promise resolve function for storage consent modal
            lastChartDataKey: null, // Cache key for chart to prevent duplicate API calls
            cachedChartHTML: null, // Cache the chart HTML to avoid re-fetching
            isGeneratingChart: false, // Prevent multiple simultaneous chart generations
            loadingMessages: null, // Cached loading messages for charts
            currentLoadingMessageIndex: 0, // Current index for rotating messages
            loadingMessageInterval: null, // Interval for rotating messages
            isAIMetricsLoading: false, // Track loader state for AI metrics
            comparisonMode: false, // Track if comparison mode is enabled (for Charts tab)
            comparisonTaxYear: null, // Tax year for comparison (for Charts tab)
            comparisonCalculation: null, // Store comparison calculation result (for Charts tab)
            overviewComparisonMode: false, // Track if comparison mode is enabled (for Overview tab)
            overviewComparisonTaxYear: null, // Tax year for comparison (for Overview tab)
            overviewComparisonCalculation: null, // Store comparison calculation result (for Overview tab)
            breakdownComparisonMode: false, // Track if comparison mode is enabled (for Breakdown tab)
            breakdownComparisonTaxYear: null, // Tax year for comparison (for Breakdown tab)
            breakdownComparisonCalculation: null, // Store comparison calculation result (for Breakdown tab)
            csrfToken: null, // CSRF token for API requests
            csrfTokenExpiry: null // CSRF token expiry timestamp
        };

        // Random annotation messages to encourage AI mode
        const annotationMessages = [
            {
                title: 'üß† Try AI Powered Mode',
                message: 'Get personalised tax optimsation insights and potential savings recommendations powered by AI.',
                position: 'left'
            },
            {
                title: 'üí° Unlock AI Insights',
                message: 'Switch to AI mode to see optimsation scores, potential savings, and expert recommendations.',
                position: 'left'
            },
            {
                title: '‚ú® Discover More',
                message: 'AI mode provides detailed breakdowns, charts, and actionable tax-saving strategies.',
                position: 'left'
            },
            {
                title: 'üéØ Maximise Your Savings',
                message: 'Our AI analyses your calculation and suggests ways to optimise your Income Tax liability.',
                position: 'left'
            },
            {
                title: 'üìä Enhanced Analytics',
            message: 'Get AI-powered insights including optimsation scores and potential tax savings.',
                position: 'left'
            }
        ];

        // reCAPTCHA Configuration
        // Get site key from WordPress config if available, otherwise use default
        const wp = window.ukpa_api_data || (window.parent && window.parent.ukpa_api_data) || {};
        const RECAPTCHA_SITE_KEY = wp.recaptcha_site_key || '6Lfy0gcsAAAAAOJAbtam6WBI8nj09N2ebYIIKdKW';
        
        // Dynamically load reCAPTCHA script with the site key
        (function loadRecaptcha() {
            const loader = document.getElementById('recaptcha-loader');
            if (loader && RECAPTCHA_SITE_KEY) {
                const script = document.createElement('script');
                script.src = `https://www.google.com/recaptcha/api.js?render=${RECAPTCHA_SITE_KEY}`;
                script.async = true;
                script.defer = true;
                loader.parentNode.replaceChild(script, loader);
            }
        })();

        /**
         * Get reCAPTCHA token for form submission
         * @param {string} action - Action name for reCAPTCHA (e.g., 'income_tax_submit')
         * @returns {Promise<string>} reCAPTCHA token
         */
        function getRecaptchaToken(action) {
            return new Promise((resolve, reject) => {
                if (typeof grecaptcha === 'undefined') {
                    reject(new Error('reCAPTCHA is not ready. Please refresh the page.'));
                    return;
                }

                try {
                    grecaptcha.ready(() => {
                        grecaptcha.execute(RECAPTCHA_SITE_KEY, { action })
                            .then(token => {
                                if (!token) {
                                    reject(new Error('reCAPTCHA token was not generated. Please try again.'));
                                } else {
                                    resolve(token);
                                }
                            })
                            .catch(err => {
                                console.error('‚ùå [FORM] reCAPTCHA execution failed:', err);
                                reject(new Error('reCAPTCHA verification failed. Please try again.'));
                            });
                    });
                } catch (error) {
                    console.error('‚ùå [FORM] reCAPTCHA error:', error);
                    reject(new Error('reCAPTCHA could not be completed. Please refresh and try again.'));
                }
            });
        }

        // CSRF Token Management
        /**
         * Fetch CSRF token from the API
         * @returns {Promise<string|null>} CSRF token or null if failed
         */
        async function fetchCsrfToken() {
            try {
                const response = await fetch(`${API_CONFIG.baseUrl}/csrf-token-authenticated`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        // Bind CSRF token generation to this API key (stronger than public /csrf-token)
                        'X-API-Key': API_CONFIG.validation
                    }
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.warn('‚ö†Ô∏è Failed to fetch CSRF token:', {
                        status: response.status,
                        error: errorData.error || 'unknown',
                        message: errorData.message || 'Unknown error'
                    });
                    
                    // If origin is required, this might be a WordPress embedding issue
                    if (errorData.error === 'origin_required') {
                        console.error('‚ùå CSRF token fetch failed: Origin header missing. This may indicate the page is not being served from a web server (e.g., opened as file://). For WordPress embedding, ensure the HTML is properly embedded.');
                    }
                    
                    return null;
                }
                
                const data = await response.json();
                if (data.success && data.csrfToken) {
                    state.csrfToken = data.csrfToken;
                    // Set expiry (subtract 1 minute for safety margin)
                    state.csrfTokenExpiry = Date.now() + ((data.expiresIn - 60) * 1000);
                    console.log('‚úÖ CSRF token fetched successfully');
                    return data.csrfToken;
                }
                return null;
            } catch (error) {
                console.error('‚ùå Error fetching CSRF token:', error);
                // Don't block the app if CSRF token fetch fails - let the API handle it
                return null;
            }
        }

        /**
         * Get valid CSRF token, refreshing if needed
         * @returns {Promise<string|null>} CSRF token or null if failed
         */
        async function getCsrfToken() {
            // Check if token exists and is not expired
            if (state.csrfToken && state.csrfTokenExpiry && Date.now() < state.csrfTokenExpiry) {
                return state.csrfToken;
            }
            
            // Token expired or doesn't exist, fetch new one
            return await fetchCsrfToken();
        }

        /**
         * Helper function to add CSRF token to headers
         * @param {Object} headers - Existing headers object
         * @returns {Promise<Object>} Headers with CSRF token added
         */
        async function addCsrfTokenToHeaders(headers = {}) {
            const csrfToken = await getCsrfToken();
            if (csrfToken) {
                headers['X-CSRF-Token'] = csrfToken;
            } else {
                // Log warning but don't block - let the API return proper error
                console.warn('‚ö†Ô∏è CSRF token not available for request. The API will reject this request.');
            }
            return headers;
        }

        // Debounce function to prevent API spam
        // Uses closure to maintain timer per debounced function instance
        function debounce(func, wait) {
            let timeoutId = null;
            return function executedFunction(...args) {
                // Clear the previous timeout
                if (timeoutId !== null) {
                    clearTimeout(timeoutId);
                }
                // Set a new timeout
                timeoutId = setTimeout(() => {
                    timeoutId = null;
                    func.apply(this, args);
                }, wait);
            };
        }

        // Format date to "24 Jan 2025" pattern
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            
            // If it's already in the format we want, return as is
            if (dateString.match(/^\d{1,2} \w{3} \d{4}$/)) {
                return dateString;
            }
            
            // If it's a date string (YYYY-MM-DD), format it
            if (dateString.match(/^\d{4}-\d{2}-\d{2}$/)) {
                const date = new Date(dateString);
                // Format: "24 Jan 2025" (day month year)
                return date.toLocaleDateString('en-GB', { 
                    day: 'numeric', 
                    month: 'short', 
                    year: 'numeric' 
                });
            }
            
            // If it's just a year (YYYY), convert to first day of that year
            if (dateString.match(/^\d{4}$/)) {
                const date = new Date(`${dateString}-01-01`);
                return date.toLocaleDateString('en-GB', { 
                    day: 'numeric', 
                    month: 'short', 
                    year: 'numeric' 
                });
            }
            
            // Return as is if we can't parse it
            return dateString;
        }

        // Handle tax year change
        function handleTaxYearChange() {
            const taxYearSelect = document.getElementById('income-tax-taxYear');
            if (taxYearSelect) {
                state.taxYear = taxYearSelect.value;
            }
            // Clear current calculation to prevent showing stale results
            if (state.currentCalculation) {
                state.currentCalculation.breakdown = null;
            }
            // Clear comparison calculation if tax years match
            if (state.comparisonMode && state.taxYear === state.comparisonTaxYear) {
                state.comparisonCalculation = null;
            }
            // Update property income visibility based on tax year
            updatePropertyIncomeVisibility();
        }

        // Update property income visibility based on tax year (2027 separate, others part of Non-Saving)
        function updatePropertyIncomeVisibility() {
            const isNewPropertyTreatment = state.taxYear === '2027';
            const propertyIncomeSeparateGroup = document.getElementById('income-tax-propertyIncomeSeparateGroup');
            const propertyIncomeNonSavingGroup = document.getElementById('income-tax-propertyIncomeNonSavingGroup');
            const propertyIncomeLabel = document.getElementById('income-tax-propertyIncomeLabel');
            const employmentIncomeGroup2027 = document.getElementById('income-tax-employmentIncomeGroup2027');
            const employmentIncomeLabel2027 = document.getElementById('income-tax-employmentIncomeLabel2027');
            const employmentIncomeGroup = document.getElementById('income-tax-employmentIncomeGroup');

            if (isNewPropertyTreatment) {
                // 2027: Property Income separate, Employment Income visible
                if (propertyIncomeSeparateGroup) propertyIncomeSeparateGroup.style.display = 'block';
                if (propertyIncomeNonSavingGroup) propertyIncomeNonSavingGroup.style.display = 'none';
                if (employmentIncomeGroup2027) employmentIncomeGroup2027.style.display = 'block';
                if (employmentIncomeGroup) employmentIncomeGroup.style.display = 'none';
                // Show employment income label only if expanded
                if (employmentIncomeLabel2027) {
                    employmentIncomeLabel2027.style.display = state.expandNonSavingIncome ? 'block' : 'none';
                }
            } else {
                // Other years: Property Income part of Non-Saving
                if (propertyIncomeSeparateGroup) propertyIncomeSeparateGroup.style.display = 'none';
                if (propertyIncomeNonSavingGroup) propertyIncomeNonSavingGroup.style.display = 'block';
                if (employmentIncomeGroup2027) employmentIncomeGroup2027.style.display = 'none';
                if (employmentIncomeGroup) employmentIncomeGroup.style.display = 'block';
                // Show property income label only if expanded
                if (propertyIncomeLabel) {
                    propertyIncomeLabel.style.display = state.expandNonSavingIncome ? 'block' : 'none';
                }
            }
        }

        // Toggle Non-Saving Income expand/collapse
        function toggleNonSavingIncome() {
            state.expandNonSavingIncome = !state.expandNonSavingIncome;
            const expandableFields = document.getElementById('income-tax-nonSavingExpandableFields');
            const expandBtn = document.getElementById('income-tax-expandNonSavingBtn');
            const propertyIncomeLabel = document.getElementById('income-tax-propertyIncomeLabel');
            const employmentIncomeLabel2027 = document.getElementById('income-tax-employmentIncomeLabel2027');
            const isNewPropertyTreatment = state.taxYear === '2027';

            if (expandableFields) {
                if (state.expandNonSavingIncome) {
                    expandableFields.style.maxHeight = '500px';
                    expandableFields.style.opacity = '1';
                } else {
                    expandableFields.style.maxHeight = '0';
                    expandableFields.style.opacity = '0';
                }
            }

            if (expandBtn) {
                expandBtn.textContent = state.expandNonSavingIncome 
                    ? 'Hide Other Non-Saving Incomes.' 
                    : 'Click for more detailed Non-Saving Incomes';
            }

            // Show/hide labels based on expansion state
            if (propertyIncomeLabel && !isNewPropertyTreatment) {
                propertyIncomeLabel.style.display = state.expandNonSavingIncome ? 'block' : 'none';
            }
            if (employmentIncomeLabel2027 && isNewPropertyTreatment) {
                employmentIncomeLabel2027.style.display = state.expandNonSavingIncome ? 'block' : 'none';
            }
        }
        
        // Update toggle switch visual state for overview
        function updateOverviewToggleSwitchState(isOn) {
            const toggleCheckbox = document.getElementById('income-tax-overviewComparisonToggle');
            if (!toggleCheckbox) return;
            
            // Find the toggle container and spans
            const toggleContainer = toggleCheckbox.parentElement;
            if (!toggleContainer) return;
            
            const spans = toggleContainer.querySelectorAll('span');
            const toggleSpan = spans[0]; // Background span
            const sliderSpan = spans[1]; // Slider circle span
            
            if (toggleSpan && sliderSpan) {
                if (isOn) {
                    toggleSpan.style.background = 'linear-gradient(255deg, #43468a 0%, #2a2667 100%)';
                    toggleSpan.style.backgroundColor = '#43468a';
                    sliderSpan.style.transform = 'translateX(24px)';
                    toggleCheckbox.checked = true;
                } else {
                    toggleSpan.style.background = '#cbd5e1';
                    toggleSpan.style.backgroundColor = '#cbd5e1';
                    sliderSpan.style.transform = 'translateX(0px)';
                    toggleCheckbox.checked = false;
                }
            }
        }
        
        // Toggle overview comparison mode
        function toggleOverviewComparisonMode() {
            const toggleCheckbox = document.getElementById('income-tax-overviewComparisonToggle');
            const comparisonGroup = document.getElementById('income-tax-overviewComparisonTaxYearGroup');
            
            // Get state from checkbox
            if (toggleCheckbox) {
                state.overviewComparisonMode = toggleCheckbox.checked;
            } else {
                state.overviewComparisonMode = !state.overviewComparisonMode;
            }
            
            // Get comparison tax year select element
            const comparisonSelect = document.getElementById('income-tax-overviewComparisonTaxYear');
            
            if (state.overviewComparisonMode) {
                // Enable comparison mode
                if (comparisonGroup) {
                    comparisonGroup.style.display = 'block';
                }
                
                // Enable the comparison tax year dropdown
                if (comparisonSelect) {
                    comparisonSelect.disabled = false;
                    comparisonSelect.style.opacity = '1';
                    comparisonSelect.style.cursor = 'pointer';
                    
                    // Initialize comparison tax year if not set
                    if (!state.overviewComparisonTaxYear) {
                        // Default to 2027
                        const defaultComparisonYear = '2027';
                        comparisonSelect.value = defaultComparisonYear;
                        state.overviewComparisonTaxYear = defaultComparisonYear;
                    }
                }
                
                // Update toggle switch visual state
                updateOverviewToggleSwitchState(true);
            } else {
                // Disable comparison mode
                if (comparisonGroup) {
                    comparisonGroup.style.display = 'block'; // Keep visible but disabled
                }
                
                // Disable the comparison tax year dropdown
                if (comparisonSelect) {
                    comparisonSelect.disabled = true;
                    comparisonSelect.style.opacity = '0.5';
                    comparisonSelect.style.cursor = 'not-allowed';
                }
                
                state.overviewComparisonTaxYear = null;
                state.overviewComparisonCalculation = null;
                
                // Update toggle switch visual state
                updateOverviewToggleSwitchState(false);
            }
            
                // Update overview layout based on comparison mode
                updateOverviewLayout();
                
                // If comparison mode is enabled, fetch comparison calculation if needed
                if (state.overviewComparisonMode && state.overviewComparisonTaxYear) {
                    if (state.currentCalculation) {
                        // Fetch comparison calculation using existing main calculation data
                        fetchOverviewComparisonCalculation(state.currentCalculation);
                    } else {
                        // If no main calculation exists, trigger recalculation to get it first
            recalculate();
                    }
                } else {
                    // Clear comparison calculation when disabled
                    state.overviewComparisonCalculation = null;
                    // Just update display without recalculating
                    updateOverviewComparisonDisplay();
                    updateOverviewLayout();
                }
        }
        
        // Handle overview comparison tax year change
        function handleOverviewComparisonTaxYearChange() {
            const comparisonSelect = document.getElementById('income-tax-overviewComparisonTaxYear');
            if (comparisonSelect) {
                state.overviewComparisonTaxYear = comparisonSelect.value;
                // Clear comparison calculation to force recalculation
                state.overviewComparisonCalculation = null;
                
                // Immediately hide old comparison results and show loader
                const comparisonColumn = document.getElementById('income-tax-comparisonColumn');
                const taxCardLoader = document.getElementById('income-tax-taxCardLoader');
                const comparisonInsightsSection = document.getElementById('income-tax-comparisonInsightsSection');
                const taxCardComparisonBox = document.getElementById('income-tax-taxCardComparisonBox');
                
                // Hide old comparison results immediately
                if (comparisonColumn) {
                    comparisonColumn.style.display = 'none';
                }
                if (comparisonInsightsSection) {
                    comparisonInsightsSection.style.display = 'none';
                }
                if (taxCardComparisonBox) {
                    taxCardComparisonBox.style.display = 'none';
                }
                
                // Show loader immediately
                if (taxCardLoader) {
                    taxCardLoader.style.display = 'flex';
                }
            }
        }
        
        // Build detailed analysis for comparison insights
        function buildDetailedAnalysis(mainCalc, comparisonCalc, currentYear, futureYear, difference, isFutureMore, isFutureLess, comparisonData, isComparisonYearPast = false) {
            const currentTax = Math.round(mainCalc.totalTax || 0);
            const futureTax = Math.round(comparisonCalc.totalTax || 0);
            const mortgageReliefDiff = Math.abs(comparisonData.mainMortgageRelief - comparisonData.comparisonMortgageRelief);
            const allowanceDiff = Math.abs(comparisonData.mainTotalAllowance - comparisonData.comparisonTotalAllowance);
            const hasSameRelief = mortgageReliefDiff === 0;
            const hasSameAllowance = allowanceDiff === 0;
            
            let comparisonText = '';
            let detailedAnalysis = '';
            const reasons = [];
            
            // Build comparison text
            if (isFutureMore) {
                // Comparison tax is higher
                if (isComparisonYearPast) {
                    // Past year had higher tax
                    if (hasSameRelief && hasSameAllowance) {
                        comparisonText = `${currentYear} is more favorable despite the same mortgage relief and allowances, saving you ¬£${difference.toLocaleString('en-GB')} compared to ${futureYear} due to lower tax rates.`;
                        reasons.push('lower tax rates in the current year');
                    } else {
                        const reliefText = hasSameRelief ? 'same mortgage relief' : `¬£${mortgageReliefDiff.toLocaleString('en-GB')} ${comparisonData.mainMortgageRelief > comparisonData.comparisonMortgageRelief ? 'more' : 'less'} mortgage relief`;
                        const allowanceText = hasSameAllowance ? 'same allowances' : `¬£${allowanceDiff.toLocaleString('en-GB')} ${comparisonData.mainTotalAllowance > comparisonData.comparisonTotalAllowance ? 'higher' : 'lower'} allowances`;
                        comparisonText = `${currentYear} is more favorable with ${reliefText} and ${allowanceText}, saving you ¬£${difference.toLocaleString('en-GB')} compared to ${futureYear} primarily due to lower tax rates.`;
                        reasons.push('lower tax rates');
                        if (!hasSameRelief && comparisonData.mainMortgageRelief > comparisonData.comparisonMortgageRelief) {
                            reasons.push('better mortgage relief');
                        }
                        if (!hasSameAllowance && comparisonData.mainTotalAllowance > comparisonData.comparisonTotalAllowance) {
                            reasons.push('higher allowances');
                        }
                    }
                } else {
                    // Future year has higher tax
                    if (hasSameRelief && hasSameAllowance) {
                        comparisonText = `${currentYear} was more favorable despite the same mortgage relief and allowances, saving you ¬£${difference.toLocaleString('en-GB')} due to lower tax rates.`;
                        reasons.push('lower tax rates in the current year');
                    } else {
                        const reliefText = hasSameRelief ? 'same mortgage relief' : `¬£${mortgageReliefDiff.toLocaleString('en-GB')} ${comparisonData.mainMortgageRelief > comparisonData.comparisonMortgageRelief ? 'more' : 'less'} mortgage relief`;
                        const allowanceText = hasSameAllowance ? 'same allowances' : `¬£${allowanceDiff.toLocaleString('en-GB')} ${comparisonData.mainTotalAllowance > comparisonData.comparisonTotalAllowance ? 'higher' : 'lower'} allowances`;
                        comparisonText = `${currentYear} was more favorable with ${reliefText} and ${allowanceText}, saving you ¬£${difference.toLocaleString('en-GB')} primarily due to lower tax rates.`;
                        reasons.push('lower tax rates');
                        if (!hasSameRelief && comparisonData.mainMortgageRelief > comparisonData.comparisonMortgageRelief) {
                            reasons.push('better mortgage relief');
                        }
                        if (!hasSameAllowance && comparisonData.mainTotalAllowance > comparisonData.comparisonTotalAllowance) {
                            reasons.push('higher allowances');
                        }
                    }
                }
                
                // Build detailed analysis
                const percentageIncrease = currentTax > 0 ? ((difference / currentTax) * 100).toFixed(1) : 0;
                if (isComparisonYearPast) {
                    detailedAnalysis = `
                        <div class="income-tax-analysis-item">
                            <strong>Tax Rate Impact:</strong> The ${futureYear} tax year had higher tax rates, resulting in a ${percentageIncrease}% higher tax liability compared to ${currentYear}.
                        </div>
                        <div class="income-tax-analysis-item">
                            <strong>Financial Impact:</strong> This represents ¬£${difference.toLocaleString('en-GB')} more in tax payments that would have been required in ${futureYear} compared to your current year.
                        </div>
                        ${reasons.length > 0 ? `
                        <div class="income-tax-analysis-item">
                            <strong>Key Factors:</strong> The difference arises from ${reasons.length === 1 ? reasons[0] : reasons.slice(0, -1).join(', ') + (reasons.length > 1 ? ' and ' + reasons[reasons.length - 1] : '')} between the two tax years.
                        </div>
                        ` : ''}
                    `;
                } else {
                    detailedAnalysis = `
                        <div class="income-tax-analysis-item">
                            <strong>Tax Rate Impact:</strong> The ${futureYear} tax year introduces higher tax rates, resulting in a ${percentageIncrease}% increase in your tax liability compared to ${currentYear}.
                        </div>
                        <div class="income-tax-analysis-item">
                            <strong>Financial Impact:</strong> This represents an additional ¬£${difference.toLocaleString('en-GB')} in tax payments, which you should factor into your financial planning for ${futureYear}.
                        </div>
                        ${reasons.length > 0 ? `
                        <div class="income-tax-analysis-item">
                            <strong>Key Factors:</strong> The difference arises from ${reasons.length === 1 ? reasons[0] : reasons.slice(0, -1).join(', ') + (reasons.length > 1 ? ' and ' + reasons[reasons.length - 1] : '')} between the two tax years.
                        </div>
                        ` : ''}
                    `;
                }
            } else if (isFutureLess) {
                // Future tax is lower
                if (hasSameRelief && hasSameAllowance) {
                    comparisonText = `${futureYear} is more favorable with the same mortgage relief and allowances, saving you ¬£${difference.toLocaleString('en-GB')} due to lower tax rates.`;
                    reasons.push('lower tax rates in the future year');
                } else {
                    const reliefText = hasSameRelief ? 'same mortgage relief' : `¬£${mortgageReliefDiff.toLocaleString('en-GB')} ${comparisonData.comparisonMortgageRelief > comparisonData.mainMortgageRelief ? 'more' : 'less'} mortgage relief`;
                    const allowanceText = hasSameAllowance ? 'same allowances' : `¬£${allowanceDiff.toLocaleString('en-GB')} ${comparisonData.comparisonTotalAllowance > comparisonData.mainTotalAllowance ? 'higher' : 'lower'} allowances`;
                    comparisonText = `${futureYear} is more favorable with ${reliefText} and ${allowanceText}, saving you ¬£${difference.toLocaleString('en-GB')} primarily due to lower tax rates.`;
                    reasons.push('lower tax rates');
                    if (!hasSameRelief && comparisonData.comparisonMortgageRelief > comparisonData.mainMortgageRelief) {
                        reasons.push('better mortgage relief');
                    }
                    if (!hasSameAllowance && comparisonData.comparisonTotalAllowance > comparisonData.mainTotalAllowance) {
                        reasons.push('higher allowances');
                    }
                }
                
                // Build detailed analysis
                const percentageDecrease = currentTax > 0 ? ((difference / currentTax) * 100).toFixed(1) : 0;
                detailedAnalysis = `
                    <div class="income-tax-analysis-item">
                        <strong>Tax Rate Impact:</strong> The ${futureYear} tax year introduces lower tax rates, resulting in a ${percentageDecrease}% reduction in your tax liability compared to ${currentYear}.
                    </div>
                    <div class="income-tax-analysis-item">
                        <strong>Financial Benefit:</strong> This represents potential savings of ¬£${difference.toLocaleString('en-GB')} under the new tax rules, which can be reinvested or used for other financial goals.
                    </div>
                    ${reasons.length > 0 ? `
                    <div class="income-tax-analysis-item">
                        <strong>Key Factors:</strong> The savings arise from ${reasons.length === 1 ? reasons[0] : reasons.slice(0, -1).join(', ') + (reasons.length > 1 ? ' and ' + reasons[reasons.length - 1] : '')} in ${futureYear}.
                    </div>
                    ` : ''}
                `;
            } else {
                comparisonText = `Both ${currentYear} and ${futureYear} result in identical tax treatment with no difference in liability.`;
            }
            
            return {
                comparisonText,
                detailedAnalysis
            };
        }
        
        // Update comparison insights in AI card with AI-generated summary
        async function updateComparisonInsights() {
            const normalInsightsSection = document.getElementById('income-tax-normalInsightsSection');
            const comparisonInsightsSection = document.getElementById('income-tax-comparisonInsightsSection');
            const comparisonInsightsText = document.getElementById('income-tax-comparisonInsightsText');
            const taxCardComparisonBox = document.getElementById('income-tax-taxCardComparisonBox');
            
            if (!normalInsightsSection || !comparisonInsightsSection || !comparisonInsightsText) return;
            
            const mainCalc = state.currentCalculation;
            const comparisonCalc = state.overviewComparisonCalculation;
            
            // If no comparison calculation, hide comparison insights immediately
            if (!comparisonCalc) {
                normalInsightsSection.style.display = 'block';
                comparisonInsightsSection.style.display = 'none';
                if (taxCardComparisonBox) {
                    taxCardComparisonBox.style.display = 'none';
                }
                return;
            }
            
            if (state.overviewComparisonMode && mainCalc && comparisonCalc) {
                // Show comparison insights, hide normal insights
                normalInsightsSection.style.display = 'none';
                comparisonInsightsSection.style.display = 'block';
                
                // Show loading state with proper loader
                comparisonInsightsText.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 120px; padding: 20px;">
                        <div class="income-tax-loader-wrapper">
                            <div class="income-tax-loader">
                                <div class="income-tax-loader income-tax-loader-inner"></div>
                            </div>
                        </div>
                        <div class="income-tax-loader-text" style="color: #6b7280; margin-top: 16px; font-size: 14px; font-weight: 500;">
                            Generating insights...
                        </div>
                    </div>
                `;
                
                // Format tax year labels
                const formatTaxYearLabel = (year) => {
                    if (!year) return '';
                    const yearNum = parseInt(year);
                    if (isNaN(yearNum)) return year;
                    return `${yearNum}/${yearNum + 1}`;
                };
                
                const mainTax = Math.round(mainCalc.totalTax || 0);
                const comparisonTax = Math.round(comparisonCalc.totalTax || 0);
                const mainTaxYear = formatTaxYearLabel(mainCalc.taxYear);
                const comparisonTaxYear = formatTaxYearLabel(comparisonCalc.taxYear);
                
                // Extract year numbers to determine if comparison year is past or future
                const mainYearNum = parseInt(mainCalc.taxYear) || 0;
                const comparisonYearNum = parseInt(comparisonCalc.taxYear) || 0;
                const isComparisonYearPast = comparisonYearNum < mainYearNum;
                const isComparisonYearFuture = comparisonYearNum > mainYearNum;
                
                // Determine which year has more tax
                const taxDifference = comparisonTax - mainTax;
                const isComparisonMore = taxDifference > 0;
                const isComparisonLess = taxDifference < 0;
                const difference = Math.abs(taxDifference);
                
                // Build grammatically correct headlines based on year relationship
                let headlineText = '';
                let subtitleText = '';
                
                if (isComparisonMore) {
                    if (isComparisonYearFuture) {
                        headlineText = `You'll Pay <span class="income-tax-comparison-amount-highlight">¬£${difference.toLocaleString('en-GB')} More</span> in <span style="font-size: 0.9em; color: #64748b;">${comparisonTaxYear}</span>`;
                        subtitleText = `Your tax liability increases significantly in ${comparisonTaxYear} due to new budget policies.`;
                    } else if (isComparisonYearPast) {
                        headlineText = `You Save <span class="income-tax-comparison-amount-highlight positive">¬£${difference.toLocaleString('en-GB')}</span> Compared to <span style="font-size: 0.9em; color: #64748b;">${comparisonTaxYear}</span>`;
                        subtitleText = `Your current tax year (${mainTaxYear}) is more favorable than ${comparisonTaxYear}, saving you ¬£${difference.toLocaleString('en-GB')}.`;
                    } else {
                        headlineText = `You'll Pay <span class="income-tax-comparison-amount-highlight">¬£${difference.toLocaleString('en-GB')} More</span> in <span style="font-size: 0.9em; color: #64748b;">${comparisonTaxYear}</span>`;
                        subtitleText = `Your tax liability increases in ${comparisonTaxYear} compared to ${mainTaxYear}.`;
                    }
                } else if (isComparisonLess) {
                    if (isComparisonYearFuture) {
                        headlineText = `You'll Save <span class="income-tax-comparison-amount-highlight positive">¬£${difference.toLocaleString('en-GB')}</span> in <span style="font-size: 0.9em; color: #64748b;">${comparisonTaxYear}</span>`;
                        subtitleText = `Your tax liability decreases in ${comparisonTaxYear} due to new budget policies.`;
                    } else if (isComparisonYearPast) {
                        headlineText = `You Pay <span class="income-tax-comparison-amount-highlight">¬£${difference.toLocaleString('en-GB')} More</span> Than <span style="font-size: 0.9em; color: #64748b;">${comparisonTaxYear}</span>`;
                        subtitleText = `Your current tax year (${mainTaxYear}) has a higher tax liability than ${comparisonTaxYear} by ¬£${difference.toLocaleString('en-GB')}.`;
                    } else {
                        headlineText = `You'll Save <span class="income-tax-comparison-amount-highlight positive">¬£${difference.toLocaleString('en-GB')}</span> in <span style="font-size: 0.9em; color: #64748b;">${comparisonTaxYear}</span>`;
                        subtitleText = `Your tax liability decreases in ${comparisonTaxYear} compared to ${mainTaxYear}.`;
                    }
                } else {
                    headlineText = `No Change in Tax Liability`;
                    subtitleText = `Your tax liability remains unchanged between ${mainTaxYear} and ${comparisonTaxYear}.`;
                }
                
                // Keep old variable names for backward compatibility with existing code
                const currentYear = mainTaxYear;
                const futureYear = comparisonTaxYear;
                const currentTax = mainTax;
                const futureTax = comparisonTax;
                const isFutureMore = isComparisonMore;
                const isFutureLess = isComparisonLess;
                
                // Prepare comparison data for AI
                const comparisonData = {
                    mainTaxYear: mainTaxYear,
                    comparisonTaxYear: comparisonTaxYear,
                    mainTax: mainTax,
                    comparisonTax: comparisonTax,
                    mainMortgageRelief: Math.round(mainCalc.mortgageReliefApplied || 0),
                    comparisonMortgageRelief: Math.round(comparisonCalc.mortgageReliefApplied || 0),
                    mainTotalAllowance: Math.round(mainCalc.totalAllowance || 0),
                    comparisonTotalAllowance: Math.round(comparisonCalc.totalAllowance || 0),
                    annualRentalIncome: Math.round(mainCalc.annualRentalIncome || mainCalc.netIncome || 0)
                };
                
                try {
                    // Fetch AI-generated comparison insights
                    const csrfHeaders = await addCsrfTokenToHeaders({
                        'X-API-Key': API_CONFIG.validation,
                        'Content-Type': 'application/json'
                    });
                    const response = await fetch(`${API_CONFIG.baseUrl}/calculators/rt/comparison-insights`, {
                        method: 'POST',
                        headers: csrfHeaders,
                        body: JSON.stringify({ comparisonData })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.summary) {
                            // Build detailed analysis
                            const analysisDetails = buildDetailedAnalysis(mainCalc, comparisonCalc, mainTaxYear, comparisonTaxYear, difference, isFutureMore, isFutureLess, comparisonData, isComparisonYearPast);
                            
                            // Display AI-generated summary with professional future-focused formatting
                            comparisonInsightsText.innerHTML = `
                                <div class="income-tax-comparison-insights-wrapper">
                                    <div class="income-tax-comparison-alert-card ${isFutureMore ? 'income-tax-comparison-alert-warning' : isFutureLess ? 'income-tax-comparison-alert-positive' : 'income-tax-comparison-alert-neutral'}">
                                        ${isFutureMore || isFutureLess ? '<div class="income-tax-comparison-important-badge">Important</div>' : ''}
                                        <div class="income-tax-comparison-main-headline">
                                            ${headlineText}
                                    </div>
                                        <div class="income-tax-comparison-subtitle">
                                            ${subtitleText}
                                        </div>
                                    </div>
                                    
                                    ${analysisDetails.detailedAnalysis ? `
                                    <div class="income-tax-comparison-analysis">
                                        <div class="income-tax-comparison-analysis-title">Detailed Analysis</div>
                                        <div class="income-tax-comparison-analysis-content">
                                            ${analysisDetails.detailedAnalysis}
                                        </div>
                                    </div>
                                    ` : ''}
                                </div>
                            `;
                            
                            // Insert comparison box into tax card only (not in insights)
                            const comparisonBoxHtml = `
                                <div class="income-tax-comparison-box">
                                    <div class="income-tax-comparison-box-label">COMPARISON</div>
                                    <div class="income-tax-comparison-box-content">
                                        ${analysisDetails.comparisonText}
                                    </div>
                                </div>
                            `;
                            if (taxCardComparisonBox) {
                                taxCardComparisonBox.innerHTML = comparisonBoxHtml;
                                taxCardComparisonBox.style.display = 'block';
                            }
                        } else {
                            // Fallback to default message if AI fails
                            throw new Error('AI insights not available');
                        }
                    } else {
                        throw new Error('Failed to fetch AI insights');
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Failed to fetch AI comparison insights:', error.message);
                    // Fallback to a detailed contextual message with professional formatting
                    const analysisDetails = buildDetailedAnalysis(mainCalc, comparisonCalc, mainTaxYear, comparisonTaxYear, difference, isFutureMore, isFutureLess, comparisonData, isComparisonYearPast);
                    
                    if (difference === 0) {
                        const comparisonBoxHtml = `
                            <div class="income-tax-comparison-box">
                                <div class="income-tax-comparison-box-label">COMPARISON</div>
                                <div class="income-tax-comparison-box-content">
                                    ${currentYear} and ${comparisonTaxYear} result in identical tax treatment with no difference in liability.
                                </div>
                            </div>
                        `;
                        
                        comparisonInsightsText.innerHTML = `
                            <div class="income-tax-comparison-insights-wrapper">
                                <div class="income-tax-comparison-alert-card income-tax-comparison-alert-neutral">
                                    <div class="income-tax-comparison-main-headline">
                                        ${headlineText}
                                    </div>
                                    <div class="income-tax-comparison-subtitle">
                                        ${subtitleText}
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        // Insert comparison box into tax card only (not in insights)
                        if (taxCardComparisonBox) {
                            taxCardComparisonBox.innerHTML = comparisonBoxHtml;
                            taxCardComparisonBox.style.display = 'block';
                        }
                        } else {
                        const comparisonBoxHtml = `
                            <div class="income-tax-comparison-box">
                                <div class="income-tax-comparison-box-label">COMPARISON</div>
                                <div class="income-tax-comparison-box-content">
                                    ${analysisDetails.comparisonText}
                                </div>
                            </div>
                        `;
                    
                    comparisonInsightsText.innerHTML = `
                            <div class="income-tax-comparison-insights-wrapper">
                                <div class="income-tax-comparison-alert-card ${isFutureMore ? 'income-tax-comparison-alert-warning' : 'income-tax-comparison-alert-positive'}">
                                    <div class="income-tax-comparison-important-badge">Important</div>
                                    <div class="income-tax-comparison-main-headline">
                                        ${headlineText}
                            </div>
                                    <div class="income-tax-comparison-subtitle">
                                        ${subtitleText}
                                    </div>
                                </div>
                                
                                ${analysisDetails.detailedAnalysis ? `
                                <div class="income-tax-comparison-analysis">
                                    <div class="income-tax-comparison-analysis-title">Detailed Analysis</div>
                                    <div class="income-tax-comparison-analysis-content">
                                        ${analysisDetails.detailedAnalysis}
                                    </div>
                                </div>
                                ` : ''}
                        </div>
                    `;
                        
                        // Insert comparison box into tax card only (not in insights)
                        if (taxCardComparisonBox) {
                            taxCardComparisonBox.innerHTML = comparisonBoxHtml;
                            taxCardComparisonBox.style.display = 'block';
                        }
                    }
                }
            } else {
                // Show normal insights, hide comparison insights
                normalInsightsSection.style.display = 'block';
                comparisonInsightsSection.style.display = 'none';
                // Hide comparison box in tax card
                if (taxCardComparisonBox) {
                    taxCardComparisonBox.style.display = 'none';
                }
            }
        }
        
        // Update overview layout based on comparison mode
        function updateOverviewLayout() {
            const taxCardContent = document.getElementById('income-tax-taxCardContent');
            const comparisonColumn = document.getElementById('income-tax-comparisonColumn');
            const mainIconBox = document.getElementById('income-tax-mainIconBox');
            const mainTaxDetails = document.querySelector('#income-tax-mainTaxCard .income-tax-tax-card-main .income-tax-tax-details');
            const dashboardGrid = document.getElementById('income-tax-overviewDashboardGrid');
            
            if (!taxCardContent) return;
            
            // Toggle comparison-active class on dashboard grid
            if (dashboardGrid) {
                if (state.overviewComparisonMode) {
                    dashboardGrid.classList.add('income-tax-comparison-active');
                } else {
                    dashboardGrid.classList.remove('income-tax-comparison-active');
                }
            }
            
            if (state.overviewComparisonMode) {
                // Comparison mode: Enable 2-column layout inside tax card
                taxCardContent.classList.add('income-tax-comparison-mode');
                
                // Hide icon box in comparison mode
                if (mainIconBox) {
                    mainIconBox.style.display = 'none';
                }
                
                // Hide Income Tax Breakdown in main column (comparison mode shows side-by-side)
                if (mainTaxDetails) {
                    mainTaxDetails.style.display = 'none';
                }
                
                // Hide Income Tax Breakdown in comparison column (will be shown in comparison column)
                const comparisonTaxDetails = document.querySelector('#income-tax-comparisonColumn .income-tax-tax-details');
                if (comparisonTaxDetails) {
                    comparisonTaxDetails.style.display = 'none';
                }
                
                // Show comparison column
                if (comparisonColumn) {
                    comparisonColumn.style.display = 'block';
                }
                
                // Update comparison insights
                updateComparisonInsights();
            } else {
                // Normal mode: Single column layout
                taxCardContent.classList.remove('income-tax-comparison-mode');
                
                // Show icon box in normal mode
                if (mainIconBox) {
                    mainIconBox.style.display = 'flex';
                }
                
                // Show Income Tax Breakdown in main column
                if (mainTaxDetails) {
                    mainTaxDetails.style.display = 'grid';
                }
                
                // Hide comparison column
                if (comparisonColumn) {
                    comparisonColumn.style.display = 'none';
                }
                
                // Show normal insights
                updateComparisonInsights();
            }
        }
        
        // Fetch overview comparison calculation independently
        async function fetchOverviewComparisonCalculation(mainCalc) {
            if (!state.overviewComparisonMode || !state.overviewComparisonTaxYear) {
                return;
            }
            
            const taxYearSelect = document.getElementById('income-tax-taxYear');
            const mainTaxYear = taxYearSelect ? taxYearSelect.value : state.taxYear || '2025';
            
            // Don't fetch if comparison tax year is same as main tax year
            if (state.overviewComparisonTaxYear === mainTaxYear) {
                state.overviewComparisonCalculation = null;
                updateOverviewComparisonDisplay();
                const taxCardLoader = document.getElementById('income-tax-taxCardLoader');
                if (taxCardLoader) {
                    taxCardLoader.style.display = 'none';
                }
                return;
            }
            
            // Hide old results and show loader immediately
            const comparisonColumn = document.getElementById('income-tax-comparisonColumn');
            const taxCardLoader = document.getElementById('income-tax-taxCardLoader');
            const comparisonInsightsSection = document.getElementById('income-tax-comparisonInsightsSection');
            const taxCardComparisonBox = document.getElementById('income-tax-taxCardComparisonBox');
            
            if (comparisonColumn) {
                comparisonColumn.style.display = 'none';
            }
            if (comparisonInsightsSection) {
                comparisonInsightsSection.style.display = 'none';
            }
            if (taxCardComparisonBox) {
                taxCardComparisonBox.style.display = 'none';
            }
            if (taxCardLoader) {
                taxCardLoader.style.display = 'flex';
            }
            
            console.log('üîÑ Fetching overview comparison calculation for tax year:', state.overviewComparisonTaxYear);
            
            try {
                const overviewComparisonRequestBody = {
                    taxYear: state.overviewComparisonTaxYear,
                    propertyIncome: (mainCalc.propertyIncome || 0).toString(),
                    employmentIncome: (mainCalc.employmentIncome || 0).toString(),
                    tradingIncome: (mainCalc.tradingIncome || 0).toString(),
                    savingIncome: (mainCalc.savingIncome || 0).toString(),
                    dividendIncome: (mainCalc.dividendIncome || 0).toString()
                };
                
                const overviewCsrfHeaders = await addCsrfTokenToHeaders({
                    'X-API-Key': API_CONFIG.validation,
                    'Content-Type': 'application/json'
                });
                const overviewComparisonResponse = await fetch(`${API_CONFIG.baseUrl}/calculators/it/calculate`, {
                    method: 'POST',
                    headers: overviewCsrfHeaders,
                    body: JSON.stringify(overviewComparisonRequestBody)
                });
                
                if (overviewComparisonResponse.ok) {
                    const overviewComparisonResult = await overviewComparisonResponse.json();
                    if (overviewComparisonResult.success) {
                        // ‚úÖ Convert income tax breakdown object to array format
                        let comparisonBreakdownArray = [];
                        if (overviewComparisonResult.breakdown && typeof overviewComparisonResult.breakdown === 'object' && !Array.isArray(overviewComparisonResult.breakdown)) {
                            if (overviewComparisonResult.tables) {
                                const allBands = [];
                                if (overviewComparisonResult.tables.nonSavingIncomeTax) allBands.push(...overviewComparisonResult.tables.nonSavingIncomeTax.map(b => ({ ...b, band: `Non-Saving: ${b.band || 'Tax'}`, rate: (b.rate || 0) * 100 })));
                                if (overviewComparisonResult.tables.propertyIncomeTax) allBands.push(...overviewComparisonResult.tables.propertyIncomeTax.map(b => ({ ...b, band: `Property: ${b.band || 'Tax'}`, rate: (b.rate || 0) * 100 })));
                                if (overviewComparisonResult.tables.savingsIncomeTax) {
                                    overviewComparisonResult.tables.savingsIncomeTax.forEach(b => {
                                        const bandName = (b.band || '').toLowerCase();
                                        const isNilOrStarting = bandName.includes('nil') || bandName.includes('starting');
                                        if (b.rate > 0 || (isNilOrStarting && (b.amount > 0 || b.tax > 0))) {
                                            allBands.push({ ...b, band: `Savings: ${b.band || 'Tax'}`, rate: (b.rate || 0) * 100 });
                                        }
                                    });
                                }
                                if (overviewComparisonResult.tables.dividendIncomeTax) {
                                    overviewComparisonResult.tables.dividendIncomeTax.forEach(b => {
                                        const bandName = (b.band || '').toLowerCase();
                                        const isNilOrStarting = bandName.includes('nil') || bandName.includes('starting');
                                        if (b.rate > 0 || (isNilOrStarting && (b.amount > 0 || b.tax > 0))) {
                                            allBands.push({ ...b, band: `Dividend: ${b.band || 'Tax'}`, rate: (b.rate || 0) * 100 });
                                        }
                                    });
                                }
                                comparisonBreakdownArray = allBands;
                            }
                        } else if (Array.isArray(overviewComparisonResult.breakdown)) {
                            comparisonBreakdownArray = overviewComparisonResult.breakdown;
                        }
                        
                        // Store overview comparison calculation
                        state.overviewComparisonCalculation = {
                            taxYear: state.overviewComparisonTaxYear,
                            propertyIncome: mainCalc.propertyIncome || 0,
                            employmentIncome: mainCalc.employmentIncome || 0,
                            tradingIncome: mainCalc.tradingIncome || 0,
                            savingIncome: mainCalc.savingIncome || 0,
                            dividendIncome: mainCalc.dividendIncome || 0,
                            totalTax: overviewComparisonResult.totalTax || 0,
                            netIncome: overviewComparisonResult.netIncome || 0,
                            totalAllowance: overviewComparisonResult.totalAllowance || 0,
                            usedAllowance: overviewComparisonResult.usedAllowance || 0,
                            remainingAllowance: overviewComparisonResult.remainingAllowance || 0,
                            mortgageReliefApplied: overviewComparisonResult.mortgageReliefApplied || 0,
                            deductibleMortgageInterest: overviewComparisonResult.deductibleMortgageInterest || 0,
                            breakdown: comparisonBreakdownArray,
                            breakdownObject: overviewComparisonResult.breakdown,
                            tables: overviewComparisonResult.tables || {},
                            isNewPropertyTreatment: overviewComparisonResult.isNewPropertyTreatment || false,
                            timestamp: new Date()
                        };
                        console.log('‚úÖ Overview comparison calculation stored');
                        
                        // Update overview display with comparison data
                        updateOverviewComparisonDisplay();
                        // Update layout to ensure comparison column is visible
                        updateOverviewLayout();
                        
                        // Hide loader after successful update
                        if (taxCardLoader) {
                            taxCardLoader.style.display = 'none';
                        }
                    }
                } else {
                    console.warn('‚ö†Ô∏è Overview comparison API call failed:', overviewComparisonResponse.status);
                    // Hide loader on error
                    if (taxCardLoader) {
                        taxCardLoader.style.display = 'none';
                    }
                }
            } catch (overviewComparisonError) {
                console.warn('‚ö†Ô∏è Failed to fetch overview comparison calculation:', overviewComparisonError.message);
                // Hide loader on error
                if (taxCardLoader) {
                    taxCardLoader.style.display = 'none';
                }
            }
        }
        
        async function fetchBreakdownComparisonCalculation(mainCalc) {
            if (!state.breakdownComparisonMode || !state.breakdownComparisonTaxYear) {
                return;
            }
            
            // Prevent race conditions when user types quickly (only apply latest response)
            state._breakdownComparisonRequestId = (state._breakdownComparisonRequestId || 0) + 1;
            const requestId = state._breakdownComparisonRequestId;
            
            const taxYearSelect = document.getElementById('income-tax-taxYear');
            const mainTaxYear = taxYearSelect ? taxYearSelect.value : state.taxYear || '2025';
            
            // Don't fetch if comparison tax year is same as main tax year
            if (state.breakdownComparisonTaxYear === mainTaxYear) {
                state.breakdownComparisonCalculation = null;
                updateDisplay(); // Refresh breakdown table
                return;
            }
            
            console.log('üîÑ Fetching breakdown comparison calculation for tax year:', state.breakdownComparisonTaxYear, 'requestId:', requestId);
            
            try {
                const breakdownComparisonRequestBody = {
                    taxYear: state.breakdownComparisonTaxYear,
                    propertyIncome: (mainCalc.propertyIncome || 0).toString(),
                    employmentIncome: (mainCalc.employmentIncome || 0).toString(),
                    tradingIncome: (mainCalc.tradingIncome || 0).toString(),
                    savingIncome: (mainCalc.savingIncome || 0).toString(),
                    dividendIncome: (mainCalc.dividendIncome || 0).toString()
                };
                
                const breakdownCsrfHeaders = await addCsrfTokenToHeaders({
                    'X-API-Key': API_CONFIG.validation,
                    'Content-Type': 'application/json'
                });
                const breakdownComparisonResponse = await fetch(`${API_CONFIG.baseUrl}/calculators/it/calculate`, {
                    method: 'POST',
                    headers: breakdownCsrfHeaders,
                    body: JSON.stringify(breakdownComparisonRequestBody)
                });
                
                if (breakdownComparisonResponse.ok) {
                    const breakdownComparisonResult = await breakdownComparisonResponse.json();
                    if (breakdownComparisonResult.success) {
                        // If a newer request was started, ignore this response
                        if (requestId !== state._breakdownComparisonRequestId) {
                            console.log('‚è≠Ô∏è Ignoring stale breakdown comparison response. requestId:', requestId, 'latest:', state._breakdownComparisonRequestId);
                            return;
                        }
                        // Convert breakdown object to array format (same as main calculation)
                        let breakdownComparisonArray = [];
                        if (breakdownComparisonResult.breakdown && typeof breakdownComparisonResult.breakdown === 'object' && !Array.isArray(breakdownComparisonResult.breakdown)) {
                            // Income tax returns breakdown as object {nonSavingIncomeTax, propertyIncomeTax, etc.}
                            // Convert to array format using tables if available
                            if (breakdownComparisonResult.tables) {
                                // Combine all tax band arrays from tables
                                const allBands = [];
                                
                                // Non-Saving Income Tax bands
                                if (breakdownComparisonResult.tables.nonSavingIncomeTax && Array.isArray(breakdownComparisonResult.tables.nonSavingIncomeTax)) {
                                    breakdownComparisonResult.tables.nonSavingIncomeTax.forEach(band => {
                                        allBands.push({
                                            band: `Non-Saving: ${band.band || 'Tax'}`,
                                            rate: (band.rate || 0) * 100, // Convert to percentage
                                            amount: band.amount || 0,
                                            tax: band.tax || 0
                                        });
                                    });
                                }
                                
                                // Property Income Tax bands (for 2027)
                                if (breakdownComparisonResult.tables.propertyIncomeTax && Array.isArray(breakdownComparisonResult.tables.propertyIncomeTax) && breakdownComparisonResult.tables.propertyIncomeTax.length > 0) {
                                    breakdownComparisonResult.tables.propertyIncomeTax.forEach(band => {
                                        allBands.push({
                                            band: `Property: ${band.band || 'Tax'}`,
                                            rate: (band.rate || 0) * 100,
                                            amount: band.amount || 0,
                                            tax: band.tax || 0
                                        });
                                    });
                                }
                                
                                // Savings Income Tax bands
                                if (breakdownComparisonResult.tables.savingsIncomeTax && Array.isArray(breakdownComparisonResult.tables.savingsIncomeTax)) {
                                    breakdownComparisonResult.tables.savingsIncomeTax.forEach(band => {
                                        allBands.push({
                                            band: `Savings: ${band.band || 'Tax'}`,
                                            rate: (band.rate || 0) * 100,
                                            amount: band.amount || 0,
                                            tax: band.tax || 0
                                        });
                                    });
                                }
                                
                                // Dividend Income Tax bands
                                if (breakdownComparisonResult.tables.dividendIncomeTax && Array.isArray(breakdownComparisonResult.tables.dividendIncomeTax)) {
                                    breakdownComparisonResult.tables.dividendIncomeTax.forEach(band => {
                                        allBands.push({
                                            band: `Dividend: ${band.band || 'Tax'}`,
                                            rate: (band.rate || 0) * 100,
                                            amount: band.amount || 0,
                                            tax: band.tax || 0
                                        });
                                    });
                                }
                                
                                breakdownComparisonArray = allBands;
                                
                                // Check if Non-Saving Income has income but tax is 0 (due to allowance)
                                const totalNonSavingIncome = (parseFloat(mainCalc.propertyIncome) || 0) + 
                                                             (parseFloat(mainCalc.employmentIncome) || 0) + 
                                                             (parseFloat(mainCalc.tradingIncome) || 0);
                                const nonSavingTax = breakdownComparisonResult.breakdown.nonSavingIncomeTax || 0;
                                const usedAllowance = breakdownComparisonResult.usedAllowance || 0;
                                
                                // If there's non-saving income but tax is 0, and we have bands, check if all bands have 0 tax
                                if (totalNonSavingIncome > 0 && nonSavingTax === 0 && breakdownComparisonResult.tables.nonSavingIncomeTax) {
                                    const hasNonSavingBands = breakdownComparisonArray.some(b => b.band && b.band.includes('Non-Saving'));
                                    // If no non-saving bands in breakdown (all filtered out due to 0 tax), add a summary row
                                    if (!hasNonSavingBands) {
                                        // Calculate total income from non-saving bands
                                        let totalNonSavingAmount = 0;
                                        breakdownComparisonResult.tables.nonSavingIncomeTax.forEach(band => {
                                            totalNonSavingAmount += band.amount || 0;
                                        });
                                        
                                        // Add a summary showing income reduced by allowance
                                        breakdownComparisonArray.unshift({
                                            band: 'Non-Saving: Personal Allowance Applied',
                                            rate: 0,
                                            amount: totalNonSavingAmount,
                                            tax: 0,
                                            allowanceReduction: usedAllowance > 0 ? Math.min(usedAllowance, totalNonSavingAmount) : 0
                                        });
                                    }
                                }
                            } else {
                                // Fallback: create array from breakdown object values
                                // Calculate total non-saving income
                                const totalNonSavingIncome = (parseFloat(mainCalc.propertyIncome) || 0) + 
                                                             (parseFloat(mainCalc.employmentIncome) || 0) + 
                                                             (parseFloat(mainCalc.tradingIncome) || 0);
                                const nonSavingTax = breakdownComparisonResult.breakdown.nonSavingIncomeTax || 0;
                                const usedAllowance = breakdownComparisonResult.usedAllowance || 0;
                                
                                breakdownComparisonArray = [
                                    // Always include Non-Saving Income Tax if there's income, even if tax is 0
                                    ...(totalNonSavingIncome > 0 ? [{
                                        band: 'Non-Saving Income Tax',
                                        rate: 0,
                                        amount: totalNonSavingIncome,
                                        tax: nonSavingTax,
                                        allowanceReduction: nonSavingTax === 0 && usedAllowance > 0 ? Math.min(usedAllowance, totalNonSavingIncome) : 0
                                    }] : []),
                                    ...(breakdownComparisonResult.breakdown.propertyIncomeTax > 0 ? [{ band: 'Property Income Tax', rate: 0, amount: 0, tax: breakdownComparisonResult.breakdown.propertyIncomeTax }] : []),
                                    { band: 'Savings Income Tax', rate: 0, amount: 0, tax: breakdownComparisonResult.breakdown.savingsIncomeTax || 0 },
                                    { band: 'Dividend Income Tax', rate: 0, amount: 0, tax: breakdownComparisonResult.breakdown.dividendIncomeTax || 0 }
                                ].filter(item => item.tax > 0 || (item.band && item.band.includes('Non-Saving') && item.amount > 0));
                            }
                        } else if (Array.isArray(breakdownComparisonResult.breakdown)) {
                            breakdownComparisonArray = breakdownComparisonResult.breakdown;
                        }
                        
                        // Store breakdown comparison calculation (latest only)
                        state.breakdownComparisonCalculation = {
                            taxYear: state.breakdownComparisonTaxYear,
                            propertyIncome: mainCalc.propertyIncome || 0,
                            employmentIncome: mainCalc.employmentIncome || 0,
                            tradingIncome: mainCalc.tradingIncome || 0,
                            savingIncome: mainCalc.savingIncome || 0,
                            dividendIncome: mainCalc.dividendIncome || 0,
                            totalTax: breakdownComparisonResult.totalTax || 0,
                            netIncome: breakdownComparisonResult.netIncome || 0,
                            totalAllowance: breakdownComparisonResult.totalAllowance || 0,
                            usedAllowance: breakdownComparisonResult.usedAllowance || 0,
                            remainingAllowance: breakdownComparisonResult.remainingAllowance || 0,
                            mortgageReliefApplied: breakdownComparisonResult.mortgageReliefApplied || 0,
                            deductibleMortgageInterest: breakdownComparisonResult.deductibleMortgageInterest || 0,
                            breakdown: breakdownComparisonArray, // Converted to array format
                            breakdownObject: breakdownComparisonResult.breakdown, // Also store original object for reference
                            tables: breakdownComparisonResult.tables || {}, // Store tables for detailed breakdown
                            allowanceBreakdown: breakdownComparisonResult.allowanceBreakdown || {}, // Store allowance breakdown by category
                            isNewPropertyTreatment: breakdownComparisonResult.isNewPropertyTreatment || false,
                            timestamp: new Date()
                        };
                        console.log('‚úÖ Breakdown comparison calculation stored');
                        
                        // Hide breakdown loader
                        const breakdownLoader = document.getElementById('income-tax-breakdownLoader');
                        if (breakdownLoader) {
                            breakdownLoader.style.display = 'none';
                        }
                        
                        // Update breakdown table with comparison data
                        updateDisplay();
                    } else {
                        // API returned success: false
                        console.warn('‚ö†Ô∏è Breakdown comparison calculation failed:', breakdownComparisonResult.message);
                        const breakdownLoader = document.getElementById('income-tax-breakdownLoader');
                        if (breakdownLoader) {
                            breakdownLoader.style.display = 'none';
                        }
                    }
                } else {
                    console.warn('‚ö†Ô∏è Breakdown comparison API call failed:', breakdownComparisonResponse.status);
                    // Hide loader on API failure
                    const breakdownLoader = document.getElementById('income-tax-breakdownLoader');
                    if (breakdownLoader) {
                        breakdownLoader.style.display = 'none';
                    }
                }
            } catch (breakdownComparisonError) {
                console.warn('‚ö†Ô∏è Failed to fetch breakdown comparison calculation:', breakdownComparisonError.message);
                // Hide loader on error
                const breakdownLoader = document.getElementById('income-tax-breakdownLoader');
                if (breakdownLoader) {
                    breakdownLoader.style.display = 'none';
                }
            }
        }
        
        // Update overview comparison display
        function updateOverviewComparisonDisplay() {
            const comparisonCalc = state.overviewComparisonCalculation;
            if (!comparisonCalc) {
                // If no comparison calculation, ensure comparison column is hidden
                const comparisonColumn = document.getElementById('income-tax-comparisonColumn');
                if (comparisonColumn) {
                    comparisonColumn.style.display = 'none';
                }
                return;
            }
            
            const comparisonTaxResultEl = document.getElementById('income-tax-comparisonTaxResult');
            const comparisonTaxYearResultEl = document.getElementById('income-tax-comparisonTaxYearResult');
            const comparisonNonSavingTaxResultEl = document.getElementById('income-tax-comparisonNonSavingTaxResult');
            const comparisonPropertyTaxResultEl = document.getElementById('income-tax-comparisonPropertyTaxResult');
            const comparisonPropertyTaxDetailItem = document.getElementById('income-tax-comparisonPropertyTaxDetailItem');
            const comparisonSavingsTaxResultEl = document.getElementById('income-tax-comparisonSavingsTaxResult');
            const comparisonDividendTaxResultEl = document.getElementById('income-tax-comparisonDividendTaxResult');
            
            // Format tax year label helper
            const formatTaxYearLabel = (year) => {
                if (!year) return '';
                const yearNum = parseInt(year);
                if (isNaN(yearNum)) return year;
                return `${yearNum}/${yearNum + 1}`;
            };
            
            if (comparisonTaxResultEl) {
                const totalTax = Math.round(comparisonCalc.totalTax || 0);
                comparisonTaxResultEl.textContent = '¬£' + (totalTax || 0).toLocaleString('en-GB');
            }
            
            if (comparisonTaxYearResultEl) {
                const taxYear = comparisonCalc.taxYear || '';
                const displayYear = formatTaxYearLabel(taxYear);
                comparisonTaxYearResultEl.textContent = 'Tax Year: ' + (displayYear || '-');
            }
            
            // ‚úÖ Display Income Tax Breakdown for comparison
            const comparisonBreakdownObj = comparisonCalc.breakdownObject || comparisonCalc.breakdown || {};
            let comparisonNonSavingTax = 0;
            let comparisonPropertyTax = 0;
            let comparisonSavingsTax = 0;
            let comparisonDividendTax = 0;
            
            if (typeof comparisonBreakdownObj === 'object' && !Array.isArray(comparisonBreakdownObj)) {
                comparisonNonSavingTax = comparisonBreakdownObj.nonSavingIncomeTax || 0;
                comparisonPropertyTax = comparisonBreakdownObj.propertyIncomeTax || 0;
                comparisonSavingsTax = comparisonBreakdownObj.savingsIncomeTax || 0;
                comparisonDividendTax = comparisonBreakdownObj.dividendIncomeTax || 0;
            } else if (Array.isArray(comparisonCalc.breakdown)) {
                comparisonCalc.breakdown.forEach(row => {
                    const band = row.band || '';
                    const tax = row.tax || 0;
                    if (band.includes('Non-Saving')) comparisonNonSavingTax += tax;
                    else if (band.includes('Property')) comparisonPropertyTax += tax;
                    else if (band.includes('Savings')) comparisonSavingsTax += tax;
                    else if (band.includes('Dividend')) comparisonDividendTax += tax;
                });
            }
            
            if (comparisonNonSavingTaxResultEl) {
                comparisonNonSavingTaxResultEl.textContent = '¬£' + Math.round(comparisonNonSavingTax).toLocaleString('en-GB');
            }
            if (comparisonPropertyTaxResultEl) {
                comparisonPropertyTaxResultEl.textContent = '¬£' + Math.round(comparisonPropertyTax).toLocaleString('en-GB');
            }
            if (comparisonPropertyTaxDetailItem) {
                comparisonPropertyTaxDetailItem.style.display = comparisonPropertyTax > 0 ? 'block' : 'none';
            }
            if (comparisonSavingsTaxResultEl) {
                comparisonSavingsTaxResultEl.textContent = '¬£' + Math.round(comparisonSavingsTax).toLocaleString('en-GB');
            }
            if (comparisonDividendTaxResultEl) {
                comparisonDividendTaxResultEl.textContent = '¬£' + Math.round(comparisonDividendTax).toLocaleString('en-GB');
            }
            
            // Ensure comparison column is visible when we have data
            if (state.overviewComparisonMode) {
                const comparisonColumn = document.getElementById('income-tax-comparisonColumn');
                if (comparisonColumn) {
                    comparisonColumn.style.display = 'block';
                }
                // Update comparison insights when comparison data is available
                updateComparisonInsights();
            }
        }
        
        // Explicitly attach to window for global accessibility
        window.toggleOverviewComparisonMode = toggleOverviewComparisonMode;
        window.handleOverviewComparisonTaxYearChange = handleOverviewComparisonTaxYearChange;
        
        // Explicitly attach to window for global accessibility
        window.handleTaxYearChange = handleTaxYearChange;
        
        // Toggle comparison mode
        function toggleComparisonMode() {
            const toggleCheckbox = document.getElementById('income-tax-comparisonToggle');
            const comparisonGroup = document.getElementById('income-tax-comparisonTaxYearGroup');
            
            // Get state from checkbox (in case function is called directly)
            if (toggleCheckbox) {
                state.comparisonMode = toggleCheckbox.checked;
            } else {
                state.comparisonMode = !state.comparisonMode;
            }
            
            // Get comparison tax year select element
            const comparisonSelect = document.getElementById('income-tax-comparisonTaxYear');
            
            if (state.comparisonMode) {
                // Enable comparison mode
                if (comparisonGroup) {
                    comparisonGroup.style.display = 'block';
                }
                
                // Enable the comparison tax year dropdown
                if (comparisonSelect) {
                    comparisonSelect.disabled = false;
                    comparisonSelect.style.opacity = '1';
                    comparisonSelect.style.cursor = 'pointer';
                    
                    // Initialize comparison tax year if not set
                    if (!state.comparisonTaxYear) {
                        // Default to 2027
                        const defaultComparisonYear = '2027';
                        comparisonSelect.value = defaultComparisonYear;
                        state.comparisonTaxYear = defaultComparisonYear;
                    }
                }
                
                // Update toggle switch visual state
                updateToggleSwitchState(true);
            } else {
                // Disable comparison mode
                if (comparisonGroup) {
                    comparisonGroup.style.display = 'block'; // Keep visible but disabled
                }
                
                // Disable the comparison tax year dropdown
                if (comparisonSelect) {
                    comparisonSelect.disabled = true;
                    comparisonSelect.style.opacity = '0.5';
                    comparisonSelect.style.cursor = 'not-allowed';
                }
                
                state.comparisonTaxYear = null;
                state.comparisonCalculation = null;
                
                // Update toggle switch visual state
                updateToggleSwitchState(false);
            }
            
            // Filter chart types based on comparison mode
            filterChartTypes();
            
            // Show loader immediately when comparison mode is toggled
            if (state.comparisonMode) {
                // Show loader for charts tab
                const chartContainer = document.getElementById('income-tax-chartContainer');
                if (chartContainer) {
                    chartContainer.style.opacity = '0.3';
                    chartContainer.style.pointerEvents = 'none';
                    showChartLoader();
                }
            }
            
            // Recalculate to show/hide comparison
            recalculate();
        }
        
        // Update toggle switch visual state
        function updateToggleSwitchState(isOn) {
            const toggleCheckbox = document.getElementById('income-tax-comparisonToggle');
            if (!toggleCheckbox) return;
            
            // Find the toggle container and spans
            const toggleContainer = toggleCheckbox.parentElement;
            if (!toggleContainer) return;
            
            const spans = toggleContainer.querySelectorAll('span');
            const toggleSpan = spans[0]; // Background span
            const sliderSpan = spans[1]; // Slider circle span
            
            if (toggleSpan && sliderSpan) {
                if (isOn) {
                    toggleSpan.style.background = 'linear-gradient(255deg, #43468a 0%, #2a2667 100%)';
                    toggleSpan.style.backgroundColor = '#43468a';
                    sliderSpan.style.transform = 'translateX(24px)';
                    toggleCheckbox.checked = true;
                } else {
                    toggleSpan.style.background = '#cbd5e1';
                    toggleSpan.style.backgroundColor = '#cbd5e1';
                    sliderSpan.style.transform = 'translateX(0px)';
                    toggleCheckbox.checked = false;
                }
            }
        }
        
        // Handle comparison tax year change
        function handleComparisonTaxYearChange() {
            const comparisonTaxYearSelect = document.getElementById('income-tax-comparisonTaxYear');
            if (comparisonTaxYearSelect) {
                state.comparisonTaxYear = comparisonTaxYearSelect.value;
            }
            // Clear comparison calculation to prevent showing stale results
            state.comparisonCalculation = null;
            
            // Don't allow same tax year for comparison
            const taxYearSelect = document.getElementById('income-tax-taxYear');
            if (taxYearSelect && state.comparisonTaxYear === taxYearSelect.value) {
                alert('Please select a different tax year for comparison.');
                // Reset to 2027
                const defaultComparisonYear = '2027';
                comparisonTaxYearSelect.value = defaultComparisonYear;
                state.comparisonTaxYear = defaultComparisonYear;
                return;
            }
            
            // Show loader immediately when comparison tax year changes
            const chartContainer = document.getElementById('income-tax-chartContainer');
            if (chartContainer && state.comparisonMode) {
                chartContainer.style.opacity = '0.3';
                chartContainer.style.pointerEvents = 'none';
                showChartLoader();
            }
        }
        
        // Filter chart types based on comparison mode
        // Charts that don't support comparison: pie, doughnut, polarArea, bubble
        function filterChartTypes() {
            const chartTypeSelect = document.getElementById('income-tax-chartTypeSelect');
            if (!chartTypeSelect) return;
            
            const incompatibleTypes = ['polarArea', 'bubble']; // Pie and donut now support comparison with side-by-side charts
            const options = Array.from(chartTypeSelect.options);
            const currentValue = chartTypeSelect.value;
            
            if (state.comparisonMode) {
                // Hide incompatible chart types when comparison is enabled
                options.forEach(option => {
                    if (incompatibleTypes.includes(option.value)) {
                        option.style.display = 'none';
                    }
                });
                
                // If current selection is incompatible, switch to bar chart
                if (incompatibleTypes.includes(currentValue)) {
                    chartTypeSelect.value = 'bar';
                    changeChartType('bar');
                }
            } else {
                // Show all chart types when comparison is disabled
                options.forEach(option => {
                    option.style.display = '';
                });
            }
        }
        
        // Explicitly attach to window for global accessibility
        window.toggleComparisonMode = toggleComparisonMode;
        window.handleComparisonTaxYearChange = handleComparisonTaxYearChange;

        // Toggle breakdown comparison mode
        function toggleBreakdownComparisonMode() {
            const toggleCheckbox = document.getElementById('income-tax-breakdownComparisonToggle');
            const comparisonGroup = document.getElementById('income-tax-breakdownComparisonTaxYearGroup');
            
            // Get state from checkbox (in case function is called directly)
            if (toggleCheckbox) {
                state.breakdownComparisonMode = toggleCheckbox.checked;
            } else {
                state.breakdownComparisonMode = !state.breakdownComparisonMode;
            }
            
            // Get comparison tax year select element
            const comparisonSelect = document.getElementById('income-tax-breakdownComparisonTaxYear');
            
            if (state.breakdownComparisonMode) {
                // Enable comparison mode
                if (comparisonGroup) {
                    comparisonGroup.style.display = 'block';
                }
                
                // Enable the comparison tax year dropdown
                if (comparisonSelect) {
                    comparisonSelect.disabled = false;
                    comparisonSelect.style.opacity = '1';
                    comparisonSelect.style.cursor = 'pointer';
                    
                    // Initialize comparison tax year if not set
                    if (!state.breakdownComparisonTaxYear) {
                        // Default to 2027
                        const defaultComparisonYear = '2027';
                        comparisonSelect.value = defaultComparisonYear;
                        state.breakdownComparisonTaxYear = defaultComparisonYear;
                    }
                }
                
                // Update toggle switch visual state
                updateBreakdownToggleSwitchState(true);
            } else {
                // Disable comparison mode
                if (comparisonGroup) {
                    comparisonGroup.style.display = 'block'; // Keep visible but disabled
                }
                
                // Disable the comparison tax year dropdown
                if (comparisonSelect) {
                    comparisonSelect.disabled = true;
                    comparisonSelect.style.opacity = '0.5';
                    comparisonSelect.style.cursor = 'not-allowed';
                }
                
                state.breakdownComparisonTaxYear = null;
                state.breakdownComparisonCalculation = null;
                
                // Update toggle switch visual state
                updateBreakdownToggleSwitchState(false);
            }
            
            // Recalculate to show/hide comparison
            recalculate();
        }
        
        // Update breakdown toggle switch visual state
        function updateBreakdownToggleSwitchState(isOn) {
            const toggleCheckbox = document.getElementById('income-tax-breakdownComparisonToggle');
            if (!toggleCheckbox) return;
            
            // Find the toggle container and spans
            const toggleContainer = toggleCheckbox.parentElement;
            if (!toggleContainer) return;
            
            const spans = toggleContainer.querySelectorAll('span');
            const toggleSpan = spans[0]; // Background span
            const sliderSpan = spans[1]; // Slider circle span
            
            if (toggleSpan && sliderSpan) {
                if (isOn) {
                    toggleSpan.style.background = 'linear-gradient(255deg, #43468a 0%, #2a2667 100%)';
                    toggleSpan.style.backgroundColor = '#43468a';
                    sliderSpan.style.transform = 'translateX(24px)';
                    toggleCheckbox.checked = true;
                } else {
                    toggleSpan.style.background = '#cbd5e1';
                    toggleSpan.style.backgroundColor = '#cbd5e1';
                    sliderSpan.style.transform = 'translateX(0px)';
                    toggleCheckbox.checked = false;
                }
            }
        }
        
        // Handle breakdown comparison tax year change
        function handleBreakdownComparisonTaxYearChange() {
            const comparisonTaxYearSelect = document.getElementById('income-tax-breakdownComparisonTaxYear');
            if (comparisonTaxYearSelect) {
                state.breakdownComparisonTaxYear = comparisonTaxYearSelect.value;
            }
            // Clear comparison calculation to prevent showing stale results
            state.breakdownComparisonCalculation = null;
            
            // Don't allow same tax year for comparison
            const taxYearSelect = document.getElementById('income-tax-taxYear');
            if (taxYearSelect && state.breakdownComparisonTaxYear === taxYearSelect.value) {
                alert('Please select a different tax year for comparison.');
                // Reset to 2027
                const defaultComparisonYear = '2027';
                comparisonTaxYearSelect.value = defaultComparisonYear;
                state.breakdownComparisonTaxYear = defaultComparisonYear;
            }
            
            // Show loader if we have a main calculation and breakdown comparison mode is enabled
            if (state.breakdownComparisonMode && state.currentCalculation) {
                const breakdownLoader = document.getElementById('income-tax-breakdownLoader');
                if (breakdownLoader) {
                    breakdownLoader.style.display = 'flex';
                }
                // Fetch breakdown comparison calculation immediately
                fetchBreakdownComparisonCalculation(state.currentCalculation);
            } else {
                // Recalculate to show/hide comparison
                recalculate();
            }
        }
        
        // Explicitly attach to window for global accessibility
        window.toggleBreakdownComparisonMode = toggleBreakdownComparisonMode;
        window.handleBreakdownComparisonTaxYearChange = handleBreakdownComparisonTaxYearChange;
        window.toggleNonSavingIncome = toggleNonSavingIncome;
        window.updatePropertyIncomeVisibility = updatePropertyIncomeVisibility;

        // Toggle between total expenses and detailed expenses
        function toggleDetailedExpenses() {
            state.showDetailedExpenses = !state.showDetailedExpenses;
            const totalExpensesGroup = document.getElementById('income-tax-totalExpensesGroup');
            const detailedExpensesGroup = document.getElementById('income-tax-detailedExpensesGroup');
            
            if (state.showDetailedExpenses) {
                // Switching to detailed expenses - clear total expenses
                const totalExpensesInput = document.getElementById('income-tax-expensesWithoutMortgage');
                if (totalExpensesInput) {
                    totalExpensesInput.value = '';
                    state.expensesWithoutMortgage = '';
                }
                if (totalExpensesGroup) totalExpensesGroup.style.display = 'none';
                if (detailedExpensesGroup) detailedExpensesGroup.style.display = 'block';
            } else {
                // Switching to total expenses - clear detailed expenses
                const detailedInputs = ['income-tax-rentRatesInsurance', 'income-tax-propertyRepairs', 'income-tax-legalFees', 'income-tax-serviceCosts', 'income-tax-otherExpenses'];
                detailedInputs.forEach(id => {
                    const input = document.getElementById(id);
                    if (input) {
                        input.value = '';
                        const name = input.name;
                        if (name) state[name] = '';
                    }
                });
                if (totalExpensesGroup) totalExpensesGroup.style.display = 'block';
                if (detailedExpensesGroup) detailedExpensesGroup.style.display = 'none';
            }
            recalculate();
        }
        
        // Explicitly attach to window for global accessibility
        window.toggleDetailedExpenses = toggleDetailedExpenses;

        // Handle property type change - update tooltip immediately and clear stale calculation
        async function handlePropertyTypeChange() {
            console.log('üè† handlePropertyTypeChange() called');
            // Clear current calculation to prevent showing stale rates
            if (state.currentCalculation) {
                state.currentCalculation.breakdown = null;
            }
            
            // Update tooltip immediately with rate bands (async)
            await updatePropertyValueTooltip();
            
            // Trigger recalculation
            recalculate();
        }
        
        // Explicitly attach to window for global accessibility
        window.handlePropertyTypeChange = handlePropertyTypeChange;

        // Update formatted date display in input overlay
        function updateDateDisplay() {
            const transactionDateInput = document.getElementById('income-tax-transactionDate');
            const dateInputOverlay = document.getElementById('income-tax-dateInputFormatted');
            const overlayContainer = document.getElementById('income-tax-dateInputOverlay');
            
            if (!transactionDateInput) return;
            
            const dateValue = transactionDateInput.value;
            if (dateValue) {
                const formatted = formatDate(dateValue);
                state.taxYear = dateValue;
                
                // Update overlay display inside the input field
                if (dateInputOverlay) {
                    dateInputOverlay.textContent = formatted;
                }
                
                // Show overlay and make input text transparent
                if (overlayContainer) {
                    overlayContainer.style.display = 'flex';
                }
                transactionDateInput.style.color = 'transparent';
                transactionDateInput.style.caretColor = 'transparent';
            } else {
                if (dateInputOverlay) {
                    dateInputOverlay.textContent = 'Select date';
                }
                if (overlayContainer) {
                    overlayContainer.style.display = 'flex';
                }
                transactionDateInput.style.color = 'transparent';
            }
        }

        // Update date input display when blurred
        function updateDateInputDisplay() {
            const transactionDateInput = document.getElementById('income-tax-transactionDate');
            const overlayContainer = document.getElementById('income-tax-dateInputOverlay');
            
            if (transactionDateInput && transactionDateInput.value) {
                transactionDateInput.style.color = 'transparent';
                transactionDateInput.style.caretColor = 'transparent';
                if (overlayContainer) {
                    overlayContainer.style.display = 'flex';
                }
                updateDateDisplay();
            } else {
                if (overlayContainer) {
                    overlayContainer.style.display = 'flex';
                }
                if (transactionDateInput) {
                    transactionDateInput.style.color = 'transparent';
                }
            }
        }

        // Open date picker when clicking on formatted date overlay
        function openDatePicker() {
            const transactionDateInput = document.getElementById('income-tax-transactionDate');
            if (transactionDateInput) {
                // Focus the input first
                transactionDateInput.focus();
                
                // Try modern showPicker() API, fallback to click() for older browsers
                if (transactionDateInput.showPicker) {
                    try {
                        transactionDateInput.showPicker();
                    } catch (error) {
                        // Fallback: trigger click event
                        transactionDateInput.click();
                    }
                } else {
                    // Fallback for browsers without showPicker()
                    transactionDateInput.click();
                }
            }
        }

        // Initialize transaction date picker
        function initializeTransactionDate() {
            const transactionDateInput = document.getElementById('income-tax-transactionDate');
                if (!transactionDateInput) {
                    // Retry after a short delay if element not found (for embedded scenarios)
                    setTimeout(() => {
                        initializeTransactionDate();
                    }, 100);
                    return;
                }
            
            // Set max date to today
            const today = new Date().toISOString().split('T')[0];
            transactionDateInput.setAttribute('max', today);
            
                // Always set default to today if no value or empty string (handles hard refresh)
                // Check for empty string explicitly as browsers may restore empty values on hard refresh
                const currentValue = transactionDateInput.value ? transactionDateInput.value.trim() : '';
                if (!currentValue || currentValue === '' || currentValue === null || currentValue === undefined) {
                transactionDateInput.value = today;
                    transactionDateInput.setAttribute('value', today); // Also set attribute for better compatibility
                state.taxYear = today;
            } else {
                state.taxYear = transactionDateInput.value;
            }
            
            // Make input text transparent to show overlay
            transactionDateInput.style.color = 'transparent';
            transactionDateInput.style.caretColor = 'transparent';
            
            // Ensure overlay is visible
            const overlayContainer = document.getElementById('income-tax-dateInputOverlay');
            if (overlayContainer) {
                overlayContainer.style.display = 'flex';
            }
            
            // Update formatted display
            updateDateDisplay();
        }

        // Set fallback result values when the page first loads or if initial calculation fails
        function setInitialFallbackResults() {
            // Don't override an existing calculation
            if (state.currentCalculation) return;
            
            const defaultTax = 15000;
            const defaultPropertyValue = 500000;
            const taxText = `¬£${defaultTax.toLocaleString('en-GB')}`;
            const propertyValueText = `¬£${defaultPropertyValue.toLocaleString('en-GB')}`;
            
            // Get formatted transaction date from the input (or use today's date)
            const taxYearInput = document.getElementById('income-tax-transactionDate');
            let rawDate = taxYearInput && taxYearInput.value ? taxYearInput.value : state.taxYear;
            if (!rawDate) {
                rawDate = new Date().toISOString().split('T')[0];
            }
            const formattedDate = formatDate(rawDate);
            
            // Simple mode fallback
            const simpleTaxEl = document.getElementById('income-tax-simpleTax');
            const simpleNonSavingTaxEl = document.getElementById('income-tax-simpleNonSavingTax');
            const simplePropertyTaxEl = document.getElementById('income-tax-simplePropertyTax');
            const simpleSavingsTaxEl = document.getElementById('income-tax-simpleSavingsTax');
            const simpleDividendTaxEl = document.getElementById('income-tax-simpleDividendTax');
            const simpleFooterTextEl = document.getElementById('income-tax-simpleFooterText');
            
            if (simpleTaxEl && !simpleTaxEl.textContent) simpleTaxEl.textContent = taxText;
            // ‚úÖ Initialize Income Tax Breakdown displays if empty
            if (simpleNonSavingTaxEl && !simpleNonSavingTaxEl.textContent) {
                simpleNonSavingTaxEl.textContent = '¬£0';
            }
            if (simplePropertyTaxEl && !simplePropertyTaxEl.textContent) {
                simplePropertyTaxEl.textContent = '¬£0';
            }
            if (simpleSavingsTaxEl && !simpleSavingsTaxEl.textContent) {
                simpleSavingsTaxEl.textContent = '¬£0';
            }
            if (simpleDividendTaxEl && !simpleDividendTaxEl.textContent) {
                simpleDividendTaxEl.textContent = '¬£0';
            }
            if (simpleFooterTextEl && !simpleFooterTextEl.textContent) {
                simpleFooterTextEl.textContent = 'Income Tax Calculator';
            }
            
            // AI overview card fallback
            const taxResultEl = document.getElementById('income-tax-taxResult');
            const propertyValueResultEl = document.getElementById('income-tax-propertyValueResult');
            const taxYearResultEl = document.getElementById('income-tax-taxYearResult');
            const calculatorTypeResultEl = document.getElementById('income-tax-calculatorTypeResult');
            const ratioEl = document.getElementById('income-tax-sdltPropertyValueRatio');
            
            if (taxResultEl && !taxResultEl.textContent) taxResultEl.textContent = taxText;
            // ‚úÖ Initialize Mortgage Relief Applied in main tax card if empty (show 0 until calculation is done)
            if (propertyValueResultEl && !propertyValueResultEl.textContent) {
                propertyValueResultEl.textContent = '¬£0';
            }
            if (taxYearResultEl && !taxYearResultEl.textContent) {
                // ‚úÖ Rental Income Tax uses tax year, not transaction date
                const taxYear = state.taxYear || '';
                const displayYear = taxYear && taxYear.match(/\d{4}/) ? `${taxYear.match(/\d{4}/)[0]}/${parseInt(taxYear.match(/\d{4}/)[0]) + 1}` : taxYear || '-';
                taxYearResultEl.textContent = `Tax Year: ${displayYear}`;
            }
            // ‚úÖ Initialize Total Allowance in main tax card if empty
            if (calculatorTypeResultEl && !calculatorTypeResultEl.textContent) {
                calculatorTypeResultEl.textContent = '¬£0';
            }
            if (ratioEl && !ratioEl.textContent) {
                // 15000 / 500000 = 3%
                ratioEl.textContent = '3.00%';
            }
        }

        // Format currency input with commas
        function formatCurrencyInput(input) {
            // Get the raw value (remove all non-digits)
            let value = input.value.replace(/[^0-9]/g, '');
            
            // Don't format if empty
            if (!value) {
                input.value = '';
                input.dataset.rawValue = '';
                return;
            }
                
                // Limit to 10 digits maximum (formats to max 12 characters with commas: "9,999,999,999")
                // This ensures the formatted value with commas stays within the 12 character limit
                if (value.length > 10) {
                    value = value.substring(0, 10);
            }
            
            // Store raw value immediately for API calls
            const numericValue = parseInt(value, 10);
            input.dataset.rawValue = numericValue.toString();
            
            // Format with commas for display
            const formatted = numericValue.toLocaleString('en-GB');
                
                // Ensure formatted value doesn't exceed 12 characters
                // If it does, reduce digits until formatted value fits
                if (formatted.length > 12) {
                    let reducedValue = value;
                    while (reducedValue.length > 0) {
                        const testFormatted = parseInt(reducedValue, 10).toLocaleString('en-GB');
                        if (testFormatted.length <= 12) {
                            input.value = testFormatted;
                            input.dataset.rawValue = reducedValue;
                            return;
                        }
                        reducedValue = reducedValue.substring(0, reducedValue.length - 1);
                    }
                    input.value = '';
                    input.dataset.rawValue = '';
                } else {
                    input.value = formatted;
                }
            
            // Update state
            state.propertyValue = numericValue;
        }
        
        // Explicitly attach to window for global accessibility
        window.formatCurrencyInput = formatCurrencyInput;

        // Sanitize currency input (remove commas) before sending to backend
        function sanitizeCurrencyInput(input) {
            // Remove all non-digit characters
            const sanitized = input.value.replace(/[^0-9]/g, '');
            // Store sanitized value but keep formatted display
            if (sanitized) {
                input.dataset.rawValue = sanitized;
            }
        }

        // Get sanitized currency value (removes commas) by element ID
        function getSanitizedCurrencyValue(inputId) {
            const input = document.getElementById(inputId);
            if (!input) return 0;
            return getSanitizedCurrencyFromInput(input);
        }

        // Helper: sanitize a specific currency input element
        function getSanitizedCurrencyFromInput(input) {
            if (!input) return 0;
            const rawValue = (input.dataset && input.dataset.rawValue) 
                ? input.dataset.rawValue 
                : input.value.replace(/[^0-9]/g, '');
            return parseFloat(rawValue) || 0;
        }

        // Special helper for Employment Income which has two inputs in the DOM:
        // - 2027+ separate group:  #income-tax-employmentIncomeGroup2027
        // - Other years expandable group: #income-tax-employmentIncomeGroup
        function getEmploymentIncomeValue(isNewPropertyTreatment, isNonSavingExpanded) {
            let input = null;

            if (isNewPropertyTreatment) {
                // 2027: use the dedicated employment group
                const group2027 = document.getElementById('income-tax-employmentIncomeGroup2027');
                if (group2027) {
                    input = group2027.querySelector('input[name="employmentIncome"]');
                }
            } else if (isNonSavingExpanded) {
                // Other years: use the expandable Non‚ÄëSaving employment group (only when expanded)
                const group = document.getElementById('income-tax-employmentIncomeGroup');
                if (group) {
                    input = group.querySelector('input[name="employmentIncome"]');
                }
            }

            return getSanitizedCurrencyFromInput(input);
        }

        // Format a tax rate as a percentage string without rounding away precision.
        // - If backend gives 0.395, we show "39.5%".
        // - If backend gives 0.2, we show "20%".
        // - If backend already gives 20, we keep it as "20%".
        function formatRatePercentage(rate) {
            if (rate === null || rate === undefined) return '-';
            const numericRate = Number(rate);
            if (isNaN(numericRate)) return '-';

            // If value looks like 0‚Äì1, treat as fraction; otherwise assume already percent.
            const percent = numericRate > 0 && numericRate <= 1 ? numericRate * 100 : numericRate;

            // Keep up to 2 decimal places but avoid trailing zeros (e.g. 20, 39.5, 39.25)
            const fixed = percent.toFixed(2);
            const trimmed = fixed.replace(/\.00$/, '').replace(/(\.\d)0$/, '$1');
            return `${trimmed}%`;
        }

        // Calculate SDLT using API
        // Fetch rate bands from API
        async function fetchRateBandsFromAPI() {
            const transactionDateInput = document.getElementById('income-tax-transactionDate');
            const taxYear = transactionDateInput ? transactionDateInput.value : '';
            const calculatorType = state.calculatorType;
            const propertyTypeEl = document.getElementById('income-tax-propertyType');
            const propertyType = propertyTypeEl ? propertyTypeEl.value : '';
            const residencyStatusEl = document.getElementById('income-tax-residencyStatus');
            const residencyStatus = residencyStatusEl ? residencyStatusEl.value : '';

            if (!taxYear || !calculatorType || (calculatorType === 'Residential' && (!propertyType || !residencyStatus))) {
                return null;
            }

            try {
                const params = new URLSearchParams({
                    taxYear,
                    calculatorType,
                    ...(calculatorType === 'Residential' && { propertyType, residencyStatus })
                });

                const response = await fetch(`${API_CONFIG.baseUrl}/calculators/sdlt/rate-bands?${params}`, {
                    method: 'GET',
                    headers: {
                        'X-API-Key': API_CONFIG.validation
                    }
                });

                if (!response.ok) {
                    // Silently fail for 404 or other errors - this is optional data for tooltips
                    if (response.status === 404) {
                        console.log('Rate bands endpoint not available (404) - using calculation breakdown instead');
                    }
                    return null;
                }

                const result = await response.json();
                return result.success ? result.rateBands : null;
            } catch (error) {
                // Silently fail - rate bands are optional and only used for tooltips
                // The calculation breakdown will be used as fallback
                console.log('Rate bands API unavailable - using calculation breakdown for tooltip');
                return null;
            }
        }

        // Update property value tooltip with dynamic rate information
        async function updatePropertyValueTooltip() {
            const tooltipIcon = document.getElementById('income-tax-propertyValueTooltip');
            if (!tooltipIcon) return;

            let tooltipText = 'Enter the total purchase price of the property, including any fixtures and fittings that are part of the sale. This should be the full consideration paid for the property.\n\n';
            
            // Check if calculation is in progress
            if (state.isCalculating) {
                tooltipText += '‚è≥ Calculating rates based on your transaction date and property type...\n\n';
                tooltipText += 'The tooltip will update automatically once the calculation completes.';
                tooltipText += '\n\nEnter the value in pounds (e.g., 500000 or 500,000).';
                tooltipIcon.setAttribute('data-tooltip', tooltipText);
                return;
            }
            
            // Try to fetch rate bands immediately if we have the required info
            const transactionDateInput = document.getElementById('income-tax-transactionDate');
            const taxYear = transactionDateInput ? transactionDateInput.value : '';
            const calculatorType = state.calculatorType;
            const propertyTypeEl = document.getElementById('income-tax-propertyType');
            const propertyType = propertyTypeEl ? propertyTypeEl.value : '';
            const residencyStatusEl = document.getElementById('income-tax-residencyStatus');
            const residencyStatus = residencyStatusEl ? residencyStatusEl.value : '';

            // If we have all required info, try to fetch rate bands
            if (taxYear && calculatorType && (calculatorType !== 'Residential' || (propertyType && residencyStatus))) {
                const rateBands = await fetchRateBandsFromAPI();
                if (rateBands && rateBands.length > 0) {
                    tooltipText += 'SDLT is calculated on a tiered basis. Based on your selected transaction date and property type, the applicable rate bands are:\n\n';
                    
                    // Format rate bands
                    const formattedBands = rateBands.slice(0, 5).map(band => {
                        const startFormatted = band.start === 0 ? '¬£0' : `¬£${band.start.toLocaleString()}`;
                        const endFormatted = band.end === null ? 'and above' : `¬£${band.end.toLocaleString()}`;
                        return `${startFormatted} - ${endFormatted}: ${band.rate}%`;
                    });
                    
                    tooltipText += formattedBands.join('\n');
                    
                    if (rateBands.length > 5) {
                        tooltipText += `\n... and ${rateBands.length - 5} more rate band(s)`;
                    }
                    
                    tooltipText += '\n\nNote: Rates are specific to your transaction date and property type.';
                    tooltipText += '\n\nEnter the value in pounds (e.g., 500000 or 500,000).';
                    tooltipIcon.setAttribute('data-tooltip', tooltipText);
                    return;
                }
            }
            
            // If we have a calculation result with breakdown, show actual rates
            if (state.currentCalculation && state.currentCalculation.breakdown && state.currentCalculation.breakdown.length > 0) {
                tooltipText += 'SDLT is calculated on a tiered basis. Based on your selected transaction date and property type, the applicable rate bands are:\n\n';
                
                // Extract rate bands from breakdown
                const breakdown = state.currentCalculation.breakdown;
                const rateBands = [];
                let previousThreshold = 0;
                
                breakdown.forEach((item) => {
                    const rate = item.rate;
                    let threshold = item.band;
                    
                    // Handle "Above Max" or very large thresholds
                    const isAboveMax = threshold === 'Above Max' || (typeof threshold === 'number' && threshold > 1e12);
                    
                    // Format the band
                    const startFormatted = previousThreshold === 0 ? '¬£0' : `¬£${previousThreshold.toLocaleString()}`;
                    const endFormatted = isAboveMax ? 'and above' : `¬£${threshold.toLocaleString()}`;
                    const rateFormatted = `${rate}%`;
                    
                    rateBands.push(`${startFormatted} - ${endFormatted}: ${rateFormatted}`);
                    
                    // Update previous threshold for next iteration
                    if (!isAboveMax && typeof threshold === 'number') {
                        previousThreshold = threshold;
                    }
                });
                
                // Show first 4-5 bands as examples (or all if less)
                const displayBands = rateBands.slice(0, 5);
                tooltipText += displayBands.join('\n');
                
                if (rateBands.length > 5) {
                    tooltipText += `\n... and ${rateBands.length - 5} more rate band(s)`;
                }
                
                tooltipText += '\n\nNote: Rates are specific to your transaction date and property type.';
            } else {
                // Generic message when no calculation available
                const transactionDateInput = document.getElementById('income-tax-transactionDate');
                const taxYear = transactionDateInput ? transactionDateInput.value : '';
                
                tooltipText += 'SDLT is calculated on a tiered basis - different portions of the property value are taxed at different rates.\n\n';
                
                if (taxYear) {
                    tooltipText += `Rates vary based on your transaction date (${formatDate(taxYear)}). `;
                } else {
                    tooltipText += 'Rates vary based on your transaction date. ';
                }
                
                tooltipText += 'Perform a calculation to see the exact rates applicable to your property.';
            }
            
            tooltipText += '\n\nEnter the value in pounds (e.g., 500000 or 500,000).';
            
            // Update the tooltip
            tooltipIcon.setAttribute('data-tooltip', tooltipText);
        }

        async function calculateTax() {
                // CRITICAL: Safety check FIRST - reset stuck flags before blocking
                // This handles cases where the flag wasn't reset due to errors or race conditions
                if (state.isCalculating) {
                    if (!state.calculatingStartTime) {
                        // If isCalculating is true but there's no start time, it's definitely stuck
                        console.warn('‚ö†Ô∏è Calculation flag stuck (no start time), resetting immediately...');
                        state.isCalculating = false;
                        hideLoader();
                        // Continue with calculation after reset
                    } else {
                        const timeSinceStart = Date.now() - state.calculatingStartTime;
                        if (timeSinceStart > 5000) { // Reduced to 5 seconds for faster recovery
                            console.warn('‚ö†Ô∏è Calculation flag stuck for >5s, resetting...', {
                                timeSinceStart,
                                calculatingStartTime: state.calculatingStartTime
                            });
                            state.isCalculating = false;
                            state.calculatingStartTime = null;
                            hideLoader();
                            // Continue with calculation after reset
                        } else {
                            // Calculation is actually in progress (less than 5 seconds)
                            console.log('‚ö†Ô∏è Calculation already in progress, skipping...', {
                                timeSinceStart: timeSinceStart + 'ms'
                            });
                            return;
                        }
                    }
                }
            
            // Get income tax inputs
            const taxYearSelect = document.getElementById('income-tax-taxYear');
            const taxYear = taxYearSelect ? taxYearSelect.value : state.taxYear || '2025';
            
            // Determine if this is the special 2027/2028 property income treatment year
            const taxYearStr = String(taxYear).trim();
            const isNewPropertyTreatment = taxYearStr === '2027' || 
                                           taxYearStr === '2027/2028' ||
                                           taxYearStr === '2027-2028';

            // Always read top‚Äëlevel visible incomes
            // Property income field ID depends on tax year:
            // - For 2027: income-tax-propertyIncome2027 (separate group)
            // - For other years: income-tax-propertyIncomeNonSaving (non-saving group)
            const propertyIncomeFieldId = isNewPropertyTreatment 
                ? 'income-tax-propertyIncome2027' 
                : 'income-tax-propertyIncomeNonSaving';
            const propertyIncome = getSanitizedCurrencyValue(propertyIncomeFieldId) || 0;
            const savingIncome = getSanitizedCurrencyValue('income-tax-savingIncome') || 0;
            const dividendIncome = getSanitizedCurrencyValue('income-tax-dividendIncome') || 0;

            // Only include expandable Non‚ÄëSaving incomes when the section is expanded
            const isNonSavingExpanded = !!state.expandNonSavingIncome;
            
            // Employment income:
            // - For 2027 (new property treatment) the employment input is always visible;
            // - For other years it's part of the expandable Non‚ÄëSaving section and should be
            //   ignored when the section is collapsed.
            const employmentIncome = getEmploymentIncomeValue(isNewPropertyTreatment, isNonSavingExpanded) || 0;

            // Trading income lives only in the expandable Non‚ÄëSaving section ‚Äì ignore when collapsed
            const tradingIncome = isNonSavingExpanded
                ? (getSanitizedCurrencyValue('income-tax-tradingIncome') || 0)
                : 0;
            
            // Debug logging
            console.log('üî¢ calculateTax called:', {
                taxYear,
                propertyIncome,
                employmentIncome,
                tradingIncome,
                savingIncome,
                dividendIncome,
                isCalculating: state.isCalculating
            });
            
            // Check if calculation inputs have actually changed to avoid duplicate API calls
            // NOTE: This optimisation was causing confusion when multiple fields changed together.
            //       We now **always** treat user input changes as requiring a fresh calculation
            //       and only use this block to decide if comparison calculations need to be refreshed.
            if (state.currentCalculation) {
                const prevCalc = state.currentCalculation;
                
                // Previously we tried to skip API calls when inputs hadn't changed:
                //   const mainInputsChanged = !(...all income fields equal...);
                // This optimisation is removed to ensure every user input change
                // reliably triggers a new calculation.
                const mainInputsChanged = true;
                
                // Check if comparison calculation is needed (if comparison mode is enabled)
                // Need to recalculate if:
                // 1. Comparison mode is enabled but no comparison calculation exists yet
                // 2. Comparison tax year has changed from previous comparison
                let needsComparisonCalculation = false;
                let needsOverviewComparisonCalculation = false;
                let needsBreakdownComparisonCalculation = false;
                
                // Ensure comparison tax year is read from dropdown (in case state is stale)
                const comparisonTaxYearSelect = document.getElementById('income-tax-comparisonTaxYear');
                if (comparisonTaxYearSelect && state.comparisonMode) {
                    state.comparisonTaxYear = comparisonTaxYearSelect.value;
                }
                
                // Check if overview comparison tax year is read from dropdown
                const overviewComparisonTaxYearSelect = document.getElementById('income-tax-overviewComparisonTaxYear');
                if (overviewComparisonTaxYearSelect && state.overviewComparisonMode) {
                    state.overviewComparisonTaxYear = overviewComparisonTaxYearSelect.value;
                }
                
                // Check if breakdown comparison tax year is read from dropdown
                const breakdownComparisonTaxYearSelect = document.getElementById('income-tax-breakdownComparisonTaxYear');
                if (breakdownComparisonTaxYearSelect && state.breakdownComparisonMode) {
                    state.breakdownComparisonTaxYear = breakdownComparisonTaxYearSelect.value;
                }
                
                // Check if comparison mode is enabled and we have a comparison tax year (for Charts tab)
                if (state.comparisonMode && state.comparisonTaxYear) {
                    console.log('üîç Checking if comparison calculation is needed', {
                        comparisonMode: state.comparisonMode,
                        comparisonTaxYear: state.comparisonTaxYear,
                        mainTaxYear: taxYear,
                        hasComparisonCalculation: !!state.comparisonCalculation,
                        comparisonCalcTaxYear: state.comparisonCalculation?.taxYear
                    });
                    // Only fetch comparison if it's different from main tax year
                    if (state.comparisonTaxYear !== taxYear) {
                        if (!state.comparisonCalculation) {
                            // No comparison calculation exists yet - need to fetch it
                            needsComparisonCalculation = true;
                            console.log('üîÑ Comparison mode enabled but no comparison calculation exists yet');
                        } else if (state.comparisonCalculation.taxYear !== state.comparisonTaxYear) {
                            // Comparison tax year changed - need to fetch new one
                            needsComparisonCalculation = true;
                            console.log('üîÑ Comparison tax year changed', {
                                old: state.comparisonCalculation.taxYear,
                                new: state.comparisonTaxYear
                            });
                            // Clear old comparison to force fetch of new one
                            state.comparisonCalculation = null;
                        }
                    } else {
                        // Comparison tax year is same as main tax year - clear comparison
                        console.log('‚ö†Ô∏è Comparison tax year is same as main tax year, clearing comparison');
                        state.comparisonCalculation = null;
                    }
                }
                
                // Check if overview comparison mode is enabled and we have a comparison tax year (for Overview tab)
                if (state.overviewComparisonMode && state.overviewComparisonTaxYear) {
                    console.log('üîç Checking if overview comparison calculation is needed', {
                        overviewComparisonMode: state.overviewComparisonMode,
                        overviewComparisonTaxYear: state.overviewComparisonTaxYear,
                        mainTaxYear: taxYear,
                        hasOverviewComparisonCalculation: !!state.overviewComparisonCalculation,
                        overviewComparisonCalcTaxYear: state.overviewComparisonCalculation?.taxYear
                    });
                    // Only fetch comparison if it's different from main tax year
                    if (state.overviewComparisonTaxYear !== taxYear) {
                        if (!state.overviewComparisonCalculation) {
                            // No overview comparison calculation exists yet - need to fetch it
                            needsOverviewComparisonCalculation = true;
                            console.log('üîÑ Overview comparison mode enabled but no comparison calculation exists yet');
                        } else if (state.overviewComparisonCalculation.taxYear !== state.overviewComparisonTaxYear) {
                            // Overview comparison tax year changed - need to fetch new one
                            needsOverviewComparisonCalculation = true;
                            console.log('üîÑ Overview comparison tax year changed', {
                                old: state.overviewComparisonCalculation.taxYear,
                                new: state.overviewComparisonTaxYear
                            });
                            // Clear old comparison to force fetch of new one
                            state.overviewComparisonCalculation = null;
                        }
                    } else {
                        // Overview comparison tax year is same as main tax year - clear comparison
                        console.log('‚ö†Ô∏è Overview comparison tax year is same as main tax year, clearing comparison');
                        state.overviewComparisonCalculation = null;
                    }
                }
                
                // Check if breakdown comparison mode is enabled and we have a comparison tax year (for Breakdown tab)
                if (state.breakdownComparisonMode && state.breakdownComparisonTaxYear) {
                    console.log('üîç Checking if breakdown comparison calculation is needed', {
                        breakdownComparisonMode: state.breakdownComparisonMode,
                        breakdownComparisonTaxYear: state.breakdownComparisonTaxYear,
                        mainTaxYear: taxYear,
                        hasBreakdownComparisonCalculation: !!state.breakdownComparisonCalculation,
                        breakdownComparisonCalcTaxYear: state.breakdownComparisonCalculation?.taxYear
                    });
                    // Only fetch comparison if it's different from main tax year
                    if (state.breakdownComparisonTaxYear !== taxYear) {
                        if (!state.breakdownComparisonCalculation) {
                            // No breakdown comparison calculation exists yet - need to fetch it
                            needsBreakdownComparisonCalculation = true;
                            console.log('üîÑ Breakdown comparison mode enabled but no comparison calculation exists yet');
                        } else if (state.breakdownComparisonCalculation.taxYear !== state.breakdownComparisonTaxYear) {
                            // Breakdown comparison tax year changed - need to fetch new one
                            needsBreakdownComparisonCalculation = true;
                            console.log('üîÑ Breakdown comparison tax year changed', {
                                old: state.breakdownComparisonCalculation.taxYear,
                                new: state.breakdownComparisonTaxYear
                            });
                            // Clear old comparison to force fetch of new one
                            state.breakdownComparisonCalculation = null;
                        }
                    } else {
                        // Breakdown comparison tax year is same as main tax year - clear comparison
                        console.log('‚ö†Ô∏è Breakdown comparison tax year is same as main tax year, clearing comparison');
                        state.breakdownComparisonCalculation = null;
                    }
                }
                
                // We **no longer** short‚Äëcircuit here based on mainInputsChanged.
                // Any call to calculateTax() after user input will proceed to make
                // a fresh API request so results always stay in sync with the UI.
                
                // If comparison calculation is needed, proceed with calculation (will fetch both)
                if (needsComparisonCalculation) {
                    console.log('üîÑ Comparison calculation needed, proceeding with calculation to fetch both', {
                        comparisonMode: state.comparisonMode,
                        comparisonTaxYear: state.comparisonTaxYear,
                        mainTaxYear: taxYear,
                        hasComparisonCalculation: !!state.comparisonCalculation
                    });
                }
                
                // Note: Comparison calculation clearing is handled above in the needsComparisonCalculation check
            } else {
                // No previous calculation exists - always calculate
                console.log('üîÑ No previous calculation exists, proceeding with calculation');
            }

            if (!taxYear) {
                console.log('‚ö†Ô∏è Skipping calculation: missing taxYear', { taxYear });
                    if (state.isCalculating) {
                        state.isCalculating = false;
                        state.calculatingStartTime = null;
                        hideLoader();
                    }
                return;
            }

            // At least one income field should have a value
            const totalIncome = (parseFloat(propertyIncome) || 0) + 
                              (parseFloat(employmentIncome) || 0) + 
                              (parseFloat(tradingIncome) || 0) + 
                              (parseFloat(savingIncome) || 0) + 
                              (parseFloat(dividendIncome) || 0);
            
            if (totalIncome <= 0) {
                console.log('‚ö†Ô∏è Skipping calculation: at least one income field must have a positive value', { 
                    propertyIncome, employmentIncome, tradingIncome, savingIncome, dividendIncome 
                });
                    if (state.isCalculating) {
                        state.isCalculating = false;
                        state.calculatingStartTime = null;
                        hideLoader();
                    }
                return;
            }

            // Set calculating flag and track start time
            state.isCalculating = true;
            state.calculatingStartTime = Date.now();
                
                // Reset AI insights fetching flag for new calculation
                state.isFetchingAIInsights = false;
                state.isAIMetricsLoading = false;
                
                // Show loading state for "How We Calculated" section
                showHowWeCalculatedLoading();
            
            // Update tooltip immediately to show calculating state
            updatePropertyValueTooltip();
            
            // Safety timeout: reset flag after 30 seconds in case API call hangs
            let calculatingTimeout = setTimeout(() => {
                if (state.isCalculating) {
                    console.warn('‚ö†Ô∏è Calculation timeout - resetting isCalculating flag');
                    state.isCalculating = false;
                    hideLoader();
                }
            }, 30000);
            
            console.log('‚úÖ Starting API call to calculate Income Tax');

            // Show loading spinner
            showLoader();

            try {
                const requestBody = {
                    taxYear: taxYear,
                    propertyIncome: propertyIncome.toString(),
                    employmentIncome: employmentIncome.toString(),
                    tradingIncome: tradingIncome.toString(),
                    savingIncome: savingIncome.toString(),
                    dividendIncome: dividendIncome.toString()
                };

                console.log('üì§ Sending API request:', requestBody);
                
                // Use external API route for income tax calculator
                let mainCsrfHeaders;
                try {
                    mainCsrfHeaders = await addCsrfTokenToHeaders({
                        'X-API-Key': API_CONFIG.validation,
                        'Content-Type': 'application/json'
                    });
                } catch (csrfError) {
                    console.error('‚ùå Error getting CSRF token:', csrfError);
                    // Continue without CSRF token - let API return proper error
                    mainCsrfHeaders = {
                        'X-API-Key': API_CONFIG.validation,
                        'Content-Type': 'application/json'
                    };
                }
                
                let response;
                try {
                    response = await fetch(`${API_CONFIG.baseUrl}/calculators/it/calculate`, {
                        method: 'POST',
                        headers: mainCsrfHeaders,
                        body: JSON.stringify(requestBody)
                    });
                } catch (fetchError) {
                    // Handle network errors (server not running, CORS, etc.)
                    console.error('‚ùå Network error during fetch:', fetchError);
                    throw new Error(`Failed to connect to API server. Please check if the backend is running at ${API_CONFIG.baseUrl}. Error: ${fetchError.message}`);
                }
                
                console.log('üì• API response status:', response.status, response.statusText);

                if (!response.ok) {
                    let errorData;
                    try {
                        errorData = await response.json();
                    } catch (e) {
                        errorData = { message: `HTTP ${response.status}: ${response.statusText}` };
                    }
                    
                    // Handle rate limit errors specifically
                    if (response.status === 429) {
                        const retryAfter = errorData.retryAfter || 60;
                        throw new Error(`Rate limit exceeded. Please wait ${Math.ceil(retryAfter / 60)} minute(s) before trying again.`);
                    }
                    
                    // More detailed error for 404
                    if (response.status === 404) {
                        const endpointUrl = `${API_CONFIG.baseUrl}/calculators/it/calculate`;
                        console.error('‚ùå 404 Error - Route not found:', endpointUrl);
                        console.error('Check if server has been restarted after adding the route');
                        throw new Error(`API endpoint not found (404). Please check server configuration. Endpoint: ${endpointUrl}`);
                    }
                    
                    throw new Error(errorData.message || `HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.message || 'Calculation failed');
                }
                
                // ‚úÖ Store calculation result FIRST before any display updates
                // Check if aiInsights is valid (not null, undefined, or empty object)
                const hasValidAIInsights = result.aiInsights && 
                    typeof result.aiInsights === 'object' && 
                    Object.keys(result.aiInsights).length > 0 &&
                    result.aiInsights.success !== false;
                
                // Debug logging for AI insights validation
                if (result.aiInsights) {
                    console.log('üîç AI Insights validation:', {
                        exists: !!result.aiInsights,
                        isObject: typeof result.aiInsights === 'object',
                        keysCount: Object.keys(result.aiInsights).length,
                        keys: Object.keys(result.aiInsights),
                        hasSuccess: 'success' in result.aiInsights,
                        successValue: result.aiInsights.success,
                        isValid: hasValidAIInsights
                    });
                }
                
                // ‚úÖ Convert income tax breakdown object to array format for charts
                let breakdownArray = [];
                if (result.breakdown && typeof result.breakdown === 'object' && !Array.isArray(result.breakdown)) {
                    // Income tax returns breakdown as object {nonSavingIncomeTax, propertyIncomeTax, etc.}
                    // Convert to array format using tables if available
                    if (result.tables) {
                        // Combine all tax band arrays from tables
                        const allBands = [];
                        
                        // Non-Saving Income Tax bands
                        if (result.tables.nonSavingIncomeTax && Array.isArray(result.tables.nonSavingIncomeTax)) {
                            result.tables.nonSavingIncomeTax.forEach(band => {
                                allBands.push({
                                    band: `Non-Saving: ${band.band || 'Tax'}`,
                                    rate: (band.rate || 0) * 100, // Convert to percentage
                                    amount: band.amount || 0,
                                    tax: band.tax || 0
                                });
                            });
                        }
                        
                        // Property Income Tax bands (for 2027)
                        if (result.tables.propertyIncomeTax && Array.isArray(result.tables.propertyIncomeTax) && result.tables.propertyIncomeTax.length > 0) {
                            result.tables.propertyIncomeTax.forEach(band => {
                                allBands.push({
                                    band: `Property: ${band.band || 'Tax'}`,
                                    rate: (band.rate || 0) * 100,
                                    amount: band.amount || 0,
                                    tax: band.tax || 0
                                });
                            });
                        }
                        
                        // Savings Income Tax bands
                        if (result.tables.savingsIncomeTax && Array.isArray(result.tables.savingsIncomeTax)) {
                            result.tables.savingsIncomeTax.forEach(band => {
                                // Include all bands with amount > 0 (even if tax is 0)
                                if (band.amount > 0) {
                                    allBands.push({
                                        band: `Savings: ${band.band || 'Tax'}`,
                                        rate: (band.rate || 0) * 100,
                                        amount: band.amount || 0,
                                        tax: band.tax || 0
                                    });
                                }
                            });
                        }
                        
                        // Dividend Income Tax bands
                        if (result.tables.dividendIncomeTax && Array.isArray(result.tables.dividendIncomeTax)) {
                            result.tables.dividendIncomeTax.forEach(band => {
                                // Include all bands with amount > 0 (even if tax is 0)
                                if (band.amount > 0) {
                                    allBands.push({
                                        band: `Dividend: ${band.band || 'Tax'}`,
                                        rate: (band.rate || 0) * 100,
                                        amount: band.amount || 0,
                                        tax: band.tax || 0
                                    });
                                }
                            });
                        }
                        
                        breakdownArray = allBands;
                        
                        // Check if Non-Saving Income has income but tax is 0 (due to allowance)
                        // Calculate total non-saving income from inputs
                        const totalNonSavingIncome = (parseFloat(propertyIncome) || 0) + 
                                                     (parseFloat(employmentIncome) || 0) + 
                                                     (parseFloat(tradingIncome) || 0);
                        const nonSavingTax = result.breakdown.nonSavingIncomeTax || 0;
                        const usedAllowance = result.usedAllowance || 0;
                        
                        // If there's non-saving income but tax is 0, add allowance reduction info
                        if (totalNonSavingIncome > 0 && nonSavingTax === 0 && result.tables.nonSavingIncomeTax) {
                            const nonSavingBands = breakdownArray.filter(b => b.band && b.band.includes('Non-Saving'));
                            
                            if (nonSavingBands.length > 0) {
                                // Add allowance reduction info to the first non-saving band
                                const firstBand = nonSavingBands[0];
                                if (firstBand && firstBand.tax === 0) {
                                    // Calculate total income from non-saving bands
                                    let totalNonSavingAmount = 0;
                                    result.tables.nonSavingIncomeTax.forEach(band => {
                                        totalNonSavingAmount += band.amount || 0;
                                    });
                                    firstBand.allowanceReduction = usedAllowance > 0 ? Math.min(usedAllowance, totalNonSavingAmount) : 0;
                                }
                            } else {
                                // If no non-saving bands in breakdown, add a summary row
                                // Calculate total income from non-saving bands
                                let totalNonSavingAmount = 0;
                                result.tables.nonSavingIncomeTax.forEach(band => {
                                    totalNonSavingAmount += band.amount || 0;
                                });
                                
                                // Add a summary showing income reduced by allowance
                                breakdownArray.unshift({
                                    band: 'Non-Saving: Personal Allowance Applied',
                                    rate: 0,
                                    amount: totalNonSavingAmount,
                                    tax: 0,
                                    allowanceReduction: usedAllowance > 0 ? Math.min(usedAllowance, totalNonSavingAmount) : 0
                                });
                            }
                        }
                    } else {
                        // Fallback: create array from breakdown object values
                        // Calculate total non-saving income
                        const totalNonSavingIncome = (parseFloat(propertyIncome) || 0) + 
                                                     (parseFloat(employmentIncome) || 0) + 
                                                     (parseFloat(tradingIncome) || 0);
                        const nonSavingTax = result.breakdown.nonSavingIncomeTax || 0;
                        const usedAllowance = result.usedAllowance || 0;
                        
                        breakdownArray = [
                            // Always include Non-Saving Income Tax if there's income, even if tax is 0
                            ...(totalNonSavingIncome > 0 ? [{
                                band: 'Non-Saving Income Tax',
                                rate: 0,
                                amount: totalNonSavingIncome,
                                tax: nonSavingTax,
                                allowanceReduction: nonSavingTax === 0 && usedAllowance > 0 ? Math.min(usedAllowance, totalNonSavingIncome) : 0
                            }] : []),
                            ...(result.breakdown.propertyIncomeTax > 0 ? [{ band: 'Property Income Tax', rate: 0, amount: 0, tax: result.breakdown.propertyIncomeTax }] : []),
                            { band: 'Savings Income Tax', rate: 0, amount: 0, tax: result.breakdown.savingsIncomeTax || 0 },
                            { band: 'Dividend Income Tax', rate: 0, amount: 0, tax: result.breakdown.dividendIncomeTax || 0 }
                        ].filter(item => item.tax > 0 || (item.band && item.band.includes('Non-Saving') && item.amount > 0));
                    }
                } else if (Array.isArray(result.breakdown)) {
                    breakdownArray = result.breakdown;
                }
                
                // ‚úÖ Store calculation data - keep frontend fields and also store controller response fields
                state.currentCalculation = {
                    taxYear,
                    propertyIncome,
                    employmentIncome,
                    tradingIncome,
                    savingIncome,
                    dividendIncome,
                    // ‚úÖ Controller returns these fields - use them if available, otherwise use frontend values
                    totalIncome: result.totalIncome || (parseFloat(propertyIncome) + parseFloat(employmentIncome) + parseFloat(tradingIncome) + parseFloat(savingIncome) + parseFloat(dividendIncome)), // Controller returns totalIncome
                    inputs: result.inputs || { propertyIncome, employmentIncome, tradingIncome, savingIncome, dividendIncome }, // Controller returns inputs object
                    totalTax: result.totalTax || 0,
                    netIncome: result.netIncome || 0,
                    totalAllowance: result.totalAllowance || 0,
                    usedAllowance: result.usedAllowance || 0,
                    remainingAllowance: result.remainingAllowance || 0,
                    mortgageReliefApplied: result.mortgageReliefApplied || 0,
                    deductibleMortgageInterest: result.deductibleMortgageInterest || 0,
                    breakdown: breakdownArray, // ‚úÖ Converted to array format
                    breakdownObject: result.breakdown, // ‚úÖ Also store original object for reference
                    tables: result.tables || {}, // ‚úÖ Store tables for detailed breakdown
                    allowanceBreakdown: result.allowanceBreakdown || {}, // ‚úÖ Store allowance breakdown by category
                    isNewPropertyTreatment: result.isNewPropertyTreatment || false,
                    aiInsights: hasValidAIInsights ? result.aiInsights : null,
                    timestamp: new Date()
                };
                state.isAIMetricsLoading = state.aiMode && !hasValidAIInsights;
                
                // Fetch breakdown comparison calculation if breakdown comparison mode is enabled
                if (state.breakdownComparisonMode && state.breakdownComparisonTaxYear && state.breakdownComparisonTaxYear !== taxYear) {
                    // Show breakdown loader
                    const breakdownLoader = document.getElementById('income-tax-breakdownLoader');
                    if (breakdownLoader) {
                        breakdownLoader.style.display = 'flex';
                    }
                    // Fetch breakdown comparison calculation
                    fetchBreakdownComparisonCalculation(state.currentCalculation);
                }
                
                // If comparison mode is enabled, fetch comparison calculation
                if (state.comparisonMode && state.comparisonTaxYear && state.comparisonTaxYear !== taxYear) {
                    console.log('üîÑ Fetching comparison calculation for tax year:', state.comparisonTaxYear);
                    
                    try {
                        const comparisonRequestBody = {
                            taxYear: state.comparisonTaxYear,
                            propertyIncome: propertyIncome.toString(),
                            employmentIncome: employmentIncome.toString(),
                            tradingIncome: tradingIncome.toString(),
                            savingIncome: savingIncome.toString(),
                            dividendIncome: dividendIncome.toString()
                        };
                        
                        const comparisonCsrfHeaders2 = await addCsrfTokenToHeaders({
                            'X-API-Key': API_CONFIG.validation,
                            'Content-Type': 'application/json'
                        });
                        const comparisonResponse = await fetch(`${API_CONFIG.baseUrl}/calculators/it/calculate`, {
                            method: 'POST',
                            headers: comparisonCsrfHeaders2,
                            body: JSON.stringify(comparisonRequestBody)
                        });
                        
                        if (comparisonResponse.ok) {
                            const comparisonResult = await comparisonResponse.json();
                            if (comparisonResult.success) {
                                // Store comparison calculation
                                state.comparisonCalculation = {
                                    taxYear: state.comparisonTaxYear,
                                    propertyIncome,
                                    employmentIncome,
                                    tradingIncome,
                                    savingIncome,
                                    dividendIncome,
                                    totalTax: comparisonResult.totalTax || 0,
                                    netIncome: comparisonResult.netIncome || 0,
                                    totalAllowance: comparisonResult.totalAllowance || 0,
                                    usedAllowance: comparisonResult.usedAllowance || 0,
                                    remainingAllowance: comparisonResult.remainingAllowance || 0,
                                    mortgageReliefApplied: comparisonResult.mortgageReliefApplied || 0,
                                    deductibleMortgageInterest: comparisonResult.deductibleMortgageInterest || 0,
                                    breakdown: comparisonResult.breakdown || [],
                                    breakdownObject: comparisonResult.breakdown,
                                    tables: comparisonResult.tables || {},
                                    allowanceBreakdown: comparisonResult.allowanceBreakdown || {},
                                    isNewPropertyTreatment: comparisonResult.isNewPropertyTreatment || false,
                                    timestamp: new Date()
                                };
                                console.log('‚úÖ Comparison calculation stored');
                                
                                // Now that comparison calculation is done, hide loader and update displays
                                clearTimeout(calculatingTimeout);
                                state.isCalculating = false;
                                state.calculatingStartTime = null;
                                
                                // Hide loading spinner and clear chart loader
                                hideLoader();
                                clearLoadingMessageInterval();
                                
                                // Update all displays (including charts with comparison data)
                                console.log('üîÑ Updating all displays after comparison calculation completes', {
                                    hasComparison: !!state.comparisonCalculation,
                                    hasMainCalc: !!state.currentCalculation,
                                    comparisonBreakdown: state.comparisonCalculation?.breakdown?.length || 0,
                                    mainBreakdown: state.currentCalculation?.breakdown?.length || 0
                                });
                                
                                // Clear chart cache to force regeneration with updated breakdown data
                                // This ensures both main and comparison charts show all bands correctly
                                state.lastChartDataKey = null;
                                state.cachedChartHTML = null;
                                
                                // Force chart update to ensure it renders with comparison data
                                const activeTab = getActiveTab();
                                if (activeTab === 'income-tax-charts') {
                                    console.log('üìä Charts tab is active, updating chart with comparison data');
                                    updateChart();
                                }
                                
                                updateAllDisplays();
                            } else {
                                // Comparison calculation failed, but proceed with main calculation
                                console.warn('‚ö†Ô∏è Comparison calculation failed, proceeding with main calculation only');
                                clearTimeout(calculatingTimeout);
                                state.isCalculating = false;
                                state.calculatingStartTime = null;
                                hideLoader();
                                updateAllDisplays();
                            }
                        } else {
                            // Comparison API call failed
                            console.warn('‚ö†Ô∏è Comparison API call failed, proceeding with main calculation only');
                            clearTimeout(calculatingTimeout);
                            state.isCalculating = false;
                            state.calculatingStartTime = null;
                            hideLoader();
                            updateAllDisplays();
                        }
                    } catch (comparisonError) {
                        console.warn('‚ö†Ô∏è Failed to fetch comparison calculation:', comparisonError.message);
                        // Proceed with main calculation only
                        clearTimeout(calculatingTimeout);
                        state.isCalculating = false;
                        state.calculatingStartTime = null;
                        hideLoader();
                        updateAllDisplays();
                    }
                } else {
                    // Comparison mode is not enabled, proceed normally
                    clearTimeout(calculatingTimeout);
                    state.isCalculating = false;
                    state.calculatingStartTime = null;
                    hideLoader();
                    updateAllDisplays();
                }

                // If comparison mode is enabled, wait for comparison calculation before hiding loader
                if (state.comparisonMode && state.comparisonTaxYear && state.comparisonTaxYear !== taxYear) {
                    console.log('‚è≥ Waiting for comparison calculation to complete before updating displays...');
                    // Clear chart cache to force regeneration when comparison completes
                    // This ensures the main chart shows the updated breakdown with all bands
                    state.lastChartDataKey = null;
                    state.cachedChartHTML = null;
                    // Still update the display immediately so main calculation shows correctly
                    updateDisplay();
                    // Pre-generate chart with current data (will be updated when comparison completes)
                    setTimeout(() => {
                        updateAllDisplays();
                    }, 0);
                } else {
                    // No comparison mode, proceed normally
                // Clear timeout and reset calculating flag
                clearTimeout(calculatingTimeout);
                state.isCalculating = false;
                state.calculatingStartTime = null;
                state.isInitialLoad = false; // Mark that initial load is complete
                
                try {
                hideLoader();
                    updateAllDisplays();
                } catch (displayError) {
                    console.error('Error updating display:', displayError);
                    // Ensure loader is hidden even if display update fails
                    hideLoader();
                }
                
                    console.log('‚úÖ Calculation completed successfully', {
                        aiMode: state.aiMode,
                        hasAIInsights: hasValidAIInsights,
                        willFetchAIInsights: state.aiMode && !hasValidAIInsights,
                        aiInsightsData: hasValidAIInsights ? result.aiInsights : null,
                        totalTax: result.totalTax,
                        breakdown: result.breakdown,
                        currentCalculation: state.currentCalculation
                    });
    
                    // Update tooltip with actual rates from calculation (non-blocking)
                updatePropertyValueTooltip();

                    // Update critical display elements IMMEDIATELY (no delay)
                    // This shows results instantly without waiting for next frame
                    console.log('üîÑ Calling updateDisplay() with currentCalculation:', state.currentCalculation);
                    try {
                    updateDisplay();
                    } catch (displayError) {
                        console.error('Error in updateDisplay():', displayError);
                        // Ensure loader is hidden even if display update fails
                        hideLoader();
                    }
    
                    // If we have valid AI insights from the calculation, update display immediately
                    if (state.aiMode && hasValidAIInsights) {
                        console.log('‚úÖ AI insights received in calculation response, updating display...');
                        state.isAIMetricsLoading = false;
                        hideAICardLoader(); // Hide loader since we have insights
                        updateAIDisplay(result.aiInsights);
                    }
    
                    // Update other displays and generate charts in background (non-blocking)
                    // Use setTimeout with 0ms to defer non-critical operations
                    setTimeout(() => {
                    updateAllDisplays();
                    }, 0);
                }
                
                // If AI insights weren't included in the response but we're in AI mode, fetch them separately
                    if (state.aiMode && !hasValidAIInsights) {
                        console.log('üîÑ Fetching AI insights separately...');
                        // Fetch AI insights in background, don't block UI
                    fetchAIInsights();
                }

            } catch (error) {
                console.error('Error calculating Income Tax:', error);
                
                // Provide better error diagnostics
                const errorMessage = error.message || 'Unknown error';
                const isNetworkError = errorMessage.includes('Failed to fetch') || 
                                     errorMessage.includes('NetworkError') ||
                                     errorMessage.includes('Failed to connect');
                
                if (isNetworkError) {
                    console.error('‚ùå Network Error Details:', {
                        message: errorMessage,
                        apiUrl: `${API_CONFIG.baseUrl}/calculators/it/calculate`,
                        suggestion: 'Please check if the backend server is running at ' + API_CONFIG.baseUrl
                    });
                }
                
                const taxResultEl = document.getElementById('income-tax-taxResult');
                if (taxResultEl) {
                    if (isNetworkError) {
                        taxResultEl.textContent = 'Connection Error';
                        taxResultEl.title = 'Unable to connect to the server. Please check if the backend is running at ' + API_CONFIG.baseUrl;
                    } else {
                        taxResultEl.textContent = '¬£0';
                    }
                }
                
                // Only show alert for actual errors, not validation issues
                if (!error.message.includes('required fields')) {
                    let userMessage = errorMessage;
                    if (isNetworkError) {
                        userMessage = `Unable to connect to the API server. Please ensure the backend is running at ${API_CONFIG.baseUrl}`;
                    }
                    alert('Error calculating Income Tax: ' + userMessage);
                }
                
                // Clear timeout and reset calculating flag on error
                clearTimeout(calculatingTimeout);
                state.isCalculating = false;
                state.calculatingStartTime = null;
                state.isInitialLoad = false; // Mark that initial load is complete
                hideLoader();
            }
        }

        // Update save button state based on calculation status
        function updateSaveButtonState(isCalculating) {
            const saveBtn1 = document.getElementById('income-tax-saveBtn');
            const saveBtn2 = document.getElementById('income-tax-saveBtn2');
            
            [saveBtn1, saveBtn2].forEach(btn => {
                if (btn) {
                    btn.disabled = isCalculating;
                        
                        // Remove any existing listeners first to avoid duplicates
                        const existingEnter = btn._calculatingTooltipEnter;
                        const existingLeave = btn._calculatingTooltipLeave;
                        const existingClick = btn._calculatingTooltipClick;
                        
                        if (existingEnter) {
                            btn.removeEventListener('mouseenter', existingEnter);
                            btn.removeEventListener('mouseover', existingEnter);
                        }
                        if (existingLeave) {
                            btn.removeEventListener('mouseleave', existingLeave);
                            btn.removeEventListener('mouseout', existingLeave);
                        }
                        if (existingClick) {
                            btn.removeEventListener('click', existingClick);
                        }
                        
                        // Add or remove tooltip event listeners
                        if (isCalculating) {
                            // Create bound functions and store them
                            const enterHandler = (e) => showCalculatingTooltip(e, btn);
                            const leaveHandler = (e) => hideCalculatingTooltip(e);
                            const clickHandler = (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                showCalculatingTooltip(e, btn);
                            };
                            
                            btn._calculatingTooltipEnter = enterHandler;
                            btn._calculatingTooltipLeave = leaveHandler;
                            btn._calculatingTooltipClick = clickHandler;
                            
                            // Use both mouseenter and mouseover for better compatibility
                            btn.addEventListener('mouseenter', enterHandler);
                            btn.addEventListener('mouseover', enterHandler);
                            btn.addEventListener('mouseleave', leaveHandler);
                            btn.addEventListener('mouseout', leaveHandler);
                            btn.addEventListener('click', clickHandler);
                            
                            // Also add pointer-events style to ensure events work on disabled button
                            btn.style.pointerEvents = 'auto';
                            btn.style.cursor = 'not-allowed';
                        } else {
                            // Clean up stored references
                            delete btn._calculatingTooltipEnter;
                            delete btn._calculatingTooltipLeave;
                            delete btn._calculatingTooltipClick;
                            btn.style.pointerEvents = '';
                            btn.style.cursor = '';
                            
                            // Hide tooltip if it's currently visible
                            hideCalculatingTooltip();
                        }
                }
            });
        }
    
            // Show calculating tooltip
            function showCalculatingTooltip(event, button) {
                // Use provided button or get from event
                const btn = button || (event ? (event.currentTarget || event.target) : null);
                if (!btn) return;
                
                // Check if button is disabled (calculating) - if not, don't show tooltip
                if (!btn.disabled || !state.isCalculating) {
                    hideCalculatingTooltip();
                    return;
                }
                
                // Prevent default click behavior on disabled button
                if (event && event.type === 'click') {
                    event.preventDefault();
                    event.stopPropagation();
                }
                
                // Get or create tooltip element
                let tooltip = document.getElementById('income-tax-calculating-tooltip');
                if (!tooltip) {
                    tooltip = document.createElement('div');
                    tooltip.id = 'income-tax-calculating-tooltip';
                    tooltip.className = 'income-tax-save-tooltip';
                    tooltip.textContent = 'Calculating...';
                    document.body.appendChild(tooltip);
                } else {
                    // Update text in case it was changed
                    tooltip.textContent = 'Calculating...';
                }
                
                // Get button position
                const rect = btn.getBoundingClientRect();
                
                // Calculate tooltip position (above button, centered)
                // First, make tooltip visible temporarily to get its actual dimensions
                tooltip.style.visibility = 'hidden';
                tooltip.style.display = 'block';
                tooltip.classList.add('visible');
                const tooltipRect = tooltip.getBoundingClientRect();
                const tooltipWidth = tooltipRect.width || 110;
                const tooltipHeight = tooltipRect.height || 36;
                
                const left = rect.left + (rect.width / 2) - (tooltipWidth / 2);
                const top = rect.top - tooltipHeight - 8;
                
                // Ensure tooltip doesn't go off screen
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;
                const finalLeft = Math.max(10, Math.min(left, viewportWidth - tooltipWidth - 10));
                const finalTop = top < 10 ? rect.bottom + 8 : top;
                
                tooltip.style.left = `${finalLeft}px`;
                tooltip.style.top = `${finalTop}px`;
                tooltip.style.visibility = 'visible';
                tooltip.style.display = 'block';
                
                // Show tooltip
                tooltip.classList.add('visible');
                
                // For click events, hide after 2 seconds
                if (event && event.type === 'click') {
                    setTimeout(() => {
                        hideCalculatingTooltip();
                    }, 2000);
                }
            }
    
            // Hide calculating tooltip
            function hideCalculatingTooltip(event) {
                const tooltip = document.getElementById('income-tax-calculating-tooltip');
                if (tooltip) {
                    tooltip.classList.remove('visible');
                }
        }

        // Show/hide loader functions
        function showLoader() {
            // Only show loader if we're actually calculating (not just toggling modes)
            if (!state.isCalculating) {
                return;
            }
            
            // Don't show loader on initial page load - user already sees fallback results
            if (state.isInitialLoad) {
                return;
            }
            
            // Show loaders only in specific cards (AI mode)
            if (state.aiMode) {
                // Hide old calculation results in Tax Card
                const taxCardContent = document.getElementById('income-tax-taxCardContent');
                if (taxCardContent) {
                    taxCardContent.style.opacity = '0.3';
                    taxCardContent.style.pointerEvents = 'none';
                }
                
                // Show loader in Tax Card
                const taxCardLoader = document.getElementById('income-tax-taxCardLoader');
                if (taxCardLoader) {
                    taxCardLoader.classList.add('active');
                }
                
                // Hide old calculation results in AI Card
                const aiCardContent = document.getElementById('income-tax-aiCardContent');
                if (aiCardContent) {
                    aiCardContent.style.opacity = '0.3';
                    aiCardContent.style.pointerEvents = 'none';
                }
                
                // Show loader in AI Card
                const aiCardLoader = document.getElementById('income-tax-aiCardLoader');
                if (aiCardLoader) {
                    aiCardLoader.classList.add('active');
            }
                
                // Hide old breakdown table content
                const breakdownTableEl = document.getElementById('income-tax-breakdownTable');
                if (breakdownTableEl) {
                    breakdownTableEl.style.opacity = '0.3';
                    breakdownTableEl.style.pointerEvents = 'none';
            }
                
                // Show loader in Breakdown Tab
                const breakdownLoader = document.getElementById('income-tax-breakdownLoader');
                if (breakdownLoader) {
                    breakdownLoader.style.display = 'flex';
                }
            }
            
            // Simple mode: show a small inline loader under the amount (no overlay)
            if (!state.aiMode) {
                // Hide old calculation results in simple mode
                const simpleResultsGrid = document.getElementById('income-tax-simpleResultsGrid');
                if (simpleResultsGrid) {
                    simpleResultsGrid.style.opacity = '0.3';
                    simpleResultsGrid.style.pointerEvents = 'none';
                }
                
                const inlineLoader = document.getElementById('income-tax-simpleInlineLoader');
                const simpleTaxEl = document.getElementById('income-tax-simpleTax');
                if (inlineLoader) {
                    inlineLoader.style.display = 'flex';
                }
                if (simpleTaxEl) {
                    simpleTaxEl.style.visibility = 'hidden';
                }
            }
            
            // Disable save buttons and show calculating text
            updateSaveButtonState(true);
        }

        function hideLoader() {
            // Hide card loaders (AI mode)
            const taxCardLoader = document.getElementById('income-tax-taxCardLoader');
            if (taxCardLoader) {
                taxCardLoader.classList.remove('active');
            }
            
            // Restore Tax Card content visibility
            const taxCardContent = document.getElementById('income-tax-taxCardContent');
            if (taxCardContent) {
                taxCardContent.style.opacity = '1';
                taxCardContent.style.pointerEvents = 'auto';
            }
            
            // Restore AI Card content visibility
            const aiCardContent = document.getElementById('income-tax-aiCardContent');
            if (aiCardContent) {
                aiCardContent.style.opacity = '1';
                aiCardContent.style.pointerEvents = 'auto';
            }
            
            // Note: AI card loader is hidden separately via hideAICardLoader() when AI insights finish loading
            
            // Hide breakdown loader
            const breakdownLoader = document.getElementById('income-tax-breakdownLoader');
            if (breakdownLoader) {
                breakdownLoader.style.display = 'none';
            }
            
            // Restore breakdown table visibility
            const breakdownTableEl = document.getElementById('income-tax-breakdownTable');
            if (breakdownTableEl) {
                breakdownTableEl.style.opacity = '1';
                breakdownTableEl.style.pointerEvents = 'auto';
            }
            
            // Hide simple mode loader
            const simpleLoader = document.getElementById('income-tax-simpleModeLoader');
            const simpleResultsGrid = document.getElementById('income-tax-simpleResultsGrid');
            const inlineLoader = document.getElementById('income-tax-simpleInlineLoader');
            const simpleTaxEl = document.getElementById('income-tax-simpleTax');
            if (simpleLoader) {
                simpleLoader.classList.remove('active');
                // Ensure loader is completely hidden - remove all inline styles that might interfere
                simpleLoader.style.cssText = 'display: none !important; visibility: hidden; opacity: 0; z-index: -1;';
            }
            if (inlineLoader) {
                inlineLoader.style.display = 'none';
            }
            if (simpleTaxEl) {
                simpleTaxEl.style.visibility = 'visible';
            }
            if (simpleResultsGrid) {
                // Ensure results grid is fully visible and interactive - reset opacity and pointer events
                simpleResultsGrid.style.opacity = '1';
                simpleResultsGrid.style.pointerEvents = 'auto';
                simpleResultsGrid.style.display = '';
                simpleResultsGrid.style.visibility = 'visible';
                // Remove any inline styles that might be causing issues
                simpleResultsGrid.style.removeProperty('filter');
                simpleResultsGrid.style.removeProperty('backdrop-filter');
            }
            
            // Restore chart container visibility
            const chartContainer = document.getElementById('income-tax-chartContainer');
            if (chartContainer) {
                chartContainer.style.opacity = '1';
                chartContainer.style.pointerEvents = 'auto';
            }
            
            // Remove mini loaders from result boxes
            const loaders = document.querySelectorAll('.income-tax-result-loader');
            loaders.forEach(loader => loader.remove());
            
            // Re-enable save buttons and hide calculating text
            updateSaveButtonState(false);
        }

        // Debounced version of calculateTax (1000ms delay to allow users to finish typing before calculation)
        const debouncedCalculateTax = debounce(calculateTax, 1000);

        // Fetch AI insights separately if needed
        function renderAIMetricLoader() {
            // Show the AI card loader
            const aiCardLoader = document.getElementById('income-tax-aiCardLoader');
            if (aiCardLoader) {
                aiCardLoader.classList.add('active');
            }
            
            // Commented out optimization score and potential savings
            // const optimizationScoreEl = document.getElementById('income-tax-optimizationScore');
            // const potentialSavingsEl = document.getElementById('income-tax-potentialSavings');
            const summaryTextEl = document.getElementById('income-tax-aiSavingsSummaryText');
            const sdltPropertyValueRatioEl = document.getElementById('income-tax-sdltPropertyValueRatio');
            
            // if (optimizationScoreEl) {
            //     optimizationScoreEl.innerHTML = '<span class="income-tax-result-loader"></span>';
            // }
            // if (potentialSavingsEl) {
            //     potentialSavingsEl.innerHTML = '<span class="income-tax-result-loader"></span>';
            // }
            if (sdltPropertyValueRatioEl) {
                sdltPropertyValueRatioEl.innerHTML = '<span class="income-tax-result-loader"></span>';
            }
            if (summaryTextEl) {
                summaryTextEl.textContent = 'Analysing your calculation...';
            }
        }
        
        // Hide AI card loader
        function hideAICardLoader() {
            const aiCardLoader = document.getElementById('income-tax-aiCardLoader');
            if (aiCardLoader) {
                aiCardLoader.classList.remove('active');
            }
        }

        async function fetchAIInsights() {
                console.log('üîç fetchAIInsights() called', {
                    hasCurrentCalculation: !!state.currentCalculation,
                    isFetchingAIInsights: state.isFetchingAIInsights,
                    hasAIInsights: !!state.currentCalculation?.aiInsights,
                    aiMode: state.aiMode
                });
                
                if (!state.currentCalculation) {
                    console.warn('‚ö†Ô∏è No current calculation, skipping AI insights fetch');
                    return;
                }
            
            // Prevent multiple simultaneous AI insights requests
            if (state.isFetchingAIInsights) {
                    console.log('‚ö†Ô∏è AI insights request already in progress, skipping...');
                return;
            }
            
            // Check if we already have AI insights for this calculation
                const hasValidAIInsights = state.currentCalculation.aiInsights && 
                    typeof state.currentCalculation.aiInsights === 'object' && 
                    Object.keys(state.currentCalculation.aiInsights).length > 0;
                
                if (hasValidAIInsights) {
                    console.log('‚úÖ AI insights already available, skipping fetch...');
                return;
            }
            
            try {
                    console.log('üöÄ Starting AI insights fetch...');
                state.isFetchingAIInsights = true;
                state.isAIMetricsLoading = true;
                renderAIMetricLoader();
                
                    const requestBody = {
                        calculationData: {
                            taxYear: state.currentCalculation.taxYear,
                            propertyIncome: state.currentCalculation.propertyIncome || 0,
                            employmentIncome: state.currentCalculation.employmentIncome || 0,
                            tradingIncome: state.currentCalculation.tradingIncome || 0,
                            savingIncome: state.currentCalculation.savingIncome || 0,
                            dividendIncome: state.currentCalculation.dividendIncome || 0,
                            totalIncome: state.currentCalculation.totalIncome || 0,
                            totalTax: state.currentCalculation.totalTax || 0,
                            netIncome: state.currentCalculation.netIncome || 0,
                            breakdown: state.currentCalculation.breakdown,
                            allowanceBreakdown: state.currentCalculation.allowanceBreakdown || {}
                        }
                    };
                    
                    console.log('üì§ Sending AI insights request:', requestBody);
                    
                    const aiCsrfHeaders = await addCsrfTokenToHeaders({
                        'X-API-Key': API_CONFIG.validation,
                        'Content-Type': 'application/json'
                    });
                    const response = await fetch(`${API_CONFIG.baseUrl}/calculators/it/ai-insights`, {
                        method: 'POST',
                        headers: aiCsrfHeaders,
                        body: JSON.stringify(requestBody)
                    });
    
                    console.log('üì• AI insights response status:', response.status, response.statusText);

                if (response.ok) {
                    const insights = await response.json();
                        console.log('‚úÖ AI insights received:', insights);
                    if (insights.success) {
                        // Update state
                        state.currentCalculation.aiInsights = insights;
                        state.isAIMetricsLoading = false;
                        updateAIDisplay(insights);
                            console.log('‚úÖ AI insights displayed successfully');
                        } else {
                            console.warn('‚ö†Ô∏è AI insights response not successful:', insights);
                            state.isAIMetricsLoading = false;
                            updateAIDisplay(null);
                    }
                    } else {
                        const errorData = await response.json().catch(() => ({}));
                        console.error('‚ùå AI insights API error:', response.status, errorData);
                        state.isAIMetricsLoading = false;
                        updateAIDisplay(null);
                }
            } catch (error) {
                    console.error('‚ùå Error fetching AI insights:', error);
                // Use default values on error
                state.isAIMetricsLoading = false;
                updateAIDisplay(null);
            } finally {
                state.isFetchingAIInsights = false;
                if (!state.currentCalculation.aiInsights) {
                    state.isAIMetricsLoading = false;
                }
                hideAICardLoader();
                    console.log('üèÅ AI insights fetch completed');
            }
        }

        // Convert common US English spellings to UK English in AI-generated text
        function sdltConvertToUKEnglish(text) {
            if (!text || typeof text !== 'string') return text;
            
            const mappings = [
                ['optimization', 'optimisation'],
                ['optimize', 'optimise'],
                ['optimized', 'optimised'],
                ['optimizing', 'optimising'],
                ['personalization', 'personalisation'],
                ['personalized', 'personalised'],
                ['personalizing', 'personalising'],
                ['analyze', 'analyse'],
                ['analyzed', 'analysed'],
                ['analyzing', 'analysing'],
                ['utilize', 'utilise'],
                ['utilized', 'utilised'],
                ['utilizing', 'utilising'],
                ['favorable', 'favourable'],
                ['favors', 'favours'],
                ['favor', 'favour']
            ];
            
            const applyCase = (source, target) => {
                if (source.toUpperCase() === source) return target.toUpperCase();
                if (source[0].toUpperCase() === source[0]) {
                    return target[0].toUpperCase() + target.slice(1);
                }
                return target;
            };
            
            let result = text;
            mappings.forEach(([us, uk]) => {
                const regex = new RegExp(`\\b${us}\\b`, 'gi');
                result = result.replace(regex, m => applyCase(m, uk));
            });
            return result;
        }

        // Update AI insights display
        function updateAIDisplay(insights) {
            const calc = state.currentCalculation;
                if (!calc) {
                    console.warn('‚ö†Ô∏è updateAIDisplay called but no current calculation');
                    return;
                }
                
                console.log('üé® updateAIDisplay called', {
                    hasInsights: !!insights,
                    insightsType: typeof insights,
                    insightsKeys: insights ? Object.keys(insights) : null
                });
                
                // Always hide loader when updating display
                state.isAIMetricsLoading = false;
                hideAICardLoader();
            
            if (!insights) {
                // Use default/fallback values
                // ‚úÖ Income Tax uses 'totalTax' and 'totalIncome'
                const totalTax = calc.totalTax || 0;
                const totalIncome = calc.totalIncome || 0;
                
                // Calculate and display total tax / total income ratio
                const taxIncomeRatioEl = document.getElementById('income-tax-sdltPropertyValueRatio');
                if (taxIncomeRatioEl && totalIncome > 0) {
                    const ratio = ((totalTax / totalIncome) * 100).toFixed(2);
                    taxIncomeRatioEl.textContent = ratio + '%';
                } else if (taxIncomeRatioEl) {
                    taxIncomeRatioEl.textContent = '0%';
                }
                
                return;
            }

            // ‚úÖ Income Tax uses 'totalTax' and 'totalIncome'
            const totalTax = calc.totalTax || 0;
            const totalIncome = calc.totalIncome || 0;
            const taxIncomeRatioEl = document.getElementById('income-tax-sdltPropertyValueRatio');
            
            // Calculate and display total tax / total income ratio
            if (taxIncomeRatioEl && totalIncome > 0) {
                const ratio = ((totalTax / totalIncome) * 100).toFixed(2);
                taxIncomeRatioEl.textContent = ratio + '%';
            } else if (taxIncomeRatioEl) {
                taxIncomeRatioEl.textContent = '0%';
            }
                
                // Commented out validation for optimization score and potential savings
                // // Validate that we have the required insight properties
                // if (typeof insights.optimizationScore === 'undefined' || typeof insights.potentialSavings === 'undefined') {
                //     console.error('‚ùå AI insights missing required properties:', {
                //         hasOptimizationScore: 'optimizationScore' in insights,
                //         hasPotentialSavings: 'potentialSavings' in insights,
                //         insightsKeys: Object.keys(insights)
                //     });
                //     // Fall back to default display
                //     updateAIDisplay(null);
                //     return;
                // }
                
                // console.log('‚úÖ Updating AI display with values:', {
                //     optimizationScore: insights.optimizationScore,
                //     potentialSavings: insights.potentialSavings,
                //     bestScenario: insights.bestScenario
                // });
            
            // if (optimizationScoreEl) {
            //     optimizationScoreEl.textContent = insights.optimizationScore + '%';
            //     } else {
            //         console.warn('‚ö†Ô∏è Optimization score element not found');
            // }
            
            // if (potentialSavingsEl) {
            //     potentialSavingsEl.textContent = '¬£' + insights.potentialSavings.toLocaleString();
            //     } else {
            //         console.warn('‚ö†Ô∏è Potential savings element not found');
            // }
            
            // // Update savings percentage
            // if (savingsPercentEl && calc.totalTaxLiability > 0) {
            //     const savingsPercentage = ((insights.potentialSavings / calc.totalTaxLiability) * 100).toFixed(1);
            //     savingsPercentEl.textContent = savingsPercentage + '% reduction';
            //     } else if (!savingsPercentEl) {
            //         console.warn('‚ö†Ô∏è Savings percent element not found');
            // }
            
            // Use AI-provided narrative fields where available
            const summaryTextEl = document.getElementById('income-tax-aiSavingsSummaryText');
            const methodTextEl = document.getElementById('income-tax-calculationMethodText');
            const descriptionEl = document.getElementById('income-tax-calculationDescriptionText');

            if (insights.overviewSummaryHtml && summaryTextEl) {
                summaryTextEl.innerHTML = sdltConvertToUKEnglish(insights.overviewSummaryHtml);
            } else if (summaryTextEl && insights.insightSummary) {
                summaryTextEl.textContent = sdltConvertToUKEnglish(insights.insightSummary);
            }

            if (insights.howWeCalculatedHtml && methodTextEl) {
                methodTextEl.innerHTML = sdltConvertToUKEnglish(insights.howWeCalculatedHtml);
            }

            if (insights.calculationExplanationHtml && descriptionEl) {
                descriptionEl.innerHTML = sdltConvertToUKEnglish(insights.calculationExplanationHtml);
            }

            // Optionally log recommendations for future UI use
            if (insights.recommendations && insights.recommendations.length > 0) {
                console.log('AI Recommendations:', insights.recommendations);
            }
                
                console.log('‚úÖ AI display updated successfully');
            }
    
            // Show loading state for "How We Calculated" section
            function showHowWeCalculatedLoading() {
                const summaryTextEl = document.getElementById('income-tax-aiSavingsSummaryText');
                const methodTextEl = document.getElementById('income-tax-calculationMethodText');
                
                if (summaryTextEl) {
                    summaryTextEl.innerHTML = 'Analyzing your income details to identify tax insights and optimisation opportunities...';
                }
                
                if (methodTextEl) {
                    methodTextEl.innerHTML = `
                        <p><strong>We are preparing a detailed explanation of your calculation.</strong></p>
                        <p>This will show how your income was distributed across tax bands and how allowances were applied.</p>
                    `;
                }
            }

        // Update AI savings summary text
        function updateSavingsSummary(potentialSavings, optimizationScore, calc, bestScenario = null) {
            const summaryTextEl = document.getElementById('income-tax-aiSavingsSummaryText');
            if (!summaryTextEl || !calc) return;
                
                // Don't update if calculation is in progress
                if (state.isCalculating) {
                    return;
                }
            
            // ‚úÖ Rental Income Tax uses 'totalTax', not 'totalTaxLiability'
            const totalTax = calc.totalTax || 0;
            const propertyValue = calc.annualRentalIncome || calc.netIncome || 0;
            const savingsPercentage = totalTax > 0 ? ((potentialSavings / totalTax) * 100).toFixed(1) : 0;
            
            // Generate concise explanation
            let summary = '';
            
            // Special handling for first-time buyer - if already selected, don't show misleading savings
            if (calc.propertyType === 'firstTimeBuyer' && potentialSavings > 0 && bestScenario && bestScenario.toLowerCase().includes('first-time buyer')) {
                // User is already using first-time buyer, so don't suggest it again
                // ‚úÖ Income Tax - ensure totalTax is defined
                const safeTotalTax = totalTax || 0;
                summary = `Your Income Tax of <strong>¬£${safeTotalTax.toLocaleString('en-GB')}</strong> has been calculated.`;
            } else if (potentialSavings > 0) {
                // Use AI's best scenario description if available, otherwise use fallback logic
                if (bestScenario) {
                    // ‚úÖ Income Tax - ensure potentialSavings is defined
                    const safeSavings = potentialSavings || 0;
                    summary = `${bestScenario} This could save you <strong>¬£${safeSavings.toLocaleString('en-GB')}</strong> (${savingsPercentage}% reduction).`;
                } else if (calc.propertyType === 'buyToLetSecondHome') {
                    // ‚úÖ Income Tax - ensure potentialSavings is defined
                    const safeSavings = potentialSavings || 0;
                    summary = `You could save <strong>¬£${safeSavings.toLocaleString('en-GB')}</strong> (${savingsPercentage}% reduction).`;
                } else if (calc.propertyType === 'singleMainHome' && calc.residencyStatus === 'nonUkResident') {
                    // ‚úÖ Income Tax - ensure potentialSavings is defined
                    const safeSavings = potentialSavings || 0;
                    summary = `As a UK resident, you could save <strong>¬£${safeSavings.toLocaleString('en-GB')}</strong> (${savingsPercentage}% reduction).`;
                } else {
                    // ‚úÖ Income Tax - ensure potentialSavings is defined
                    const safeSavings = potentialSavings || 0;
                    summary = `Our analysis identified potential savings of <strong>¬£${safeSavings.toLocaleString('en-GB')}</strong> (${savingsPercentage}% reduction) by optimising your income tax strategy.`;
                }
            } else {
                // No potential savings - show optimized message
                // ‚úÖ Income Tax - ensure totalTax is defined
                const safeTotalTax = totalTax || 0;
                if (calc.propertyType === 'firstTimeBuyer') {
                    summary = `Your Income Tax of <strong>¬£${safeTotalTax.toLocaleString('en-GB')}</strong> has been calculated with an optimisation score of ${optimizationScore}%.`;
                } else {
                    summary = `Your Income Tax of <strong>¬£${safeTotalTax.toLocaleString('en-GB')}</strong> is already optimised for your scenario. With an optimisation score of ${optimizationScore}%, you're in a favourable position.`;
                }
            }
            
            // Add expert consultation message at the end
            summary += ` <strong>Talk with our experts to find out any other possible savings and get personalised advice tailored to your specific situation.</strong>`;
            
            // Enforce UK English spellings in the final summary text
            summary = sdltConvertToUKEnglish(summary);
            
            summaryTextEl.innerHTML = summary;
        }

        // Helper function to get the currently active tab
        function getActiveTab() {
            const tabs = ['income-tax-overview', 'income-tax-breakdown', 'income-tax-charts', 'income-tax-history'];
            for (const tab of tabs) {
                const tabElement = document.getElementById(tab);
                if (tabElement && tabElement.classList.contains('active')) {
                    return tab;
                }
            }
            return 'income-tax-overview'; // Default to overview
        }

        // Update display for both simple and AI modes
        /**
         * Update all displays and tab contents when inputs change
         * This ensures all result items and tab contents are refreshed
         * Prioritizes the active tab's data first
         */
        function updateAllDisplays() {
            const activeTab = getActiveTab();
            console.log('üìä Active tab:', activeTab);
            
            // Prioritize based on active tab
            if (activeTab === 'income-tax-charts') {
                // Charts tab is active - prioritize chart generation
                console.log('üéØ Prioritizing chart generation (Charts tab active)');
                updateChart(); // This will generate chart immediately
                
                // Update other tabs in background (no API calls needed)
                    // Use setTimeout instead of requestAnimationFrame for faster execution
                    setTimeout(() => {
                    updateDisplay();
                    }, 0);
                
                // Pre-generate chart for future use (if not already generating)
                preGenerateChart();
            } else if (activeTab === 'income-tax-breakdown') {
                // Breakdown tab is active - prioritize breakdown display
                console.log('üéØ Prioritising breakdown display (Breakdown tab active)');
                updateDisplay(); // This updates breakdown immediately
                
                    // Generate chart in background (lower priority, defer to avoid blocking)
                    setTimeout(() => {
                    preGenerateChart();
                    }, 50); // Small delay to let main display render first
            } else {
                // Overview or other tab is active - prioritize overview/display
                console.log('üéØ Prioritising overview display (Overview tab active)');
                updateDisplay(); // This updates overview immediately
                
                    // Generate chart in background (lower priority, defer to avoid blocking)
                    setTimeout(() => {
                    preGenerateChart();
                    }, 50); // Small delay to let main display render first
            }
            
            // Note: History tab doesn't need to update on input change as it shows saved calculations
            
            // Show lead form if there's a calculation
            if (state.currentCalculation) {
                showLeadForm();
            }
        }

        /**
         * Show the lead form CTA when there's a calculation result
         */
        function showLeadForm() {
            const leadFormSection = document.getElementById('income-tax-leadFormSection');
            if (leadFormSection) {
                leadFormSection.style.display = 'block';
            }
        }

        /**
         * Toggle email form visibility
         */
        function toggleEmailForm() {
            const leadFormSection = document.getElementById('income-tax-leadFormSection');
            const showBtn = document.getElementById('income-tax-showEmailFormBtn');
            
            if (leadFormSection) {
                if (leadFormSection.style.display === 'none' || !leadFormSection.style.display) {
                    leadFormSection.style.display = 'block';
                    if (showBtn) {
                        showBtn.textContent = '‚úï Hide Email Form';
                    }
                } else {
                    leadFormSection.style.display = 'none';
                    if (showBtn) {
                        showBtn.textContent = 'üìß Get Results via Email';
                    }
                }
            }
        }

        /**
         * Format calculation data as HTML for email/webhook
         * @returns {string} HTML formatted calculation data
         */
        function formatCalculationAsHTML() {
            if (!state.currentCalculation) {
                return '';
            }

            const calc = state.currentCalculation;
            
            // Format inputs
            const inputs = {
                'Tax Year': calc.taxYear || 'N/A',
                'Employment Income': calc.employmentIncome ? `¬£${parseFloat(calc.employmentIncome).toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` : '¬£0.00',
                'Trading Income': calc.tradingIncome ? `¬£${parseFloat(calc.tradingIncome).toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` : '¬£0.00',
                'Property Income': calc.propertyIncome ? `¬£${parseFloat(calc.propertyIncome).toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` : '¬£0.00',
                'Savings Income': calc.savingIncome ? `¬£${parseFloat(calc.savingIncome).toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` : '¬£0.00',
                'Dividend Income': calc.dividendIncome ? `¬£${parseFloat(calc.dividendIncome).toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` : '¬£0.00',
            };

            // Format outputs/results
            const outputs = {
                'Total Tax Liability': calc.totalTax ? `¬£${parseFloat(calc.totalTax).toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` : '¬£0.00',
                'Non-Saving Income Tax': calc.nonSavingTax ? `¬£${parseFloat(calc.nonSavingTax).toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` : '¬£0.00',
                'Property Income Tax': calc.propertyTax ? `¬£${parseFloat(calc.propertyTax).toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` : '¬£0.00',
                'Savings Income Tax': calc.savingsTax ? `¬£${parseFloat(calc.savingsTax).toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` : '¬£0.00',
                'Dividend Income Tax': calc.dividendTax ? `¬£${parseFloat(calc.dividendTax).toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` : '¬£0.00',
            };

            // Build HTML tables
            const inputsTable = `
                <h3 style="color: #012169; font-size: 18px; margin-top: 20px;">üìù Your Provided Details</h3>
                <table border="0" cellpadding="8" cellspacing="0" style="border-collapse: collapse; width: 100%; font-size: 14px; margin-bottom: 20px;">
                    <thead>
                        <tr style="background-color: #f4f4f4; border-bottom: 2px solid #012169;">
                            <th style="text-align: left; padding: 10px; font-weight: bold;">Field</th>
                            <th style="text-align: left; padding: 10px; font-weight: bold;">Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Object.entries(inputs).map(([key, value]) => `
                            <tr>
                                <td style="padding: 10px; border-bottom: 1px solid #ddd;">${key}</td>
                                <td style="padding: 10px; border-bottom: 1px solid #ddd;">${value}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>`;

            const resultsTable = `
                <h3 style="color: #09306e; font-size: 18px; margin-top: 20px;">üìä Your Calculation Results</h3>
                <table border="0" cellpadding="8" cellspacing="0" style="border-collapse: collapse; width: 100%; font-size: 14px; margin-bottom: 20px;">
                    <thead>
                        <tr style="background-color: #f4f4f4; border-bottom: 2px solid #09306e;">
                            <th style="text-align: left; padding: 10px; font-weight: bold;">Field</th>
                            <th style="text-align: left; padding: 10px; font-weight: bold;">Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Object.entries(outputs).map(([key, value]) => `
                            <tr>
                                <td style="padding: 10px; border-bottom: 1px solid #ddd;">${key}</td>
                                <td style="padding: 10px; border-bottom: 1px solid #ddd;">${value}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>`;

            return `
                <div style="font-family: Arial, sans-serif; color: #333; line-height: 1.6;">
                    <p style="font-size: 16px;">Thank you for using our <strong>Income Tax Calculator</strong>. Below is a summary of your input details and calculated results.</p>
                    ${inputsTable}
                    ${resultsTable}
                    <p style="font-size: 14px;">
                        If you have any questions or require further assistance, feel free to get in touch with our team. We're here to help!
                    </p>
                </div>
            `.trim();
        }

        /**
         * Handle lead form submission
         * @param {Event} event - Form submit event
         */
        async function handleLeadFormSubmit(event) {
            event.preventDefault();
            
            const submitBtn = document.getElementById('income-tax-leadFormSubmitBtn');
            const submitText = document.getElementById('income-tax-leadFormSubmitText');
            const submitLoader = document.getElementById('income-tax-leadFormSubmitLoader');
            const messageDiv = document.getElementById('income-tax-leadFormMessage');
            
            // Get form data
            const fullName = document.getElementById('income-tax-leadFullName').value.trim();
            const email = document.getElementById('income-tax-leadEmail').value.trim();
            
            if (!fullName || !email) {
                messageDiv.textContent = '‚ö†Ô∏è Please fill in all required fields';
                messageDiv.style.color = '#fbbf24';
                return;
            }

            // Validate email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                messageDiv.textContent = '‚ö†Ô∏è Please enter a valid email address';
                messageDiv.style.color = '#fbbf24';
                return;
            }

            // Ensure email is not empty after validation
            if (email.length === 0) {
                messageDiv.textContent = '‚ö†Ô∏è Email address is required';
                messageDiv.style.color = '#fbbf24';
                return;
            }

            // Show loading state
            submitBtn.disabled = true;
            submitText.textContent = 'Sending...';
            submitLoader.style.display = 'inline';
            messageDiv.textContent = '';
            messageDiv.style.color = '';

            try {
                // Get reCAPTCHA token
                let captchaToken = null;
                try {
                    captchaToken = await getRecaptchaToken('income_tax_submit');
                    console.log('‚úÖ reCAPTCHA token obtained');
                } catch (captchaError) {
                    console.error('‚ùå Failed to get reCAPTCHA token:', captchaError);
                    throw new Error('reCAPTCHA verification is required. Please refresh the page and try again.');
                }

                // Format calculation data as HTML
                const htmlTables = formatCalculationAsHTML();
                
                if (!htmlTables) {
                    throw new Error('No calculation data available');
                }

                // Get API configuration
                const wp = window.ukpa_api_data || (window.parent && window.parent.ukpa_api_data) || {};
                if (!wp.ajaxurl) {
                    throw new Error('API configuration not available');
                }

                // Prepare payload
                const payload = {
                    email: email,
                    fullName: fullName,
                    formName: 'Income Tax Calculator',
                    calculatorName: 'Income Tax Calculator',
                    calculatorType: 'Income Tax Calculator',
                    htmlTables: htmlTables,
                    captchaToken: captchaToken, // Include reCAPTCHA token
                    inputs: {
                        taxYear: state.currentCalculation.taxYear || '',
                        employmentIncome: state.currentCalculation.employmentIncome || 0,
                        tradingIncome: state.currentCalculation.tradingIncome || 0,
                        propertyIncome: state.currentCalculation.propertyIncome || 0,
                        savingIncome: state.currentCalculation.savingIncome || 0,
                        dividendIncome: state.currentCalculation.dividendIncome || 0,
                    },
                    summary: {
                        totalTax: state.currentCalculation.totalTax || 0,
                        nonSavingTax: state.currentCalculation.nonSavingTax || 0,
                        propertyTax: state.currentCalculation.propertyTax || 0,
                        savingsTax: state.currentCalculation.savingsTax || 0,
                        dividendTax: state.currentCalculation.dividendTax || 0,
                    },
                    website: wp.website || 'UKPA',
                    source: 'wordpress',
                    nonce: wp.nonce || '',
                };

                // Submit via WordPress proxy
                console.log('üì§ Submitting form with payload:', payload);
                const response = await fetch(`${wp.ajaxurl}?action=ukpa_external_proxy`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        method: 'POST',
                        path: '/submissions/submit',
                        payload: payload,
                        nonce: wp.nonce || '',
                    }),
                });

                const result = await response.json();
                console.log('üì• Proxy response:', result);

                // Check for errors - WordPress proxy wraps responses, so check result.data.code and result.data.body
                if (!response.ok || !result.success) {
                    // Extract error from proxy response structure
                    const errorBody = result.data?.body;
                    let errorMessage = errorBody?.message || errorBody?.error || result.data?.error || result.data?.message || 'Submission failed';
                    
                    // Include validation errors if present
                    if (errorBody?.validationErrors && Array.isArray(errorBody.validationErrors)) {
                        const validationErrors = errorBody.validationErrors.join(', ');
                        errorMessage += ` (Validation errors: ${validationErrors})`;
                    }
                    
                    console.error('‚ùå Submission error:', {
                        responseOk: response.ok,
                        resultSuccess: result.success,
                        statusCode: result.data?.code,
                        errorBody: errorBody,
                        errorMessage: errorMessage
                    });
                    throw new Error(errorMessage);
                }

                // Also check if the backend returned an error (even if WordPress proxy succeeded)
                if (result.data?.code && (result.data.code < 200 || result.data.code >= 300)) {
                    const errorBody = result.data?.body;
                    let errorMessage = errorBody?.message || errorBody?.error || `Server returned status ${result.data.code}`;
                    
                    // Include validation errors if present
                    if (errorBody?.validationErrors && Array.isArray(errorBody.validationErrors)) {
                        const validationErrors = errorBody.validationErrors.join(', ');
                        errorMessage += ` (Validation errors: ${validationErrors})`;
                    }
                    
                    console.error('‚ùå Backend error:', {
                        statusCode: result.data.code,
                        errorBody: errorBody,
                        errorMessage: errorMessage
                    });
                    throw new Error(errorMessage);
                }

                // Success
                messageDiv.textContent = '‚úÖ Success! Your results have been sent to your email.';
                messageDiv.style.color = '#10b981';
                
                // Reset form
                document.getElementById('income-tax-leadForm').reset();
                
                // Hide form after 3 seconds
                setTimeout(() => {
                    const leadFormSection = document.getElementById('income-tax-leadFormSection');
                    if (leadFormSection) {
                        leadFormSection.style.display = 'none';
                    }
                }, 3000);

            } catch (error) {
                console.error('‚ùå Error submitting lead form:', error);
                messageDiv.textContent = `‚ùå Error: ${error.message || 'Failed to submit. Please try again.'}`;
                messageDiv.style.color = '#ef4444';
            } finally {
                // Reset button state
                submitBtn.disabled = false;
                submitText.textContent = 'Send My Results';
                submitLoader.style.display = 'none';
            }
        }
        
        // Pre-generate chart in background for faster loading when user switches to Charts tab
        function preGenerateChart() {
            const calc = state.currentCalculation;
            if (!calc || !calc.breakdown || calc.breakdown.length === 0) {
                return;
            }
            
            // Prevent multiple simultaneous chart generations
            if (state.isGeneratingChart) {
                return;
            }
            
            // Get the currently selected chart type from the dropdown
            const chartTypeSelect = document.getElementById('income-tax-chartTypeSelect');
            const selectedChartType = chartTypeSelect ? chartTypeSelect.value : 'bar';
            
            // ‚úÖ Rental Income Tax chart cache key - use normalized breakdown to match what's actually displayed
            const annualRentalIncome = calc.annualRentalIncome || calc.netIncome || 0;
            const taxYear = calc.taxYear || '';
            
            // Use normalized breakdown for cache key (same as what's used in generateChartHTML)
            // This ensures cache key matches the actual chart data
            const normalizedBreakdown = sdltPrepareBreakdownForChart(calc);
            const breakdownHash = normalizedBreakdown ? normalizedBreakdown.map(b => `${b.band}-${b.rate}-${b.amount}-${b.tax}`).join('|') : '';
            
            // Include comparison data in cache key if comparison mode is enabled
            let comparisonHash = '';
            if (state.comparisonMode && state.comparisonCalculation) {
                const compNormalizedBreakdown = sdltPrepareBreakdownForChart(state.comparisonCalculation);
                comparisonHash = compNormalizedBreakdown ? compNormalizedBreakdown.map(b => `${b.band}-${b.rate}-${b.amount}-${b.tax}`).join('|') : '';
                comparisonHash = `-comp-${state.comparisonCalculation.taxYear}-${comparisonHash}`;
            }
            
            const chartDataKey = `income-tax-${taxYear}-${annualRentalIncome}-${breakdownHash}-${selectedChartType}${comparisonHash}`;
            if (state.lastChartDataKey === chartDataKey && state.cachedChartHTML) {
                // Chart already cached for this data
                return;
            }
            
            // Generate chart in background with the currently selected chart type
            state.isGeneratingChart = true;
            generateChartHTML(calc, selectedChartType).then(result => {
                const html = result.html || result; // Support both old and new format
                const containerHeight = result.containerHeight || '450px';
                
                // Validate HTML before caching
                if (!html || html.trim().length === 0) {
                    console.error('‚ö†Ô∏è Pre-generated chart HTML is empty');
                    state.isGeneratingChart = false;
                    return;
                }
                
                // Check if HTML contains canvas element
                const tempCheck = document.createElement('div');
                tempCheck.innerHTML = html;
                if (!tempCheck.querySelector('canvas')) {
                    console.error('‚ö†Ô∏è Pre-generated chart HTML does not contain canvas element');
                    state.isGeneratingChart = false;
                    return;
                }
                
                state.cachedChartHTML = html;
                state.lastChartDataKey = chartDataKey;
                state.isGeneratingChart = false;
                
                console.log('‚úÖ Chart pre-generated and cached successfully');
                
                // If charts tab is active, update it with cached HTML
                const chartsTab = document.getElementById('income-tax-charts');
                if (chartsTab && chartsTab.classList.contains('active')) {
                    const chartContainer = document.getElementById('income-tax-chartContainer');
                    if (chartContainer && html) {
                        // Use dynamic height from chart generation
                        chartContainer.style.minHeight = containerHeight;
                        chartContainer.style.height = containerHeight;
                        chartContainer.style.position = 'relative';
                        chartContainer.style.overflow = 'hidden';
                        chartContainer.style.boxSizing = 'border-box';
                        
                        // Insert HTML properly
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = html;
                        const scripts = Array.from(tempDiv.querySelectorAll('script'));
                        
                        // Save script contents before removing
                        const scriptContents = scripts.map(script => ({
                            attributes: Array.from(script.attributes).map(attr => ({ name: attr.name, value: attr.value })),
                            textContent: script.textContent
                        }));
                        
                        // Remove scripts from temp div and insert the rest
                        scripts.forEach(script => script.remove());
                        chartContainer.innerHTML = tempDiv.innerHTML;
                        
                        // Restore chart container visibility after updating
                        chartContainer.style.opacity = '1';
                        chartContainer.style.pointerEvents = 'auto';
                        
                        // Clear loading message interval now that chart is loaded
                        clearLoadingMessageInterval();
                        
                        // Execute scripts separately to ensure they run
                        scriptContents.forEach(scriptData => {
                            const newScript = document.createElement('script');
                            scriptData.attributes.forEach(attr => {
                                newScript.setAttribute(attr.name, attr.value);
                            });
                            newScript.textContent = scriptData.textContent;
                            document.body.appendChild(newScript);
                            setTimeout(() => {
                                if (newScript.parentNode) {
                                    newScript.parentNode.removeChild(newScript);
                                }
                            }, 1000);
                        });
                    }
                }
            }).catch(error => {
                console.error('Error pre-generating chart:', error);
                state.isGeneratingChart = false;
            });
        }
        
        // Helper function to format tax year label (e.g., "2025" -> "2025/2026")
        function formatTaxYearLabel(year) {
            if (!year) return '';
            const yearNum = parseInt(year);
            if (isNaN(yearNum)) return year;
            return `${yearNum}/${yearNum + 1}`;
        }
        
        // Generate chart HTML locally using the current calculation data
        function generateChartHTML(calc, chartType) {
            return new Promise((resolve, reject) => {
                try {
                    const breakdownForChart = sdltPrepareBreakdownForChart(calc);
                    if (!breakdownForChart || breakdownForChart.length === 0) {
                        resolve({ html: '<div style="text-align:center;color:#6b7280;">No breakdown data available</div>', containerHeight: '450px' });
                        return;
                    }

                    // ‚úÖ Rental Income Tax - use annualRentalIncome or netIncome instead of propertyValue
                    const propertyValue = sdltSanitizeNumeric(calc.annualRentalIncome || calc.netIncome || calc.propertyValue || 0);
                    const labels = sdltBuildChartLabels(calc, breakdownForChart);
                    const taxableAmounts = breakdownForChart.map(row => sdltSanitizeNumeric(row.amount));
                    const taxAmounts = breakdownForChart.map(row => sdltSanitizeNumeric(row.tax));
                    const rates = breakdownForChart.map(row => sdltSanitizeRate(row.rate));
                    
                    // Check if comparison mode is enabled and we have comparison calculation
                    let comparisonData = null;
                    if (state.comparisonMode && state.comparisonCalculation && state.comparisonCalculation.breakdown) {
                        // Prepare breakdown first (handles both object and array formats)
                        const comparisonBreakdown = sdltPrepareBreakdownForChart(state.comparisonCalculation);
                        
                        // Only create comparison data if we have valid breakdown data
                        if (comparisonBreakdown && comparisonBreakdown.length > 0) {
                            comparisonData = {
                                taxYear: state.comparisonCalculation.taxYear,
                                breakdown: comparisonBreakdown,
                                labels: sdltBuildChartLabels(state.comparisonCalculation, comparisonBreakdown),
                                taxableAmounts: comparisonBreakdown.map(row => sdltSanitizeNumeric(row.amount)),
                                taxAmounts: comparisonBreakdown.map(row => sdltSanitizeNumeric(row.tax)),
                                rates: comparisonBreakdown.map(row => sdltSanitizeRate(row.rate))
                            };
                            console.log('üìä Comparison data prepared for chart', {
                                comparisonTaxYear: comparisonData.taxYear,
                                mainTaxYear: calc.taxYear,
                                comparisonBreakdownLength: comparisonData.breakdown.length,
                                mainBreakdownLength: breakdownForChart.length
                            });
                        } else {
                            console.warn('‚ö†Ô∏è Comparison calculation exists but breakdown is empty or invalid', {
                                hasBreakdown: !!state.comparisonCalculation.breakdown,
                                breakdownType: typeof state.comparisonCalculation.breakdown,
                                isArray: Array.isArray(state.comparisonCalculation.breakdown),
                                preparedLength: comparisonBreakdown?.length || 0
                            });
                        }
                    }
                    
                    const config = sdltBuildChartConfigObject(
                        chartType || 'bar',
                        labels,
                        taxableAmounts,
                        taxAmounts,
                        rates,
                        propertyValue,
                        calc.taxYear,
                        comparisonData // Pass comparison data
                    );

                    // Special handling for pie and donut charts with comparison - create two side-by-side charts
                    const isPieOrDonut = (chartType === 'pie' || chartType === 'doughnut');
                    const needsSideBySide = isPieOrDonut && comparisonData && comparisonData.taxAmounts && comparisonData.taxAmounts.length > 0;
                    
                    // Calculate container height: increase if comparison mode with side-by-side charts
                    // For mobile, we stack vertically, so need more height
                    const isMobileView = window.innerWidth <= 768;
                    const comparisonContainerHeight = needsSideBySide ? (isMobileView ? '750px' : '450px') : '450px'; // More height for mobile stacked charts
                    
                    if (needsSideBySide) {
                        // Create two separate pie/donut charts side by side
                        const mainChartId = `sdltChart-main-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
                        const compChartId = `sdltChart-comp-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
                        
                        // Main chart config
                        const mainChartConfig = {
                            type: chartType,
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: `Tax ${formatTaxYearLabel(calc.taxYear) || 'Main'}`,
                                    data: taxAmounts,
                                    backgroundColor: sdltGetColorPalette(labels.length).solid,
                                    borderColor: '#ffffff',
                                    borderWidth: 2,
                                    hoverOffset: chartType === 'doughnut' ? 6 : 0
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'bottom',
                                        labels: { color: '#111827', font: { size: 12 } }
                                    },
                                    title: {
                                        display: true,
                                        text: `Tax ${formatTaxYearLabel(calc.taxYear) || 'Main'}`,
                                        color: '#111827',
                                        font: { size: 14, weight: 'bold' }
                                    }
                                }
                            }
                        };
                        
                        // Comparison chart config
                        const compChartConfig = {
                            type: chartType,
                            data: {
                                labels: comparisonData.labels || labels,
                                datasets: [{
                                    label: `Tax ${formatTaxYearLabel(comparisonData.taxYear) || 'Comparison'}`,
                                    data: comparisonData.taxAmounts,
                                    backgroundColor: sdltGetColorPalette((comparisonData.labels || labels).length).solid,
                                    borderColor: '#ffffff',
                                    borderWidth: 2,
                                    hoverOffset: chartType === 'doughnut' ? 6 : 0
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'bottom',
                                        labels: { color: '#111827', font: { size: 12 } }
                                    },
                                    title: {
                                        display: true,
                                        text: `Tax ${formatTaxYearLabel(comparisonData.taxYear) || 'Comparison'}`,
                                        color: '#111827',
                                        font: { size: 14, weight: 'bold' }
                                    }
                                }
                            }
                        };
                        
                        const mainConfigJSON = JSON.stringify(mainChartConfig);
                        const compConfigJSON = JSON.stringify(compChartConfig);
                        
                        const html = `
                            <div class="income-tax-comparison-charts-container" style="display: flex; gap: 20px; width: 100%; height: 430px; justify-content: center; align-items: center;">
                                <div class="income-tax-comparison-chart-item" style="flex: 1; max-width: 50%; width: 50%; height: 100%; min-height: 350px; position: relative; box-sizing: border-box;">
                                    <canvas id="${mainChartId}" style="display: block; width: 100%; height: 100%;"></canvas>
                                </div>
                                <div class="income-tax-comparison-chart-item" style="flex: 1; max-width: 50%; width: 50%; height: 100%; min-height: 350px; position: relative; box-sizing: border-box;">
                                    <canvas id="${compChartId}" style="display: block; width: 100%; height: 100%;"></canvas>
                                </div>
                            </div>
                            <script>
                                (function() {
                                    window.sdltChartInstances = window.sdltChartInstances || {};
                                    
                                    function initMainChart() {
                                        const canvas = document.getElementById('${mainChartId}');
                                        if (!canvas) return;
                                        if (typeof Chart === 'undefined') {
                                            setTimeout(initMainChart, 100);
                                            return;
                                        }
                                        if (window.sdltChartInstances['${mainChartId}']) {
                                            window.sdltChartInstances['${mainChartId}'].destroy();
                                        }
                                        const ctx = canvas.getContext('2d');
                                        const config = ${mainConfigJSON};
                                        window.sdltChartInstances['${mainChartId}'] = new Chart(ctx, config);
                                    }
                                    
                                    function initCompChart() {
                                        const canvas = document.getElementById('${compChartId}');
                                        if (!canvas) return;
                                        if (typeof Chart === 'undefined') {
                                            setTimeout(initCompChart, 100);
                                            return;
                                        }
                                        if (window.sdltChartInstances['${compChartId}']) {
                                            window.sdltChartInstances['${compChartId}'].destroy();
                                        }
                                        const ctx = canvas.getContext('2d');
                                        const config = ${compConfigJSON};
                                        window.sdltChartInstances['${compChartId}'] = new Chart(ctx, config);
                                    }
                                    
                                    // Initialize charts with a small delay to ensure DOM is ready
                                    function initializeBothCharts() {
                                        if (typeof Chart === 'undefined') {
                                            let attempts = 0;
                                            const checkInterval = setInterval(() => {
                                                attempts++;
                                                if (typeof Chart !== 'undefined') {
                                                    clearInterval(checkInterval);
                                                    setTimeout(() => {
                                                        initMainChart();
                                                        initCompChart();
                                                    }, 50);
                                                } else if (attempts > 50) {
                                                    clearInterval(checkInterval);
                                                }
                                            }, 100);
                                        } else {
                                            // Small delay to ensure canvas elements are in DOM
                                            setTimeout(() => {
                                                initMainChart();
                                                initCompChart();
                                            }, 50);
                                        }
                                    }
                                    
                                    // Use requestAnimationFrame for better mobile compatibility
                                    if (window.requestAnimationFrame) {
                                        requestAnimationFrame(() => {
                                            initializeBothCharts();
                                        });
                                    } else {
                                        initializeBothCharts();
                                    }
                                })();
                        <\/script>
                        `;
                        
                        resolve({ html: html, containerHeight: comparisonContainerHeight });
                        return;
                    }

                    const chartId = `sdltChart-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
                    const configJSON = JSON.stringify(config);
                    
                    // Use larger height for radar charts to reduce empty space
                    const wrapperHeight = chartType === 'radar' ? '500px' : '400px';
                    const wrapperMinHeight = chartType === 'radar' ? '500px' : '400px';
                    
                    // Calculate container height: only increase for pie/donut charts with comparison (they show two separate charts)
                    // Bar/line charts show both datasets in one chart, so they don't need extra height
                    const hasComparison = comparisonData && comparisonData.taxAmounts && comparisonData.taxAmounts.length > 0;
                    const isPieOrDonutForHeight = (chartType === 'pie' || chartType === 'doughnut');
                    const needsExtraHeight = isPieOrDonutForHeight && hasComparison;
                    const isMobileViewport = window.innerWidth <= 768;
                    const singleChartContainerHeight = needsExtraHeight ? (isMobileViewport ? '750px' : '450px') : '450px';
                    
                    const html = `
                        <div class="income-tax-chart-wrapper" style="position: relative; height: ${wrapperHeight}; min-height: ${wrapperMinHeight}; width: 100%; max-width: 100%; overflow: hidden;">
                            <canvas id="${chartId}"></canvas>
                        </div>
                        <script>
                            (function() {
                                window.sdltChartInstances = window.sdltChartInstances || {};
                                if (window.sdltChartInstances['${chartId}']) {
                                    window.sdltChartInstances['${chartId}'].destroy();
                                }
                                
                                function initChart() {
                                    const canvas = document.getElementById('${chartId}');
                                    if (!canvas) {
                                        console.error('Canvas element not found');
                                        return;
                                    }
                                    
                                    if (typeof Chart === 'undefined') {
                                        console.error('Chart.js not loaded');
                                        canvas.parentElement.innerHTML = '<div style="padding: 20px; text-align: center; color: #ef4444;">Chart.js library not loaded. Please refresh the page.</div>';
                                        return;
                                    }
                                    
                                    try {
                                        const ctx = canvas.getContext('2d');
                                        const config = ${configJSON};
                                        window.sdltChartInstances['${chartId}'] = new Chart(ctx, config);
                                    } catch (error) {
                                        console.error('Error creating chart:', error);
                                        canvas.parentElement.innerHTML = '<div style="padding: 20px; text-align: center; color: #ef4444;">Error rendering chart: ' + (error.message || 'Unknown error') + '</div>';
                                    }
                                }
                                
                                if (typeof Chart !== 'undefined') {
                                    initChart();
                                } else {
                                    let attempts = 0;
                                    const checkInterval = setInterval(() => {
                                        attempts++;
                                        if (typeof Chart !== 'undefined') {
                                            clearInterval(checkInterval);
                                            initChart();
                                        } else if (attempts > 50) {
                                            clearInterval(checkInterval);
                                            console.error('Chart.js failed to load after 5 seconds');
                                        }
                                    }, 100);
                                }
                            })();
                        <\/script>
                    `;
                    
                    resolve({ html: html, containerHeight: singleChartContainerHeight });
                } catch (error) {
                    reject(error);
                }
            });
        }

        function sdltPrepareBreakdownForChart(calc) {
            let breakdown = [];
            
            // Handle income tax breakdown (object format)
            if (calc.breakdownObject && typeof calc.breakdownObject === 'object' && !Array.isArray(calc.breakdownObject)) {
                // Use the pre-converted array if available
                if (Array.isArray(calc.breakdown)) {
                    breakdown = calc.breakdown.map(row => ({ ...row }));
                } else if (calc.tables) {
                    // Build from tables
                    const allBands = [];
                    if (calc.tables.nonSavingIncomeTax) allBands.push(...calc.tables.nonSavingIncomeTax);
                    if (calc.tables.propertyIncomeTax) allBands.push(...calc.tables.propertyIncomeTax);
                    if (calc.tables.savingsIncomeTax) allBands.push(...calc.tables.savingsIncomeTax.filter(b => b.rate > 0));
                    if (calc.tables.dividendIncomeTax) allBands.push(...calc.tables.dividendIncomeTax.filter(b => b.rate > 0));
                    breakdown = allBands.map(band => ({
                        band: band.band || 'Tax',
                        rate: (band.rate || 0) * 100,
                        amount: band.amount || 0,
                        tax: band.tax || 0
                    }));
                }
            } else if (Array.isArray(calc.breakdown)) {
                breakdown = calc.breakdown.map(row => ({ ...row }));
            }
            
            // ‚úÖ Rental Income Tax uses band names (Basic Rate, Higher Rate, Additional Rate)
            // Check if this is rental income tax breakdown by looking for band names
            const isRentalIncomeTax = breakdown.length > 0 && 
                breakdown.some(row => typeof row.band === 'string' && 
                    (row.band.includes('Basic Rate') || row.band.includes('Higher Rate') || row.band.includes('Additional Rate')));
            
            if (isRentalIncomeTax) {
                // ‚úÖ For rental income tax, normalise to always have Basic / Higher / Additional in fixed order
                const orderedBands = ['Basic Rate', 'Higher Rate', 'Additional Rate'];
                
                const normalised = orderedBands.map(name => {
                    // Find existing row for this band (if any)
                    const existing = breakdown.find(row => 
                        typeof row.band === 'string' && row.band.toLowerCase().includes(name.toLowerCase().split(' ')[0])
                    );
                    
                    if (existing) {
                        return {
                            band: name,
                            rate: existing.rate ?? existing.ratePercent ?? 0,
                            amount: sdltSanitizeNumeric(existing.amount),
                            tax: sdltSanitizeNumeric(existing.tax)
                        };
                    }
                    
                    // If backend did not return this band (e.g. no tax due in that band),
                    // include it with zero amounts so charts (especially radar) still
                    // render all three axes consistently.
                    return {
                        band: name,
                        rate: 0,
                        amount: 0,
                        tax: 0
                    };
                });
                
                return normalised;
            }
            
            // income-tax-specific logic (numeric bands)
            const hasAboveMax = breakdown.some(row => row.band === 'Above Max');
            if (!hasAboveMax && breakdown.length > 0) {
                const numericBands = breakdown
                    .map(row => (typeof row.band === 'number' ? row.band : null))
                    .filter(value => value !== null)
                        .sort((a, b) => a - b);

                    const lastThreshold = numericBands.length > 0 ? numericBands[numericBands.length - 1] : 0;
                const propertyValue = sdltSanitizeNumeric(calc.propertyValue || calc.annualRentalIncome || calc.netIncome);
                const remainingAmount = propertyValue > lastThreshold ? propertyValue - lastThreshold : 0;
                    
                    if (remainingAmount > 0) {
                    const totalBreakdownTax = breakdown.reduce((sum, row) => sum + sdltSanitizeNumeric(row.tax), 0);
                    const totalTax = sdltSanitizeNumeric(calc.totalTax || calc.totalTaxLiability);
                    const remainingTax = totalTax - totalBreakdownTax;
                    const lastEntry = breakdown[breakdown.length - 1] || {};
                    const lastRate = sdltSanitizeRate(lastEntry.rate);
                        const calculatedRate = remainingAmount > 0 && remainingTax > 0 
                            ? (remainingTax / remainingAmount) * 100 
                            : lastRate;
                        const rateToUse = calculatedRate > 0 && calculatedRate <= 100 ? calculatedRate : lastRate;
                        
                    breakdown = [
                        ...breakdown,
                        {
                            band: 'Above Max',
                            rate: rateToUse,
                            amount: remainingAmount,
                            tax: remainingTax > 0 ? remainingTax : (remainingAmount * rateToUse) / 100
                        }
                    ];
                    }
                }
                
            return breakdown;
        }

        function sdltSanitizeNumeric(value) {
            if (typeof value === 'number' && isFinite(value)) {
                return value;
            }
            if (typeof value === 'string') {
                const cleaned = value.replace(/[^0-9.-]/g, '');
                const parsed = parseFloat(cleaned);
                return isNaN(parsed) ? 0 : parsed;
            }
            return 0;
        }

        function sdltSanitizeRate(value) {
            if (typeof value === 'number' && isFinite(value)) {
                return value;
            }
            if (typeof value === 'string') {
                const cleaned = value.replace('%', '').replace(/[^0-9.-]/g, '');
                const parsed = parseFloat(cleaned);
                return isNaN(parsed) ? 0 : parsed;
            }
            return 0;
        }

        function sdltBuildChartLabels(calc, breakdown) {
            if (!Array.isArray(breakdown) || breakdown.length === 0) {
                return [];
            }

            // Mirror the backend label logic so bands + percentages match
            const numericBands = breakdown
                .filter(row => typeof row.band === 'number')
                .map(row => row.band)
                .sort((a, b) => a - b);

            const highestBand = numericBands.length > 0 ? numericBands[numericBands.length - 1] : null;
            const secondHighestBand = numericBands.length > 1 ? numericBands[numericBands.length - 2] : null;

            let previousThreshold = 0;

            return breakdown.map((row, index) => {
                if (typeof row.band === 'number') {
                    const currentThreshold = row.band;
                    const currentIndexInSorted = numericBands.indexOf(currentThreshold);
                    const hasNextHigherThreshold =
                        currentIndexInSorted >= 0 && currentIndexInSorted < numericBands.length - 1;

                    const rate = row.rate !== undefined && row.rate !== null ? row.rate : null;
                    const rateDisplay = rate !== null ? ` @ ${rate}%` : '';

                    // Treat very large max thresholds as sentinel "no upper limit"
                    if (
                        highestBand !== null &&
                        row.band === highestBand &&
                        row.band > 1e12 &&
                        secondHighestBand !== null
                    ) {
                        const label = `Above ¬£${secondHighestBand.toLocaleString()}${rateDisplay}`;
                        previousThreshold = currentThreshold;
                        return label;
                    }

                    let label;
                    if (hasNextHigherThreshold) {
                        label = previousThreshold === 0
                            ? `0 - ¬£${currentThreshold.toLocaleString()}${rateDisplay}`
                            : `¬£${previousThreshold.toLocaleString()} - ¬£${currentThreshold.toLocaleString()}${rateDisplay}`;
                    } else {
                        label = previousThreshold === 0
                            ? `0 - ¬£${currentThreshold.toLocaleString()}${rateDisplay}`
                            : `¬£${previousThreshold.toLocaleString()} - ¬£${currentThreshold.toLocaleString()}${rateDisplay}`;
                    }

                    previousThreshold = currentThreshold;
                    return label;
                    }

                if (row.band === 'Above Max') {
                    const rate = row.rate !== undefined && row.rate !== null ? row.rate : null;
                    const rateDisplay = rate !== null ? ` @ ${rate}%` : '';
                    return highestBand
                        ? `Above ¬£${highestBand.toLocaleString()}${rateDisplay}`
                        : `Above${rateDisplay}`;
                }

                if (typeof row.band === 'string' && row.band.trim().length > 0) {
                    return row.band.replace(/&ndash;/g, '‚Äì');
                }

                return `Band ${index + 1}`;
            });
        }

        function sdltGetColorPalette(count) {
            const base = [
                '124, 58, 237',
                '99, 102, 241',
                '59, 130, 246',
                '14, 165, 233',
                '16, 185, 129',
                '34, 197, 94',
                '249, 115, 22',
                '234, 179, 8',
                '239, 68, 68',
                '236, 72, 153',
                '59, 130, 246',
                '139, 92, 246'
            ];

            const solid = [];
            const faded = [];
            const border = [];

            for (let i = 0; i < Math.max(count, 1); i++) {
                const rgb = base[i % base.length];
                solid.push(`rgba(${rgb}, 0.9)`);
                faded.push(`rgba(${rgb}, 0.35)`);
                border.push(`rgba(${rgb}, 1)`);
        }
        
            return { solid, faded, border };
        }

        function sdltBuildChartConfigObject(chartType, labels, taxableAmounts, taxAmounts, rates, propertyValue, mainTaxYear = null, comparisonData = null) {
            const normalizedType = chartType || 'bar';
            const colors = sdltGetColorPalette(labels.length);
            const hasComparison = comparisonData && comparisonData.taxAmounts && comparisonData.taxAmounts.length > 0;

            const cartesianLegend = {
                position: 'top',
                labels: {
                    color: '#111827',
                    font: { size: 12, family: 'Inter, \"Segoe UI\", sans-serif' }
                }
            };

            const baseOptions = {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 600,
                    easing: 'easeOutQuart'
                },
                plugins: {
                    legend: cartesianLegend,
                    tooltip: {
                        backgroundColor: 'rgba(15, 23, 42, 0.9)',
                        titleColor: '#ffffff',
                        bodyColor: '#f8fafc'
                    }
                }
            };

            const singleAxis = title => ({
                beginAtZero: true,
                type: 'linear',
                ticks: {
                    color: '#111827'
                },
                grid: {
                    color: 'rgba(148, 163, 184, 0.25)'
                },
                title: {
                    display: true,
                    text: title,
                    color: '#111827',
                    font: { size: 12 }
                }
            });

            // Format tax year label (e.g., "2025" -> "2025/2026")
            const formatTaxYearLabel = (year) => {
                if (!year) return '';
                const yearNum = parseInt(year);
                if (isNaN(yearNum)) return year;
                return `${yearNum}/${yearNum + 1}`;
            };

            // Create main dataset
            const mainTaxYearLabel = formatTaxYearLabel(mainTaxYear) || 'Main';
            const taxDataset = {
                label: hasComparison ? `Tax ${mainTaxYearLabel}` : 'Tax by Band (¬£)',
                data: taxAmounts,
                backgroundColor: hasComparison ? 'rgba(79, 70, 229, 0.7)' : colors.solid,
                borderColor: hasComparison ? '#4f46e5' : colors.border,
                borderWidth: 2,
                borderRadius: 6,
                tension: 0.35,
                fill: false
            };
            
            // Create comparison dataset if comparison data exists
            let comparisonDataset = null;
            if (hasComparison) {
                const comparisonTaxYearLabel = formatTaxYearLabel(comparisonData.taxYear) || 'Comparison';
                
                // Map comparison tax amounts to match main labels by band name
                // This ensures both datasets use the same band structure
                const comparisonTaxAmounts = labels.map((label, index) => {
                    // Try to find matching band in comparison breakdown
                    // For rental income tax, bands are named (e.g., "Basic Rate", "Higher Rate")
                    const mainBand = taxableAmounts[index] !== undefined ? labels[index] : null;
                    
                    // Find the matching band in comparison breakdown
                    if (comparisonData.breakdown && comparisonData.breakdown.length > 0) {
                        // Try to match by index first (same order)
                        if (index < comparisonData.taxAmounts.length) {
                            return comparisonData.taxAmounts[index];
                        }
                        
                        // If index doesn't match, try to find by band name
                        // Extract band name from label if possible
                        const comparisonBreakdown = comparisonData.breakdown;
                        if (comparisonBreakdown[index]) {
                            return sdltSanitizeNumeric(comparisonBreakdown[index].tax);
                        }
                    }
                    
                    return 0;
                });
                
                comparisonDataset = {
                    label: `Tax ${comparisonTaxYearLabel}`,
                    data: comparisonTaxAmounts.length > 0 ? comparisonTaxAmounts : comparisonData.taxAmounts,
                    backgroundColor: 'rgba(236, 72, 153, 0.7)', // Pink color for comparison
                    borderColor: '#ec4899',
                    borderWidth: 2,
                    borderRadius: 6,
                    tension: 0.35,
                    fill: false
                };
            }

            const config = {
                type: 'bar',
                data: {
                    labels,
                    datasets: []
                },
                options: { ...baseOptions }
            };

            // Helper function to build datasets with comparison support
            const buildDatasets = (baseDataset, comparisonDatasetOverride = null) => {
                const datasets = [];
                
                // Add main dataset
                datasets.push(baseDataset);
                
                // Add comparison dataset if available
                if (hasComparison && comparisonDataset) {
                    const compDataset = comparisonDatasetOverride || comparisonDataset;
                    datasets.push(compDataset);
                }
                
                return datasets;
            };

            switch (normalizedType) {
                case 'horizontalBar':
                    config.type = 'bar';
                    config.data.datasets = buildDatasets({ ...taxDataset });
                    config.options.indexAxis = 'y';
                    config.options.scales = {
                        x: singleAxis('Tax Amount (¬£)'),
                        y: {
                            ticks: { color: '#111827' },
                            grid: { color: 'rgba(148, 163, 184, 0.15)' }
                        }
                    };
                    break;
                case 'line':
                    config.type = 'line';
                    config.data.datasets = buildDatasets(
                        {
                            ...taxDataset,
                            borderWidth: 3,
                            backgroundColor: 'rgba(79, 70, 229, 0.15)',
                            fill: true,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            pointBackgroundColor: '#4f46e5',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2
                        },
                        hasComparison ? {
                            ...comparisonDataset,
                            borderWidth: 3,
                            backgroundColor: 'rgba(236, 72, 153, 0.15)',
                            fill: true,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            pointBackgroundColor: '#ec4899',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2
                        } : null
                    );
                    config.options.scales = {
                        y: singleAxis('Tax Amount (¬£)')
                    };
                    config.options.elements = {
                        line: {
                            tension: 0.4,
                            borderJoinStyle: 'round',
                            borderCapStyle: 'round'
                        }
                    };
                    config.options.plugins = {
                        ...config.options.plugins,
                        filler: {
                            propagate: false
                        }
                    };
                    break;
                case 'area':
                    config.type = 'line';
                    config.data.datasets = buildDatasets(
                        {
                            ...taxDataset,
                            borderWidth: 3,
                            backgroundColor: 'rgba(79, 70, 229, 0.25)',
                            fill: true,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            pointBackgroundColor: '#4f46e5',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            tension: 0.4
                        },
                        hasComparison ? {
                            ...comparisonDataset,
                            borderWidth: 3,
                            backgroundColor: 'rgba(236, 72, 153, 0.25)',
                            fill: true,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            pointBackgroundColor: '#ec4899',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            tension: 0.4
                        } : null
                    );
                    config.options.scales = {
                        y: singleAxis('Tax Amount (¬£)')
                    };
                    config.options.elements = {
                        line: {
                            tension: 0.4,
                            borderJoinStyle: 'round',
                            borderCapStyle: 'round'
                        }
                    };
                    config.options.plugins = {
                        ...config.options.plugins,
                        filler: {
                            propagate: false
                        }
                    };
                    break;
                case 'pie':
                    config.type = 'pie';
                    // Pie charts with comparison are handled separately in generateChartHTML with side-by-side charts
                    config.data.datasets = [
                        {
                            label: 'Tax by Band (¬£)',
                            data: taxAmounts,
                            backgroundColor: colors.solid,
                            borderColor: '#ffffff',
                            borderWidth: 2
                        }
                    ];
                    break;
                case 'doughnut':
                    config.type = 'doughnut';
                    // Donut charts with comparison are handled separately in generateChartHTML with side-by-side charts
                    config.data.datasets = [
                        {
                            label: 'Tax by Band (¬£)',
                            data: taxAmounts,
                            backgroundColor: colors.solid,
                            borderColor: '#ffffff',
                            borderWidth: 2,
                            hoverOffset: 6
                        }
                    ];
                    break;
                case 'polarArea':
                    config.type = 'polarArea';
                    config.data.datasets = [
                        {
                            label: 'Tax by Band (¬£)',
                            data: taxAmounts,
                            backgroundColor: colors.solid,
                            borderColor: colors.border,
                            borderWidth: 1.5
                        }
                    ];
                    // Polar area charts don't support comparison well - prevent comparison mode
                    if (hasComparison) {
                        console.warn('Polar area charts do not support comparison mode. Showing main calculation only.');
                    }
                    break;
                case 'radar':
                    // Match SDLT radar behaviour but with rental labels and optional comparison dataset
                    config.type = 'radar';

                    // Build main + comparison datasets using existing helper
                    config.data.datasets = buildDatasets(
                        {
                            ...taxDataset,
                            backgroundColor: 'rgba(79, 70, 229, 0.2)',
                            borderColor: '#4f46e5',
                            pointBackgroundColor: '#4f46e5',
                            pointBorderColor: '#ffffff',
                            fill: true
                        },
                        hasComparison ? {
                            ...comparisonDataset,
                            backgroundColor: 'rgba(236, 72, 153, 0.2)',
                            borderColor: '#ec4899',
                            pointBackgroundColor: '#ec4899',
                            pointBorderColor: '#ffffff',
                            fill: true
                        } : null
                    );

                    // Use a simple radial scale configuration like SDLT
                    config.options.scales = {
                        r: {
                            angleLines: { color: 'rgba(148, 163, 184, 0.3)' },
                            grid: { color: 'rgba(148, 163, 184, 0.3)' },
                            ticks: { beginAtZero: true, color: '#6b7280' },
                            pointLabels: { 
                                color: '#111827', 
                                font: { size: 11 },
                                padding: 8
                            }
                        }
                    };

                    // Slightly reduce padding and keep legend at top (same as SDLT)
                    config.options.layout = {
                        padding: {
                            top: 10,
                            bottom: 10,
                            left: 10,
                            right: 10
                        }
                    };
                    config.options.plugins.legend = {
                        ...cartesianLegend,
                        position: 'top'
                    };
                    break;
                case 'bubble': {
                    const total = propertyValue > 0 ? propertyValue : taxableAmounts.reduce((sum, val) => sum + val, 0);
                    const bubbleData = labels.map((label, index) => {
                        const amount = taxableAmounts[index] || 0;
                        const tax = taxAmounts[index] || 0;
                        const rate = rates[index] || 0;
                        const portion = total > 0 ? amount / total : 0;
                        const derivedRadius = rate > 0 ? rate * 0.6 : portion * 40;
                        const radius = Math.max(6, Math.min(25, derivedRadius));
                        return {
                            x: index,
                            y: tax,
                            r: Math.round(radius * 10) / 10,
                            label: label,
                            amount: amount,
                            rate: rate
                        };
                    });

                    const bubbleDatasets = [
                            {
                            label: hasComparison ? `Tax ${mainTaxYearLabel}` : 'Tax by Band (¬£)',
                                data: bubbleData,
                                backgroundColor: colors.solid.map(color => color.replace('0.9', '0.6')),
                                borderColor: colors.border,
                                borderWidth: 1.5
                            }
                    ];
                    
                    // Add comparison dataset if available
                    if (hasComparison && comparisonData && comparisonData.taxAmounts && comparisonData.taxAmounts.length > 0) {
                        const comparisonTotal = comparisonData.taxableAmounts ? 
                            comparisonData.taxableAmounts.reduce((sum, val) => sum + val, 0) : total;
                        // Use main labels to ensure proper alignment between datasets
                        const comparisonBubbleData = labels.map((label, index) => {
                            // Map comparison data to match main labels
                            const amount = index < (comparisonData.taxableAmounts || []).length ? 
                                (comparisonData.taxableAmounts || [])[index] : 0;
                            const tax = index < comparisonData.taxAmounts.length ? 
                                comparisonData.taxAmounts[index] : 0;
                            const rate = index < (comparisonData.rates || []).length ? 
                                (comparisonData.rates || [])[index] : 0;
                            const portion = comparisonTotal > 0 ? amount / comparisonTotal : 0;
                            const derivedRadius = rate > 0 ? rate * 0.6 : portion * 40;
                            const radius = Math.max(6, Math.min(25, derivedRadius));
                            return {
                                x: index + 0.3, // Offset slightly to show both datasets
                                y: tax,
                                r: Math.round(radius * 10) / 10,
                                label: label,
                                amount: amount,
                                rate: rate
                            };
                        });
                        
                        bubbleDatasets.push({
                            label: `Tax ${formatTaxYearLabel(comparisonData.taxYear)}`,
                            data: comparisonBubbleData,
                            backgroundColor: colors.solid.map(color => color.replace('0.9', '0.4')),
                            borderColor: '#ec4899',
                            borderWidth: 1.5
                        });
                    }

                    config.type = 'bubble';
                    config.data = {
                        datasets: bubbleDatasets
                    };
                    // Store labels in a way accessible to the callback
                    const bubbleLabels = labels;
                    config.options.scales = {
                        x: {
                            beginAtZero: true,
                            type: 'linear',
                            ticks: {
                                stepSize: 1,
                                autoSkip: false,
                                maxRotation: 45,
                                minRotation: 0,
                                precision: 0,
                                callback: function(value, index, ticks) {
                                    const idx = Math.round(value);
                                    if (idx >= 0 && idx < bubbleLabels.length) {
                                        const label = bubbleLabels[idx];
                                        if (!label) return '';
                                        // Truncate very long labels for x-axis
                                        if (label.length > 25) {
                                            return label.substring(0, 22) + '...';
                                        }
                                        return label;
                                    }
                                    return '';
                                },
                                color: '#111827',
                                font: {
                                    size: 11
                                }
                            },
                            grid: {
                                color: 'rgba(148, 163, 184, 0.15)',
                                drawOnChartArea: true
                            },
                            title: {
                                display: false
                            }
                        },
                        y: singleAxis('Tax Amount (¬£)')
                    };
                    // Enhanced tooltip for bubble chart to show band information
                    config.options.plugins.tooltip = {
                        ...baseOptions.plugins.tooltip,
                        callbacks: {
                            title: function(context) {
                                const dataPoint = context[0].raw;
                                return dataPoint.label || `Band ${context[0].dataIndex + 1}`;
                            },
                            label: function(context) {
                                const dataPoint = context.raw;
                                const tax = dataPoint.y;
                                const amount = dataPoint.amount || 0;
                                const rate = dataPoint.rate || 0;
                                return [
                                    `Tax: ¬£${tax.toLocaleString()}`,
                                    `Taxable Amount: ¬£${amount.toLocaleString()}`,
                                    `Rate: ${rate}%`
                                ];
                            }
                        }
                    };
                    break;
                }
                default:
                    config.type = 'bar';
                    config.data.datasets = buildDatasets({ ...taxDataset });
                    config.options.scales = {
                        y: singleAxis('Tax Amount (¬£)')
                    };
                    break;
            }

            return config;
        }

        function updateDisplay() {
                // If calculating, show loading state and return early
                if (state.isCalculating) {
                    console.log('‚è∏Ô∏è updateDisplay() skipped - isCalculating is true');
                    showHowWeCalculatedLoading();
                    return;
                }
                
            const calc = state.currentCalculation;
            if (!calc) {
                console.log('‚è∏Ô∏è updateDisplay() skipped - no currentCalculation');
                return;
            }

            console.log('üîÑ updateDisplay() called with calc:', {
                totalTax: calc.totalTax,
                breakdown: calc.breakdown,
                breakdownObject: calc.breakdownObject
            });

            // ‚úÖ Rental Income Tax uses 'totalTax', not 'totalTaxLiability'
            const totalTax = Math.round(calc.totalTax || 0);

                // Update AI mode results (Overview tab) - IMMEDIATE (no delays)
                // Batch DOM updates for better performance
            const taxResultEl = document.getElementById('income-tax-taxResult');
            const propertyValueResultEl = document.getElementById('income-tax-propertyValueResult');
            const calculatorTypeResultEl = document.getElementById('income-tax-calculatorTypeResult');
            const taxYearResultEl = document.getElementById('income-tax-taxYearResult');
            
                // Update all critical values immediately
            if (taxResultEl) taxResultEl.textContent = '¬£' + (totalTax || 0).toLocaleString('en-GB');
            // ‚úÖ Display Income Tax Breakdown in AI mode overview
            const breakdownObj = calc.breakdownObject || calc.breakdown || {};
            let nonSavingTax = 0;
            let propertyTax = 0;
            let savingsTax = 0;
            let dividendTax = 0;
            
            if (typeof breakdownObj === 'object' && !Array.isArray(breakdownObj)) {
                nonSavingTax = breakdownObj.nonSavingIncomeTax || 0;
                propertyTax = breakdownObj.propertyIncomeTax || 0;
                savingsTax = breakdownObj.savingsIncomeTax || 0;
                dividendTax = breakdownObj.dividendIncomeTax || 0;
            } else if (Array.isArray(calc.breakdown)) {
                calc.breakdown.forEach(row => {
                    const band = row.band || '';
                    const tax = row.tax || 0;
                    if (band.includes('Non-Saving')) nonSavingTax += tax;
                    else if (band.includes('Property')) propertyTax += tax;
                    else if (band.includes('Savings')) savingsTax += tax;
                    else if (band.includes('Dividend')) dividendTax += tax;
                });
            }
            
            const nonSavingTaxResultEl = document.getElementById('income-tax-nonSavingTaxResult');
            const propertyTaxResultEl = document.getElementById('income-tax-propertyTaxResult');
            const propertyTaxDetailItem = document.getElementById('income-tax-propertyTaxDetailItem');
            const savingsTaxResultEl = document.getElementById('income-tax-savingsTaxResult');
            const dividendTaxResultEl = document.getElementById('income-tax-dividendTaxResult');
            
            if (nonSavingTaxResultEl) {
                nonSavingTaxResultEl.textContent = '¬£' + Math.round(nonSavingTax).toLocaleString('en-GB');
            }
            if (propertyTaxResultEl) {
                propertyTaxResultEl.textContent = '¬£' + Math.round(propertyTax).toLocaleString('en-GB');
            }
            if (propertyTaxDetailItem) {
                propertyTaxDetailItem.style.display = propertyTax > 0 ? 'block' : 'none';
            }
            if (savingsTaxResultEl) {
                savingsTaxResultEl.textContent = '¬£' + Math.round(savingsTax).toLocaleString('en-GB');
            }
            if (dividendTaxResultEl) {
                dividendTaxResultEl.textContent = '¬£' + Math.round(dividendTax).toLocaleString('en-GB');
            }
            if (taxYearResultEl) {
                // ‚úÖ Rental Income Tax uses tax year format like "2024/2025"
                const taxYear = calc.taxYear || '';
                const displayYear = taxYear && taxYear.match(/\d{4}/) ? `${taxYear.match(/\d{4}/)[0]}/${parseInt(taxYear.match(/\d{4}/)[0]) + 1}` : taxYear || '-';
                taxYearResultEl.textContent = 'Tax Year: ' + displayYear;
            }
            
                // Update AI insights if available (Overview tab) - immediate
            if (calc.aiInsights) {
                state.isAIMetricsLoading = false;
                updateAIDisplay(calc.aiInsights);
            } else if (state.aiMode && state.isAIMetricsLoading) {
                renderAIMetricLoader();
            } else if (state.aiMode) {
                updateAIDisplay(null);
            }
                
                // Update calculation description immediately (critical for "How We Calculated" section)
                updateCalculationDescription(calc, totalTax);

            // Restore AI mode card visibility after updating
            if (state.aiMode) {
                const taxCardContent = document.getElementById('income-tax-taxCardContent');
                if (taxCardContent) {
                    taxCardContent.style.opacity = '1';
                    taxCardContent.style.pointerEvents = 'auto';
                }
                
                const aiCardContent = document.getElementById('income-tax-aiCardContent');
                if (aiCardContent) {
                    aiCardContent.style.opacity = '1';
                    aiCardContent.style.pointerEvents = 'auto';
                }
            }

            // Update simple mode results with smooth animations
            const simpleTaxEl = document.getElementById('income-tax-simpleTax');
            const simpleNonSavingTaxEl = document.getElementById('income-tax-simpleNonSavingTax');
            const simplePropertyTaxEl = document.getElementById('income-tax-simplePropertyTax');
            const simpleSavingsTaxEl = document.getElementById('income-tax-simpleSavingsTax');
            const simpleDividendTaxEl = document.getElementById('income-tax-simpleDividendTax');
            const simpleHeroSubtitleEl = document.getElementById('income-tax-simpleHeroSubtitle');
            const simpleResultsGrid = document.getElementById('income-tax-simpleResultsGrid');
            
            // Ensure simple mode results are visible and loader is hidden (in case loader didn't hide properly)
            if (!state.aiMode) {
                const simpleLoader = document.getElementById('income-tax-simpleModeLoader');
                if (simpleLoader) {
                    simpleLoader.classList.remove('active');
                    // Ensure loader is completely hidden - remove all inline styles that might interfere
                    simpleLoader.style.cssText = 'display: none !important; visibility: hidden; opacity: 0; z-index: -1;';
                }
                
                // CRITICAL: Ensure initialization loader stays hidden after calculation
                const initLoader = document.getElementById('income-tax-initLoader');
                if (initLoader && state.isInitialized) {
                    initLoader.classList.add('hidden');
                    initLoader.style.display = 'none';
                    initLoader.style.opacity = '0';
                    initLoader.style.visibility = 'hidden';
                }
                
                if (simpleResultsGrid) {
                    // Ensure results grid is fully visible and interactive - reset opacity and pointer events
                    simpleResultsGrid.style.opacity = '1';
                    simpleResultsGrid.style.pointerEvents = 'auto';
                    simpleResultsGrid.style.display = '';
                    simpleResultsGrid.style.visibility = 'visible';
                    // Remove any inline styles that might be causing issues
                    simpleResultsGrid.style.removeProperty('filter');
                    simpleResultsGrid.style.removeProperty('backdrop-filter');
                }
            }
            
                // Update hero card (main tax amount) - immediate for faster display
            if (simpleTaxEl) {
                    // Update immediately, use CSS transitions for smooth animation
                    simpleTaxEl.textContent = '¬£' + (totalTax || 0).toLocaleString('en-GB');
                    simpleTaxEl.style.transition = 'opacity 0.2s ease, transform 0.2s ease';
                    simpleTaxEl.style.opacity = '1';
                    simpleTaxEl.style.transform = 'scale(1) translateY(0)';
            }

            // Update hero subtitle with context
            if (simpleHeroSubtitleEl) {
                simpleHeroSubtitleEl.textContent = 'Your calculated income tax based on the income details provided.';
            }

            // ‚úÖ Update footer text with income tax details
            const simpleFooterTextEl = document.getElementById('income-tax-simpleFooterText');
            if (simpleFooterTextEl) {
                simpleFooterTextEl.textContent = 'Income Tax Calculator';
            }
            
            // ‚úÖ Update Income Tax Breakdown in simple mode sidebar
            if (simpleNonSavingTaxEl) {
                simpleNonSavingTaxEl.textContent = '¬£' + Math.round(nonSavingTax).toLocaleString('en-GB');
                simpleNonSavingTaxEl.style.transition = 'opacity 0.2s ease, transform 0.2s ease';
                simpleNonSavingTaxEl.style.opacity = '1';
                simpleNonSavingTaxEl.style.transform = 'translateX(0)';
            }
            if (simplePropertyTaxEl) {
                simplePropertyTaxEl.textContent = '¬£' + Math.round(propertyTax).toLocaleString('en-GB');
                simplePropertyTaxEl.style.transition = 'opacity 0.2s ease, transform 0.2s ease';
                simplePropertyTaxEl.style.opacity = '1';
                simplePropertyTaxEl.style.transform = 'translateX(0)';
            }
            if (simpleSavingsTaxEl) {
                simpleSavingsTaxEl.textContent = '¬£' + Math.round(savingsTax).toLocaleString('en-GB');
                simpleSavingsTaxEl.style.transition = 'opacity 0.2s ease, transform 0.2s ease';
                simpleSavingsTaxEl.style.opacity = '1';
                simpleSavingsTaxEl.style.transform = 'translateX(0)';
            }
            if (simpleDividendTaxEl) {
                simpleDividendTaxEl.textContent = '¬£' + Math.round(dividendTax).toLocaleString('en-GB');
                simpleDividendTaxEl.style.transition = 'opacity 0.2s ease, transform 0.2s ease';
                simpleDividendTaxEl.style.opacity = '1';
                simpleDividendTaxEl.style.transform = 'translateX(0)';
            }

            // Update breakdown table (Breakdown tab - always update, even if tab is not visible)
            const breakdownTableEl = document.getElementById('income-tax-breakdownTable');
            if (breakdownTableEl) {
                // If calculating, show loader and clear content
                if (state.isCalculating) {
                    breakdownTableEl.innerHTML = '';
                    const breakdownLoader = document.getElementById('income-tax-breakdownLoader');
                    if (breakdownLoader && state.aiMode) {
                        breakdownLoader.style.display = 'flex';
                    }
                    return; // Don't update table content while calculating
                }
                
                // Clear existing content first
                breakdownTableEl.innerHTML = '';
                
                // Check if comparison mode is enabled
                const comparisonCalc = state.breakdownComparisonCalculation;
                const showComparison = state.breakdownComparisonMode && state.breakdownComparisonTaxYear;
                const hasComparisonData = comparisonCalc && comparisonCalc.breakdown && comparisonCalc.breakdown.length > 0;
                
                // Format tax year label helper
                const formatTaxYearLabel = (year) => {
                    if (!year) return '';
                    const yearNum = parseInt(year);
                    if (isNaN(yearNum)) return year;
                    return `${yearNum}/${yearNum + 1}`;
                };
                
                // Helper function to group breakdown by income type and render with totals
                const renderGroupedBreakdown = (breakdown, showTotals = true, allowanceBreakdown = {}) => {
                    if (!breakdown || breakdown.length === 0) return '';
                    
                    // Group rows by income type
                    const groups = {
                        'Non-Saving': [],
                        'Property': [],
                        'Savings': [],
                        'Dividend': []
                    };
                    
                    let totalIncome = 0;
                    let totalTax = 0;
                    
                    breakdown.forEach(row => {
                        const band = row.band || '';
                        // Exclude Personal Allowance rows from totals
                        if (!row.isPersonalAllowanceRow) {
                            totalIncome += row.amount || 0;
                            totalTax += row.tax || 0;
                        }
                        
                        // Filter out Nil rate bands from Non-Saving category (they don't exist in non-saving income)
                        const isNilRate = (band.toLowerCase().includes('nil') || band.toLowerCase().includes('nil rate')) && !band.toLowerCase().includes('dividend') && !band.toLowerCase().includes('savings');
                        
                        if (band.includes('Non-Saving')) {
                            // Don't add Nil rate bands to Non-Saving category
                            if (!isNilRate) {
                                groups['Non-Saving'].push(row);
                            }
                        } else if (band.includes('Property')) {
                            groups['Property'].push(row);
                        } else if (band.includes('Savings')) {
                            groups['Savings'].push(row);
                        } else if (band.includes('Dividend')) {
                            groups['Dividend'].push(row);
                        }
                    });
                    
                    let html = '';
                    
                    // Render each group with section headers
                    const groupOrder = ['Non-Saving', 'Property', 'Savings', 'Dividend'];
                    groupOrder.forEach(groupName => {
                        const groupRows = groups[groupName];
                        if (groupRows.length === 0) return;
                        
                        // Get allowance amount from allowanceBreakdown for this category
                        let groupAllowance = 0;
                        if (groupName === 'Non-Saving' && allowanceBreakdown.alloForNonSaving) {
                            groupAllowance = allowanceBreakdown.alloForNonSaving;
                        } else if (groupName === 'Property' && allowanceBreakdown.alloForProperty) {
                            groupAllowance = allowanceBreakdown.alloForProperty;
                        } else if (groupName === 'Savings' && allowanceBreakdown.alloForSaving) {
                            groupAllowance = allowanceBreakdown.alloForSaving;
                        } else if (groupName === 'Dividend' && allowanceBreakdown.alloForDividend) {
                            groupAllowance = allowanceBreakdown.alloForDividend;
                        }
                        
                        // If allowance is applied in this group, add a Personal Allowance row at the beginning
                        if (groupAllowance > 0) {
                            groupRows.unshift({
                                band: 'Personal Allowance',
                                amount: groupAllowance,
                                tax: 0,
                                rate: 0,
                                allowanceReduction: 0,
                                isPersonalAllowanceRow: true
                            });
                        }
                        
                        // Sort bands: Input Income first, then Personal Allowance, then Nil/Starting rate, then Basic, Higher, Additional
                        groupRows.sort((a, b) => {
                            // Input Income rows always come first
                            if (a.isInputIncomeRow && !b.isInputIncomeRow) return -1;
                            if (!a.isInputIncomeRow && b.isInputIncomeRow) return 1;
                            // Personal Allowance rows come after Input Income
                            if (a.isPersonalAllowanceRow && !b.isPersonalAllowanceRow) return -1;
                            if (!a.isPersonalAllowanceRow && b.isPersonalAllowanceRow) return 1;
                            
                            const bandA = (a.band || '').toLowerCase();
                            const bandB = (b.band || '').toLowerCase();
                            
                            // Check for Nil or Starting rate (should come first after Personal Allowance)
                            const aIsNil = bandA.includes('nil') || bandA.includes('starting');
                            const bIsNil = bandB.includes('nil') || bandB.includes('starting');
                            
                            if (aIsNil && !bIsNil) return -1;
                            if (!aIsNil && bIsNil) return 1;
                            
                            // If both are Nil/Starting or both are not, sort by: Basic, Higher, Additional
                            const getBandOrder = (band) => {
                                if (band.includes('basic')) return 1;
                                if (band.includes('higher')) return 2;
                                if (band.includes('additional')) return 3;
                                return 4; // Other bands
                            };
                            
                            return getBandOrder(bandA) - getBandOrder(bandB);
                        });
                        
                        // Section header
                        html += `
                            <div style="background-color: #f3f4f6; padding: 12px 16px; margin-top: 16px; margin-bottom: 8px; border-radius: 6px; font-weight: 600; font-size: 14px; color: #374151;">
                                ${groupName === 'Non-Saving' ? 'Non-Saving Income Tax' : 
                                  groupName === 'Property' ? 'Property Income Tax' :
                                  groupName === 'Savings' ? 'Savings Income Tax' :
                                  'Dividend Income Tax'}
                            </div>
                        `;
                        
                        // Group rows
                        let groupIncome = 0;
                        let groupTax = 0;
                        
                        groupRows.forEach(row => {
                            const bandName = row.band || 'N/A';
                            const amount = row.amount || 0;
                            const tax = row.tax || 0;
                            
                            // Skip Personal Allowance and display-only rows from income/tax totals (they're deductions/display-only)
                            if (!row.isPersonalAllowanceRow && !row.isDisplayOnly) {
                                groupIncome += amount;
                                groupTax += tax;
                            }
                        });
                        
                        // If income is fully eliminated by allowance (net income is 0 or less), set subtotal to 0
                        // Calculate net income: total income - allowance applied to this category
                        const netGroupIncome = groupIncome - groupAllowance;
                        if (netGroupIncome <= 0 && groupAllowance > 0) {
                            groupIncome = 0;
                            groupTax = 0;
                        }
                        
                        groupRows.forEach(row => {
                            const bandName = row.band || 'N/A';
                            const amount = row.amount || 0;
                            const tax = row.tax || 0;
                            
                            // Clean band name (remove prefix and keep only Basic, Higher, Additional, Nil, Starting)
                            let cleanBandName = bandName.replace(/^(Non-Saving|Property|Savings|Dividend):\s*/i, '');
                            const bandRate = row.rate || 0;
                            
                            // Extract band name: prioritize Nil/Starting, then Basic, Higher, Additional
                            // All bands should have "Rate" in the name (except Personal Allowance)
                            if (cleanBandName.toLowerCase().includes('nil')) {
                                cleanBandName = 'Nil Rate';
                            } else if (cleanBandName.toLowerCase().includes('starting')) {
                                cleanBandName = 'Starting Rate';
                            } else if (cleanBandName.toLowerCase().includes('basic')) {
                                cleanBandName = 'Basic Rate';
                            } else if (cleanBandName.toLowerCase().includes('higher')) {
                                cleanBandName = 'Higher Rate';
                            } else if (cleanBandName.toLowerCase().includes('additional')) {
                                cleanBandName = 'Additional Rate';
                            } else {
                                // Fallback: use the cleaned name as-is if it doesn't match expected patterns
                                cleanBandName = cleanBandName.trim();
                            }
                            
                            // Add rate percentage to band name for Nil and Starting rate bands (show 0%)
                            let rateLabel = '';
                            if (cleanBandName === 'Nil Rate' || cleanBandName === 'Starting Rate') {
                                rateLabel = ' (0%)';
                            } else if (bandRate > 0) {
                                rateLabel = ` (${Math.round(bandRate)}%)`;
                            }
                            
                            // Display income amount (always show, even if 0)
                            const incomeDisplay = amount !== null && amount !== undefined ? '¬£' + Math.round(amount).toLocaleString('en-GB') : '-';
                            
                            // Display tax amount
                            const taxDisplay = tax !== null && tax !== undefined ? '¬£' + Math.round(tax).toLocaleString('en-GB') : '-';
                            
                            html += `
                                <div class="income-tax-bracket-row">
                                    <div style="grid-column: 1 / 3; padding-left: 20px;">
                                        ${cleanBandName}${rateLabel}
                                    </div>
                                    <div style="font-weight: 600;">${incomeDisplay}</div>
                                    <div style="font-weight: 700; color: var(--income-tax-red);">${taxDisplay}</div>
                                </div>
                            `;
                        });
                        
                        // Group total
                        if (showTotals && groupRows.length > 0) {
                            html += `
                                <div class="income-tax-bracket-row" style="background-color: #f9fafb; border-top: 2px solid #e5e7eb;">
                                    <div style="font-weight: 700; grid-column: 1 / 3;">${groupName} Total</div>
                                    <div style="font-weight: 700;">¬£${Math.round(groupIncome).toLocaleString('en-GB')}</div>
                                    <div style="font-weight: 700; color: var(--income-tax-red);">¬£${Math.round(groupTax).toLocaleString('en-GB')}</div>
                                </div>
                            `;
                        }
                    });
                    
                    // Grand total
                    if (showTotals && totalTax > 0) {
                        html += `
                            <div class="income-tax-bracket-row" style="background-color: #ede9fe; padding: 16px; margin-top: 16px; border-radius: 6px; font-size: 15px; border-top: 3px solid var(--income-tax-primary);">
                                <div style="font-weight: 700; grid-column: 1 / 3; color: var(--income-tax-primary);">TOTAL</div>
                                <div style="font-weight: 700;">¬£${Math.round(totalIncome).toLocaleString('en-GB')}</div>
                                <div style="font-weight: 700; color: var(--income-tax-red); font-size: 16px;">¬£${Math.round(totalTax).toLocaleString('en-GB')}</div>
                            </div>
                        `;
                    }
                    
                    return html;
                };
                
                let breakdownHtml = '';
                
                // Get calc object (current calculation)
                const calc = state.currentCalculation;
                if (!calc) {
                    breakdownTableEl.innerHTML = '';
                    return;
                }
                
                if (showComparison) {
                    // Comparison mode: show a single combined comparison table (current vs comparison year)
                    const mainBreakdown = calc.breakdown || [];
                    const comparisonBreakdown = hasComparisonData ? (comparisonCalc.breakdown || []) : [];
                    const mainTaxYear = formatTaxYearLabel(calc.taxYear);
                    const comparisonTaxYear = hasComparisonData ? formatTaxYearLabel(comparisonCalc.taxYear) : formatTaxYearLabel(state.breakdownComparisonTaxYear);
                    
                    // Detect mobile viewport
                    const isMobile = window.innerWidth <= 768;
                    
                    if (hasComparisonData && (mainBreakdown.length > 0 || comparisonBreakdown.length > 0)) {
                        // Helper: normalise band into category + band label
                        const getCategoryAndBand = (row) => {
                            const band = row.band || '';
                            let category = 'Other Income Tax';
                            let bandLabel = '';
                            
                            if (/^Non-Saving:/i.test(band) || /Non-Saving Income Tax/i.test(band)) {
                                category = 'Non-Saving Income Tax';
                                bandLabel = band.split(':')[1]?.trim() || '';
                            } else if (/^Property:/i.test(band) || /Property Income Tax/i.test(band)) {
                                category = 'Property Income Tax';
                                bandLabel = band.split(':')[1]?.trim() || '';
                            } else if (/^Savings:/i.test(band) || /Savings Income Tax/i.test(band)) {
                                category = 'Savings Income Tax';
                                bandLabel = band.split(':')[1]?.trim() || '';
                            } else if (/^Dividend:/i.test(band) || /Dividend Income Tax/i.test(band)) {
                                category = 'Dividend Income Tax';
                                bandLabel = band.split(':')[1]?.trim() || '';
                            } else {
                                category = 'Other Income Tax';
                                bandLabel = band;
                            }
                            
                            // Normalize band names to include "Rate" for all bands
                            const bandLower = bandLabel.toLowerCase();
                            if (bandLower.includes('nil')) {
                                bandLabel = 'Nil Rate';
                            } else if (bandLower.includes('starting')) {
                                bandLabel = 'Starting Rate';
                            } else if (bandLower.includes('basic')) {
                                bandLabel = 'Basic Rate';
                            } else if (bandLower.includes('higher')) {
                                bandLabel = 'Higher Rate';
                            } else if (bandLower.includes('additional')) {
                                bandLabel = 'Additional Rate';
                            } else {
                                // Keep as-is for other labels (like Personal Allowance)
                                bandLabel = bandLabel.trim();
                            }
                            
                            return { category, bandLabel };
                        };
                        
                        // Combine rows from both years keyed by category + band
                        const rowMap = new Map();
                        
                        const addRows = (source, isComparison) => {
                            source.forEach(row => {
                                const { category, bandLabel } = getCategoryAndBand(row);
                                
                                // Filter out Nil rate bands from Non-Saving Income Tax category (they don't exist in non-saving income)
                                if (category === 'Non-Saving Income Tax' && (bandLabel.toLowerCase().includes('nil') || bandLabel.toLowerCase().includes('nil rate'))) {
                                    return; // Skip this row
                                }
                                
                            const amount = row.amount || 0;
                            const tax = row.tax || 0;
                                const rate = row.rate || 0;
                                const allowanceReduction = row.allowanceReduction || 0;
                                const maxThreshold = row.maxThreshold || null;
                                const key = `${category}||${bandLabel || 'Total'}`;
                                
                                if (!rowMap.has(key)) {
                                    rowMap.set(key, {
                                        category,
                                        bandLabel,
                                        mainIncome: 0,
                                        mainTax: 0,
                                        comparisonIncome: 0,
                                        comparisonTax: 0,
                                        rate: rate || 0, // Default rate (will be overridden by main/comparison specific rates)
                                        mainRate: null, // Separate rate for main calculation
                                        comparisonRate: null, // Separate rate for comparison calculation
                                        mainAllowanceReduction: 0,
                                        comparisonAllowanceReduction: 0,
                                        maxThreshold: null
                                    });
                                }
                                
                                const entry = rowMap.get(key);
                                // Store separate rates for main and comparison
                                if (isComparison) {
                                    if (rate && rate > 0) {
                                        entry.comparisonRate = rate;
                                    }
                                    // If no comparison rate set yet, use the default rate
                                    if (entry.comparisonRate === null && entry.rate) {
                                        entry.comparisonRate = entry.rate;
                                    }
                                } else {
                                    if (rate && rate > 0) {
                                        entry.mainRate = rate;
                                    }
                                    // If no main rate set yet, use the default rate
                                    if (entry.mainRate === null && entry.rate) {
                                        entry.mainRate = entry.rate;
                                    }
                                }
                                // Preserve a non-zero rate if we see one (for backward compatibility)
                                if (!entry.rate && rate) {
                                    entry.rate = rate;
                                }
                                // Preserve maxThreshold if available
                                if (maxThreshold !== null && maxThreshold !== undefined && entry.maxThreshold === null) {
                                    entry.maxThreshold = maxThreshold;
                                }
                                // Preserve allowance reduction
                                if (allowanceReduction > 0) {
                                    if (isComparison) {
                                        entry.comparisonAllowanceReduction = allowanceReduction;
                                    } else {
                                        entry.mainAllowanceReduction = allowanceReduction;
                                    }
                                }
                                if (isComparison) {
                                    entry.comparisonIncome += amount;
                                    entry.comparisonTax += tax;
                                } else {
                                    entry.mainIncome += amount;
                                    entry.mainTax += tax;
                                }
                            });
                        };
                        
                        addRows(mainBreakdown, false);
                        addRows(comparisonBreakdown, true);
                        
                        // Group by category for ordered rendering
                        const categoryOrder = ['Non-Saving Income Tax', 'Property Income Tax', 'Savings Income Tax', 'Dividend Income Tax', 'Other Income Tax'];
                        const grouped = {};
                        rowMap.forEach(entry => {
                            if (!grouped[entry.category]) grouped[entry.category] = [];
                            grouped[entry.category].push(entry);
                        });
                        
                        // Add Personal Allowance rows for categories where allowance is applied
                        // Use allowanceBreakdown from API response
                        const mainAllowanceBreakdown = calc.allowanceBreakdown || {};
                        const comparisonAllowanceBreakdown = comparisonCalc?.allowanceBreakdown || {};
                        
                        categoryOrder.forEach(categoryName => {
                            let rows = grouped[categoryName] || [];
                            
                            // Calculate input income for each category first to check if category should be shown
                            let mainCategoryIncome = 0;
                            let comparisonCategoryIncome = 0;
                            
                            if (categoryName === 'Non-Saving Income Tax') {
                                // Calculate non-saving income for main calculation
                                const mainTaxYearStr = String(calc.taxYear || '').trim();
                                const mainIsNewPropertyTreatment = mainTaxYearStr === "2027" || 
                                    mainTaxYearStr === "2027/2028" ||
                                    mainTaxYearStr === "2027-2028" ||
                                    /^2027[/-]2028$/.test(mainTaxYearStr);
                                mainCategoryIncome = mainIsNewPropertyTreatment
                                    ? (calc.tradingIncome || 0) + (calc.employmentIncome || 0)
                                    : (calc.propertyIncome || 0) + (calc.tradingIncome || 0) + (calc.employmentIncome || 0);
                                
                                // Calculate non-saving income for comparison calculation
                                if (hasComparisonData && comparisonCalc) {
                                    const comparisonTaxYearStr = String(comparisonCalc.taxYear || '').trim();
                                    const comparisonIsNewPropertyTreatment = comparisonTaxYearStr === "2027" || 
                                        comparisonTaxYearStr === "2027/2028" ||
                                        comparisonTaxYearStr === "2027-2028" ||
                                        /^2027[/-]2028$/.test(comparisonTaxYearStr);
                                    comparisonCategoryIncome = comparisonIsNewPropertyTreatment
                                        ? (comparisonCalc.tradingIncome || 0) + (comparisonCalc.employmentIncome || 0)
                                        : (comparisonCalc.propertyIncome || 0) + (comparisonCalc.tradingIncome || 0) + (comparisonCalc.employmentIncome || 0);
                                }
                            } else if (categoryName === 'Property Income Tax') {
                                mainCategoryIncome = calc.propertyIncome || 0;
                                comparisonCategoryIncome = comparisonCalc?.propertyIncome || 0;
                            } else if (categoryName === 'Savings Income Tax') {
                                mainCategoryIncome = calc.savingIncome || 0;
                                comparisonCategoryIncome = comparisonCalc?.savingIncome || 0;
                            } else if (categoryName === 'Dividend Income Tax') {
                                mainCategoryIncome = calc.dividendIncome || 0;
                                comparisonCategoryIncome = comparisonCalc?.dividendIncome || 0;
                            }
                            
                            // If category has no income in either year, skip it
                            if (mainCategoryIncome === 0 && comparisonCategoryIncome === 0) return;
                            
                            // Ensure rows array exists in grouped object
                            if (!grouped[categoryName]) {
                                grouped[categoryName] = [];
                            }
                            // Get reference to the actual array in grouped object
                            rows = grouped[categoryName];
                            
                            // Get allowance amounts from allowanceBreakdown for this category
                            let categoryMainAllowance = 0;
                            let categoryComparisonAllowance = 0;
                            // Declare these outside if blocks for use in Basic band logic
                            let mainNonSavingIncome = mainCategoryIncome;
                            let comparisonNonSavingIncome = comparisonCategoryIncome;
                            
                            if (categoryName === 'Non-Saving Income Tax') {
                                // Personal Allowance should show the actual income amount used (min of income and allowance)
                                // This is the amount actually deducted from income
                                categoryMainAllowance = Math.min(mainNonSavingIncome, mainAllowanceBreakdown.alloForNonSaving || 0);
                                categoryComparisonAllowance = Math.min(comparisonNonSavingIncome, comparisonAllowanceBreakdown.alloForNonSaving || 0);
                            } else if (categoryName === 'Property Income Tax') {
                                categoryMainAllowance = mainAllowanceBreakdown.alloForProperty || 0;
                                categoryComparisonAllowance = comparisonAllowanceBreakdown.alloForProperty || 0;
                            } else if (categoryName === 'Savings Income Tax') {
                                categoryMainAllowance = mainAllowanceBreakdown.alloForSaving || 0;
                                categoryComparisonAllowance = comparisonAllowanceBreakdown.alloForSaving || 0;
                            } else if (categoryName === 'Dividend Income Tax') {
                                categoryMainAllowance = mainAllowanceBreakdown.alloForDividend || 0;
                                categoryComparisonAllowance = comparisonAllowanceBreakdown.alloForDividend || 0;
                            }
                            
                            // If allowance is applied in this category, add a Personal Allowance row
                            if (categoryMainAllowance > 0 || categoryComparisonAllowance > 0) {
                                // For Savings and Dividend, show "Remaining Personal Allowance" instead of "Personal Allowance"
                                const allowanceLabel = (categoryName === 'Savings Income Tax' || categoryName === 'Dividend Income Tax')
                                    ? 'Remaining Personal Allowance'
                                    : 'Personal Allowance';
                                
                                // Insert Personal Allowance row
                                rows.unshift({
                                    category: categoryName,
                                    bandLabel: allowanceLabel,
                                    mainIncome: categoryMainAllowance,
                                    mainTax: 0,
                                    comparisonIncome: categoryComparisonAllowance,
                                    comparisonTax: 0,
                                    rate: 0,
                                    mainAllowanceReduction: 0,
                                    comparisonAllowanceReduction: 0,
                                    isPersonalAllowanceRow: true
                                });
                            }
                            
                            // (Removed) Category-income band row: we now show the category input income in the category header row.
                            
                            // For Non-Saving Income Tax: If income is fully covered by allowance, add Basic band with ¬£0
                            // This shows that the income falls within Basic rate but is fully covered by allowance
                            if (categoryName === 'Non-Saving Income Tax') {
                                const hasBasicBand = rows.some(r => r.bandLabel && (r.bandLabel.toLowerCase().includes('basic')));
                                const mainNetIncome = mainNonSavingIncome - categoryMainAllowance;
                                const comparisonNetIncome = comparisonNonSavingIncome - categoryComparisonAllowance;
                                
                                // If no Basic band exists and income is fully covered (net income is 0 or less), add Basic band with ¬£0
                                if (!hasBasicBand && mainNonSavingIncome > 0 && mainNetIncome <= 0) {
                                    // Get basic rate from tables if available
                                    let basicRate = 0.20; // Default 20%
                                    let basicBandThreshold = 37700; // Default threshold
                                    
                                    // Try to get rate from tables
                                    if (calc.tables && calc.tables.nonSavingIncomeTax && calc.tables.nonSavingIncomeTax.length > 0) {
                                        const basicBandRow = calc.tables.nonSavingIncomeTax.find(b => b.band && b.band.toLowerCase().includes('basic'));
                                        if (basicBandRow) {
                                            basicRate = basicBandRow.rate || 0.20;
                                            basicBandThreshold = basicBandRow.maxThreshold || 37700;
                                        }
                                    }
                                    
                                    rows.push({
                                        category: categoryName,
                                        bandLabel: 'Basic Rate',
                                        mainIncome: 0,
                                        mainTax: 0,
                                        comparisonIncome: comparisonNetIncome <= 0 ? (comparisonNonSavingIncome > 0 ? Math.min(comparisonNonSavingIncome, basicBandThreshold) : 0) : comparisonNetIncome,
                                        comparisonTax: 0,
                                        rate: basicRate,
                                        mainAllowanceReduction: 0,
                                        comparisonAllowanceReduction: 0,
                                        maxThreshold: basicBandThreshold
                                    });
                                } else if (!hasBasicBand && comparisonNonSavingIncome > 0 && comparisonNetIncome <= 0 && mainNetIncome > 0) {
                                    // For comparison year only
                                    let basicRate = 0.20;
                                    let basicBandThreshold = 37700;
                                    
                                    if (comparisonCalc && comparisonCalc.tables && comparisonCalc.tables.nonSavingIncomeTax && comparisonCalc.tables.nonSavingIncomeTax.length > 0) {
                                        const basicBandRow = comparisonCalc.tables.nonSavingIncomeTax.find(b => b.band && b.band.toLowerCase().includes('basic'));
                                        if (basicBandRow) {
                                            basicRate = basicBandRow.rate || 0.20;
                                            basicBandThreshold = basicBandRow.maxThreshold || 37700;
                                        }
                                    }
                                    
                                    // Fully covered by allowance in comparison year => band should be ¬£0 (mathematically)
                                    const comparisonBasicBandIncome = 0;
                                    
                                    rows.push({
                                        category: categoryName,
                                        bandLabel: 'Basic Rate',
                                        mainIncome: mainNetIncome > 0 ? Math.min(mainNonSavingIncome, basicBandThreshold) : 0,
                                        mainTax: 0,
                                        comparisonIncome: comparisonBasicBandIncome,
                                        comparisonTax: 0,
                                        rate: basicRate,
                                        mainAllowanceReduction: 0,
                                        comparisonAllowanceReduction: 0,
                                        maxThreshold: basicBandThreshold
                                    });
                                }
                            }
                            
                            // For Property Income Tax: If income is fully covered by allowance, add Basic band
                            // This shows that the income falls within Basic rate but is fully covered by allowance
                            if (categoryName === 'Property Income Tax') {
                                const hasBasicBand = rows.some(r => r.bandLabel && (r.bandLabel.toLowerCase().includes('basic')));
                                const mainNetIncome = mainCategoryIncome - categoryMainAllowance;
                                const comparisonNetIncome = comparisonCategoryIncome - categoryComparisonAllowance;
                                
                                // If no Basic band exists and income is fully covered (net income is 0 or less), add Basic band
                                if (!hasBasicBand && mainCategoryIncome > 0 && mainNetIncome <= 0) {
                                    // Get basic rate from tables if available
                                    let basicRate = 0.20; // Default 20%
                                    let basicBandThreshold = 37700; // Default threshold
                                    
                                    // Try to get rate from tables
                                    if (calc.tables && calc.tables.propertyIncomeTax && calc.tables.propertyIncomeTax.length > 0) {
                                        const basicBandRow = calc.tables.propertyIncomeTax.find(b => b.band && b.band.toLowerCase().includes('basic'));
                                        if (basicBandRow) {
                                            basicRate = basicBandRow.rate || 0.20;
                                            basicBandThreshold = basicBandRow.maxThreshold || 37700;
                                        }
                                    }
                                    
                                    // Fully covered by allowance => show Basic Rate band with ¬£0 (mathematically)
                                    const basicBandIncome = 0;
                                    const comparisonBasicBandIncome = (comparisonNetIncome <= 0 && comparisonCategoryIncome > 0) ? 0 : 0;
                                    
                                    rows.push({
                                        category: categoryName,
                                        bandLabel: 'Basic Rate',
                                        mainIncome: basicBandIncome,
                                        mainTax: 0,
                                        comparisonIncome: comparisonBasicBandIncome,
                                        comparisonTax: 0,
                                        rate: basicRate,
                                        mainAllowanceReduction: 0,
                                        comparisonAllowanceReduction: 0,
                                        maxThreshold: basicBandThreshold,
                                        isDisplayOnly: true // Mark as display-only, exclude from subtotals
                                    });
                                } else if (!hasBasicBand && comparisonCategoryIncome > 0 && comparisonNetIncome <= 0 && mainNetIncome > 0) {
                                    // For comparison year only
                                    let basicRate = 0.20;
                                    let basicBandThreshold = 37700;
                                    
                                    if (comparisonCalc && comparisonCalc.tables && comparisonCalc.tables.propertyIncomeTax && comparisonCalc.tables.propertyIncomeTax.length > 0) {
                                        const basicBandRow = comparisonCalc.tables.propertyIncomeTax.find(b => b.band && b.band.toLowerCase().includes('basic'));
                                        if (basicBandRow) {
                                            basicRate = basicBandRow.rate || 0.20;
                                            basicBandThreshold = basicBandRow.maxThreshold || 37700;
                                        }
                                    }
                                    
                                    const comparisonBasicBandIncome = 0;
                                    
                                    rows.push({
                                        category: categoryName,
                                        bandLabel: 'Basic Rate',
                                        mainIncome: 0,
                                        mainTax: 0,
                                        comparisonIncome: comparisonBasicBandIncome,
                                        comparisonTax: 0,
                                        rate: basicRate,
                                        mainAllowanceReduction: 0,
                                        comparisonAllowanceReduction: 0,
                                        maxThreshold: basicBandThreshold,
                                        isDisplayOnly: true // Mark as display-only, exclude from subtotals
                                    });
                                }
                            }
                            
                            // For Savings Income Tax: If income is fully covered by allowance and zero-rate bands, add Basic band
                            // This shows that the income would fall within Basic rate but is fully covered
                            if (categoryName === 'Savings Income Tax') {
                                const hasBasicBand = rows.some(r => r.bandLabel && (r.bandLabel.toLowerCase().includes('basic')));
                                const mainNetIncome = mainCategoryIncome - categoryMainAllowance;
                                const comparisonNetIncome = comparisonCategoryIncome - categoryComparisonAllowance;
                                
                                // Calculate total income in zero-rate bands (Starting Rate, Nil Rate/PSA) for main
                                const mainZeroRateIncome = rows
                                    .filter(r => !r.isPersonalAllowanceRow && ((r.bandLabel || '').toLowerCase().includes('starting') || (r.bandLabel || '').toLowerCase().includes('nil rate')))
                                    .reduce((sum, r) => sum + (r.mainIncome || 0), 0);
                                
                                // Calculate total income in zero-rate bands for comparison
                                const comparisonZeroRateIncome = rows
                                    .filter(r => !r.isPersonalAllowanceRow && ((r.bandLabel || '').toLowerCase().includes('starting') || (r.bandLabel || '').toLowerCase().includes('nil rate')))
                                    .reduce((sum, r) => sum + (r.comparisonIncome || 0), 0);
                                
                                // Net income after allowance and zero-rate bands
                                const mainRemainingAfterZeroRate = mainNetIncome - mainZeroRateIncome;
                                const comparisonRemainingAfterZeroRate = comparisonNetIncome - comparisonZeroRateIncome;
                                
                                // If no Basic band exists and income is fully covered (remaining after zero-rate is 0 or less), add Basic band
                                // Show the full input income amount in Basic Rate (not just the zero-rate amount)
                                if (!hasBasicBand && mainCategoryIncome > 0 && mainRemainingAfterZeroRate <= 0) {
                                    // Get basic rate from tables if available
                                    let basicRate = 0.20; // Default 20%
                                    let basicBandThreshold = 37700; // Default threshold
                                    
                                    // Try to get rate from tables
                                    if (calc.tables && calc.tables.savingIncomeTax && calc.tables.savingIncomeTax.length > 0) {
                                        const basicBandRow = calc.tables.savingIncomeTax.find(b => b.band && b.band.toLowerCase().includes('basic'));
                                        if (basicBandRow) {
                                            basicRate = basicBandRow.rate || 0.20;
                                            basicBandThreshold = basicBandRow.maxThreshold || 37700;
                                        }
                                    }
                                    
                                    // Fully eliminated by PA + zero-rate bands => show Basic Rate band with ¬£0 (mathematically)
                                    const mainBasicBandIncome = 0;
                                    const comparisonBasicBandIncome = (comparisonRemainingAfterZeroRate <= 0 && comparisonCategoryIncome > 0) ? 0 : 0;
                                    
                                    rows.push({
                                        category: categoryName,
                                        bandLabel: 'Basic Rate',
                                        mainIncome: mainBasicBandIncome,
                                        mainTax: 0,
                                        comparisonIncome: comparisonBasicBandIncome,
                                        comparisonTax: 0,
                                        rate: basicRate,
                                        mainAllowanceReduction: 0,
                                        comparisonAllowanceReduction: 0,
                                        maxThreshold: basicBandThreshold,
                                        isDisplayOnly: true // Mark as display-only, exclude from subtotals
                                    });
                                } else if (!hasBasicBand && comparisonCategoryIncome > 0 && comparisonRemainingAfterZeroRate <= 0 && mainRemainingAfterZeroRate > 0) {
                                    // For comparison year only
                                    let basicRate = 0.20;
                                    let basicBandThreshold = 37700;
                                    
                                    if (comparisonCalc && comparisonCalc.tables && comparisonCalc.tables.savingIncomeTax && comparisonCalc.tables.savingIncomeTax.length > 0) {
                                        const basicBandRow = comparisonCalc.tables.savingIncomeTax.find(b => b.band && b.band.toLowerCase().includes('basic'));
                                        if (basicBandRow) {
                                            basicRate = basicBandRow.rate || 0.20;
                                            basicBandThreshold = basicBandRow.maxThreshold || 37700;
                                        }
                                    }
                                    
                                    // Fully eliminated => show Basic Rate band with ¬£0
                                    const comparisonBasicBandIncome = 0;
                                    
                                    rows.push({
                                        category: categoryName,
                                        bandLabel: 'Basic Rate',
                                        mainIncome: 0,
                                        mainTax: 0,
                                        comparisonIncome: comparisonBasicBandIncome,
                                        comparisonTax: 0,
                                        rate: basicRate,
                                        mainAllowanceReduction: 0,
                                        comparisonAllowanceReduction: 0,
                                        maxThreshold: basicBandThreshold,
                                        isDisplayOnly: true // Mark as display-only, exclude from subtotals
                                    });
                                }
                            }
                        });
                        
                        let grandMainIncome = 0;
                        let grandMainTax = 0;
                        let grandComparisonIncome = 0;
                        let grandComparisonTax = 0;
                        
                        // Color mapping for each category (toned down, more subtle)
                        const categoryColors = {
                            'Non-Saving Income Tax': { bg: '#fef9e7', border: '#fde68a', empty: '#fef3c7', header: '#fde68a', subtotalEmpty: '#fef9e7', stripe: '#fefbf0' }, // Very light yellow/amber
                            'Property Income Tax': { bg: '#eff6ff', border: '#bfdbfe', empty: '#dbeafe', header: '#bfdbfe', subtotalEmpty: '#eff6ff', stripe: '#f5f9ff' }, // Very light blue
                            'Savings Income Tax': { bg: '#f5f3ff', border: '#ddd6fe', empty: '#e9d5ff', header: '#ddd6fe', subtotalEmpty: '#f5f3ff', stripe: '#faf8ff' }, // Very light indigo
                            'Dividend Income Tax': { bg: '#fdf2f8', border: '#fbcfe8', empty: '#fce7f3', header: '#fbcfe8', subtotalEmpty: '#fdf2f8', stripe: '#fef7fb' }, // Very light pink
                            'Other Income Tax': { bg: '#f9fafb', border: '#e5e7eb', empty: '#f3f4f6', header: '#e5e7eb', subtotalEmpty: '#f9fafb', stripe: '#fbfcfd' } // Very light gray
                        };
                        
                        // Mobile card layout
                        if (isMobile) {
                            breakdownHtml = '<div class="income-tax-comparison-mobile-wrapper">';
                            
                            categoryOrder.forEach(categoryName => {
                                const rows = grouped[categoryName];
                                if (!rows || rows.length === 0) return;
                                const categoryKey = categoryName.toLowerCase().replace(/[^a-z0-9]+/g, '-');
                                
                                // Get category allowance amounts from allowanceBreakdown
                                let categoryMainAllowance = 0;
                                let categoryComparisonAllowance = 0;
                                if (categoryName === 'Non-Saving Income Tax') {
                                    categoryMainAllowance = mainAllowanceBreakdown.alloForNonSaving || 0;
                                    categoryComparisonAllowance = comparisonAllowanceBreakdown.alloForNonSaving || 0;
                                } else if (categoryName === 'Property Income Tax') {
                                    categoryMainAllowance = mainAllowanceBreakdown.alloForProperty || 0;
                                    categoryComparisonAllowance = comparisonAllowanceBreakdown.alloForProperty || 0;
                                } else if (categoryName === 'Savings Income Tax') {
                                    categoryMainAllowance = mainAllowanceBreakdown.alloForSaving || 0;
                                    categoryComparisonAllowance = comparisonAllowanceBreakdown.alloForSaving || 0;
                                } else if (categoryName === 'Dividend Income Tax') {
                                    categoryMainAllowance = mainAllowanceBreakdown.alloForDividend || 0;
                                    categoryComparisonAllowance = comparisonAllowanceBreakdown.alloForDividend || 0;
                                }
                                
                                // Calculate category totals
                                let categoryMainIncome = 0;
                                let categoryMainTax = 0;
                                let categoryComparisonIncome = 0;
                                let categoryComparisonTax = 0;
                                
                                rows.forEach(entry => {
                                    // Exclude Personal Allowance, Input Income, and display-only rows from totals (they're just for display)
                                    if (!entry.isPersonalAllowanceRow && !entry.isInputIncomeRow && !entry.isDisplayOnly) {
                                        categoryMainIncome += entry.mainIncome;
                                        categoryMainTax += entry.mainTax;
                                        categoryComparisonIncome += entry.comparisonIncome;
                                        categoryComparisonTax += entry.comparisonTax;
                                    }
                                });
                                
                                // If income is fully eliminated by allowance (net income is 0 or less), set subtotal to 0
                                // BUT: For Savings and Dividend Income Tax, if there are zero-rate bands (Starting Rate, Nil Rate) 
                                // that show income, we should NOT reset to 0 - show the actual amounts
                                const mainNetIncome = categoryMainIncome - categoryMainAllowance;
                                const comparisonNetIncome = categoryComparisonIncome - categoryComparisonAllowance;
                                
                                // Check if there are zero-rate bands with income (Starting Rate, Nil Rate)
                                const hasMainZeroRateBands = rows.some(entry => {
                                    const bandLabel = (entry.bandLabel || '').toLowerCase();
                                    const isZeroRate = (bandLabel.includes('starting') || bandLabel.includes('nil rate')) && 
                                                      !entry.isPersonalAllowanceRow && 
                                                      (entry.mainIncome > 0 || entry.comparisonIncome > 0);
                                    return isZeroRate;
                                });
                                
                                // Only reset to 0 if income is fully eliminated by allowance AND there are no zero-rate bands showing income
                                // For Savings and Dividend, zero-rate bands (Starting Rate, Nil Rate) should show their actual income amounts
                                if (mainNetIncome <= 0 && categoryMainAllowance > 0 && !hasMainZeroRateBands) {
                                    categoryMainIncome = 0;
                                    categoryMainTax = 0;
                                }
                                if (comparisonNetIncome <= 0 && categoryComparisonAllowance > 0 && !hasMainZeroRateBands) {
                                    categoryComparisonIncome = 0;
                                    categoryComparisonTax = 0;
                                }
                                
                                grandMainIncome += categoryMainIncome;
                                grandMainTax += categoryMainTax;
                                grandComparisonIncome += categoryComparisonIncome;
                                grandComparisonTax += categoryComparisonTax;
                                
                                const categoryDiffTax = categoryComparisonTax - categoryMainTax;
                                const categoryDiffClass = categoryDiffTax > 0 ? 'income-tax-comparison-mobile-diff-negative' : (categoryDiffTax < 0 ? 'income-tax-comparison-mobile-diff-positive' : 'income-tax-comparison-mobile-diff-neutral');
                                const categoryColor = categoryColors[categoryName] || categoryColors['Other Income Tax'];
                            
                            breakdownHtml += `
                                    <div class="income-tax-comparison-mobile-card" data-category-key="${categoryKey}" style="border-left: 4px solid ${categoryColor.border};">
                                        <div class="income-tax-comparison-mobile-card-header" data-category-toggle="${categoryKey}">
                                            <span class="income-tax-comparison-mobile-toggle-icon">‚ñ∏</span>
                                            <span class="income-tax-comparison-mobile-card-title">${categoryName}</span>
                                </div>
                                        <div class="income-tax-comparison-mobile-card-summary">
                                            <div class="income-tax-comparison-mobile-summary-row">
                                                <div class="income-tax-comparison-mobile-year">${mainTaxYear}</div>
                                                <div class="income-tax-comparison-mobile-year">${comparisonTaxYear}</div>
                                            </div>
                                            <div class="income-tax-comparison-mobile-summary-row">
                                                <div class="income-tax-comparison-mobile-value-group">
                                                    <div class="income-tax-comparison-mobile-label">Income</div>
                                                    <div class="income-tax-comparison-mobile-value">¬£${Math.round(categoryMainIncome).toLocaleString('en-GB')}</div>
                                                </div>
                                                <div class="income-tax-comparison-mobile-value-group">
                                                    <div class="income-tax-comparison-mobile-label">Income</div>
                                                    <div class="income-tax-comparison-mobile-value">¬£${Math.round(categoryComparisonIncome).toLocaleString('en-GB')}</div>
                                                </div>
                                            </div>
                                            <div class="income-tax-comparison-mobile-summary-row">
                                                <div class="income-tax-comparison-mobile-value-group">
                                                    <div class="income-tax-comparison-mobile-label">Tax</div>
                                                    <div class="income-tax-comparison-mobile-value income-tax-comparison-mobile-tax">¬£${Math.round(categoryMainTax).toLocaleString('en-GB')}</div>
                                                </div>
                                                <div class="income-tax-comparison-mobile-value-group">
                                                    <div class="income-tax-comparison-mobile-label">Tax</div>
                                                    <div class="income-tax-comparison-mobile-value income-tax-comparison-mobile-tax">¬£${Math.round(categoryComparisonTax).toLocaleString('en-GB')}</div>
                                                </div>
                                            </div>
                                            <div class="income-tax-comparison-mobile-difference">
                                                <span class="income-tax-comparison-mobile-diff-label">Difference:</span>
                                                <span class="income-tax-comparison-mobile-diff-value ${categoryDiffClass}">${categoryDiffTax >= 0 ? '+' : ''}¬£${Math.round(Math.abs(categoryDiffTax)).toLocaleString('en-GB')}</span>
                                            </div>
                                        </div>
                                        <div class="income-tax-comparison-mobile-card-details" data-category-details="${categoryKey}" style="display: none;">
                                            ${rows.map(entry => {
                                                const bandDiffTax = entry.comparisonTax - entry.mainTax;
                                                const bandDiffClass = bandDiffTax > 0 ? 'income-tax-comparison-mobile-diff-negative' : (bandDiffTax < 0 ? 'income-tax-comparison-mobile-diff-positive' : 'income-tax-comparison-mobile-diff-neutral');
                                                let bandLabel = entry.bandLabel || 'Total';
                                                const isPersonalAllowanceRow = entry.isPersonalAllowanceRow || false;
                                                const isPersonalAllowance = (bandLabel.toLowerCase().includes('personal allowance') || bandLabel.toLowerCase().includes('remaining personal allowance')) && !isPersonalAllowanceRow;
                                                
                                                // Skip Nil rate rows for Non-Saving Income Tax category (they don't exist in non-saving income)
                                                if (categoryName === 'Non-Saving Income Tax' && (bandLabel.toLowerCase().includes('nil') || bandLabel.toLowerCase().includes('nil rate'))) {
                                                    return ''; // Skip this row
                                                }
                                                
                                                // If this is an old "Personal Allowance Applied" row (not the new Personal Allowance row), show "Nil" as the band name instead
                                                // But skip it for Non-Saving category
                                                if (isPersonalAllowance) {
                                                    if (categoryName === 'Non-Saving Income Tax') {
                                                        return ''; // Skip old Personal Allowance Applied rows for Non-Saving
                                                    }
                                                    bandLabel = 'Nil Rate';
                                                }
                                                
                                                // Add (0%) for Nil rates, Starting rates, and Personal Allowance (which already has it)
                                                // Remove rates and thresholds from other bands
                                                let rateLabel = '';
                                                if (bandLabel === 'Total') {
                                                    rateLabel = '';
                                                } else if (isPersonalAllowanceRow) {
                                                    // Personal Allowance already has (0%) in the label
                                                    rateLabel = '';
                                                } else if (bandLabel.toLowerCase().includes('nil') || bandLabel.toLowerCase().includes('starting')) {
                                                    rateLabel = ' (0%)';
                                                }
                                                // No rate label for Basic, Higher, Additional bands
                                                
                                                const displayBandLabel = bandLabel === 'Total' ? bandLabel : `${bandLabel}${rateLabel}`;
                                                
                                                // For Personal Allowance rows, show negative allowance amount (deduction) in income and ¬£0 in tax
                                                // For other rows, show the income amount (including ¬£0 if it's 0)
                                                const mainIncomeDisplay = entry.isInputIncomeRow
                                                    ? (entry.mainIncome > 0 ? '¬£' + Math.round(entry.mainIncome).toLocaleString('en-GB') : '')
                                                    : (isPersonalAllowanceRow 
                                                        ? (entry.mainIncome > 0 ? `-¬£${Math.round(entry.mainIncome).toLocaleString('en-GB')}` : '-')
                                                        : (entry.mainIncome !== null && entry.mainIncome !== undefined ? '¬£' + Math.round(entry.mainIncome).toLocaleString('en-GB') : '-'));
                                                
                                                const comparisonIncomeDisplay = entry.isInputIncomeRow
                                                    ? (entry.comparisonIncome > 0 ? '¬£' + Math.round(entry.comparisonIncome).toLocaleString('en-GB') : '')
                                                    : (isPersonalAllowanceRow
                                                        ? (entry.comparisonIncome > 0 ? `-¬£${Math.round(entry.comparisonIncome).toLocaleString('en-GB')}` : '-')
                                                        : (entry.comparisonIncome !== null && entry.comparisonIncome !== undefined ? '¬£' + Math.round(entry.comparisonIncome).toLocaleString('en-GB') : '-'));
                                                
                                                // Display tax: show message if fully covered by allowance, otherwise show tax amount
                                                let mainTaxDisplay = '';
                                                if (entry.isInputIncomeRow) {
                                                    mainTaxDisplay = '';
                                                } else if (isPersonalAllowanceRow) {
                                                    mainTaxDisplay = '¬£0';
                                                } else {
                                                    mainTaxDisplay = entry.mainTax !== null && entry.mainTax !== undefined ? '¬£' + Math.round(entry.mainTax).toLocaleString('en-GB') : '-';
                                                }
                                                
                                                let comparisonTaxDisplay = '';
                                                if (entry.isInputIncomeRow) {
                                                    comparisonTaxDisplay = '';
                                                } else if (isPersonalAllowanceRow) {
                                                    comparisonTaxDisplay = '¬£0';
                                                } else {
                                                    comparisonTaxDisplay = entry.comparisonTax !== null && entry.comparisonTax !== undefined ? '¬£' + Math.round(entry.comparisonTax).toLocaleString('en-GB') : '-';
                                                }
                                                
                                                return `
                                                    <div class="income-tax-comparison-mobile-band-row">
                                                        <div class="income-tax-comparison-mobile-band-label">${displayBandLabel}</div>
                                                        <div class="income-tax-comparison-mobile-band-values">
                                                            <div class="income-tax-comparison-mobile-band-year-group">
                                                                <div class="income-tax-comparison-mobile-band-year">${mainTaxYear}</div>
                                                                <div class="income-tax-comparison-mobile-band-value">${mainIncomeDisplay}</div>
                                                                <div class="income-tax-comparison-mobile-band-value income-tax-comparison-mobile-tax">${entry.isInputIncomeRow ? '' : mainTaxDisplay}</div>
                                                            </div>
                                                            <div class="income-tax-comparison-mobile-band-year-group">
                                                                <div class="income-tax-comparison-mobile-band-year">${comparisonTaxYear}</div>
                                                                <div class="income-tax-comparison-mobile-band-value">${comparisonIncomeDisplay}</div>
                                                                <div class="income-tax-comparison-mobile-band-value income-tax-comparison-mobile-tax">${entry.isInputIncomeRow ? '' : comparisonTaxDisplay}</div>
                                                            </div>
                                                        </div>
                                </div>
                    `;
                                            }).join('')}
                                        </div>
                                    </div>
                                `;
                            });
                            
                            // Grand total card
                            const grandDiffTax = grandComparisonTax - grandMainTax;
                            const grandDiffClass = grandDiffTax > 0 ? 'income-tax-comparison-mobile-diff-negative' : (grandDiffTax < 0 ? 'income-tax-comparison-mobile-diff-positive' : 'income-tax-comparison-mobile-diff-neutral');
                    
                    breakdownHtml += `
                                <div class="income-tax-comparison-mobile-card income-tax-comparison-mobile-total-card">
                                    <div class="income-tax-comparison-mobile-card-title income-tax-comparison-mobile-total-title">TOTAL TAX</div>
                                    <div class="income-tax-comparison-mobile-card-summary">
                                        <div class="income-tax-comparison-mobile-summary-row">
                                            <div class="income-tax-comparison-mobile-year">${mainTaxYear}</div>
                                            <div class="income-tax-comparison-mobile-year">${comparisonTaxYear}</div>
                            </div>
                                        <div class="income-tax-comparison-mobile-summary-row">
                                            <div class="income-tax-comparison-mobile-value-group">
                                                <div class="income-tax-comparison-mobile-label">Tax</div>
                                                <div class="income-tax-comparison-mobile-value income-tax-comparison-mobile-tax income-tax-comparison-mobile-total-value">¬£${Math.round(grandMainTax).toLocaleString('en-GB')}</div>
                                </div>
                                            <div class="income-tax-comparison-mobile-value-group">
                                                <div class="income-tax-comparison-mobile-label">Tax</div>
                                                <div class="income-tax-comparison-mobile-value income-tax-comparison-mobile-tax income-tax-comparison-mobile-total-value">¬£${Math.round(grandComparisonTax).toLocaleString('en-GB')}</div>
                                            </div>
                                        </div>
                                        <div class="income-tax-comparison-mobile-difference">
                                            <span class="income-tax-comparison-mobile-diff-label">Difference:</span>
                                            <span class="income-tax-comparison-mobile-diff-value ${grandDiffClass} income-tax-comparison-mobile-total-diff">${grandDiffTax >= 0 ? '+' : ''}¬£${Math.round(Math.abs(grandDiffTax)).toLocaleString('en-GB')}</span>
                                        </div>
                                    </div>
                                </div>
                                </div>
                            `;
                        } else {
                            // Desktop table layout
                    breakdownHtml = `
                            <div class="income-tax-comparison-table-wrapper">
                                <!-- Header rows container with merged Category and Difference -->
                                <div class="income-tax-comparison-header-container">
                                    <!-- Top header row: grouped by year -->
                                    <div class="income-tax-comparison-header-row income-tax-comparison-header-row-top">
                                        <div class="income-tax-comparison-header-cell income-tax-comparison-header-cell-top-category income-tax-comparison-header-cell-merged">Category</div>
                                        <div class="income-tax-comparison-header-cell income-tax-comparison-header-cell-top-year" style="grid-column: 2 / 5; border-bottom:1px solid #bfdbfe;">${mainTaxYear}</div>
                                        <div class="income-tax-comparison-header-cell income-tax-comparison-header-cell-top-year" style="grid-column: 5 / 8; border-bottom:1px solid #bfdbfe;">${comparisonTaxYear}</div>
                                        <div class="income-tax-comparison-header-cell income-tax-comparison-header-cell-top-year income-tax-comparison-header-cell-merged" style="grid-column: 8 / 9;">Difference</div>
                                    </div>
                                    <!-- Sub header row: Income / Rate / Tax labels -->
                                    <div class="income-tax-comparison-header-row income-tax-comparison-header-row-sub">
                                        <div class="income-tax-comparison-header-cell">Income</div>
                                        <div class="income-tax-comparison-header-cell income-tax-comparison-header-cell-rate">Rate</div>
                                        <div class="income-tax-comparison-header-cell">Tax</div>
                                        <div class="income-tax-comparison-header-cell">Income</div>
                                        <div class="income-tax-comparison-header-cell income-tax-comparison-header-cell-rate">Rate</div>
                                        <div class="income-tax-comparison-header-cell" style="border-right:1px solid #bfdbfe;">Tax</div>
                                    </div>
                                </div>
                    `;
                    
                        categoryOrder.forEach(categoryName => {
                            const rows = grouped[categoryName];
                            if (!rows || rows.length === 0) return;
                            const categoryKey = categoryName.toLowerCase().replace(/[^a-z0-9]+/g, '-');
                            const categoryColor = categoryColors[categoryName] || categoryColors['Other Income Tax'];
                            
                            // Get category allowance amounts from allowanceBreakdown for this category
                            let categoryMainAllowance = 0;
                            let categoryComparisonAllowance = 0;
                            if (categoryName === 'Non-Saving Income Tax') {
                                categoryMainAllowance = mainAllowanceBreakdown.alloForNonSaving || 0;
                                categoryComparisonAllowance = comparisonAllowanceBreakdown.alloForNonSaving || 0;
                            } else if (categoryName === 'Property Income Tax') {
                                categoryMainAllowance = mainAllowanceBreakdown.alloForProperty || 0;
                                categoryComparisonAllowance = comparisonAllowanceBreakdown.alloForProperty || 0;
                            } else if (categoryName === 'Savings Income Tax') {
                                categoryMainAllowance = mainAllowanceBreakdown.alloForSaving || 0;
                                categoryComparisonAllowance = comparisonAllowanceBreakdown.alloForSaving || 0;
                            } else if (categoryName === 'Dividend Income Tax') {
                                categoryMainAllowance = mainAllowanceBreakdown.alloForDividend || 0;
                                categoryComparisonAllowance = comparisonAllowanceBreakdown.alloForDividend || 0;
                            }
                            
                            // Sort bands: Input Income first, then Personal Allowance, then Nil/Starting rate, then Basic, Higher, Additional
                            rows.sort((a, b) => {
                                // Input Income rows always come first
                                if (a.isInputIncomeRow && !b.isInputIncomeRow) return -1;
                                if (!a.isInputIncomeRow && b.isInputIncomeRow) return 1;

                                // Personal Allowance rows always come first
                                if (a.isPersonalAllowanceRow && !b.isPersonalAllowanceRow) return -1;
                                if (!a.isPersonalAllowanceRow && b.isPersonalAllowanceRow) return 1;
                                
                                const bandA = (a.bandLabel || '').toLowerCase();
                                const bandB = (b.bandLabel || '').toLowerCase();
                                
                                // Check for Nil or Starting rate (should come first after Personal Allowance)
                                const aIsNil = bandA.includes('nil') || bandA.includes('starting');
                                const bIsNil = bandB.includes('nil') || bandB.includes('starting');
                                
                                if (aIsNil && !bIsNil) return -1;
                                if (!aIsNil && bIsNil) return 1;
                                
                                // If both are Nil/Starting or both are not, sort by: Basic, Higher, Additional
                                const getBandOrder = (band) => {
                                    if (band.includes('basic')) return 1;
                                    if (band.includes('higher')) return 2;
                                    if (band.includes('additional')) return 3;
                                    return 4; // Other bands
                                };
                                
                                return getBandOrder(bandA) - getBandOrder(bandB);
                            });
                            
                            let categoryMainIncome = 0;
                            let categoryMainTax = 0;
                            let categoryComparisonIncome = 0;
                            let categoryComparisonTax = 0;
                            
                            rows.forEach(entry => {
                                // Exclude Personal Allowance, Input Income, and display-only rows from totals (they're just for display)
                                if (!entry.isPersonalAllowanceRow && !entry.isInputIncomeRow && !entry.isDisplayOnly) {
                                    categoryMainIncome += entry.mainIncome;
                                    categoryMainTax += entry.mainTax;
                                    categoryComparisonIncome += entry.comparisonIncome;
                                    categoryComparisonTax += entry.comparisonTax;
                                }
                            });
                            
                            // Calculate difference BEFORE potentially resetting totals to 0
                            // This ensures the difference reflects actual changes even when totals are reset
                            const categoryDiffTax = categoryComparisonTax - categoryMainTax;
                            
                            // Store original totals for difference calculation (before reset)
                            const originalCategoryMainTax = categoryMainTax;
                            const originalCategoryComparisonTax = categoryComparisonTax;
                            const originalCategoryDiffTax = originalCategoryComparisonTax - originalCategoryMainTax;
                            
                            // If income is fully eliminated by allowance (net income is 0 or less), set subtotal to 0
                            // BUT: For Savings and Dividend Income Tax, if there are zero-rate bands (Starting Rate, Nil Rate) 
                            // that show income, we should NOT reset to 0 - show the actual amounts
                            const mainNetIncome = categoryMainIncome - categoryMainAllowance;
                            const comparisonNetIncome = categoryComparisonIncome - categoryComparisonAllowance;
                            
                            // Check if there are zero-rate bands with income (Starting Rate, Nil Rate)
                            const hasMainZeroRateBands = rows.some(entry => {
                                const bandLabel = (entry.bandLabel || '').toLowerCase();
                                const isZeroRate = (bandLabel.includes('starting') || bandLabel.includes('nil rate')) && 
                                                  !entry.isPersonalAllowanceRow && 
                                                  (entry.mainIncome > 0 || entry.comparisonIncome > 0);
                                return isZeroRate;
                            });
                            
                            // Only reset to 0 if income is fully eliminated by allowance AND there are no zero-rate bands showing income
                            // For Savings and Dividend, zero-rate bands (Starting Rate, Nil Rate) should show their actual income amounts
                            if (mainNetIncome <= 0 && categoryMainAllowance > 0 && !hasMainZeroRateBands) {
                                categoryMainIncome = 0;
                                categoryMainTax = 0;
                            }
                            if (comparisonNetIncome <= 0 && categoryComparisonAllowance > 0 && !hasMainZeroRateBands) {
                                categoryComparisonIncome = 0;
                                categoryComparisonTax = 0;
                            }
                            
                            grandMainIncome += categoryMainIncome;
                            grandMainTax += categoryMainTax;
                            grandComparisonIncome += categoryComparisonIncome;
                            grandComparisonTax += categoryComparisonTax;
                            // Use original difference for class calculation (before reset)
                            const categoryDiffClass = originalCategoryDiffTax > 0 ? 'income-tax-comparison-diff-negative' : (originalCategoryDiffTax < 0 ? 'income-tax-comparison-diff-positive' : 'income-tax-comparison-diff-neutral');
                            
                            // Category header row (label + expand/collapse; show input income in the Income columns)
                            const categoryLabelNoTax = String(categoryName || '').replace(/\s+Tax\s*$/i, '').trim();

                            // Compute category input income for both years (do NOT use band totals)
                            let mainCategoryInputIncome = 0;
                            let comparisonCategoryInputIncome = 0;
                            if (categoryName === 'Non-Saving Income Tax') {
                                const mainTaxYearStr = String(calc.taxYear || '').trim();
                                const mainIsNewPropertyTreatment = mainTaxYearStr === "2027" || 
                                    mainTaxYearStr === "2027/2028" ||
                                    mainTaxYearStr === "2027-2028" ||
                                    /^2027[/-]2028$/.test(mainTaxYearStr);
                                mainCategoryInputIncome = mainIsNewPropertyTreatment
                                    ? (calc.tradingIncome || 0) + (calc.employmentIncome || 0)
                                    : (calc.propertyIncome || 0) + (calc.tradingIncome || 0) + (calc.employmentIncome || 0);
                                if (comparisonCalc) {
                                    const comparisonTaxYearStr = String(comparisonCalc.taxYear || '').trim();
                                    const comparisonIsNewPropertyTreatment = comparisonTaxYearStr === "2027" || 
                                        comparisonTaxYearStr === "2027/2028" ||
                                        comparisonTaxYearStr === "2027-2028" ||
                                        /^2027[/-]2028$/.test(comparisonTaxYearStr);
                                    comparisonCategoryInputIncome = comparisonIsNewPropertyTreatment
                                        ? (comparisonCalc.tradingIncome || 0) + (comparisonCalc.employmentIncome || 0)
                                        : (comparisonCalc.propertyIncome || 0) + (comparisonCalc.tradingIncome || 0) + (comparisonCalc.employmentIncome || 0);
                                }
                            } else if (categoryName === 'Property Income Tax') {
                                // Property income is treated differently from 2027 onwards:
                                // - For 2027+ it has its own category
                                // - For earlier years it's merged into Non-Saving Income
                                const mainTaxYearStr = String(calc.taxYear || '').trim();
                                const mainIsNewPropertyTreatment = mainTaxYearStr === "2027" || 
                                    mainTaxYearStr === "2027/2028" ||
                                    mainTaxYearStr === "2027-2028" ||
                                    /^2027[/-]2028$/.test(mainTaxYearStr);
                                
                                const comparisonTaxYearStrProp = comparisonCalc ? String(comparisonCalc.taxYear || '').trim() : '';
                                const comparisonIsNewPropertyTreatmentProp = comparisonTaxYearStrProp === "2027" || 
                                    comparisonTaxYearStrProp === "2027/2028" ||
                                    comparisonTaxYearStrProp === "2027-2028" ||
                                    /^2027[/-]2028$/.test(comparisonTaxYearStrProp);

                                // Only show property input income for years where property is a separate category
                                mainCategoryInputIncome = mainIsNewPropertyTreatment ? (calc.propertyIncome || 0) : 0;
                                comparisonCategoryInputIncome = comparisonCalc && comparisonIsNewPropertyTreatmentProp
                                    ? (comparisonCalc.propertyIncome || 0)
                                    : 0;
                            } else if (categoryName === 'Savings Income Tax') {
                                mainCategoryInputIncome = calc.savingIncome || 0;
                                comparisonCategoryInputIncome = comparisonCalc?.savingIncome || 0;
                            } else if (categoryName === 'Dividend Income Tax') {
                                mainCategoryInputIncome = calc.dividendIncome || 0;
                                comparisonCategoryInputIncome = comparisonCalc?.dividendIncome || 0;
                            }

                            const mainCategoryInputIncomeDisplay = mainCategoryInputIncome > 0 ? `¬£${Math.round(mainCategoryInputIncome).toLocaleString('en-GB')}` : '';
                            const comparisonCategoryInputIncomeDisplay = comparisonCategoryInputIncome > 0 ? `¬£${Math.round(comparisonCategoryInputIncome).toLocaleString('en-GB')}` : '';
                            
                            // Subtotal tax displays for category header row (shown when minimized)
                            const mainSubtotalTaxDisplay = categoryMainTax > 0 ? `¬£${Math.round(categoryMainTax).toLocaleString('en-GB')}` : '';
                            const comparisonSubtotalTaxDisplay = categoryComparisonTax > 0 ? `¬£${Math.round(categoryComparisonTax).toLocaleString('en-GB')}` : '';
                            const categoryDiffTaxDisplay = originalCategoryDiffTax === 0 ? '¬£0' : `¬£${Math.round(Math.abs(originalCategoryDiffTax)).toLocaleString('en-GB')}`;
                            
                            breakdownHtml += `
                                <div class="income-tax-comparison-row income-tax-comparison-row-category" 
                                     data-category-key="${categoryKey}"
                                     data-main-income="${categoryMainIncome}"
                                     data-main-tax="${categoryMainTax}"
                                     data-comparison-income="${categoryComparisonIncome}"
                                     data-comparison-tax="${categoryComparisonTax}"
                                     data-diff-tax="${categoryDiffTax}"
                                     data-diff-class="${categoryDiffClass}"
                                     style="background-color: ${categoryColor.header}; border-left: 3px solid ${categoryColor.border};">
                                    <div class="income-tax-comparison-cell income-tax-comparison-cell-category">
                                        <span class="income-tax-comparison-toggle-icon">‚ñæ</span>
                                        <span>${categoryLabelNoTax}</span>
                            </div>
                                    <div class="income-tax-comparison-cell income-tax-comparison-cell-category-value" style="background-color: ${categoryColor.header};">
                                        ${mainCategoryInputIncomeDisplay}
                                </div>
                                    <div class="income-tax-comparison-cell income-tax-comparison-cell-category-value income-tax-comparison-cell-rate" style="background-color: ${categoryColor.header};">
                                        ${''}
                                    </div>
                                    <div class="income-tax-comparison-cell income-tax-comparison-cell-category-value" style="background-color: ${categoryColor.header};">
                                        ${mainSubtotalTaxDisplay}
                                    </div>
                                    <div class="income-tax-comparison-cell income-tax-comparison-cell-category-value" style="background-color: ${categoryColor.header};">
                                        ${comparisonCategoryInputIncomeDisplay}
                                    </div>
                                    <div class="income-tax-comparison-cell income-tax-comparison-cell-category-value income-tax-comparison-cell-rate" style="background-color: ${categoryColor.header};">
                                        ${''}
                                    </div>
                                    <div class="income-tax-comparison-cell income-tax-comparison-cell-category-value" style="background-color: ${categoryColor.header};">
                                        ${comparisonSubtotalTaxDisplay}
                                    </div>
                                    <div class="income-tax-comparison-cell income-tax-comparison-cell-category-value ${categoryDiffClass}" style="background-color: ${categoryColor.header};">
                                        ${categoryDiffTaxDisplay}
                                    </div>
                                </div>
                            `;
                    
                            // Band rows within the category
                            rows.forEach((entry, index) => {
                                const bandDiffTax = entry.comparisonTax - entry.mainTax;
                                const bandDiffClass = bandDiffTax > 0 ? 'income-tax-comparison-diff-negative' : (bandDiffTax < 0 ? 'income-tax-comparison-diff-positive' : 'income-tax-comparison-diff-neutral');
                                let bandLabel = entry.bandLabel || 'Total';
                                const isPersonalAllowanceRow = entry.isPersonalAllowanceRow || false;
                                const isPersonalAllowance = bandLabel.toLowerCase().includes('personal allowance') && !isPersonalAllowanceRow;
                                
                                // Skip Nil rate rows for Non-Saving Income Tax category (they don't exist in non-saving income)
                                if (categoryName === 'Non-Saving Income Tax' && (bandLabel.toLowerCase().includes('nil') || bandLabel.toLowerCase().includes('nil rate'))) {
                                    return; // Skip this row
                                }
                                
                                // If this is an old "Personal Allowance Applied" row (not the new Personal Allowance row), show "Nil Rate" as the band name instead
                                // But skip it for Non-Saving category
                                if (isPersonalAllowance) {
                                    if (categoryName === 'Non-Saving Income Tax') {
                                        return; // Skip old Personal Allowance Applied rows for Non-Saving
                                    }
                                    bandLabel = 'Nil Rate';
                                }
                                
                                // Remove rate and threshold labels - just show the band name
                                // For the category-income row, show the category name without "Tax" instead of the literal label
                                const categoryLabelNoTax = String(categoryName || '')
                                    .replace(/\s+Tax\s*$/i, '')
                                    .replace(/\s+Income\s*$/i, ' Income')
                                    .trim();
                                const displayBandLabel = (entry.isInputIncomeRow && categoryLabelNoTax)
                                    ? categoryLabelNoTax
                                    : (bandLabel === 'Total' ? bandLabel : bandLabel);
                                
                                // For Personal Allowance rows, show negative allowance amount (deduction) in income and ¬£0 in tax
                                // For other rows, show the income amount (including ¬£0 if it's 0)
                                // If Personal Allowance fully covers the category input, show ¬£0 for subsequent taxable-rate bands (math-correct)
                                // Use the injected category-income row as the source of truth (avoids scope/race issues).
                                // Determine if PA fully covers the category input (use category-level input incomes)
                                const mainFullyCoveredByAllowance = (mainCategoryInputIncome - categoryMainAllowance) <= 0;
                                const comparisonFullyCoveredByAllowance = (comparisonCategoryInputIncome - categoryComparisonAllowance) <= 0;
                                const isTaxableRateBand = ['basic rate', 'higher rate', 'additional rate'].includes(displayBandLabel.toLowerCase());

                                const mainIncomeValue = (!isPersonalAllowanceRow && !entry.isInputIncomeRow && mainFullyCoveredByAllowance && isTaxableRateBand) ? 0 : entry.mainIncome;
                                const comparisonIncomeValue = (!isPersonalAllowanceRow && !entry.isInputIncomeRow && comparisonFullyCoveredByAllowance && isTaxableRateBand) ? 0 : entry.comparisonIncome;

                                const hasCategoryMainIncome = mainCategoryInputIncome > 0;
                                const hasCategoryComparisonIncome = comparisonCategoryInputIncome > 0;

                                const mainIncomeDisplay = entry.isInputIncomeRow
                                    ? (hasCategoryMainIncome && mainIncomeValue > 0 ? '¬£' + Math.round(mainIncomeValue).toLocaleString('en-GB') : '')
                                    : (isPersonalAllowanceRow 
                                        ? (entry.mainIncome > 0 ? `-¬£${Math.round(entry.mainIncome).toLocaleString('en-GB')}` : '-')
                                        : (!hasCategoryMainIncome
                                            ? ''
                                            : (mainIncomeValue > 0
                                                ? '¬£' + Math.round(mainIncomeValue).toLocaleString('en-GB')
                                                : '-')));
                                
                                const comparisonIncomeDisplay = entry.isInputIncomeRow
                                    ? (hasCategoryComparisonIncome && comparisonIncomeValue > 0 ? '¬£' + Math.round(comparisonIncomeValue).toLocaleString('en-GB') : '')
                                    : (isPersonalAllowanceRow 
                                        ? (entry.comparisonIncome > 0 ? `-¬£${Math.round(entry.comparisonIncome).toLocaleString('en-GB')}` : '-')
                                        : (!hasCategoryComparisonIncome
                                            ? ''
                                            : (comparisonIncomeValue > 0
                                                ? '¬£' + Math.round(comparisonIncomeValue).toLocaleString('en-GB')
                                                : '-')));
                                
                                                let mainTaxDisplay = '';
                                                if (entry.isInputIncomeRow) {
                                                    mainTaxDisplay = '';
                                                } else if (isPersonalAllowanceRow) {
                                                    mainTaxDisplay = '¬£0';
                    } else if (!hasCategoryMainIncome) {
                                                    mainTaxDisplay = '';
                                                } else if (mainIncomeValue > 0) {
                                                    mainTaxDisplay = entry.mainTax !== null && entry.mainTax !== undefined ? '¬£' + Math.round(entry.mainTax).toLocaleString('en-GB') : '';
                                                } else {
                                                    mainTaxDisplay = '¬£0';
                                                }
                                                
                                                let comparisonTaxDisplay = '';
                                                if (entry.isInputIncomeRow) {
                                                    comparisonTaxDisplay = '';
                                                } else if (isPersonalAllowanceRow) {
                                                    comparisonTaxDisplay = '¬£0';
                                                } else if (!hasCategoryComparisonIncome) {
                                                    comparisonTaxDisplay = '';
                                                } else if (comparisonIncomeValue > 0) {
                                                    comparisonTaxDisplay = entry.comparisonTax !== null && entry.comparisonTax !== undefined ? '¬£' + Math.round(entry.comparisonTax).toLocaleString('en-GB') : '';
                                                } else {
                                                    comparisonTaxDisplay = '¬£0';
                                                }
                    
                                // Calculate rate display for main and comparison
                                // Use separate rates for main and comparison, with fallback to shared rate
                                const mainRateToDisplay = entry.mainRate !== null && entry.mainRate !== undefined ? entry.mainRate : entry.rate;
                                const comparisonRateToDisplay = entry.comparisonRate !== null && entry.comparisonRate !== undefined ? entry.comparisonRate : entry.rate;
                                
                                const mainRateDisplay = entry.isInputIncomeRow
                                    ? ''
                                    : (isPersonalAllowanceRow 
                                        ? '0%'
                                        : (!hasCategoryMainIncome
                                            ? ''
                                            : (mainIncomeValue > 0
                                                ? formatRatePercentage(mainRateToDisplay)
                                                : '0%')));
                                
                                const comparisonRateDisplay = entry.isInputIncomeRow
                                    ? ''
                                    : (isPersonalAllowanceRow
                                        ? '0%'
                                        : (!hasCategoryComparisonIncome
                                            ? ''
                                            : (comparisonIncomeValue > 0
                                                ? formatRatePercentage(comparisonRateToDisplay)
                                                : '0%')));
                    
                                // Alternate stripe colors for rows (even index = bg, odd index = stripe)
                                const rowBgColor = index % 2 === 0 ? categoryColor.bg : categoryColor.stripe;
                            
                        breakdownHtml += `
                                    <div class="income-tax-comparison-row income-tax-comparison-row-band" 
                                         data-category-parent="${categoryKey}"
                                         style="background-color: ${rowBgColor}; border-left: 3px solid ${categoryColor.border};">
                                        <div class="income-tax-comparison-cell income-tax-comparison-cell-band">${displayBandLabel}</div>
                                        <div class="income-tax-comparison-cell">${mainIncomeDisplay}</div>
                                        <div class="income-tax-comparison-cell income-tax-comparison-cell-rate">${mainRateDisplay}</div>
                                        <div class="income-tax-comparison-cell">${mainTaxDisplay}</div>
                                        <div class="income-tax-comparison-cell">${comparisonIncomeDisplay}</div>
                                        <div class="income-tax-comparison-cell income-tax-comparison-cell-rate">${comparisonRateDisplay}</div>
                                        <div class="income-tax-comparison-cell">${comparisonTaxDisplay}</div>
                                        <div class="income-tax-comparison-cell income-tax-comparison-cell-diff ${bandDiffClass}">${entry.isInputIncomeRow ? '' : (bandDiffTax === 0 ? '¬£0' : `¬£${Math.round(Math.abs(bandDiffTax)).toLocaleString('en-GB')}`)}</div>
                            </div>
                            `;
                            });
                            
                            // Category subtotal row (only show if more than one band row)
                            if (rows.length > 1) {
                                const mainSubtotalDisplay = categoryMainIncome > 0
                                    ? `¬£${Math.round(categoryMainTax).toLocaleString('en-GB')}`
                                    : '';
                                const comparisonSubtotalDisplay = categoryComparisonIncome > 0
                                    ? `¬£${Math.round(categoryComparisonTax).toLocaleString('en-GB')}`
                                    : '';

                                breakdownHtml += `
                                    <div class="income-tax-comparison-row income-tax-comparison-row-subtotal" 
                                         data-category-parent="${categoryKey}"
                                         style="background-color: ${categoryColor.bg}; border-left: 3px solid ${categoryColor.border}; border-top: 1px solid ${categoryColor.border};">
                                        <div class="income-tax-comparison-cell income-tax-comparison-cell-subtotal" style="font-weight: 600;">Subtotal</div>
                                        <div class="income-tax-comparison-cell income-tax-comparison-cell-subtotal"></div>
                                        <div class="income-tax-comparison-cell income-tax-comparison-cell-empty income-tax-comparison-cell-rate" style="background-color: ${categoryColor.subtotalEmpty};"></div>
                                        <div class="income-tax-comparison-cell income-tax-comparison-cell-subtotal">${mainSubtotalDisplay}</div>
                                        <div class="income-tax-comparison-cell income-tax-comparison-cell-subtotal"></div>
                                        <div class="income-tax-comparison-cell income-tax-comparison-cell-empty income-tax-comparison-cell-rate" style="background-color: ${categoryColor.subtotalEmpty};"></div>
                                        <div class="income-tax-comparison-cell income-tax-comparison-cell-subtotal">${comparisonSubtotalDisplay}</div>
                                        <div class="income-tax-comparison-cell income-tax-comparison-cell-subtotal ${categoryDiffClass}">${originalCategoryDiffTax === 0 ? '¬£0' : `¬£${Math.round(Math.abs(originalCategoryDiffTax)).toLocaleString('en-GB')}`}</div>
                            </div>
                        `;
                    }
                        });
                    
                        // Empty row before grand total
                    breakdownHtml += `
                        `;
                    
                        const grandDiffTax = grandComparisonTax - grandMainTax;
                        const grandDiffClass = grandDiffTax > 0 ? 'income-tax-comparison-diff-negative' : (grandDiffTax < 0 ? 'income-tax-comparison-diff-positive' : 'income-tax-comparison-diff-neutral');
                            
                            breakdownHtml += `
                                <div class="income-tax-comparison-row income-tax-comparison-row-grand-total">
                                    <div class="income-tax-comparison-cell income-tax-comparison-cell-grand-label">TOTAL</div>
                                    <div class="income-tax-comparison-cell">¬£${Math.round(grandMainIncome).toLocaleString('en-GB')}</div>
                                    <div class="income-tax-comparison-cell income-tax-comparison-cell-empty income-tax-comparison-cell-rate"></div>
                                    <div class="income-tax-comparison-cell">¬£${Math.round(grandMainTax).toLocaleString('en-GB')}</div>
                                    <div class="income-tax-comparison-cell">¬£${Math.round(grandComparisonIncome).toLocaleString('en-GB')}</div>
                                    <div class="income-tax-comparison-cell income-tax-comparison-cell-empty income-tax-comparison-cell-rate"></div>
                                    <div class="income-tax-comparison-cell">¬£${Math.round(grandComparisonTax).toLocaleString('en-GB')}</div>
                                    <div class="income-tax-comparison-cell income-tax-comparison-cell-grand-diff ${grandDiffClass}">${grandDiffTax === 0 ? '¬£0' : `¬£${Math.round(Math.abs(grandDiffTax)).toLocaleString('en-GB')}`}</div>
                            </div>
                        </div>
                    `;
                        }
                } else {
                        // No comparison data yet - show loading state (never leave blank)
                        breakdownHtml = `
                            <div style="padding: 40px 20px; text-align: center; color: #6b7280;">
                                <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid #e5e7eb; border-top-color: var(--income-tax-primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 8px;"></div>
                                <div style="font-size: 13px;">Loading comparison‚Ä¶</div>
                        </div>
                    `;
                    }
                } else {
                    // Normal mode: Single year styled table (same format as comparison table)
                    const mainBreakdown = calc.breakdown || [];
                    const mainTaxYear = formatTaxYearLabel(calc.taxYear);
                    
                    // Detect mobile viewport
                    const isMobile = window.innerWidth <= 768;
                    
                    if (mainBreakdown.length > 0) {
                        // Helper: normalise band into category + band label
                        const getCategoryAndBand = (row) => {
                            const band = row.band || '';
                            let category = 'Other Income Tax';
                            let bandLabel = '';
                            
                            if (/^Non-Saving:/i.test(band) || /Non-Saving Income Tax/i.test(band)) {
                                category = 'Non-Saving Income Tax';
                                bandLabel = band.split(':')[1]?.trim() || '';
                            } else if (/^Property:/i.test(band) || /Property Income Tax/i.test(band)) {
                                category = 'Property Income Tax';
                                bandLabel = band.split(':')[1]?.trim() || '';
                            } else if (/^Savings:/i.test(band) || /Savings Income Tax/i.test(band)) {
                                category = 'Savings Income Tax';
                                bandLabel = band.split(':')[1]?.trim() || '';
                            } else if (/^Dividend:/i.test(band) || /Dividend Income Tax/i.test(band)) {
                                category = 'Dividend Income Tax';
                                bandLabel = band.split(':')[1]?.trim() || '';
                            } else {
                                category = 'Other Income Tax';
                                bandLabel = band;
                            }
                            
                            // Normalize band names to include "Rate" for all bands
                            const bandLower = bandLabel.toLowerCase();
                            if (bandLower.includes('nil')) {
                                bandLabel = 'Nil Rate';
                            } else if (bandLower.includes('starting')) {
                                bandLabel = 'Starting Rate';
                            } else if (bandLower.includes('basic')) {
                                bandLabel = 'Basic Rate';
                            } else if (bandLower.includes('higher')) {
                                bandLabel = 'Higher Rate';
                            } else if (bandLower.includes('additional')) {
                                bandLabel = 'Additional Rate';
                            } else {
                                // Keep as-is for other labels (like Personal Allowance)
                                bandLabel = bandLabel.trim();
                            }
                            
                            return { category, bandLabel };
                        };
                        
                        // Process rows into category + band structure
                        const rowMap = new Map();
                        mainBreakdown.forEach(row => {
                            const { category, bandLabel } = getCategoryAndBand(row);
                            
                            // Filter out Nil rate bands from Non-Saving Income Tax category (they don't exist in non-saving income)
                            if (category === 'Non-Saving Income Tax' && (bandLabel.toLowerCase().includes('nil') || bandLabel.toLowerCase().includes('nil rate'))) {
                                return; // Skip this row
                            }
                            
                            const amount = row.amount || 0;
                            const tax = row.tax || 0;
                            const rate = row.rate || 0;
                            const allowanceReduction = row.allowanceReduction || 0;
                            const maxThreshold = row.maxThreshold || null;
                            const key = `${category}||${bandLabel || 'Total'}`;
                            
                            if (!rowMap.has(key)) {
                                rowMap.set(key, {
                                    category,
                                    bandLabel,
                                    income: 0,
                                    tax: 0,
                                    rate: rate || 0,
                                    allowanceReduction: 0,
                                    maxThreshold: null
                                });
                            }
                            
                            const entry = rowMap.get(key);
                            if (!entry.rate && rate) {
                                entry.rate = rate;
                            }
                            // Preserve maxThreshold if available
                            if (maxThreshold !== null && maxThreshold !== undefined && entry.maxThreshold === null) {
                                entry.maxThreshold = maxThreshold;
                            }
                            // Preserve allowance reduction
                            if (allowanceReduction > 0) {
                                entry.allowanceReduction = allowanceReduction;
                            }
                            entry.income += amount;
                            entry.tax += tax;
                        });
                        
                        // Group by category for ordered rendering
                        const categoryOrder = ['Non-Saving Income Tax', 'Property Income Tax', 'Savings Income Tax', 'Dividend Income Tax', 'Other Income Tax'];
                        const grouped = {};
                        rowMap.forEach(entry => {
                            if (!grouped[entry.category]) grouped[entry.category] = [];
                            grouped[entry.category].push(entry);
                        });
                        
                        // Add Personal Allowance rows for categories where allowance is applied
                        // Use allowanceBreakdown from API response
                        const allowanceBreakdown = calc.allowanceBreakdown || {};
                        
                        categoryOrder.forEach(categoryName => {
                            const rows = grouped[categoryName];
                            if (!rows || rows.length === 0) return;
                            
                            // Get allowance amount from allowanceBreakdown for this category
                            let categoryAllowance = 0;
                            let categoryIncome = 0; // Input income for this category
                            
                            if (categoryName === 'Non-Saving Income Tax') {
                                // Calculate non-saving income for input income row
                                const taxYearStr = String(calc.taxYear || '').trim();
                                const isNewPropertyTreatment = taxYearStr === "2027" || 
                                    taxYearStr === "2027/2028" ||
                                    taxYearStr === "2027-2028" ||
                                    /^2027[/-]2028$/.test(taxYearStr);
                                categoryIncome = isNewPropertyTreatment
                                    ? (calc.tradingIncome || 0) + (calc.employmentIncome || 0)
                                    : (calc.propertyIncome || 0) + (calc.tradingIncome || 0) + (calc.employmentIncome || 0);
                                
                                // Personal Allowance should show the actual income amount used (min of income and allowance)
                                // This is the amount actually deducted from income
                                categoryAllowance = Math.min(categoryIncome, allowanceBreakdown.alloForNonSaving || 0);
                            } else if (categoryName === 'Property Income Tax') {
                                categoryIncome = calc.propertyIncome || 0;
                                categoryAllowance = allowanceBreakdown.alloForProperty || 0;
                            } else if (categoryName === 'Savings Income Tax') {
                                categoryIncome = calc.savingIncome || 0;
                                categoryAllowance = allowanceBreakdown.alloForSaving || 0;
                            } else if (categoryName === 'Dividend Income Tax') {
                                categoryIncome = calc.dividendIncome || 0;
                                categoryAllowance = allowanceBreakdown.alloForDividend || 0;
                            }
                            
                            // If allowance is applied in this category, add a Personal Allowance row
                            if (categoryAllowance > 0) {
                                // For Savings and Dividend, show "Remaining Personal Allowance" instead of "Personal Allowance"
                                const allowanceLabel = (categoryName === 'Savings Income Tax' || categoryName === 'Dividend Income Tax')
                                    ? 'Remaining Personal Allowance'
                                    : 'Personal Allowance';
                                
                                // Insert Personal Allowance row
                                rows.unshift({
                                    category: categoryName,
                                    bandLabel: allowanceLabel,
                                    income: categoryAllowance,
                                    tax: 0,
                                    rate: 0,
                                    allowanceReduction: 0,
                                    isPersonalAllowanceRow: true
                                });
                            }
                            
                            // (Removed) Category-income band row: we now show the category input income in the category header row.
                            
                            // For Non-Saving Income Tax: If income is fully covered by allowance, add Basic band with ¬£0
                            // This shows that the income falls within Basic rate but is fully covered by allowance
                            if (categoryName === 'Non-Saving Income Tax') {
                                const hasBasicBand = rows.some(r => r.bandLabel && (r.bandLabel.toLowerCase().includes('basic')));
                                const netIncome = categoryIncome - categoryAllowance;
                                
                                // If no Basic band exists and income is fully covered (net income is 0 or less), add Basic band with ¬£0
                                if (!hasBasicBand && categoryIncome > 0 && netIncome <= 0) {
                                    // Get basic rate from tables if available
                                    let basicRate = 0.20; // Default 20%
                                    let basicBandThreshold = 37700; // Default threshold
                                    
                                    // Try to get rate from tables
                                    if (calc.tables && calc.tables.nonSavingIncomeTax && calc.tables.nonSavingIncomeTax.length > 0) {
                                        const basicBandRow = calc.tables.nonSavingIncomeTax.find(b => b.band && b.band.toLowerCase().includes('basic'));
                                        if (basicBandRow) {
                                            basicRate = basicBandRow.rate || 0.20;
                                            basicBandThreshold = basicBandRow.maxThreshold || 37700;
                                        }
                                    }
                                    
                                    rows.push({
                                        category: categoryName,
                                        bandLabel: 'Basic Rate',
                                        income: 0,
                                        tax: 0,
                                        rate: basicRate,
                                        allowanceReduction: 0,
                                        maxThreshold: basicBandThreshold,
                                        isDisplayOnly: true // Mark as display-only, exclude from subtotals
                                    });
                                }
                            }
                            
                            // For Savings Income Tax: If income is fully covered by allowance and zero-rate bands, add Basic band
                            // This shows that the income would fall within Basic rate but is fully covered
                            if (categoryName === 'Savings Income Tax') {
                                const hasBasicBand = rows.some(r => r.bandLabel && (r.bandLabel.toLowerCase().includes('basic')));
                                const netIncome = categoryIncome - categoryAllowance;
                                
                                // Calculate total income in zero-rate bands (Starting Rate, Nil Rate/PSA)
                                const zeroRateIncome = rows
                                    .filter(r => !r.isPersonalAllowanceRow && ((r.bandLabel || '').toLowerCase().includes('starting') || (r.bandLabel || '').toLowerCase().includes('nil rate')))
                                    .reduce((sum, r) => sum + (r.income || 0), 0);
                                
                                // Net income after allowance and zero-rate bands
                                const remainingAfterZeroRate = netIncome - zeroRateIncome;
                                
                                // If no Basic band exists and income is fully covered (remaining after zero-rate is 0 or less), add Basic band
                                // Show the full input income amount in Basic Rate (not just the zero-rate amount)
                                if (!hasBasicBand && categoryIncome > 0 && remainingAfterZeroRate <= 0) {
                                    // Get basic rate from tables if available
                                    let basicRate = 0.20; // Default 20%
                                    let basicBandThreshold = 37700; // Default threshold
                                    
                                    // Try to get rate from tables
                                    if (calc.tables && calc.tables.savingIncomeTax && calc.tables.savingIncomeTax.length > 0) {
                                        const basicBandRow = calc.tables.savingIncomeTax.find(b => b.band && b.band.toLowerCase().includes('basic'));
                                        if (basicBandRow) {
                                            basicRate = basicBandRow.rate || 0.20;
                                            basicBandThreshold = basicBandRow.maxThreshold || 37700;
                                        }
                                    }
                                    
                                    // Show the full input income amount (the amount that would fall in Basic band)
                                    // This is the minimum of the input income and the Basic band threshold
                                    const basicBandIncome = Math.min(categoryIncome, basicBandThreshold);
                                    
                                    rows.push({
                                        category: categoryName,
                                        bandLabel: 'Basic Rate',
                                        income: basicBandIncome,
                                        tax: 0,
                                        rate: basicRate,
                                        allowanceReduction: 0,
                                        maxThreshold: basicBandThreshold,
                                        isDisplayOnly: true // Mark as display-only, exclude from subtotals
                                    });
                                }
                            }
                        });
                        
                        let grandIncome = 0;
                        let grandTax = 0;
                        
                        // Color mapping for each category (same as comparison table)
                        const categoryColors = {
                            'Non-Saving Income Tax': { bg: '#fef9e7', border: '#fde68a', empty: '#fef3c7', header: '#fde68a', subtotalEmpty: '#fef9e7', stripe: '#fefbf0' },
                            'Property Income Tax': { bg: '#eff6ff', border: '#bfdbfe', empty: '#dbeafe', header: '#bfdbfe', subtotalEmpty: '#eff6ff', stripe: '#f5f9ff' },
                            'Savings Income Tax': { bg: '#f5f3ff', border: '#ddd6fe', empty: '#e9d5ff', header: '#ddd6fe', subtotalEmpty: '#f5f3ff', stripe: '#faf8ff' },
                            'Dividend Income Tax': { bg: '#fdf2f8', border: '#fbcfe8', empty: '#fce7f3', header: '#fbcfe8', subtotalEmpty: '#fdf2f8', stripe: '#fef7fb' },
                            'Other Income Tax': { bg: '#f9fafb', border: '#e5e7eb', empty: '#f3f4f6', header: '#e5e7eb', subtotalEmpty: '#f9fafb', stripe: '#fbfcfd' }
                        };
                        
                        // Mobile card layout
                        if (isMobile) {
                            breakdownHtml = '<div class="income-tax-comparison-mobile-wrapper">';
                            
                            categoryOrder.forEach(categoryName => {
                                const rows = grouped[categoryName];
                                if (!rows || rows.length === 0) return;
                                const categoryKey = categoryName.toLowerCase().replace(/[^a-z0-9]+/g, '-');
                                
                                // Calculate category totals
                                let categoryIncome = 0;
                                let categoryTax = 0;
                                
                                // Calculate net income (input income - personal allowance) for display in category label
                                let netIncome = 0;
                                
                                rows.forEach(entry => {
                                    // For Input Income rows, capture the input income
                                    if (entry.isInputIncomeRow) {
                                        netIncome = entry.income || 0;
                                    }
                                    // For Personal Allowance rows, subtract from net income
                                    if (entry.isPersonalAllowanceRow) {
                                        netIncome -= (entry.income || 0);
                                    }
                                    
                                    // Exclude Personal Allowance, Input Income, and display-only rows from totals (they're just for display)
                                    if (!entry.isPersonalAllowanceRow && !entry.isInputIncomeRow && !entry.isDisplayOnly) {
                                        categoryIncome += entry.income;
                                        categoryTax += entry.tax;
                                    }
                                });
                                
                                // If net income is 0 or less (fully eliminated by allowance), set subtotal to 0
                                if (netIncome <= 0) {
                                    categoryIncome = 0;
                                    categoryTax = 0;
                                }
                                
                                grandIncome += categoryIncome;
                                grandTax += categoryTax;
                                
                                const categoryColor = categoryColors[categoryName] || categoryColors['Other Income Tax'];
                            
                            breakdownHtml += `
                                    <div class="income-tax-comparison-mobile-card" data-category-key="${categoryKey}" style="border-left: 4px solid ${categoryColor.border};">
                                        <div class="income-tax-comparison-mobile-card-header" data-category-toggle="${categoryKey}">
                                            <span class="income-tax-comparison-mobile-toggle-icon">‚ñ∏</span>
                                            <span class="income-tax-comparison-mobile-card-title">${categoryName}</span>
                                        </div>
                                        <div class="income-tax-comparison-mobile-card-summary">
                                            <div class="income-tax-comparison-mobile-summary-row">
                                                <div class="income-tax-comparison-mobile-year">${mainTaxYear}</div>
                                            </div>
                                            <div class="income-tax-comparison-mobile-summary-row">
                                                <div class="income-tax-comparison-mobile-value-group">
                                                    <div class="income-tax-comparison-mobile-label">Income</div>
                                                    <div class="income-tax-comparison-mobile-value">¬£${Math.round(categoryIncome).toLocaleString('en-GB')}</div>
                                                </div>
                                            </div>
                                            <div class="income-tax-comparison-mobile-summary-row">
                                                <div class="income-tax-comparison-mobile-value-group">
                                                    <div class="income-tax-comparison-mobile-label">Tax</div>
                                                    <div class="income-tax-comparison-mobile-value income-tax-comparison-mobile-tax">¬£${Math.round(categoryTax).toLocaleString('en-GB')}</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="income-tax-comparison-mobile-card-details" data-category-details="${categoryKey}" style="display: none;">
                                            ${rows.map(entry => {
                                                let bandLabel = entry.bandLabel || 'Total';
                                                const isPersonalAllowanceRow = entry.isPersonalAllowanceRow || false;
                                                const isPersonalAllowance = (bandLabel.toLowerCase().includes('personal allowance') || bandLabel.toLowerCase().includes('remaining personal allowance')) && !isPersonalAllowanceRow;
                                                
                                                // Skip Nil rate rows for Non-Saving Income Tax category (they don't exist in non-saving income)
                                                if (categoryName === 'Non-Saving Income Tax' && (bandLabel.toLowerCase().includes('nil') || bandLabel.toLowerCase().includes('nil rate'))) {
                                                    return ''; // Skip this row
                                                }
                                                
                                                // If this is an old "Personal Allowance Applied" row (not the new Personal Allowance row), show "Nil" as the band name instead
                                                // But skip it for Non-Saving category
                                                if (isPersonalAllowance) {
                                                    if (categoryName === 'Non-Saving Income Tax') {
                                                        return ''; // Skip old Personal Allowance Applied rows for Non-Saving
                                                    }
                                                    bandLabel = 'Nil Rate';
                                                }
                                                
                                                // Add (0%) for Nil rates, Starting rates, and Personal Allowance (which already has it)
                                                // Remove rates and thresholds from other bands
                                                let rateLabel = '';
                                                if (bandLabel === 'Total') {
                                                    rateLabel = '';
                                                } else if (isPersonalAllowanceRow) {
                                                    // Personal Allowance already has (0%) in the label
                                                    rateLabel = '';
                                                } else if (bandLabel.toLowerCase().includes('nil') || bandLabel.toLowerCase().includes('starting')) {
                                                    rateLabel = ' (0%)';
                                                }
                                                // No rate label for Basic, Higher, Additional bands
                                                
                                                const displayBandLabel = bandLabel === 'Total' ? bandLabel : `${bandLabel}${rateLabel}`;
                                                
                                                // For Personal Allowance rows, show negative allowance amount (deduction) in income and ¬£0 in tax
                                                // For other rows, show the income amount (including ¬£0 if it's 0)
                                                const incomeDisplay = isPersonalAllowanceRow 
                                                    ? (entry.income > 0 ? `-¬£${Math.round(entry.income).toLocaleString('en-GB')}` : '-')
                                                    : (entry.income !== null && entry.income !== undefined ? '¬£' + Math.round(entry.income).toLocaleString('en-GB') : '-');
                                                
                                                const taxDisplay = entry.isInputIncomeRow
                                                    ? ''
                                                    : (isPersonalAllowanceRow 
                                                        ? '¬£0'
                                                        : (isPersonalAllowance && entry.allowanceReduction > 0
                                                            ? `- (Personal Allowance) ¬£${Math.round(entry.allowanceReduction).toLocaleString('en-GB')}`
                                                            : (entry.tax ? '¬£' + Math.round(entry.tax).toLocaleString('en-GB') : '-')));
                                                
                                                return `
                                                    <div class="income-tax-comparison-mobile-band-row">
                                                        <div class="income-tax-comparison-mobile-band-label">${displayBandLabel}</div>
                                                        <div class="income-tax-comparison-mobile-band-values">
                                                            <div class="income-tax-comparison-mobile-band-year-group">
                                                                <div class="income-tax-comparison-mobile-band-year">${mainTaxYear}</div>
                                                                <div class="income-tax-comparison-mobile-band-value">${incomeDisplay}</div>
                                                                <div class="income-tax-comparison-mobile-band-value income-tax-comparison-mobile-tax">${taxDisplay}</div>
                                                            </div>
                                                        </div>
                                </div>
                            `;
                                            }).join('')}
                                        </div>
                                    </div>
                                `;
                            });
                            
                            // Grand total card
                            breakdownHtml += `
                                <div class="income-tax-comparison-mobile-card income-tax-comparison-mobile-total-card">
                                    <div class="income-tax-comparison-mobile-card-title income-tax-comparison-mobile-total-title">TOTAL TAX</div>
                                    <div class="income-tax-comparison-mobile-card-summary">
                                        <div class="income-tax-comparison-mobile-summary-row">
                                            <div class="income-tax-comparison-mobile-year">${mainTaxYear}</div>
                                        </div>
                                        <div class="income-tax-comparison-mobile-summary-row">
                                            <div class="income-tax-comparison-mobile-value-group">
                                                <div class="income-tax-comparison-mobile-label">Tax</div>
                                                <div class="income-tax-comparison-mobile-value income-tax-comparison-mobile-tax income-tax-comparison-mobile-total-value">¬£${Math.round(grandTax).toLocaleString('en-GB')}</div>
                                            </div>
                                        </div>
                                    </div>
                            </div>
                        </div>
                    `;
                } else {
                            // Desktop table layout
                            breakdownHtml = `
                            <div class="income-tax-comparison-table-wrapper income-tax-single-year">
                                <!-- Header rows container with merged Category -->
                                <div class="income-tax-comparison-header-container income-tax-single-year">
                                    <!-- Top header row -->
                                    <div class="income-tax-comparison-header-row income-tax-comparison-header-row-top income-tax-single-year">
                                        <div class="income-tax-comparison-header-cell income-tax-comparison-header-cell-top-category income-tax-comparison-header-cell-merged">Category</div>
                                        <div class="income-tax-comparison-header-cell income-tax-comparison-header-cell-top-year" style="grid-column: 2 / 5; border-bottom:1px solid #bfdbfe;">${mainTaxYear}</div>
                                    </div>
                                    <!-- Sub header row: Income / Rate / Tax labels -->
                                    <div class="income-tax-comparison-header-row income-tax-comparison-header-row-sub income-tax-single-year">
                                        <div class="income-tax-comparison-header-cell">Income</div>
                                        <div class="income-tax-comparison-header-cell income-tax-comparison-header-cell-rate">Rate</div>
                                        <div class="income-tax-comparison-header-cell">Tax</div>
                                    </div>
                                </div>
                    `;
                    
                            categoryOrder.forEach(categoryName => {
                                const rows = grouped[categoryName];
                                if (!rows || rows.length === 0) return;
                                const categoryKey = categoryName.toLowerCase().replace(/[^a-z0-9]+/g, '-');
                                const categoryColor = categoryColors[categoryName] || categoryColors['Other Income Tax'];
                                
                                // Get allowance amount from allowanceBreakdown for this category9
                                let categoryAllowance = 0;
                                if (categoryName === 'Non-Saving Income Tax') {
                                    categoryAllowance = allowanceBreakdown.alloForNonSaving || 0;
                                } else if (categoryName === 'Property Income Tax') {
                                    categoryAllowance = allowanceBreakdown.alloForProperty || 0;
                                } else if (categoryName === 'Savings Income Tax') {
                                    categoryAllowance = allowanceBreakdown.alloForSaving || 0;
                                } else if (categoryName === 'Dividend Income Tax') {
                                    categoryAllowance = allowanceBreakdown.alloForDividend || 0;
                                }
                                
                                // Sort bands: Input Income first, then Personal Allowance, then Nil/Starting rate, then Basic, Higher, Additional
                                rows.sort((a, b) => {
                                    // Input Income rows always come first
                                    if (a.isInputIncomeRow && !b.isInputIncomeRow) return -1;
                                    if (!a.isInputIncomeRow && b.isInputIncomeRow) return 1;

                                    // Personal Allowance rows always come first
                                    if (a.isPersonalAllowanceRow && !b.isPersonalAllowanceRow) return -1;
                                    if (!a.isPersonalAllowanceRow && b.isPersonalAllowanceRow) return 1;
                                    
                                    const bandA = (a.bandLabel || '').toLowerCase();
                                    const bandB = (b.bandLabel || '').toLowerCase();
                                    
                                    const aIsNil = bandA.includes('nil') || bandA.includes('starting');
                                    const bIsNil = bandB.includes('nil') || bandB.includes('starting');
                                    
                                    if (aIsNil && !bIsNil) return -1;
                                    if (!aIsNil && bIsNil) return 1;
                                    
                                    const getBandOrder = (band) => {
                                        if (band.includes('basic')) return 1;
                                        if (band.includes('higher')) return 2;
                                        if (band.includes('additional')) return 3;
                                        return 4;
                                    };
                                    
                                    return getBandOrder(bandA) - getBandOrder(bandB);
                                });
                                
                                let categoryIncome = 0;
                                let categoryTax = 0;
                                
                                rows.forEach(entry => {
                                    // Exclude Personal Allowance and Input Income rows from totals (they're just for display)
                                    if (!entry.isPersonalAllowanceRow && !entry.isInputIncomeRow) {
                                        categoryIncome += entry.income;
                                        categoryTax += entry.tax;
                                    }
                                });
                                
                                // If income is fully eliminated by allowance (net income is 0 or less), set subtotal to 0
                                // BUT: For Savings and Dividend Income Tax, if there are zero-rate bands (Starting Rate, Nil Rate) 
                                // that show income, we should NOT reset to 0 - show the actual amounts
                                const netCategoryIncome = categoryIncome - categoryAllowance;
                                
                                // Check if there are zero-rate bands with income (Starting Rate, Nil Rate)
                                const hasZeroRateBands = rows.some(entry => {
                                    const bandLabel = (entry.bandLabel || entry.band || '').toLowerCase();
                                    const isZeroRate = (bandLabel.includes('starting') || bandLabel.includes('nil rate')) && 
                                                      !entry.isPersonalAllowanceRow && 
                                                      (entry.income > 0);
                                    return isZeroRate;
                                });
                                
                                // Only reset to 0 if income is fully eliminated by allowance AND there are no zero-rate bands showing income
                                // For Savings and Dividend, zero-rate bands (Starting Rate, Nil Rate) should show their actual income amounts
                                if (netCategoryIncome <= 0 && categoryAllowance > 0 && !hasZeroRateBands) {
                                    categoryIncome = 0;
                                    categoryTax = 0;
                                }
                                
                                grandIncome += categoryIncome;
                                grandTax += categoryTax;
                                
                                // Category header row (label without "Tax"; show input income; keep other cells empty)
                                const categoryLabelNoTax = String(categoryName || '').replace(/\s+Tax\s*$/i, '').trim();
                                let categoryInputIncome = 0;
                                if (categoryName === 'Non-Saving Income Tax') {
                                    const taxYearStr = String(calc.taxYear || '').trim();
                                    const isNewPropertyTreatment = taxYearStr === "2027" || 
                                        taxYearStr === "2027/2028" ||
                                        taxYearStr === "2027-2028" ||
                                        /^2027[/-]2028$/.test(taxYearStr);
                                    categoryInputIncome = isNewPropertyTreatment
                                        ? (calc.tradingIncome || 0) + (calc.employmentIncome || 0)
                                        : (calc.propertyIncome || 0) + (calc.tradingIncome || 0) + (calc.employmentIncome || 0);
                                } else if (categoryName === 'Property Income Tax') {
                                    categoryInputIncome = calc.propertyIncome || 0;
                                } else if (categoryName === 'Savings Income Tax') {
                                    categoryInputIncome = calc.savingIncome || 0;
                                } else if (categoryName === 'Dividend Income Tax') {
                                    categoryInputIncome = calc.dividendIncome || 0;
                                }
                                const categoryInputIncomeDisplay = categoryInputIncome > 0 ? `¬£${Math.round(categoryInputIncome).toLocaleString('en-GB')}` : '';
                                // Subtotal tax display for category header row (shown when minimized)
                                const subtotalTaxDisplay = categoryTax > 0 ? `¬£${Math.round(categoryTax).toLocaleString('en-GB')}` : '';
                            breakdownHtml += `
                                    <div class="income-tax-comparison-row income-tax-comparison-row-category" 
                                         data-category-key="${categoryKey}"
                                         data-income="${categoryIncome}"
                                         data-tax="${categoryTax}"
                                         style="background-color: ${categoryColor.header}; border-left: 3px solid ${categoryColor.border};">
                                        <div class="income-tax-comparison-cell income-tax-comparison-cell-category">
                                            <span class="income-tax-comparison-toggle-icon">‚ñæ</span>
                                            <span>${categoryLabelNoTax}</span>
                                        </div>
                                        <div class="income-tax-comparison-cell income-tax-comparison-cell-category-value" style="background-color: ${categoryColor.header};">
                                            ${categoryInputIncomeDisplay}
                                        </div>
                                        <div class="income-tax-comparison-cell income-tax-comparison-cell-category-value income-tax-comparison-cell-rate" style="background-color: ${categoryColor.header};">
                                            ${''}
                                        </div>
                                        <div class="income-tax-comparison-cell income-tax-comparison-cell-category-value" style="background-color: ${categoryColor.header};">
                                            ${subtotalTaxDisplay}
                                        </div>
                                </div>
                            `;
                                
                                // Band rows within the category
                                rows.forEach((entry, index) => {
                                    let bandLabel = entry.bandLabel || 'Total';
                                    const isPersonalAllowanceRow = entry.isPersonalAllowanceRow || false;
                                    const isPersonalAllowance = bandLabel.toLowerCase().includes('personal allowance') && !isPersonalAllowanceRow;
                                    
                                    // Skip Nil rate rows for Non-Saving Income Tax category (they don't exist in non-saving income)
                                    if (categoryName === 'Non-Saving Income Tax' && (bandLabel.toLowerCase().includes('nil') || bandLabel.toLowerCase().includes('nil rate'))) {
                                        return; // Skip this row
                                    }
                                    
                                    // If this is an old "Personal Allowance Applied" row (not the new Personal Allowance row), show "Nil Rate" as the band name instead
                                    // But skip it for Non-Saving category
                                    if (isPersonalAllowance) {
                                        if (categoryName === 'Non-Saving Income Tax') {
                                            return; // Skip old Personal Allowance Applied rows for Non-Saving
                                        }
                                        bandLabel = 'Nil Rate';
                                    }
                                    
                                    // Remove rate and threshold labels - just show the band name
                                    const baseBandLabel = bandLabel === 'Total' ? bandLabel : bandLabel;
                                    
                                    // For Personal Allowance rows, show negative allowance amount (deduction) in income and ¬£0 in tax
                                    // For Personal Allowance rows, show negative allowance amount (deduction) in income and ¬£0 in tax
                                    // For other rows, show the income amount (including ¬£0 if it's 0)
                                    // For the category-income row, show the category name without "Tax" instead of the literal label
                                    const categoryLabelNoTax = String(categoryName || '')
                                        .replace(/\s+Tax\s*$/i, '')
                                        .replace(/\s+Income\s*$/i, ' Income')
                                        .trim();
                                    const finalBandLabel = (entry.isInputIncomeRow && categoryLabelNoTax)
                                        ? categoryLabelNoTax
                                        : baseBandLabel;

                                    // If Personal Allowance fully covers input, show ¬£0 for subsequent taxable-rate bands (math-correct)
                                    const fullyCoveredByAllowance = (categoryIncome - categoryAllowance) <= 0;
                                    const isTaxableRateBand = ['basic rate', 'higher rate', 'additional rate'].includes(String(finalBandLabel).toLowerCase());
                                    const incomeValue = (!isPersonalAllowanceRow && !entry.isInputIncomeRow && fullyCoveredByAllowance && isTaxableRateBand) ? 0 : entry.income;

                                    const incomeDisplay = entry.isInputIncomeRow
                                        ? (incomeValue > 0 ? '¬£' + Math.round(incomeValue).toLocaleString('en-GB') : '')
                                        : (isPersonalAllowanceRow 
                                            ? (entry.income > 0 ? `-¬£${Math.round(entry.income).toLocaleString('en-GB')}` : '-')
                                            : (incomeValue !== null && incomeValue !== undefined ? '¬£' + Math.round(incomeValue).toLocaleString('en-GB') : '-'));

                                    let rateDisplay = '';
                                    if (!entry.isInputIncomeRow) {
                                        if (isPersonalAllowanceRow) {
                                            rateDisplay = '0%';
                                        } else if (entry.rate !== null && entry.rate !== undefined) {
                                            rateDisplay = formatRatePercentage(entry.rate);
                                        }
                                    }

                                    const taxDisplay = entry.isInputIncomeRow
                                        ? ''
                                        : (isPersonalAllowanceRow 
                                            ? '¬£0'
                                            : (entry.tax !== null && entry.tax !== undefined ? '¬£' + Math.round(entry.tax).toLocaleString('en-GB') : '-'));
                                    
                                    // Alternate stripe colors for rows (even index = bg, odd index = stripe)
                                    const rowBgColor = index % 2 === 0 ? categoryColor.bg : categoryColor.stripe;
                                
                                    breakdownHtml += `
                                        <div class="income-tax-comparison-row income-tax-comparison-row-band" 
                                             data-category-parent="${categoryKey}"
                                             style="background-color: ${rowBgColor}; border-left: 3px solid ${categoryColor.border};">
                                            <div class="income-tax-comparison-cell income-tax-comparison-cell-band">${finalBandLabel}</div>
                                            <div class="income-tax-comparison-cell">${incomeDisplay}</div>
                                            <div class="income-tax-comparison-cell income-tax-comparison-cell-rate">${rateDisplay}</div>
                                            <div class="income-tax-comparison-cell">${taxDisplay}</div>
                                        </div>
                                    `;
                                });
                                
                                // Category subtotal row (only show if more than one band row)
                                if (rows.length > 1) {
                                    const subtotalTaxDisplay = categoryTax > 0 ? `¬£${Math.round(categoryTax).toLocaleString('en-GB')}` : '';
                                    breakdownHtml += `
                                        <div class="income-tax-comparison-row income-tax-comparison-row-subtotal" 
                                             data-category-parent="${categoryKey}"
                                             style="background-color: ${categoryColor.bg}; border-left: 3px solid ${categoryColor.border}; border-top: 1px solid ${categoryColor.border};">
                                            <div class="income-tax-comparison-cell income-tax-comparison-cell-subtotal" style="font-weight: 600;">Subtotal</div>
                                            <div class="income-tax-comparison-cell income-tax-comparison-cell-subtotal"></div>
                                            <div class="income-tax-comparison-cell income-tax-comparison-cell-subtotal income-tax-comparison-cell-rate"></div>
                                            <div class="income-tax-comparison-cell income-tax-comparison-cell-subtotal">${subtotalTaxDisplay}</div>
                                        </div>
                                    `;
                                }
                            });
                            
                            // Empty row before grand total
                            breakdownHtml += `
                                <div class="income-tax-comparison-row" style="background-color: transparent; height: 8px;"></div>
                            `;
                            
                            // Grand total row
                            breakdownHtml += `
                                <div class="income-tax-comparison-row income-tax-comparison-row-grand-total">
                                    <div class="income-tax-comparison-cell income-tax-comparison-cell-grand-label">TOTAL TAX</div>
                                    <div class="income-tax-comparison-cell">¬£${Math.round(grandIncome).toLocaleString('en-GB')}</div>
                                    <div class="income-tax-comparison-cell income-tax-comparison-cell-rate"></div>
                                    <div class="income-tax-comparison-cell">¬£${Math.round(grandTax).toLocaleString('en-GB')}</div>
                                </div>
                            </div>
                        `;
                        }
                    } else {
                        breakdownHtml = '<div class="income-tax-empty-state-text" style="padding: 20px; text-align: center; color: #6b7280;">No breakdown data available</div>';
                    }
                }
                
                // Update with new content or show empty state
                const breakdownForTable = calc.breakdown || [];
                if (breakdownForTable.length > 0 || showComparison) {
                    // Defensive: never render empty when comparison toggle is on
                    breakdownTableEl.innerHTML = breakdownHtml || `
                        <div style="padding: 40px 20px; text-align: center; color: #6b7280;">
                            <div style="font-size: 13px;">No breakdown to display.</div>
                        </div>
                    `;

                    // Attach collapse/expand behaviour for table categories (comparison + normal mode)
                    const categoryRows = breakdownTableEl.querySelectorAll('.income-tax-comparison-row-category');
                    categoryRows.forEach(row => {
                        const categoryKey = row.getAttribute('data-category-key');
                        if (!categoryKey) return;
                        const toggleIcon = row.querySelector('.income-tax-comparison-toggle-icon');

                        row.addEventListener('click', () => {
                            const isCollapsed = row.classList.toggle('is-collapsed');
                            const bandRows = breakdownTableEl.querySelectorAll(`.income-tax-comparison-row-band[data-category-parent="${categoryKey}"]`);
                            const subtotalRows = breakdownTableEl.querySelectorAll(`.income-tax-comparison-row-subtotal[data-category-parent="${categoryKey}"]`);
                            
                            // In minimised view we hide detailed band rows and subtotal row
                            // since the subtotal is already shown in the category header row
                            if (isCollapsed) {
                                // Hide all band rows and subtotal rows when collapsed
                                bandRows.forEach(bandRow => {
                                    bandRow.style.display = 'none';
                                });
                                subtotalRows.forEach(subtotalRow => {
                                    subtotalRow.style.display = 'none';
                                });
                            } else {
                                // Show all band rows and subtotal rows when expanded
                                bandRows.forEach(bandRow => {
                                    bandRow.style.display = 'grid';
                                });
                                subtotalRows.forEach(subtotalRow => {
                                    subtotalRow.style.display = 'grid';
                                });
                            }

                            if (toggleIcon) {
                                toggleIcon.textContent = isCollapsed ? '‚ñ∏' : '‚ñæ';
                            }
                        });
                    });
                    
                    // Attach collapse/expand behaviour for mobile cards (works for both comparison and normal mode)
                    const mobileCardHeaders = breakdownTableEl.querySelectorAll('.income-tax-comparison-mobile-card-header');
                    mobileCardHeaders.forEach(header => {
                        const categoryKey = header.getAttribute('data-category-toggle');
                        if (!categoryKey) return;
                        const toggleIcon = header.querySelector('.income-tax-comparison-mobile-toggle-icon');
                        const detailsSection = breakdownTableEl.querySelector(`[data-category-details="${categoryKey}"]`);
                        
                        header.addEventListener('click', () => {
                            const isCollapsed = detailsSection.style.display === 'none';
                            detailsSection.style.display = isCollapsed ? 'block' : 'none';
                            
                            if (toggleIcon) {
                                toggleIcon.textContent = isCollapsed ? '‚ñæ' : '‚ñ∏';
                            }
                        });
                    });

                    // Restore visibility after updating content
                    breakdownTableEl.style.opacity = '1';
                    breakdownTableEl.style.pointerEvents = 'auto';
                    
                    // Ensure breakdown loader is hidden
                    const breakdownLoader = document.getElementById('income-tax-breakdownLoader');
                    if (breakdownLoader) {
                        breakdownLoader.style.display = 'none';
                    }
                } else {
                    breakdownTableEl.innerHTML = '<div class="income-tax-empty-state-text" style="padding: 20px; text-align: center; color: #6b7280;">No breakdown data available</div>';
                    // Restore visibility even for empty state
                    breakdownTableEl.style.opacity = '1';
                    breakdownTableEl.style.pointerEvents = 'auto';
                    
                    // Ensure breakdown loader is hidden
                    const breakdownLoader = document.getElementById('income-tax-breakdownLoader');
                    if (breakdownLoader) {
                        breakdownLoader.style.display = 'none';
                    }
                }
            }

            // Update summary (only if elements exist - Breakdown tab)
            const summaryGrossIncome = document.getElementById('income-tax-summaryGrossIncome');
            const summaryDeductions = document.getElementById('income-tax-summaryDeductions');
            const summaryTaxableIncome = document.getElementById('income-tax-summaryTaxableIncome');
            const summaryFederalTax = document.getElementById('income-tax-summaryFederalTax');
            
            if (summaryGrossIncome) {
                const displayValue = calc.annualRentalIncome || calc.netIncome || 0;
                summaryGrossIncome.textContent = '¬£' + (displayValue || 0).toLocaleString('en-GB');
            }
            if (summaryDeductions) summaryDeductions.textContent = 'Income Tax';
            if (summaryTaxableIncome) summaryTaxableIncome.textContent = calc.propertyType || 'N/A';
            if (summaryFederalTax) summaryFederalTax.textContent = '¬£' + (totalTax || 0).toLocaleString('en-GB');
            
            // Update calculation description (Breakdown tab)
            updateCalculationDescription(calc, totalTax);
            
            // Re-apply copy prevention after display updates (in case new elements were added)
            setTimeout(() => {
                preventCopyFromResults();
            }, 100);
        }

        // Update calculation description with actual calculation details
        function updateCalculationDescription(calc, totalTax) {
                // Don't update if calculation is in progress
                if (state.isCalculating) {
                    return;
                }
                
                // Get elements first
                const descriptionEl = document.getElementById('income-tax-calculationDescriptionText');
                const explanationCard = document.getElementById('income-tax-calculationDescription');
                const toggleTextEl = document.getElementById('income-tax-calculationExplanationToggleText');
                const toggleIconEl = document.getElementById('income-tax-calculationExplanationToggleIcon');
                
                // Ensure card is collapsed BEFORE updating content to prevent showing empty content
                if (explanationCard) {
                    explanationCard.classList.add('income-tax-collapsed');
                    if (toggleTextEl) toggleTextEl.textContent = 'Show explanation';
                    if (toggleIconEl) toggleIconEl.textContent = '+';
                }
                
            // Ensure simple mode loader stays hidden when updating content
            if (!state.aiMode) {
                const simpleLoader = document.getElementById('income-tax-simpleModeLoader');
                if (simpleLoader) {
                    simpleLoader.classList.remove('active');
                    simpleLoader.style.cssText = 'display: none !important; visibility: hidden; opacity: 0; z-index: -1;';
                }
                const simpleResultsGrid = document.getElementById('income-tax-simpleResultsGrid');
                if (simpleResultsGrid) {
                    simpleResultsGrid.style.opacity = '1';
                    simpleResultsGrid.style.pointerEvents = 'auto';
                }
            }
                
            const methodTextEl = document.getElementById('income-tax-calculationMethodText');
            
            // Update calculation method in "How We Calculated" section
            if (methodTextEl && calc && calc.breakdown) {
                // Get total income from calculation
                const totalIncome = calc.totalIncome || 0;
                const displayIncome = totalIncome.toLocaleString('en-GB');
                const breakdownCount = calc.breakdown.length;
                const taxYear = calc.taxYear || '2025';
                const taxYearLabel = taxYear.includes('/') ? taxYear : `${taxYear}/${parseInt(taxYear) + 1}`;
                
                // Count income types
                const incomeTypes = {
                    nonSaving: 0,
                    property: 0,
                    savings: 0,
                    dividend: 0
                };
                
                calc.breakdown.forEach(band => {
                    const bandName = (band.band || '').toLowerCase();
                    if (bandName.includes('non-saving')) incomeTypes.nonSaving++;
                    else if (bandName.includes('property')) incomeTypes.property++;
                    else if (bandName.includes('savings')) incomeTypes.savings++;
                    else if (bandName.includes('dividend')) incomeTypes.dividend++;
                });
                
                const activeIncomeTypes = Object.values(incomeTypes).filter(count => count > 0).length;
                const incomeTypeNames = [];
                if (incomeTypes.nonSaving > 0) incomeTypeNames.push('Non-Saving Income');
                if (incomeTypes.property > 0) incomeTypeNames.push('Property Income');
                if (incomeTypes.savings > 0) incomeTypeNames.push('Savings Income');
                if (incomeTypes.dividend > 0) incomeTypeNames.push('Dividend Income');
                
                // Build income type description
                let incomeTypeDesc = '';
                if (incomeTypeNames.length === 1) {
                    incomeTypeDesc = incomeTypeNames[0];
                } else if (incomeTypeNames.length === 2) {
                    incomeTypeDesc = `${incomeTypeNames[0]} and ${incomeTypeNames[1]}`;
                } else if (incomeTypeNames.length > 2) {
                    incomeTypeDesc = incomeTypeNames.slice(0, -1).join(', ') + ', and ' + incomeTypeNames[incomeTypeNames.length - 1];
                }
                
                // ‚úÖ Income Tax calculation description
                let methodText = `<p style="margin-bottom: 12px;">For total income of <strong>¬£${displayIncome}</strong> in the <strong>${taxYearLabel}</strong> tax year, the Income Tax calculation uses a tiered rate system based on income tax bands. `;
                
                if (activeIncomeTypes > 1) {
                    methodText += `Your income consists of ${incomeTypeDesc}, each with its own tax bands and rates. `;
                }
                
                methodText += `The taxable income (after personal allowances) is divided across <strong>${breakdownCount} tax band${breakdownCount > 1 ? 's' : ''}</strong>. `;
                
                // Describe the tax bands based on what's actually in the breakdown
                const bandNames = calc.breakdown.map(b => (b.band || '').toLowerCase()).join(' ');
                const hasNil = bandNames.includes('nil');
                const hasStarting = bandNames.includes('starting');
                const hasBasic = bandNames.includes('basic');
                const hasHigher = bandNames.includes('higher');
                const hasAdditional = bandNames.includes('additional');
                
                let bandDescription = '';
                if (hasNil || hasStarting) {
                    bandDescription = 'The first portion is tax-free (0% rate), ';
                    if (hasBasic) {
                        bandDescription += 'followed by the basic rate band, ';
                    }
                } else if (hasBasic) {
                    bandDescription = 'The first portion is taxed at the basic rate, ';
                }
                
                if (hasHigher) {
                    bandDescription += 'with higher rate bands applied as income increases';
                    if (hasAdditional) {
                        bandDescription += ', and additional rate bands for the highest income portions';
                    }
                    bandDescription += '. ';
                } else if (hasAdditional) {
                    bandDescription += 'with additional rate bands applied for higher income portions. ';
                } else {
                    bandDescription += '. ';
                }
                
                methodText += bandDescription;
                
                // ‚úÖ Income Tax - ensure totalTax is defined
                const safeTotalTax = totalTax || 0;
                methodText += `The total Income Tax payable is <strong style="color: #ef4444;">¬£${safeTotalTax.toLocaleString('en-GB')}</strong>, which represents `;
                
                // Calculate percentage
                const percentage = totalIncome > 0 ? ((totalTax / totalIncome) * 100).toFixed(2) : '0.00';
                methodText += `<strong>${percentage}%</strong> of your total income.</p>`;
                
                methodText += `<p style="margin-bottom: 12px;">The breakdown table below shows exactly how your taxable income is distributed across each tax band and income category, with the corresponding tax amount calculated for each portion.</p>`;
                methodText += `<p style="margin: 0;">This progressive tax system ensures that lower-income portions are taxed at lower rates, while higher-income portions are subject to higher rates. Different income types (Non-Saving, Property, Savings, and Dividend) may have different rate structures depending on the tax year.</p>`;
                
                methodTextEl.innerHTML = methodText;
            }
            
            if (!descriptionEl || !calc || !calc.breakdown) {
                // If no calculation data, ensure card is collapsed and content is empty
                if (explanationCard) {
                    explanationCard.classList.add('income-tax-collapsed');
                    if (toggleTextEl) toggleTextEl.textContent = 'Show explanation';
                    if (toggleIconEl) toggleIconEl.textContent = '+';
                }
                if (descriptionEl) {
                    descriptionEl.innerHTML = '';
                }
                return;
            }
            
            // Get total income from calculation
            const totalIncome = calc.totalIncome || 0;
            const displayIncome = totalIncome.toLocaleString('en-GB');
            const breakdownCount = calc.breakdown.length;
            const taxYear = calc.taxYear || '2025';
            const taxYearLabel = taxYear.includes('/') ? taxYear : `${taxYear}/${parseInt(taxYear) + 1}`;
            
            // Count income types
            const incomeTypes = {
                nonSaving: 0,
                property: 0,
                savings: 0,
                dividend: 0
            };
            
            calc.breakdown.forEach(band => {
                const bandName = (band.band || '').toLowerCase();
                if (bandName.includes('non-saving')) incomeTypes.nonSaving++;
                else if (bandName.includes('property')) incomeTypes.property++;
                else if (bandName.includes('savings')) incomeTypes.savings++;
                else if (bandName.includes('dividend')) incomeTypes.dividend++;
            });
            
            const activeIncomeTypes = Object.values(incomeTypes).filter(count => count > 0).length;
            const incomeTypeNames = [];
            if (incomeTypes.nonSaving > 0) incomeTypeNames.push('Non-Saving Income');
            if (incomeTypes.property > 0) incomeTypeNames.push('Property Income');
            if (incomeTypes.savings > 0) incomeTypeNames.push('Savings Income');
            if (incomeTypes.dividend > 0) incomeTypeNames.push('Dividend Income');
            
            // Build income type description
            let incomeTypeDesc = '';
            if (incomeTypeNames.length === 1) {
                incomeTypeDesc = incomeTypeNames[0];
            } else if (incomeTypeNames.length === 2) {
                incomeTypeDesc = `${incomeTypeNames[0]} and ${incomeTypeNames[1]}`;
            } else if (incomeTypeNames.length > 2) {
                incomeTypeDesc = incomeTypeNames.slice(0, -1).join(', ') + ', and ' + incomeTypeNames[incomeTypeNames.length - 1];
            }
            
            // Build description based on actual calculation
            // ‚úÖ Income Tax calculation description
            let description = `<p style="margin-bottom: 12px;">For total income of <strong>¬£${displayIncome}</strong> in the <strong>${taxYearLabel}</strong> tax year, the Income Tax calculation uses a tiered rate system based on income tax bands. `;
            
            if (activeIncomeTypes > 1) {
                description += `Your income consists of ${incomeTypeDesc}, each with its own tax bands and rates. `;
            }
            
            description += `The taxable income (after personal allowances) is divided across <strong>${breakdownCount} tax band${breakdownCount > 1 ? 's' : ''}</strong>. `;
            
            // Describe the tax bands based on what's actually in the breakdown
            const bandNames = calc.breakdown.map(b => (b.band || '').toLowerCase()).join(' ');
            const hasNil = bandNames.includes('nil');
            const hasStarting = bandNames.includes('starting');
            const hasBasic = bandNames.includes('basic');
            const hasHigher = bandNames.includes('higher');
            const hasAdditional = bandNames.includes('additional');
            
            let bandDescription = '';
            if (hasNil || hasStarting) {
                bandDescription = 'The first portion is tax-free (0% rate), ';
                if (hasBasic) {
                    bandDescription += 'followed by the basic rate band, ';
                }
            } else if (hasBasic) {
                bandDescription = 'The first portion is taxed at the basic rate, ';
            }
            
            if (hasHigher) {
                bandDescription += 'with higher rate bands applied as income increases';
                if (hasAdditional) {
                    bandDescription += ', and additional rate bands for the highest income portions';
                }
                bandDescription += '. ';
            } else if (hasAdditional) {
                bandDescription += 'with additional rate bands applied for higher income portions. ';
            } else {
                bandDescription += '. ';
            }
            
            description += bandDescription;
            
            // ‚úÖ Income Tax - ensure totalTax is defined
            const safeTotalTax = totalTax || 0;
            description += `The total Income Tax payable is <strong style="color: var(--income-tax-red);">¬£${safeTotalTax.toLocaleString('en-GB')}</strong>, which represents `;
            
            // Calculate percentage
            const percentage = totalIncome > 0 ? ((totalTax / totalIncome) * 100).toFixed(2) : '0.00';
            description += `<strong>${percentage}%</strong> of your total income.</p>`;
            
            description += `<p style="margin-bottom: 12px;">The breakdown table below shows exactly how your taxable income is distributed across each tax band and income category, with the corresponding tax amount calculated for each portion.</p>`;
            
            description += `<p style="margin: 0;">This progressive tax system ensures that lower-income portions are taxed at lower rates, while higher-income portions are subject to higher rates. Different income types (Non-Saving, Property, Savings, and Dividend) may have different rate structures depending on the tax year.</p>`;
            
            // Update the description content first (before handling collapse state)
            descriptionEl.innerHTML = description;
            
            // Always ensure the card is collapsed after updating content
            // This prevents showing empty content if the card was expanded
            if (explanationCard) {
                // Force collapse state - remove any expanded state
                explanationCard.classList.add('income-tax-collapsed');
                
                // Always set toggle state to "Show explanation" (collapsed state)
                if (toggleTextEl) toggleTextEl.textContent = 'Show explanation';
                if (toggleIconEl) toggleIconEl.textContent = '+';
            }
        }

        // Toggle calculation explanation visibility
        function toggleCalculationExplanation() {
            const explanationCard = document.getElementById('income-tax-calculationDescription');
            if (!explanationCard) return;
            
            const toggleTextEl = document.getElementById('income-tax-calculationExplanationToggleText');
            const toggleIconEl = document.getElementById('income-tax-calculationExplanationToggleIcon');
            
            const isCollapsed = explanationCard.classList.contains('income-tax-collapsed');
            if (isCollapsed) {
                explanationCard.classList.remove('income-tax-collapsed');
                if (toggleTextEl) toggleTextEl.textContent = 'Hide explanation';
                if (toggleIconEl) toggleIconEl.textContent = '‚àí';
            } else {
                explanationCard.classList.add('income-tax-collapsed');
                if (toggleTextEl) toggleTextEl.textContent = 'Show explanation';
                if (toggleIconEl) toggleIconEl.textContent = '+';
            }
        }
        
        // Toggle "How We Calculated" section
        function toggleHowWeCalculated() {
            const content = document.getElementById('income-tax-howWeCalculatedContent');
            const toggleText = document.getElementById('income-tax-howWeCalculatedToggleText');
            const toggleIcon = document.getElementById('income-tax-howWeCalculatedToggleIcon');
            
            if (!content) return;
            
            const isHidden = content.style.display === 'none';
            if (isHidden) {
                content.style.display = 'block';
                if (toggleText) toggleText.textContent = 'Hide details';
                if (toggleIcon) toggleIcon.classList.add('expanded');
            } else {
                content.style.display = 'none';
                if (toggleText) toggleText.textContent = 'Show details';
                if (toggleIcon) toggleIcon.classList.remove('expanded');
            }
        }

        // Fallback loading message (used if API fails)
        const fallbackLoadingMessage = "Rendering your tax breakdown chart";

        // Load creative loading messages from API (only once, then cache)
        async function loadLoadingMessages() {
            // If already loaded, return
            if (state.loadingMessages && state.loadingMessages.length > 0) {
                return;
            }

            try {
                const response = await fetch(`${API_CONFIG.baseUrl}/loading-messages`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.messages && data.messages.length > 0) {
                        state.loadingMessages = data.messages;
                        console.log(`‚úÖ Loaded ${data.messages.length} loading messages from ${data.source}`);
                        return;
                    }
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Failed to load loading messages from API, using fallback:', error.message);
            }

            // Use fallback message if API fails (create array with single message)
            state.loadingMessages = [fallbackLoadingMessage];
        }

        // Get next loading message (rotates through available messages)
        function getNextLoadingMessage() {
            const messages = state.loadingMessages || [fallbackLoadingMessage];
            if (messages.length === 0) return "Loading chart...";
            
            const message = messages[state.currentLoadingMessageIndex % messages.length];
            state.currentLoadingMessageIndex = (state.currentLoadingMessageIndex + 1) % messages.length;
            return message;
        }

        // Show chart loader immediately when inputs change
        function showChartLoader() {
            const chartContainer = document.getElementById('income-tax-chartContainer');
            if (!chartContainer) return;

            // Ensure container maintains fixed height and prevents overflow
            chartContainer.style.minHeight = '450px';
            chartContainer.style.height = '450px';
            chartContainer.style.position = 'relative';
            chartContainer.style.overflow = 'hidden';
            chartContainer.style.boxSizing = 'border-box';
            
            // Get current loading message
            const messages = state.loadingMessages || [fallbackLoadingMessage];
            const currentMessage = messages.length > 0 
                ? messages[state.currentLoadingMessageIndex % messages.length]
                : "Loading chart...";
            
            // Show loading state with smooth transition and fade-in animation
            const loaderHTML = `
                <div style="
                    display: flex; 
                    flex-direction: column; 
                    align-items: center; 
                    justify-content: center; 
                    position: absolute; 
                    top: 0; 
                    left: 0; 
                    width: 100%; 
                    height: 100%; 
                    background: rgba(255, 255, 255, 0.95); 
                    z-index: 10;
                    animation: fadeIn 0.2s ease-in;
                ">
                    <div class="income-tax-loader-wrapper">
                        <div class="income-tax-loader">
                            <div class="income-tax-loader income-tax-loader-inner"></div>
                        </div>
                    </div>
                        <div id="income-tax-chartLoadingMessage" style="margin-top: 16px; color: var(--income-tax-primary); font-size: 14px; font-weight: 500; text-align: center; max-width: 300px; padding: 0 20px; transition: opacity 0.3s ease-in-out;">
                        ${currentMessage}
                    </div>
                </div>
            `;
            chartContainer.innerHTML = loaderHTML;

            // Rotate messages every 5 seconds while loading
            if (state.loadingMessageInterval) {
                clearInterval(state.loadingMessageInterval);
            }

            const messagesToUse = state.loadingMessages || [fallbackLoadingMessage];
            if (messagesToUse.length > 1) {
                state.loadingMessageInterval = setInterval(() => {
                    const messageEl = document.getElementById('income-tax-chartLoadingMessage');
                    if (messageEl) {
                        const nextMessage = getNextLoadingMessage();
                        messageEl.style.opacity = '0';
                        setTimeout(() => {
                            messageEl.textContent = nextMessage;
                            messageEl.style.opacity = '1';
                        }, 200);
                    }
                }, 5000); // Change message every 5 seconds
            }
        }

        // Clear loading message interval (call when chart loads)
        function clearLoadingMessageInterval() {
            if (state.loadingMessageInterval) {
                clearInterval(state.loadingMessageInterval);
                state.loadingMessageInterval = null;
            }
        }

        // Update chart with breakdown data
        function updateChart() {
            const calc = state.currentCalculation;
            const chartContainer = document.getElementById('income-tax-chartContainer');
            
            // Check if breakdown exists (handles both object and array formats)
            const hasBreakdown = calc && calc.breakdown && (
                Array.isArray(calc.breakdown) ? calc.breakdown.length > 0 : 
                typeof calc.breakdown === 'object' ? Object.keys(calc.breakdown).length > 0 : false
            );
            
            if (!calc || !hasBreakdown) {
                // Show empty state if no data
                if (chartContainer) {
                    chartContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">No breakdown data available for chart</div>';
                }
                return;
            }

            // Log for debugging
            console.log('üìä updateChart called - breakdown length:', calc.breakdown ? calc.breakdown.length : 0, 'breakdown:', calc.breakdown);

            // Ensure loader is shown (in case updateChart is called directly)
            showChartLoader();

            // Destroy existing chart if it exists (for client-side charts)
            if (state.chartInstance) {
                state.chartInstance.destroy();
                state.chartInstance = null;
            }

            // Load chart using server-side generation
            const chartTypeSelect = document.getElementById('income-tax-chartTypeSelect');
            const chartType = chartTypeSelect ? chartTypeSelect.value : 'bar';
            changeChartType(chartType);
        }

        // Change chart type and load via server
        function changeChartType(chartType) {
            const calc = state.currentCalculation;
            
            // Check if breakdown exists (handles both object and array formats)
            const hasBreakdown = calc && calc.breakdown && (
                Array.isArray(calc.breakdown) ? calc.breakdown.length > 0 : 
                typeof calc.breakdown === 'object' ? Object.keys(calc.breakdown).length > 0 : false
            );
            
            if (!calc || !hasBreakdown) {
                console.warn('No calculation data available for chart');
                return;
            }

            const chartContainer = document.getElementById('income-tax-chartContainer');
            if (!chartContainer) return;
            
            // ‚úÖ Rental Income Tax chart cache key - use normalized breakdown to match what's actually displayed
            const annualRentalIncome = calc.annualRentalIncome || calc.netIncome || 0;
            const taxYear = calc.taxYear || '';
            
            // Use normalized breakdown for cache key (same as what's used in generateChartHTML)
            // This ensures cache key matches the actual chart data
            const normalizedBreakdown = sdltPrepareBreakdownForChart(calc);
            const breakdownHash = normalizedBreakdown ? normalizedBreakdown.map(b => `${b.band}-${b.rate}-${b.amount}-${b.tax}`).join('|') : '';
            
            // Include comparison data in cache key if comparison mode is enabled
            let comparisonHash = '';
            if (state.comparisonMode && state.comparisonCalculation) {
                const compNormalizedBreakdown = sdltPrepareBreakdownForChart(state.comparisonCalculation);
                comparisonHash = compNormalizedBreakdown ? compNormalizedBreakdown.map(b => `${b.band}-${b.rate}-${b.amount}-${b.tax}`).join('|') : '';
                comparisonHash = `-comp-${state.comparisonCalculation.taxYear}-${comparisonHash}`;
            }
            
            const chartDataKey = `income-tax-${taxYear}-${annualRentalIncome}-${breakdownHash}-${chartType}${comparisonHash}`;
            
            // If we have cached HTML for this chart type and data, use it immediately
            if (state.lastChartDataKey === chartDataKey && state.cachedChartHTML) {
                // Validate cached HTML before using
                if (state.cachedChartHTML.trim().length > 0 && state.cachedChartHTML.includes('canvas')) {
                    console.log('Using cached chart HTML for instant display');
                    // Calculate dynamic height: only increase for pie/donut charts with comparison
                    const isPieOrDonut = (chartType === 'pie' || chartType === 'doughnut');
                    const hasComparison = state.comparisonMode && state.comparisonCalculation;
                    const needsSideBySide = isPieOrDonut && hasComparison;
                    const isMobile = window.innerWidth <= 768;
                    const dynamicHeight = needsSideBySide ? (isMobile ? '750px' : '450px') : '450px';
                    
                    // Use dynamic height based on chart type and comparison mode
                    chartContainer.style.minHeight = dynamicHeight;
                    chartContainer.style.height = dynamicHeight;
                    chartContainer.style.position = 'relative';
                    chartContainer.style.overflow = 'hidden';
                    chartContainer.style.boxSizing = 'border-box';
                    
                    // Insert HTML and execute scripts
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = state.cachedChartHTML;
                    const scripts = Array.from(tempDiv.querySelectorAll('script'));
                    
                    // Save script contents before removing
                    const scriptContents = scripts.map(script => ({
                        attributes: Array.from(script.attributes).map(attr => ({ name: attr.name, value: attr.value })),
                        textContent: script.textContent
                    }));
                    
                    // Remove scripts from temp div and insert the rest
                    scripts.forEach(script => script.remove());
                    chartContainer.innerHTML = tempDiv.innerHTML;
                    
                    // Clear loading message interval now that chart is loaded
                    clearLoadingMessageInterval();
                    
                    // Execute scripts separately to ensure they run
                    scriptContents.forEach(scriptData => {
                        const newScript = document.createElement('script');
                        scriptData.attributes.forEach(attr => {
                            newScript.setAttribute(attr.name, attr.value);
                        });
                        newScript.textContent = scriptData.textContent;
                        document.body.appendChild(newScript);
                        setTimeout(() => {
                            if (newScript.parentNode) {
                                newScript.parentNode.removeChild(newScript);
                            }
                        }, 1000);
                    });
                    return;
                } else {
                    console.warn('‚ö†Ô∏è Cached chart HTML is invalid, regenerating...');
                    // Fall through to generate new chart
                }
            }
            
            // Check if canvas already exists with same data
            if (state.lastChartDataKey === chartDataKey && chartContainer.querySelector('canvas')) {
                console.log('Chart already loaded with same data, skipping API call');
                return;
            }
            state.lastChartDataKey = chartDataKey;

            // Log current calculation data for debugging
            console.log('üìä changeChartType - Breakdown entries:', calc.breakdown ? calc.breakdown.length : 0, 'Breakdown:', calc.breakdown);

            // Show loader (updateChart may have already shown it, but ensure it's visible)
            showChartLoader();

            // Use the shared generateChartHTML function
            generateChartHTML(calc, chartType)
                .then(result => {
                    const html = result.html || result; // Support both old and new format
                    const containerHeight = result.containerHeight || '450px';
                    
                    // Use dynamic height based on comparison mode
                    chartContainer.style.minHeight = containerHeight;
                    chartContainer.style.height = containerHeight;
                    chartContainer.style.position = 'relative';
                    chartContainer.style.overflow = 'hidden';
                    chartContainer.style.boxSizing = 'border-box';
                    
                    // Insert HTML and execute scripts
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = html;
                    const scripts = Array.from(tempDiv.querySelectorAll('script'));
                    
                    // Save script contents before removing
                    const scriptContents = scripts.map(script => ({
                        attributes: Array.from(script.attributes).map(attr => ({ name: attr.name, value: attr.value })),
                        textContent: script.textContent
                    }));
                    
                    // Remove scripts from temp div and insert the rest
                    scripts.forEach(script => script.remove());
                    chartContainer.innerHTML = tempDiv.innerHTML;
                    
                    // Clear loading message interval now that chart is loaded
                    clearLoadingMessageInterval();
                    
                    // Execute scripts separately to ensure they run
                    scriptContents.forEach(scriptData => {
                        const newScript = document.createElement('script');
                        scriptData.attributes.forEach(attr => {
                            newScript.setAttribute(attr.name, attr.value);
                        });
                        newScript.textContent = scriptData.textContent;
                        document.body.appendChild(newScript);
                        setTimeout(() => {
                            if (newScript.parentNode) {
                                newScript.parentNode.removeChild(newScript);
                            }
                        }, 1000);
                    });
                    
                    // Cache the HTML for this chart type and data key
                        state.cachedChartHTML = html;
                })
                .catch(error => {
                    console.error('Error loading chart:', error);
                    clearLoadingMessageInterval();
                    chartContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">Error loading chart. Please try again.</div>';
                });
        }

        // Set functions
        function setCalculatorType(type) {
            // Only proceed if type actually changed
            if (state.calculatorType === type) {
                return;
            }
            
            state.calculatorType = type;
            document.getElementById('income-tax-btn-residential').classList.remove('active');
            document.getElementById('income-tax-btn-commercial').classList.remove('active');
            document.getElementById('income-tax-btn-' + type.toLowerCase()).classList.add('active');
            
            // Show/hide property type and residency status based on calculator type
            const propertyTypeGroup = document.getElementById('income-tax-propertyTypeGroup');
            const residencyStatusGroup = document.getElementById('income-tax-residencyStatusGroup');
            const propertyTypeSeparator = document.getElementById('income-tax-propertyTypeSeparator');
            const propertyValueSeparator = document.getElementById('income-tax-propertyValueSeparator');
            
            if (type === 'Residential') {
                propertyTypeGroup.style.display = 'block';
                residencyStatusGroup.style.display = 'block';
                if (propertyTypeSeparator) propertyTypeSeparator.style.display = 'block';
                if (propertyValueSeparator) propertyValueSeparator.style.display = 'block';
            } else {
                propertyTypeGroup.style.display = 'none';
                residencyStatusGroup.style.display = 'none';
                if (propertyTypeSeparator) propertyTypeSeparator.style.display = 'none';
                if (propertyValueSeparator) propertyValueSeparator.style.display = 'none';
            }
            
            // Clear current calculation to prevent showing stale rates
            if (state.currentCalculation) {
                state.currentCalculation.breakdown = null;
            }
            
            // Update tooltip immediately with rate bands (async)
            updatePropertyValueTooltip(); // Don't await here to avoid blocking UI
            
            // Always recalculate when calculator type changes to get fresh results
            recalculate();
        }

        function setPropertyValue(amount) {
            const input = document.getElementById('income-tax-propertyValue');
            if (input) {
                // Format with commas for display
                input.value = amount.toLocaleString('en-GB');
                input.dataset.rawValue = amount.toString();
                state.propertyValue = amount;
                recalculate();
            }
        }

        // ‚úÖ Show loaders and hide content in all tabs when inputs change
        function showAllTabLoaders() {
            console.log('üîÑ showAllTabLoaders() - Showing loaders in all tabs');
            
            // Only hide old chart content if we're actually calculating
            if (!state.isCalculating) {
                return;
            }
            
            // Hide old chart content
            const chartContainer = document.getElementById('income-tax-chartContainer');
            if (chartContainer) {
                chartContainer.style.opacity = '0.3';
                chartContainer.style.pointerEvents = 'none';
            }
            
            // Show loader in Charts tab and clear content
            if (chartContainer) {
                // Clear any existing chart content
                const existingCanvas = chartContainer.querySelector('canvas');
                if (existingCanvas) {
                    // Destroy Chart.js instance if it exists
                    if (window.Chart && existingCanvas.chart) {
                        try {
                            existingCanvas.chart.destroy();
                        } catch (e) {
                            console.warn('Could not destroy chart instance:', e);
                        }
                    }
                }
                showChartLoader();
            }
            
            // Hide old breakdown table content
            const breakdownTableEl = document.getElementById('income-tax-breakdownTable');
            if (breakdownTableEl) {
                breakdownTableEl.style.opacity = '0.3';
                breakdownTableEl.style.pointerEvents = 'none';
                breakdownTableEl.innerHTML = ''; // Clear breakdown table content
            }
            
            // Show loader in Breakdown tab
            const breakdownLoader = document.getElementById('income-tax-breakdownLoader');
            if (breakdownLoader) {
                breakdownLoader.style.display = 'flex';
            }
            
            // Show loader in Overview/Simple mode
            if (!state.aiMode) {
                // Hide old simple mode results
                const simpleResultsGrid = document.getElementById('income-tax-simpleResultsGrid');
                if (simpleResultsGrid) {
                    simpleResultsGrid.style.opacity = '0.3';
                    simpleResultsGrid.style.pointerEvents = 'none';
                }
                
                const inlineLoader = document.getElementById('income-tax-simpleInlineLoader');
                const simpleTaxEl = document.getElementById('income-tax-simpleTax');
                if (inlineLoader) {
                    inlineLoader.style.display = 'flex';
                }
                if (simpleTaxEl) {
                    simpleTaxEl.style.visibility = 'hidden';
                }
            } else {
                // Hide old AI mode card content
                const taxCardContent = document.getElementById('income-tax-taxCardContent');
                if (taxCardContent) {
                    taxCardContent.style.opacity = '0.3';
                    taxCardContent.style.pointerEvents = 'none';
                }
                
                const aiCardContent = document.getElementById('income-tax-aiCardContent');
                if (aiCardContent) {
                    aiCardContent.style.opacity = '0.3';
                    aiCardContent.style.pointerEvents = 'none';
                }
                
                // Show loaders in AI mode cards
                const taxCardLoader = document.getElementById('income-tax-taxCardLoader');
                const aiCardLoader = document.getElementById('income-tax-aiCardLoader');
                if (taxCardLoader) {
                    taxCardLoader.classList.add('active');
                }
                if (aiCardLoader) {
                    aiCardLoader.classList.add('active');
                }
            }
        }

        function recalculate() {
            console.log('üîÑ recalculate() called - START', {
                isCalculating: state.isCalculating,
                isInitialLoad: state.isInitialLoad,
                calculatingStartTime: state.calculatingStartTime,
                debouncedCalculateTaxExists: typeof debouncedCalculateTax !== 'undefined',
                calculateTaxExists: typeof calculateTax !== 'undefined'
            });
            
            // Mark that initial load is complete (user is actively changing inputs)
            state.isInitialLoad = false;
            
            // CRITICAL: Aggressively reset stuck calculation flag when user changes inputs
            // User is actively interacting, so we should allow the calculation
            if (state.isCalculating) {
                if (!state.calculatingStartTime) {
                    // Flag is set but no start time - definitely stuck, reset immediately
                    console.warn('‚ö†Ô∏è Calculation flag stuck (no start time), resetting immediately to allow new calculation...');
                    state.isCalculating = false;
                    hideLoader();
                } else {
                    const timeSinceStart = Date.now() - state.calculatingStartTime;
                    // Be very aggressive - if it's been more than 2 seconds, reset it
                    // User is actively changing inputs, so prioritize their action
                    if (timeSinceStart > 2000) {
                        console.warn('‚ö†Ô∏è Calculation flag stuck for >2s, resetting to allow new calculation...', {
                            timeSinceStart: timeSinceStart + 'ms'
                        });
                        state.isCalculating = false;
                        state.calculatingStartTime = null;
                        hideLoader();
                    } else {
                        console.log('‚ö†Ô∏è Calculation in progress, but not stuck yet. Time since start:', timeSinceStart, 'ms');
                        // If it's been less than 2 seconds, it might be a real calculation
                        // But still allow it to proceed - calculateTax() will handle the check
                    }
                }
            }
            
            // ‚úÖ Show loaders and hide content immediately in all tabs when inputs change
            showAllTabLoaders();
            
            // Use debounced version to prevent API spam (1000ms delay to allow user to finish typing)
            if (typeof debouncedCalculateTax === 'function') {
                console.log('‚úÖ Calling debouncedCalculateTax() - waiting 1000ms for user to finish typing');
                debouncedCalculateTax();
            } else {
                console.error('‚ùå debouncedCalculateTax is not accessible! Trying calculateTax directly...');
                // Fallback: call calculateTax directly (will be debounced by the function itself)
                if (typeof calculateTax === 'function') {
                    console.log('‚úÖ Calling calculateTax() directly');
                    calculateTax();
                } else {
                    console.error('‚ùå calculateTax is also not accessible! Functions may not be loaded.');
                }
            }
            
            console.log('üîÑ recalculate() called - END');
        }
        
        // Explicitly attach to window for global accessibility
        window.recalculate = recalculate;
        
        // Explicitly attach to window to ensure global accessibility
        window.recalculate = recalculate;

        // Handle tab click (check if AI mode is enabled)
        function handleTabClick(tabName, event) {
            if (!state.aiMode) {
                // Prevent default action
                if (event) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                // Store the tab name that was clicked (remove prefix for state)
                state.pendingTab = tabName.replace('income-tax-', '');
                // Show annotation to encourage AI mode
                const tabId = tabName.includes('income-tax-') ? tabName + 'Tab' : 'income-tax-' + tabName + 'Tab';
                showTabAnnotation(event?.target || document.getElementById(tabId));
                return;
            }
            // If AI mode is enabled, proceed with normal tab switching
            switchTab(tabName, event);
        }

        // Handle "View detailed breakdown" button click
        function handleViewBreakdown() {
            if (!state.aiMode) {
                // Store the tab that should be opened after enabling AI mode
                state.pendingTab = 'income-tax-breakdown';
                // Show annotation to encourage AI mode
                const button = document.getElementById('income-tax-viewBreakdownBtn');
                if (button) {
                    showTabAnnotation(button);
                }
                return;
            }
            // If AI mode is enabled, switch to breakdown tab
            switchTab('income-tax-breakdown');
        }

        // Tab switching
        function switchTab(tabName, event) {
            document.querySelectorAll('.income-tax-tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.income-tax-tab-trigger').forEach(trigger => trigger.classList.remove('active'));
            
            const tabContent = document.getElementById(tabName);
            if (tabContent) {
                tabContent.classList.add('active');
            }
            
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Find and activate the corresponding tab trigger
                const tabTriggers = document.querySelectorAll('.income-tax-tab-trigger');
                tabTriggers.forEach((trigger) => {
                    const triggerText = trigger.textContent.trim();
                    if ((tabName === 'income-tax-overview' || tabName === 'overview') && triggerText === 'Overview') {
                        trigger.classList.add('active');
                    } else if ((tabName === 'income-tax-charts' || tabName === 'charts') && triggerText === 'Charts') {
                        trigger.classList.add('active');
                    } else if ((tabName === 'income-tax-breakdown' || tabName === 'breakdown') && triggerText === 'Breakdown') {
                        trigger.classList.add('active');
                    } else if ((tabName === 'income-tax-history' || tabName === 'history') && triggerText === 'History') {
                        trigger.classList.add('active');
                    }
                });
            }
            
            // Render history when history tab is opened
            if (tabName === 'income-tax-history' || tabName === 'history') {
                renderHistory();
                return; // History tab doesn't need recalculation
            }
            
            // Only refresh display when switching tabs, don't recalculate unless inputs changed
            // Recalculating on every tab switch causes excessive API calls
            if (tabName === 'income-tax-overview' || tabName === 'overview' || tabName === 'income-tax-charts' || tabName === 'charts' || tabName === 'income-tax-breakdown' || tabName === 'breakdown') {
                if (state.currentCalculation) {
                    // Just refresh the display with existing calculation data (no API calls)
                    if (tabName === 'income-tax-charts' || tabName === 'charts') {
                        // ‚úÖ Always regenerate chart when switching to Charts tab to ensure all bands (including Additional Rate) are shown
                        // This prevents issues where chart might not show all bands initially
                        if (state.currentCalculation && state.currentCalculation.breakdown && state.currentCalculation.breakdown.length > 0) {
                            console.log('üîÑ Regenerating chart for Charts tab to ensure all bands are displayed');
                            updateChart();
                            return;
                        }
                        
                        // ‚úÖ Rental Income Tax chart cache key
                        const calc = state.currentCalculation;
                        const annualRentalIncome = calc.annualRentalIncome || calc.netIncome || 0;
                        const taxYear = calc.taxYear || '';
                        const breakdownHash = calc.breakdown ? calc.breakdown.map(b => `${b.band}-${b.rate}-${b.amount}`).join('|') : '';
                        const chartDataKey = `income-tax-${taxYear}-${annualRentalIncome}-${breakdownHash}-bar`;
                        const chartContainer = document.getElementById('income-tax-chartContainer');
                        
                        if (state.lastChartDataKey === chartDataKey && state.cachedChartHTML && chartContainer) {
                            // Validate cached HTML before using
                            if (state.cachedChartHTML.trim().length > 0 && state.cachedChartHTML.includes('canvas')) {
                                // Use cached chart for instant display (no API call needed!)
                                console.log('Using pre-generated chart for instant display');
                                
                                // Calculate dynamic height: only increase for pie/donut charts with comparison
                                const isPieOrDonut = (chartType === 'pie' || chartType === 'doughnut');
                                const hasComparison = state.comparisonMode && state.comparisonCalculation;
                                const needsSideBySide = isPieOrDonut && hasComparison;
                                const isMobile = window.innerWidth <= 768;
                                const dynamicHeight = needsSideBySide ? (isMobile ? '750px' : '450px') : '450px';
                                
                                // Use dynamic height based on chart type and comparison mode
                                chartContainer.style.minHeight = dynamicHeight;
                                chartContainer.style.height = dynamicHeight;
                                chartContainer.style.position = 'relative';
                                chartContainer.style.overflow = 'hidden';
                                chartContainer.style.boxSizing = 'border-box';
                                
                                // Insert HTML properly
                                const tempDiv = document.createElement('div');
                                tempDiv.innerHTML = state.cachedChartHTML;
                                const scripts = Array.from(tempDiv.querySelectorAll('script'));
                                
                                // Save script contents before removing
                                const scriptContents = scripts.map(script => ({
                                    attributes: Array.from(script.attributes).map(attr => ({ name: attr.name, value: attr.value })),
                                    textContent: script.textContent
                                }));
                                
                                // Remove scripts from temp div and insert the rest
                                scripts.forEach(script => script.remove());
                                chartContainer.innerHTML = tempDiv.innerHTML;
                                
                                // Clear loading message interval now that chart is loaded
                                clearLoadingMessageInterval();
                                
                                // Execute scripts separately to ensure they run
                                scriptContents.forEach(scriptData => {
                                    const newScript = document.createElement('script');
                                    scriptData.attributes.forEach(attr => {
                                        newScript.setAttribute(attr.name, attr.value);
                                    });
                                    newScript.textContent = scriptData.textContent;
                                    document.body.appendChild(newScript);
                                    setTimeout(() => {
                                        if (newScript.parentNode) {
                                            newScript.parentNode.removeChild(newScript);
                                        }
                                    }, 1000);
                                });
                            } else {
                                console.warn('‚ö†Ô∏è Cached chart HTML is invalid, regenerating...');
                                // Generate chart if cached HTML is invalid
                                updateChart();
                            }
                        } else {
                            // Generate chart if not cached
                            updateChart();
                        }
                    } else {
                        // For overview and breakdown, just update display (no API calls)
                        updateDisplay();
                    }
                }
            }
        }

        // Show annotation when clicking disabled tab
        function showTabAnnotation(targetElement) {
            if (!targetElement) return;

            // Store which tab was clicked so we can switch to it after enabling AI mode
            const tabId = targetElement.id;
            if (tabId === 'income-tax-chartsTab' || tabId === 'chartsTab') {
                state.pendingTab = 'income-tax-charts';
            } else if (tabId === 'income-tax-breakdownTab' || tabId === 'breakdownTab') {
                state.pendingTab = 'income-tax-breakdown';
            } else if (tabId === 'income-tax-historyTab' || tabId === 'historyTab') {
                state.pendingTab = 'income-tax-history';
            }

            // Remove any existing annotation
            const existingAnnotation = document.querySelector('.income-tax-annotation');
            if (existingAnnotation) {
                existingAnnotation.remove();
            }

            // Get element position
            const rect = targetElement.getBoundingClientRect();
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            const annotationWidth = 280;
            const annotationHeight = 120;

            // Create annotation
            const annotation = document.createElement('div');
            annotation.className = 'income-tax-annotation left';
            
            // Position annotation
            let annotationTop, annotationLeft;
            
            if (rect.left >= annotationWidth + 40) {
                annotationLeft = rect.left - annotationWidth - 20;
                annotationTop = rect.top + (rect.height / 2) - (annotationHeight / 2);
            } else if (rect.bottom + annotationHeight + 20 <= viewportHeight) {
                annotationLeft = Math.max(20, Math.min(rect.left - (annotationWidth / 2) + (rect.width / 2), viewportWidth - annotationWidth - 20));
                annotationTop = rect.bottom + 15;
                annotation.className = 'income-tax-annotation top';
            } else {
                annotationLeft = Math.min(rect.right + 20, viewportWidth - annotationWidth - 20);
                annotationTop = rect.top + (rect.height / 2) - (annotationHeight / 2);
                annotation.className = 'income-tax-annotation right';
            }

            annotationTop = Math.max(20, Math.min(annotationTop, viewportHeight - annotationHeight - 20));
            annotationLeft = Math.max(20, Math.min(annotationLeft, viewportWidth - annotationWidth - 20));

            annotation.style.cssText = `
                position: fixed;
                top: ${annotationTop}px;
                left: ${annotationLeft}px;
                z-index: 99999;
                max-width: ${annotationWidth}px;
                opacity: 1;
                display: block;
            `;

            annotation.innerHTML = `
                <div class="income-tax-annotation-header">
                    <div class="income-tax-annotation-title">üß† Enable AI Mode</div>
                    <button class="income-tax-annotation-close" onclick="closeAnnotation(this)">√ó</button>
                </div>
                <div class="income-tax-annotation-body">Switch to AI Powered mode to access Comparison mode, charts, breakdown analysis, and calculation history.</div>
                <button class="income-tax-annotation-cta" onclick="switchToAIMode()">Enable AI Mode ‚Üí</button>
            `;

            document.body.appendChild(annotation);

            // Auto-hide after 8 seconds
            setTimeout(() => {
                if (annotation.parentNode) {
                    annotation.style.opacity = '0';
                    annotation.style.transition = 'opacity 0.3s';
                    setTimeout(() => {
                        if (annotation.parentNode) {
                            annotation.remove();
                        }
                    }, 300);
                }
            }, 8000);
        }

        // Check if user has used AI mode before
        function checkAIModeUsage() {
            try {
                const hasUsed = localStorage.getItem('sdlt_has_used_ai_mode');
                state.hasUsedAIMode = hasUsed === 'true';
            } catch (error) {
                state.hasUsedAIMode = false;
            }
        }

        // Mark that user has used AI mode
        function markAIModeUsed() {
            try {
                localStorage.setItem('sdlt_has_used_ai_mode', 'true');
                state.hasUsedAIMode = true;
                // Clear any annotations when switching to AI mode
                clearAnnotations();
            } catch (error) {
                console.error('Error saving AI mode usage:', error);
            }
        }

        // Show random annotation in simple mode pointing to toggle switch
        function showRandomAnnotation() {
            // Don't show if user has used AI mode or is currently in AI mode
            if (state.hasUsedAIMode || state.aiMode) {
                return;
            }

            // Don't show if we've already shown 2 annotations
            if (state.annotationCount >= 2) {
                return;
            }

            const modeToggle = document.getElementById('income-tax-modeToggle');
            if (!modeToggle) {
                console.log('Mode toggle not found');
                return;
            }

            // Remove any existing annotation
            const existingAnnotations = document.querySelectorAll('.income-tax-annotation');
            existingAnnotations.forEach(ann => ann.remove());

            // Pick a random message
            const message = annotationMessages[Math.floor(Math.random() * annotationMessages.length)];
            
            // Get toggle position relative to viewport
            const toggleRect = modeToggle.getBoundingClientRect();
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            const annotationWidth = 280;
            const annotationHeight = 120;
            
            // Create annotation element
            const annotation = document.createElement('div');
            annotation.className = `income-tax-annotation left`; // Always use left position (arrow pointing right)
            
            // Calculate best position - try to place it above or below the toggle if not enough space on left
            let annotationTop, annotationLeft;
            
            // Check if there's enough space on the left (need at least 300px)
            if (toggleRect.left >= annotationWidth + 40) {
                // Position to the left of toggle
                annotationLeft = toggleRect.left - annotationWidth - 20;
                annotationTop = toggleRect.top + (toggleRect.height / 2) - (annotationHeight / 2);
            } else if (toggleRect.bottom + annotationHeight + 20 <= viewportHeight) {
                // Position below the toggle
                annotationLeft = Math.max(20, Math.min(toggleRect.left - (annotationWidth / 2) + (toggleRect.width / 2), viewportWidth - annotationWidth - 20));
                annotationTop = toggleRect.bottom + 15;
                annotation.className = 'income-tax-annotation top'; // Arrow pointing up
            } else if (toggleRect.top >= annotationHeight + 20) {
                // Position above the toggle
                annotationLeft = Math.max(20, Math.min(toggleRect.left - (annotationWidth / 2) + (toggleRect.width / 2), viewportWidth - annotationWidth - 20));
                annotationTop = toggleRect.top - annotationHeight - 15;
                annotation.className = 'income-tax-annotation bottom'; // Arrow pointing down
            } else {
                // Fallback: position to the right if no other space
                annotationLeft = Math.min(toggleRect.right + 20, viewportWidth - annotationWidth - 20);
                annotationTop = toggleRect.top + (toggleRect.height / 2) - (annotationHeight / 2);
                annotation.className = 'income-tax-annotation right'; // Arrow pointing left
            }
            
            // Ensure annotation stays within viewport bounds
            annotationTop = Math.max(20, Math.min(annotationTop, viewportHeight - annotationHeight - 20));
            annotationLeft = Math.max(20, Math.min(annotationLeft, viewportWidth - annotationWidth - 20));
            
            annotation.style.cssText = `
                position: fixed;
                top: ${annotationTop}px;
                left: ${annotationLeft}px;
                z-index: 99999;
                max-width: ${annotationWidth}px;
                opacity: 1;
                display: block;
            `;
            
            annotation.innerHTML = `
                <div class="income-tax-annotation-header">
                    <div class="income-tax-annotation-title">${message.title}</div>
                    <button class="income-tax-annotation-close" onclick="closeAnnotation(this)">√ó</button>
                </div>
                <div class="income-tax-annotation-body">${message.message}</div>
                <button class="income-tax-annotation-cta" onclick="switchToAIMode()">Try AI Mode ‚Üí</button>
            `;

            document.body.appendChild(annotation);
            
            // Increment annotation count
            state.annotationCount++;
            console.log(`‚úÖ Annotation ${state.annotationCount} shown:`, {
                position: `${annotationLeft}px, ${annotationTop}px`,
                viewport: `${viewportWidth}x${viewportHeight}`,
                togglePosition: `${toggleRect.left}px, ${toggleRect.top}px`,
                className: annotation.className
            });
            
            // Force visibility check
            const computedStyle = window.getComputedStyle(annotation);
            console.log('Annotation visibility:', {
                display: computedStyle.display,
                opacity: computedStyle.opacity,
                zIndex: computedStyle.zIndex,
                visibility: computedStyle.visibility
            });

            // Auto-hide after 10 seconds
            setTimeout(() => {
                if (annotation.parentNode) {
                    annotation.style.opacity = '0';
                    annotation.style.transition = 'opacity 0.3s';
                    setTimeout(() => {
                        if (annotation.parentNode) {
                            annotation.remove();
                        }
                    }, 300);
                }
            }, 10000);
        }

        // Close annotation
        function closeAnnotation(button) {
            const annotation = button.closest('.income-tax-annotation');
            if (annotation) {
                annotation.style.opacity = '0';
                annotation.style.transition = 'opacity 0.3s';
                setTimeout(() => annotation.remove(), 300);
            }
        }

        // Switch to AI mode from annotation
        function switchToAIMode() {
            if (!state.aiMode) {
                // Store the pending tab before switching mode (ensure it has prefix)
                let pendingTab = state.pendingTab || 'income-tax-overview';
                if (!pendingTab.startsWith('income-tax-')) {
                    pendingTab = 'income-tax-' + pendingTab;
                }
                
                toggleMode();
                markAIModeUsed();
                
                // Close any annotations
                clearAnnotations();
                
                // Switch to the tab that was clicked (or overview if none)
                setTimeout(() => {
                    // switchTab already handles tab trigger activation, so just call it
                    switchTab(pendingTab);
                }, 100); // Small delay to ensure AI mode UI is fully rendered
                
                // Clear pending tab
                state.pendingTab = null;
            }
        }

        // Clear all annotations
        function clearAnnotations() {
            const existingAnnotations = document.querySelectorAll('.income-tax-annotation');
            existingAnnotations.forEach(ann => ann.remove());
            
            // Clear all annotation timers
            state.annotationTimers.forEach(timer => clearTimeout(timer));
            state.annotationTimers = [];
            
            if (state.annotationTimer) {
                clearInterval(state.annotationTimer);
                state.annotationTimer = null;
            }
        }

        // Toggle mode
        function toggleMode() {
            state.aiMode = !state.aiMode;
            const toggle = document.getElementById('income-tax-modeToggle');
            const simpleResults = document.getElementById('income-tax-simpleResults');
            const aiResults = document.getElementById('income-tax-aiResults');
            const headerSubtitle = document.getElementById('income-tax-headerSubtitle');
            const simpleModeLabel = document.getElementById('income-tax-simpleModeLabel');
            const aiModeLabel = document.getElementById('income-tax-aiModeLabel');
            
            toggle.classList.toggle('active');
            
            if (state.aiMode) {
                // Show AI mode
                simpleResults.classList.add('income-tax-hidden');
                aiResults.classList.remove('income-tax-hidden');
                headerSubtitle.textContent = 'AI-powered calculations with real-time insights';
                simpleModeLabel.style.fontWeight = '400';
                simpleModeLabel.style.color = '#6b7280';
                aiModeLabel.style.fontWeight = '700';
                    aiModeLabel.style.color = 'var(--income-tax-foreground)';
                
                // Show all AI-only elements
                document.querySelectorAll('.income-tax-ai-only').forEach(el => {
                    el.classList.remove('income-tax-hidden');
                    el.style.display = '';
                });
                
                // Mark AI mode as used and clear annotations
                markAIModeUsed();

                // If we already have a calculation, fetch AI insights for the current result
                if (state.currentCalculation && !state.currentCalculation.aiInsights) {
                    fetchAIInsights().catch(err => console.error('Error fetching AI insights on AI mode toggle:', err));
                }
            } else {
                // Show simple mode
                simpleResults.classList.remove('income-tax-hidden');
                aiResults.classList.add('income-tax-hidden');
                headerSubtitle.textContent = 'Quick and simple tax calculations';
                simpleModeLabel.style.fontWeight = '700';
                    simpleModeLabel.style.color = 'var(--income-tax-foreground)';
                aiModeLabel.style.fontWeight = '400';
                aiModeLabel.style.color = '#6b7280';
                
                // Hide all AI-only elements
                document.querySelectorAll('.income-tax-ai-only').forEach(el => {
                    el.classList.add('income-tax-hidden');
                    el.style.display = 'none';
                });
                
                // Check if current tab is an AI-only tab (charts, breakdown, history)
                // If so, switch to overview tab
                const activeTabContent = document.querySelector('.income-tax-tab-content.active');
                const activeTabName = activeTabContent ? activeTabContent.id : null;
                const aiOnlyTabs = ['income-tax-charts', 'income-tax-breakdown', 'income-tax-history', 'charts', 'breakdown', 'history'];
                
                if (activeTabName && aiOnlyTabs.includes(activeTabName)) {
                    // Switch to overview tab
                    switchTab('income-tax-overview');
                }
                
                // Start showing annotations if user hasn't used AI mode
                if (!state.hasUsedAIMode) {
                    // Clear any existing timers
                    clearAnnotations();
                    
                    // Reset annotation count when switching to simple mode
                    state.annotationCount = 0;
                    
                    // Show first annotation after 5 seconds
                    const timer1 = setTimeout(() => {
                        if (!state.aiMode && !state.hasUsedAIMode && state.annotationCount < 2) {
                            showRandomAnnotation();
                        }
                    }, 5000);
                    state.annotationTimers.push(timer1);
                    
                    // Show second annotation after 30 seconds
                    const timer2 = setTimeout(() => {
                        if (!state.aiMode && !state.hasUsedAIMode && state.annotationCount < 2) {
                            showRandomAnnotation();
                        }
                    }, 30000);
                    state.annotationTimers.push(timer2);
                }
            }
            
            // Refresh display when mode is toggled, but don't recalculate unless necessary
            // Recalculating on every mode toggle causes excessive API calls
            if (state.currentCalculation) {
                    // Enable loader if AI mode active and insights missing
                    state.isAIMetricsLoading = state.aiMode && !state.currentCalculation.aiInsights;
                // Just refresh the display with existing calculation data
                updateAllDisplays();
                
                // If switching to AI mode and we don't have AI insights, fetch them
                if (state.aiMode && !state.currentCalculation.aiInsights && !state.isFetchingAIInsights) {
                    fetchAIInsights();
                }
            }
        }

        // Expert modal functions
        function openExpertModal() {
            document.getElementById('income-tax-expertModal').classList.add('active');
            state.selectedConsultation = null;
        }
        
        // Open Rentalbux registration
        function openRentalbuxRegistration() {
            window.open('https://app.rentalbux.com/register', '_blank');
        }
        
        // Open review page
        function openReviewPage() {
            window.open('https://www.trustpilot.com/evaluate/rentalbux.com', '_blank');
        }
        
        // Open Trustpilot reviews page
        function openTrustpilotReviews() {
            window.open('https://www.trustpilot.com/review/rentalbux.com', '_blank');
        }

        function closeExpertModal() {
            document.getElementById('income-tax-expertModal').classList.remove('active');
            document.querySelectorAll('.income-tax-consultation-option').forEach(opt => opt.classList.remove('income-tax-selected'));
            document.getElementById('income-tax-selectBtn').textContent = 'Book Now'; // Reset button text
        }

        function selectOption(type, element) {
            state.selectedConsultation = type;
            document.querySelectorAll('.income-tax-consultation-option').forEach(opt => opt.classList.remove('income-tax-selected'));
            element.classList.add('income-tax-selected');
            document.getElementById('income-tax-selectBtn').textContent = type === 'discovery' ? 'üìÖ Schedule Call' : 'üí≥ Book Session';
        }

        function bookConsultation() {
            if (state.selectedConsultation) {
                alert(`‚úÖ Booking confirmed!\n\nYou selected: ${state.selectedConsultation === 'discovery' ? '15-min Discovery Call (FREE)' : '60-min Tax Advisory ($149)'}\n\nYou will receive a confirmation email shortly.`);
                closeExpertModal();
            } else {
                alert('Please select a consultation option first.');
            }
        }

        // Check and load consent preference
        function loadStorageConsent() {
            try {
                const consent = localStorage.getItem('sdlt_storage_consent');
                    // Only load consent if it's true (permanent). If false (temporary), treat as null to ask again
                    if (consent === 'true') {
                        state.storageConsent = true;
                    } else {
                        // If consent was false (temporary) or doesn't exist, reset to null to ask again
                        state.storageConsent = null;
                        // Clear any temporary consent preference from localStorage
                        localStorage.removeItem('sdlt_storage_consent');
                        // Clear sessionStorage data on reload if user previously chose temporary
                        // This ensures temporary data doesn't persist across reloads
                        sessionStorage.removeItem('sdlt_calculations_history');
                }
            } catch (error) {
                console.error('Error loading storage consent:', error);
                    state.storageConsent = null;
                    // Clear sessionStorage on error as well
                    try {
                        sessionStorage.removeItem('sdlt_calculations_history');
                    } catch (e) {
                        // Ignore errors
                    }
            }
        }

        // Show consent dialog (custom modal)
        function showStorageConsentDialog() {
            return new Promise((resolve) => {
                const modal = document.getElementById('income-tax-storageConsentModal');
                if (modal) {
                    modal.classList.add('active');
                    // Store resolve function to call when user makes choice
                    modal.dataset.resolve = 'pending';
                    state.storageConsentResolve = resolve;
                } else {
                    // Fallback if modal doesn't exist
                    resolve(false);
                }
            });
        }

        // Close storage consent modal and handle user choice
        function closeStorageConsentModal(userConsent) {
            const modal = document.getElementById('income-tax-storageConsentModal');
            if (modal) {
                modal.classList.remove('active');
                
                // Store consent preference
                state.storageConsent = userConsent;
                try {
                        if (userConsent === true) {
                            // Only save consent preference to localStorage if user chose permanent
                            localStorage.setItem('sdlt_storage_consent', 'true');
                        } else {
                            // User chose temporary - don't save consent preference, and clear any existing localStorage data
                            localStorage.removeItem('sdlt_storage_consent');
                            // Clear any existing permanent storage data when user chooses temporary
                            localStorage.removeItem('sdlt_calculations_history');
                        }
                } catch (error) {
                    console.error('Error saving consent preference:', error);
                }
                
                // Resolve the promise
                if (state.storageConsentResolve) {
                    state.storageConsentResolve(userConsent);
                    state.storageConsentResolve = null;
                }
            }
        }

        // LocalStorage functions
        function loadHistoryFromStorage() {
            try {
                let calculations = [];
                
                    // Only load from localStorage if user has consented to permanent storage
                    if (state.storageConsent === true) {
                        const saved = localStorage.getItem('sdlt_calculations_history');
                if (saved) {
                    calculations = JSON.parse(saved);
                        }
                }
                
                    // Only load from sessionStorage if user has explicitly chosen temporary storage in this session
                    // Don't load if consent is null (not asked yet) - this prevents loading old temporary data on reload
                    if (state.storageConsent === false) {
                const tempSaved = sessionStorage.getItem('sdlt_calculations_history');
                if (tempSaved) {
                    const tempCalculations = JSON.parse(tempSaved);
                    // Merge temporary calculations with permanent ones, avoiding duplicates
                    // ‚úÖ Rental Income Tax: Check duplicates using rental income tax fields
                    tempCalculations.forEach(tempCalc => {
                        const normalizeNumeric = (val) => {
                            if (val === null || val === undefined) return null;
                            const num = typeof val === 'string' ? parseFloat(val.replace(/,/g, '')) : Number(val);
                            return isNaN(num) ? null : Math.round(num);
                        };
                        const normalizeTaxYear = (val) => {
                            if (!val) return '';
                            const dateStr = String(val);
                            const yearMatch = dateStr.match(/^(\d{4})/);
                            return yearMatch ? yearMatch[1] : dateStr;
                        };
                        
                        const tempAnnualRentalIncome = normalizeNumeric(tempCalc.annualRentalIncome || tempCalc.totalIncome || tempCalc.netIncome);
                        const tempTaxYear = normalizeTaxYear(tempCalc.taxYear);
                        const tempMortgageInterest = normalizeNumeric(tempCalc.mortgageInterest);
                        
                        const exists = calculations.find(c => {
                            if (c.id === tempCalc.id) return true;
                            const savedAnnualRentalIncome = normalizeNumeric(c.annualRentalIncome || c.totalIncome || c.netIncome);
                            const savedTaxYear = normalizeTaxYear(c.taxYear);
                            const savedMortgageInterest = normalizeNumeric(c.mortgageInterest);
                            return tempAnnualRentalIncome === savedAnnualRentalIncome &&
                                   tempTaxYear === savedTaxYear &&
                                   tempMortgageInterest === savedMortgageInterest;
                        });
                        if (!exists) {
                            calculations.unshift(tempCalc);
                        }
                    });
                        }
                }
                
                state.calculations = calculations;
                renderHistory();
            } catch (error) {
                console.error('Error loading history from storage:', error);
                state.calculations = [];
            }
        }

        function saveHistoryToStorage() {
            try {
                if (state.storageConsent === true) {
                    // User consented: save to localStorage (permanent)
                    localStorage.setItem('sdlt_calculations_history', JSON.stringify(state.calculations));
                } else {
                    // User rejected or not asked: save to sessionStorage (temporary)
                    sessionStorage.setItem('sdlt_calculations_history', JSON.stringify(state.calculations));
                }
            } catch (error) {
                console.error('Error saving history to storage:', error);
            }
        }

        // Render history list
        function renderHistory() {
            const historyList = document.getElementById('income-tax-historyList');
            if (!historyList) return;

            if (!state.calculations || state.calculations.length === 0) {
                historyList.innerHTML = `
                    <div class="income-tax-empty-state">
                        <div class="income-tax-empty-state-icon">‚è±Ô∏è</div>
                        <div class="income-tax-empty-state-text">No calculations saved yet<br>Start calculating to see your history here</div>
                    </div>
                `;
                return;
            }

            let historyHtml = '<div style="display: grid; gap: 12px;">';
            
            state.calculations.forEach((calc, index) => {
                const date = new Date(calc.timestamp);
                const formattedDate = date.toLocaleDateString('en-GB', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // ‚úÖ Rental Income Tax uses 'totalTax', not 'totalTaxLiability'
                const totalTax = Math.round(calc.totalTax || 0);
                
                historyHtml += `
                    <div class="income-tax-breakdown-card" style="cursor: pointer; transition: all 0.2s;" 
                         onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)'"
                         onmouseout="this.style.transform=''; this.style.boxShadow=''"
                         onclick="restoreCalculation(${index})">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div>
                                    <div style="font-weight: 700; font-size: 16px; margin-bottom: 4px; color: var(--income-tax-foreground);">
                                    Income Tax
                                </div>
                                <div style="font-size: 12px; color: #6b7280;">
                                    Tax Year: ${calc.taxYear ? (calc.taxYear.match(/\d{4}/) ? `${calc.taxYear.match(/\d{4}/)[0]}/${parseInt(calc.taxYear.match(/\d{4}/)[0]) + 1}` : calc.taxYear) : '-'}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                    <div style="font-weight: 700; font-size: 18px; color: var(--income-tax-red);">
                                    ¬£${(totalTax || 0).toLocaleString('en-GB')}
                                </div>
                                <div style="font-size: 12px; color: #6b7280;">
                                    Tax Liability
                                </div>
                            </div>
                        </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px; padding-top: 12px; border-top: 1px solid var(--income-tax-border);">
                            <div>
                                <span style="color: #6b7280;">Annual Rental Income:</span>
                                <span style="font-weight: 600; margin-left: 4px;">¬£${((calc.annualRentalIncome || calc.netIncome || 0)).toLocaleString('en-GB')}</span>
                            </div>
                            <div>
                                <span style="color: #6b7280;">Tax Year:</span>
                                <span style="font-weight: 600; margin-left: 4px;">${calc.taxYear ? (calc.taxYear.match(/\d{4}/) ? `${calc.taxYear.match(/\d{4}/)[0]}/${parseInt(calc.taxYear.match(/\d{4}/)[0]) + 1}` : calc.taxYear) : '-'}</span>
                            </div>
                        </div>
                        <div style="margin-top: 8px; text-align: right;">
                            <button class="income-tax-button income-tax-button-small" onclick="event.stopPropagation(); deleteHistoryItem(${index})" style="font-size: 12px; padding: 6px 12px;">
                                Delete
                            </button>
                        </div>
                    </div>
                `;
            });
            
            historyHtml += '</div>';
            historyList.innerHTML = historyHtml;
        }

        // ‚úÖ Rental Income Tax: Restore calculation from history
        function restoreCalculation(index) {
            if (index >= 0 && index < state.calculations.length) {
                const calc = state.calculations[index];
                
                // ‚úÖ Restore Annual Rental Income
                const annualRentalIncomeInput = document.getElementById('income-tax-annualRentalIncome');
                if (annualRentalIncomeInput) {
                    const displayValue = calc.annualRentalIncome || calc.netIncome || 0;
                    annualRentalIncomeInput.value = (displayValue || 0).toLocaleString('en-GB');
                    annualRentalIncomeInput.dataset.rawValue = displayValue.toString();
                    state.annualRentalIncome = displayValue;
                }
                
                // ‚úÖ Restore Tax Year
                if (calc.taxYear) {
                    const taxYearSelect = document.getElementById('income-tax-taxYear');
                    if (taxYearSelect) {
                        // Extract year from taxYear (could be "2024" or "2024/2025")
                        const yearMatch = calc.taxYear.match(/^(\d{4})/);
                        const year = yearMatch ? yearMatch[1] : calc.taxYear;
                        taxYearSelect.value = year;
                        state.taxYear = year;
                        // Trigger change handler if it exists
                        if (typeof handleTaxYearChange === 'function') {
                            handleTaxYearChange();
                        }
                    }
                }
                
                // ‚úÖ Restore Mortgage Interest
                const mortgageInterestInput = document.getElementById('income-tax-mortgageInterest');
                if (mortgageInterestInput && calc.mortgageInterest) {
                    const mortgageValue = typeof calc.mortgageInterest === 'string' 
                        ? parseFloat(calc.mortgageInterest.replace(/,/g, '')) || 0 
                        : calc.mortgageInterest || 0;
                    mortgageInterestInput.value = mortgageValue.toLocaleString('en-GB');
                    mortgageInterestInput.dataset.rawValue = mortgageValue.toString();
                    state.mortgageInterest = mortgageValue.toString();
                }
                
                // Restore calculation result
                state.currentCalculation = calc;
                // Update all display elements and tabs
                updateAllDisplays();
                
                // Switch to overview tab
                switchTab('income-tax-overview');
                document.querySelectorAll('.income-tax-tab-trigger').forEach(trigger => trigger.classList.remove('active'));
                document.querySelectorAll('.income-tax-tab-trigger')[0].classList.add('active');
                
                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // Delete history item
        function deleteHistoryItem(index) {
            if (confirm('Are you sure you want to delete this calculation?')) {
                state.calculations.splice(index, 1);
                saveHistoryToStorage();
                renderHistory();
            }
        }

        // Show save tooltip
        function showSaveTooltip(targetElement, text) {
            const rect = targetElement.getBoundingClientRect();
            const tooltip = document.createElement('div');
            tooltip.className = 'income-tax-save-tooltip';
            tooltip.textContent = text;
            
            document.body.appendChild(tooltip);
            
            // Position tooltip above the element
            // We need to render it first to get dimensions, but it's already in DOM
            // Force a layout calc/paint frame if needed, but usually rAF is enough
            
            const tooltipRect = tooltip.getBoundingClientRect(); // This might be 0 if not rendered? No, it's in DOM.
            // But since it's fixed position and newly added, it has dimensions based on content.
            
            const top = rect.top - tooltipRect.height - 10; 
            const left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
            
            tooltip.style.top = `${top}px`;
            tooltip.style.left = `${left}px`;
            
            // Trigger animation
            requestAnimationFrame(() => {
                tooltip.classList.add('visible');
            });
            
            // Remove after delay
            setTimeout(() => {
                tooltip.classList.remove('visible');
                setTimeout(() => {
                    if (tooltip.parentNode) {
                        tooltip.parentNode.removeChild(tooltip);
                    }
                }, 300);
            }, 2000);
        }

        // Utility functions
        async function saveCalculation() {
            // Prevent saving while calculation is in progress
            if (state.isCalculating) {
                return;
            }
            
            if (state.currentCalculation) {
                // Check if consent has been given
                if (state.storageConsent === null) {
                    // Ask for consent
                    await showStorageConsentDialog();
                }
                
                // Add unique ID if not present
                if (!state.currentCalculation.id) {
                    state.currentCalculation.id = Date.now() + Math.random();
                }
                
                // ‚úÖ Rental Income Tax: Check if this calculation already exists (prevent duplicates)
                // Normalize values for proper comparison (handle type mismatches)
                const currentCalc = state.currentCalculation;
                const normalizeNumeric = (val) => {
                    if (val === null || val === undefined) return null;
                    const num = typeof val === 'string' ? parseFloat(val.replace(/,/g, '')) : Number(val);
                    return isNaN(num) ? null : Math.round(num);
                };
                
                const normalizeTaxYear = (val) => {
                    if (!val) return '';
                    // Extract just the year part if it's a full date string
                    const dateStr = String(val);
                    const yearMatch = dateStr.match(/^(\d{4})/);
                    return yearMatch ? yearMatch[1] : dateStr;
                };
                
                // ‚úÖ Rental Income Tax fields for duplicate detection - use fields that are actually saved
                const currentAnnualRentalIncome = normalizeNumeric(currentCalc.annualRentalIncome || currentCalc.totalIncome || currentCalc.netIncome);
                const currentTaxYear = normalizeTaxYear(currentCalc.taxYear);
                const currentMortgageInterest = normalizeNumeric(currentCalc.mortgageInterest);
                
                const exists = state.calculations.find(c => {
                    const savedAnnualRentalIncome = normalizeNumeric(c.annualRentalIncome || c.totalIncome || c.netIncome);
                    const savedTaxYear = normalizeTaxYear(c.taxYear);
                    const savedMortgageInterest = normalizeNumeric(c.mortgageInterest);
                    
                    // All fields must match exactly to be considered a duplicate
                    return currentAnnualRentalIncome === savedAnnualRentalIncome &&
                           currentTaxYear === savedTaxYear &&
                           currentMortgageInterest === savedMortgageInterest;
                });
                
                if (exists) {
                    alert('‚ö†Ô∏è This calculation is already saved in history.');
                    return;
                }
                
                state.calculations.unshift(state.currentCalculation);
                
                // Limit to last 50 calculations
                if (state.calculations.length > 50) {
                    state.calculations = state.calculations.slice(0, 50);
                }
                    
                    // Store consent value for tooltip message
                    const wasPermanent = state.storageConsent === true;
                
                saveHistoryToStorage();
                renderHistory();
                    
                    // Keep the consent value for the current session (don't reset it)
                    // It will only be reset on page reload if it was temporary
                
                // Show success message with visual feedback
                const saveButtons = document.querySelectorAll('button[onclick*="saveCalculation"]');
                saveButtons.forEach(btn => {
                    const originalText = btn.textContent;
                    const originalBg = btn.style.background || '';
                    const originalColor = btn.style.color || '';
                    
                    // Update button text to just "Saved"
                    btn.textContent = 'Saved';
                    btn.style.background = '#10b981'; // Green
                    btn.style.color = 'white';
                    
                    // Show tooltip with specific message
                        const tooltipText = wasPermanent ? 'Saved to history' : 'Saved temporary to history';
                    showSaveTooltip(btn, tooltipText);
                    
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = originalBg;
                        btn.style.color = originalColor;
                    }, 2000);
                });
            } else {
                alert('‚ö†Ô∏è No calculation to save. Please perform a calculation first.');
            }
        }

        // Export/Share Logic
        function exportData() {
                // Export calculations as CSV file
                downloadCSV();
        }

        function downloadCSV() {
                // Load calculations from storage if state is empty
                let calculations = state.calculations;
                
                if (calculations.length === 0) {
                    // Try to load from storage
                    try {
                        let storedCalculations = null;
                        
                        // Try localStorage first (if consent given)
                        if (state.storageConsent === true) {
                            const localStorageData = localStorage.getItem('sdlt_calculations_history');
                            if (localStorageData) {
                                storedCalculations = JSON.parse(localStorageData);
                            }
                        }
                        
                        // If not in localStorage, try sessionStorage
                        if (!storedCalculations || storedCalculations.length === 0) {
                            const sessionStorageData = sessionStorage.getItem('sdlt_calculations_history');
                            if (sessionStorageData) {
                                storedCalculations = JSON.parse(sessionStorageData);
                            }
                        }
                        
                        if (storedCalculations && storedCalculations.length > 0) {
                            calculations = storedCalculations;
                            // Update state with loaded calculations
                            state.calculations = storedCalculations;
                        }
                    } catch (error) {
                        console.error('Error loading calculations from storage:', error);
                    }
                }
                
                if (calculations.length === 0) {
                alert('‚ö†Ô∏è No calculations to export.');
                return;
            }
            
            // Create CSV content
            // ‚úÖ Rental Income Tax CSV columns
            let csv = 'Date,Tax Year,Annual Rental Income,Net Income,Total Tax,Allowance Used,Mortgage Interest\n';
            
                calculations.forEach(calc => {
                const date = new Date(calc.timestamp).toLocaleString('en-GB');
                // ‚úÖ Rental Income Tax uses 'totalTax', not 'totalTaxLiability'
                const totalTax = Math.round(calc.totalTax || 0);
                const taxYear = calc.taxYear || 'N/A';
                const annualRentalIncome = calc.annualRentalIncome || calc.netIncome || 0;
                const netIncome = calc.netIncome || 0;
                const allowanceUsed = calc.usedAllowance || 0;
                const mortgageInterest = calc.mortgageInterest || 0;
                
                csv += `"${date}","${taxYear}","${annualRentalIncome}","${netIncome}","${totalTax}","${allowanceUsed}","${mortgageInterest}"\n`;
            });
            
            // Add signature/attribution
            csv += '\n';
            csv += '"Generated by Rentalbux.com Income Tax Calculator"\n';
            csv += `"Exported on: ${new Date().toLocaleString('en-GB')}"\n`;
            csv += '"Visit: https://www.rentalbux.com"\n';
            
            // Create download link
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sdlt_calculations_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Image Generation & Sharing
        function openShareModal() {
            const modal = document.getElementById('income-tax-shareModal');
            if (!modal) return;
            
            modal.classList.add('active');
            
            // Reset previous image state completely
            const imgPreview = document.getElementById('income-tax-shareImage');
            const loader = document.getElementById('income-tax-shareLoader');
            const preview = document.getElementById('income-tax-sharePreview');
            
            // Clear any previous error messages or content
            if (preview) {
                const errorMsg = preview.querySelector('p');
                if (errorMsg) {
                    errorMsg.remove();
                }
            }
            
            state.lastGeneratedImage = null;
            if (imgPreview) {
                imgPreview.src = '';
                imgPreview.style.display = 'none';
                imgPreview.onload = null;
                imgPreview.onerror = null;
            }
            if (loader) {
                loader.style.display = 'flex';
            }
            updateShareButtonsState();
            
            // Small delay to ensure modal is fully rendered and styles are ready
            // This is especially important when embedded in Next.js
            // Also check if "How We Calculated" section is expanded and wait for it to render
            const howWeCalculatedContent = document.getElementById('income-tax-howWeCalculatedContent');
            const isExpanded = howWeCalculatedContent && 
                             howWeCalculatedContent.style.display !== 'none' && 
                             window.getComputedStyle(howWeCalculatedContent).display !== 'none';
            
            // If expanded, wait a bit longer for content to render
            const delay = isExpanded ? 300 : 150;
            
            setTimeout(() => {
            generateOverviewImage();
            }, delay);
        }

        function closeShareModal() {
            const modal = document.getElementById('income-tax-shareModal');
            if (modal) modal.classList.remove('active');
        }
        
        // Handle ESC key to close modals
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' || e.keyCode === 27) {
                // Close share modal
                const shareModal = document.getElementById('income-tax-shareModal');
                if (shareModal && shareModal.classList.contains('active')) {
                    closeShareModal();
                    return;
                }
                
                // Close expert modal
                const expertModal = document.getElementById('income-tax-expertModal');
                if (expertModal && expertModal.classList.contains('active')) {
                    closeExpertModal();
                    return;
                }
                
                // Close storage consent modal
                const storageModal = document.getElementById('income-tax-storageConsentModal');
                if (storageModal && storageModal.classList.contains('active')) {
                    closeStorageConsentModal(false);
                    return;
                }
            }
        });

        function generateOverviewImage() {
            const loader = document.getElementById('income-tax-shareLoader');
            const imgPreview = document.getElementById('income-tax-shareImage');
            
            // Determine which content to capture based on active mode
            // Use state.aiMode as the primary indicator
            const aiResults = document.getElementById('income-tax-aiResults');
            const simpleResults = document.getElementById('income-tax-simpleResults');
            
            let targetElement;
            let trustpilotSection;
            let disclaimerSection;
            let explanationCard;
            
            if (state.aiMode && aiResults) {
                 // For AI mode, capture the entire aiResults container to include all sections
                 // Even if it has income-tax-hidden class, we'll remove it when cloning
                 targetElement = aiResults;
                 
                 // Get sections within aiResults
                 if (targetElement) {
                     trustpilotSection = targetElement.querySelector('.income-tax-cta-banner');
                     disclaimerSection = targetElement.querySelector('.income-tax-disclaimer');
                     explanationCard = targetElement.querySelector('.income-tax-explanation-card');
                 }
                 
                 // Fallback: if Trustpilot / disclaimer are not inside aiResults,
                 // look for them in the main overview container (they are siblings there)
                 if (!trustpilotSection || !disclaimerSection) {
                     const overviewTab = document.getElementById('income-tax-overview');
                     if (overviewTab) {
                         if (!trustpilotSection) {
                             trustpilotSection = overviewTab.querySelector('.income-tax-cta-banner');
                         }
                         if (!disclaimerSection) {
                             disclaimerSection = overviewTab.querySelector('.income-tax-disclaimer');
                         }
                     }
                 }
            } else {
                 // For Simple mode, capture the simple results container
                 targetElement = document.getElementById('income-tax-simpleResultsGrid');
                 
                 // Get Trustpilot and disclaimer sections - they're inside income-tax-aiResults (shared between modes)
                 const aiResults = document.getElementById('income-tax-aiResults');
                 if (aiResults) {
                     trustpilotSection = aiResults.querySelector('.income-tax-cta-banner');
                     disclaimerSection = aiResults.querySelector('.income-tax-disclaimer');
                 }
                 
                 // Fallback: check in overview tab if not found in aiResults
                 if (!trustpilotSection || !disclaimerSection) {
                     const overviewTab = document.getElementById('income-tax-overview');
                     if (overviewTab) {
                         if (!trustpilotSection) trustpilotSection = overviewTab.querySelector('.income-tax-cta-banner');
                         if (!disclaimerSection) disclaimerSection = overviewTab.querySelector('.income-tax-disclaimer');
                     }
                 }
            }
            
            // Create a temporary wrapper container that includes all sections
            const tempWrapper = document.createElement('div');
            // Strictly enforce 820px max-width
            // Ensure no unwanted borders or outlines appear
            tempWrapper.style.cssText = 'background: white; padding: 20px; border-radius: 12px; max-width: 820px !important; width: 820px !important; margin: 0 auto; box-sizing: border-box; overflow: hidden; border: none; outline: none; box-shadow: none;';
            
            // Set fixed max-width for all exports
            const maxWidth = '820px';
            
            // For AI mode, if targetElement is aiResults, we can use it directly
            // Otherwise, clone and append elements to wrapper
            if (state.aiMode && targetElement && targetElement.id === 'income-tax-aiResults') {
                // For AI mode, clone the entire aiResults container
                const clonedContainer = targetElement.cloneNode(true);
                
                // Remove hidden class from cloned container to ensure it's visible
                clonedContainer.classList.remove('income-tax-hidden');
                clonedContainer.style.display = 'block';
                clonedContainer.style.visibility = 'visible';
                clonedContainer.style.opacity = '1';
                
                // Copy all computed styles from original to preserve exact appearance
                try {
                    const originalComputedStyle = window.getComputedStyle(targetElement);
                    clonedContainer.style.padding = originalComputedStyle.padding;
                    clonedContainer.style.margin = originalComputedStyle.margin;
                    clonedContainer.style.border = originalComputedStyle.border;
                    clonedContainer.style.borderRadius = originalComputedStyle.borderRadius;
                    clonedContainer.style.boxSizing = originalComputedStyle.boxSizing || 'border-box';
                    clonedContainer.style.outline = 'none';
                    clonedContainer.style.outlineWidth = '0';
                } catch (e) {
                    // Silently continue
                }
                
                // Ensure Trustpilot and disclaimer are visible (they might be hidden)
                // Note: These are outside the dashboard-grid, so we need to handle them separately
                const clonedTrustpilot = clonedContainer.querySelector('.income-tax-cta-banner');
                if (clonedTrustpilot) {
                    clonedTrustpilot.style.display = 'block';
                    clonedTrustpilot.style.visibility = 'visible';
                    clonedTrustpilot.style.maxWidth = '100%';
                    clonedTrustpilot.style.width = '100%';
                    clonedTrustpilot.style.marginLeft = '0';
                    clonedTrustpilot.style.marginRight = '0';
                    clonedTrustpilot.style.marginTop = '20px';
                    clonedTrustpilot.style.marginBottom = '20px';
                    clonedTrustpilot.style.opacity = '1';
                    clonedTrustpilot.style.position = 'relative';
                    clonedTrustpilot.style.zIndex = '1';
                    // Remove any hidden classes
                    clonedTrustpilot.classList.remove('income-tax-hidden');
                } else {
                    console.warn('AI Mode Export: Trustpilot section not found in cloned container');
                }
                
                const clonedDisclaimer = clonedContainer.querySelector('.income-tax-disclaimer');
                if (clonedDisclaimer) {
                    clonedDisclaimer.style.display = 'block';
                    clonedDisclaimer.style.visibility = 'visible';
                    clonedDisclaimer.style.maxWidth = '100%';
                    clonedDisclaimer.style.width = '100%';
                    clonedDisclaimer.style.marginLeft = '0';
                    clonedDisclaimer.style.marginRight = '0';
                    clonedDisclaimer.style.marginTop = '20px';
                    clonedDisclaimer.style.marginBottom = '20px';
                    clonedDisclaimer.style.opacity = '1';
                    clonedDisclaimer.style.position = 'relative';
                    clonedDisclaimer.style.zIndex = '1';
                    // Remove any hidden classes
                    clonedDisclaimer.classList.remove('income-tax-hidden');
                } else {
                    console.warn('AI Mode Export: Disclaimer section not found in cloned container');
                }
                
                // Debug: Log what sections we found
                console.log('AI Mode Export - Found sections:');
                console.log('Trustpilot:', !!clonedTrustpilot);
                console.log('Disclaimer:', !!clonedDisclaimer);
                console.log('Dashboard Grid:', !!clonedContainer.querySelector('.income-tax-dashboard-grid'));
                console.log('Tax Card:', !!clonedContainer.querySelector('.income-tax-tax-card'));
                console.log('AI Card:', !!clonedContainer.querySelector('.income-tax-ai-card'));
                
                // Hide all loaders in cloned container (they shouldn't appear in export)
                const clonedLoaders = clonedContainer.querySelectorAll('.income-tax-card-loader, .income-tax-loader-container');
                clonedLoaders.forEach(loader => {
                    loader.style.display = 'none';
                    loader.classList.remove('active');
                });
                
                // Ensure AI card is visible and its content is displayed
                const clonedAICard = clonedContainer.querySelector('.income-tax-ai-card');
                if (clonedAICard) {
                    clonedAICard.style.display = 'block';
                    clonedAICard.style.visibility = 'visible';
                    clonedAICard.style.opacity = '1';
                    clonedAICard.style.position = 'relative';
                    clonedAICard.style.zIndex = '1';
                    
                    // Ensure AI card header and content are visible
                    const aiCardHeader = clonedAICard.querySelector('.income-tax-ai-card-header');
                    if (aiCardHeader) {
                        aiCardHeader.style.display = 'flex';
                        aiCardHeader.style.visibility = 'visible';
                        aiCardHeader.style.opacity = '1';
                    }
                    const aiCardContent = clonedAICard.querySelector('.income-tax-ai-content');
                    if (aiCardContent) {
                        aiCardContent.style.display = 'flex';
                        aiCardContent.style.visibility = 'visible';
                        aiCardContent.style.opacity = '1';
                    }
                }
                
                // Ensure tax card is visible
                const clonedTaxCard = clonedContainer.querySelector('.income-tax-tax-card');
                if (clonedTaxCard) {
                    clonedTaxCard.style.display = 'block';
                    clonedTaxCard.style.visibility = 'visible';
                    clonedTaxCard.style.opacity = '1';
                }
                
                // Apply width constraint to dashboard grid to prevent overflow
                // Force grid to use 3-column layout even at 820px width
                const clonedDashboardGrid = clonedContainer.querySelector('.income-tax-dashboard-grid');
                if (clonedDashboardGrid) {
                    clonedDashboardGrid.style.maxWidth = '100%';
                    clonedDashboardGrid.style.width = '100%';
                    clonedDashboardGrid.style.boxSizing = 'border-box';
                    // Force 3-column layout for export (override media query)
                    clonedDashboardGrid.style.display = 'grid';
                    clonedDashboardGrid.style.gridTemplateColumns = 'repeat(3, 1fr)';
                    clonedDashboardGrid.style.gap = '24px';
                }
                
                // Force column spans for export
                const clonedTaxCardSpan = clonedContainer.querySelector('.income-tax-tax-card.income-tax-dashboard-col-span-2');
                if (clonedTaxCardSpan) {
                    clonedTaxCardSpan.style.gridColumn = 'span 2';
                }
                const clonedExplanationCardSpan = clonedContainer.querySelector('.income-tax-explanation-card.income-tax-dashboard-col-span-3');
                if (clonedExplanationCardSpan) {
                    clonedExplanationCardSpan.style.gridColumn = 'span 3';
                }
                const clonedDisclaimerSpan = clonedContainer.querySelector('.income-tax-disclaimer.income-tax-dashboard-col-span-3');
                if (clonedDisclaimerSpan) {
                    clonedDisclaimerSpan.style.gridColumn = 'span 3';
                }
                
                // Apply width constraint to explanation card to prevent overflow
                // Use the same element we found earlier for span
                if (clonedExplanationCardSpan) {
                    clonedExplanationCardSpan.style.maxWidth = '100%';
                    clonedExplanationCardSpan.style.width = '100%';
                    clonedExplanationCardSpan.style.boxSizing = 'border-box';
                    clonedExplanationCardSpan.style.overflow = 'hidden';
                    clonedExplanationCardSpan.style.wordWrap = 'break-word';
                }
                
                // Check if "How We Calculated" section is expanded and handle accordingly
                const clonedExplanationContent = clonedContainer.querySelector('#income-tax-howWeCalculatedContent');
                if (clonedExplanationContent) {
                    const originalContent = document.getElementById('income-tax-howWeCalculatedContent');
                    if (originalContent) {
                        // Check both inline style and computed style to determine if expanded
                        const inlineDisplay = originalContent.style.display;
                        const computedDisplay = window.getComputedStyle(originalContent).display;
                        const isExpanded = inlineDisplay !== 'none' && computedDisplay !== 'none';
                        
                        if (isExpanded) {
                            // Ensure it's visible in the cloned version
                            clonedExplanationContent.style.display = 'block';
                            clonedExplanationContent.style.visibility = 'visible';
                            clonedExplanationContent.style.opacity = '1';
                            
                            // Copy all computed styles to preserve layout
                            try {
                                const computedStyle = window.getComputedStyle(originalContent);
                                clonedExplanationContent.style.padding = computedStyle.padding;
                                clonedExplanationContent.style.margin = computedStyle.margin;
                                clonedExplanationContent.style.marginTop = computedStyle.marginTop;
                                clonedExplanationContent.style.marginBottom = computedStyle.marginBottom;
                                clonedExplanationContent.style.border = computedStyle.border;
                                clonedExplanationContent.style.borderWidth = computedStyle.borderWidth;
                                clonedExplanationContent.style.borderColor = computedStyle.borderColor;
                                clonedExplanationContent.style.borderStyle = computedStyle.borderStyle;
                                clonedExplanationContent.style.outline = 'none';
                                clonedExplanationContent.style.outlineWidth = '0';
                            } catch (e) {
                                // Silently continue
                            }
                        } else {
                            // Hide the entire explanation card if collapsed
                            const clonedExplanationCardToHide = clonedContainer.querySelector('.income-tax-explanation-card');
                            if (clonedExplanationCardToHide) {
                                clonedExplanationCardToHide.style.display = 'none';
                            }
                        }
                    }
                }
                
                // Show attribution watermarks in cloned container (for export only)
                const clonedAttribution = clonedContainer.querySelector('.income-tax-attribution');
                if (clonedAttribution) {
                    clonedAttribution.style.display = 'block';
                }
                const clonedSimpleAttribution = clonedContainer.querySelector('.income-tax-simple-attribution');
                if (clonedSimpleAttribution) {
                    clonedSimpleAttribution.style.display = 'block';
                }
                
                // Apply width constraint to cloned container
                clonedContainer.style.maxWidth = '100%';
                clonedContainer.style.width = '100%';
                clonedContainer.style.boxSizing = 'border-box';
                clonedContainer.style.overflow = 'hidden';
                
                tempWrapper.appendChild(clonedContainer);
            } else {
                // For simple mode or fallback, clone individual elements
                if (targetElement) {
                    const clonedTarget = targetElement.cloneNode(true);
                    // Constrain to wrapper width
                    clonedTarget.style.maxWidth = '100%';
                    clonedTarget.style.width = '100%';
                    clonedTarget.style.margin = '0';
                    clonedTarget.style.boxSizing = 'border-box';
                    clonedTarget.style.overflow = 'hidden';
                    tempWrapper.appendChild(clonedTarget);
                    
                    // Show attribution in cloned simple target if it exists
                    const clonedSimpleAttribution = clonedTarget.querySelector('.income-tax-simple-attribution');
                    if (clonedSimpleAttribution) {
                        clonedSimpleAttribution.style.display = 'block';
                    }
                } else {
                    console.error('Simple mode: targetElement not found');
                }
            }
            
            // Append Trustpilot and disclaimer sections for BOTH modes (if available)
            // This guarantees they are present in the export regardless of layout container
            if (trustpilotSection) {
                const exportedTrustpilot = trustpilotSection.cloneNode(true);
                exportedTrustpilot.style.marginTop = '20px';
                exportedTrustpilot.style.maxWidth = '100%';
                exportedTrustpilot.style.width = '100%';
                exportedTrustpilot.style.marginLeft = '0';
                exportedTrustpilot.style.marginRight = '0';
                exportedTrustpilot.style.display = 'block';
                exportedTrustpilot.style.boxSizing = 'border-box';
                exportedTrustpilot.style.overflow = 'hidden';
                
                // Hide CTA buttons in exported image
                const ctaButtons = exportedTrustpilot.querySelector('.income-tax-cta-buttons');
                if (ctaButtons) {
                    ctaButtons.style.display = 'none';
                }
                
                tempWrapper.appendChild(exportedTrustpilot);
            } else {
                console.warn((state.aiMode ? 'AI mode' : 'Simple mode') + ': Trustpilot section not found');
            }
            
            if (disclaimerSection) {
                const exportedDisclaimer = disclaimerSection.cloneNode(true);
                exportedDisclaimer.style.marginTop = '20px';
                exportedDisclaimer.style.maxWidth = '100%';
                exportedDisclaimer.style.width = '100%';
                exportedDisclaimer.style.marginLeft = '0';
                exportedDisclaimer.style.marginRight = '0';
                exportedDisclaimer.style.display = 'block';
                exportedDisclaimer.style.boxSizing = 'border-box';
                exportedDisclaimer.style.overflow = 'hidden';
                tempWrapper.appendChild(exportedDisclaimer);
            } else {
                console.warn((state.aiMode ? 'AI mode' : 'Simple mode') + ': Disclaimer section not found');
            }
            
            // Add footer with contact information
            const footer = document.createElement('div');
            footer.style.cssText = 'width: 100%; padding: 12px 0 0 0; margin-top: 20px; border-top: 1px solid #e5e7eb; display: flex; justify-content: center; align-items: center; gap: 16px; flex-wrap: wrap; font-size: 10px; color: #9ca3af; line-height: 1.4;';
            footer.innerHTML = `
                <span style="display: flex; align-items: center; gap: 4px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="10" height="10" style="opacity: 0.7;"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                    <span>+44 20 1234 5678</span>
                </span>
                <span style="display: flex; align-items: center; gap: 4px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="10" height="10" style="opacity: 0.7;"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                    <span>info@rentalbux.com</span>
                </span>
                <span style="display: flex; align-items: center; gap: 4px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="10" height="10" style="opacity: 0.7;"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
                    <span>www.rentalbux.com</span>
                </span>
            `;
            tempWrapper.appendChild(footer);
            
            // Process all elements in tempWrapper to ensure proper styling
            // This fixes padding, margin, and border issues
            try {
                const allClonedElements = tempWrapper.querySelectorAll('*');
                allClonedElements.forEach(clonedEl => {
                    try {
                        // Find original element to get computed styles
                        let originalEl = null;
                        if (clonedEl.id) {
                            originalEl = document.getElementById(clonedEl.id);
                        } else if (clonedEl.className) {
                            // Try to find by class and position
                            const classList = Array.from(clonedEl.classList);
                            const possibleMatches = document.querySelectorAll('.' + classList[0]);
                            if (possibleMatches.length === 1) {
                                originalEl = possibleMatches[0];
                            }
                        }
                        
                        if (originalEl) {
                            const computedStyle = window.getComputedStyle(originalEl);
                            
                            // Preserve padding
                            if (computedStyle.padding && computedStyle.padding !== '0px') {
                                clonedEl.style.padding = computedStyle.padding;
                            }
                            
                            // Preserve margin (but only if it's not auto)
                            if (computedStyle.margin && computedStyle.margin !== 'auto' && computedStyle.margin !== '0px') {
                                clonedEl.style.margin = computedStyle.margin;
                            }
                            
                            // Remove unwanted borders/outlines
                            if (computedStyle.borderWidth === '0px' || !computedStyle.border || computedStyle.border === 'none') {
                                clonedEl.style.border = 'none';
                                clonedEl.style.borderWidth = '0';
                            } else {
                                // Preserve border if it exists
                                clonedEl.style.border = computedStyle.border;
                            }
                            
                            clonedEl.style.outline = 'none';
                            clonedEl.style.outlineWidth = '0';
                            clonedEl.style.boxSizing = computedStyle.boxSizing || 'border-box';
                        }
                    } catch (e) {
                        // Silently continue
                    }
                });
            } catch (e) {
                // Silently continue
            }
            
            // Append wrapper to body temporarily (off-screen)
            tempWrapper.style.position = 'absolute';
            tempWrapper.style.left = '-9999px';
            tempWrapper.style.top = '0';
            document.body.appendChild(tempWrapper);
            
            // Show loader properly
            if (loader) {
                loader.style.display = 'flex';
            }
            if (imgPreview) imgPreview.style.display = 'none';
            
            if (!targetElement) {
                console.error('Target element for capture not found');
                console.error('AI Mode:', state.aiMode);
                console.error('AI Results element:', document.getElementById('income-tax-aiResults'));
                console.error('Simple Results element:', document.getElementById('income-tax-simpleResultsGrid'));
                if (loader) loader.style.display = 'none';
                document.body.removeChild(tempWrapper);
                const preview = document.getElementById('income-tax-sharePreview');
                if (preview) preview.innerHTML = '<p style="color: #ef4444; padding: 20px; text-align: center;">Error: Could not find content to export. Please ensure you have calculated results.</p>';
                return;
            }
            
            // Debug: Log what we're about to export
            console.log('Exporting in mode:', state.aiMode ? 'AI' : 'Simple');
            console.log('Target element:', targetElement.id || targetElement.className);
            
            if (typeof html2canvas === 'undefined') {
                console.error('html2canvas library not loaded');
                if (loader) loader.style.display = 'none';
                document.body.removeChild(tempWrapper);
                // Show error in modal
                const preview = document.getElementById('income-tax-sharePreview');
                if (preview) preview.innerHTML = '<p style="color: #ef4444; padding: 20px; text-align: center;">Error: Image generation library not loaded. Please refresh page.</p>';
                return;
            }
            
            // Store original styles for restoration
            const originalStyles = new Map();
            
            // Fix CSS variable gradients that html2canvas can't render properly
                // Find all elements with var(--income-tax-primary) background and replace with explicit gradient
            const taxCard = tempWrapper.querySelector('.income-tax-tax-card');
            if (taxCard) {
                // Store original
                originalStyles.set(taxCard, {
                    background: taxCard.style.background || '',
                    backgroundImage: taxCard.style.backgroundImage || ''
                });
                
                // Apply explicit gradient for the primary color (purple gradient)
                taxCard.style.background = 'linear-gradient(255deg, #43468a 0%, #2a2667 100%)';
                taxCard.style.backgroundImage = 'linear-gradient(255deg, #43468a 0%, #2a2667 100%)';
            }
            
            // Fix simple mode sidebar background
            const simpleSidebar = tempWrapper.querySelector('.income-tax-simple-sidebar');
            if (simpleSidebar) {
                // Store original
                originalStyles.set(simpleSidebar, {
                    background: simpleSidebar.style.background || '',
                    backgroundImage: simpleSidebar.style.backgroundImage || ''
                });
                
                    // Check computed style to see if it's using var(--income-tax-primary)
                const computedStyle = window.getComputedStyle(simpleSidebar);
                const computedBg = computedStyle.background || computedStyle.backgroundImage;
                
                // Apply explicit gradient for the primary color (purple gradient)
                simpleSidebar.style.background = 'linear-gradient(255deg, #43468a 0%, #2a2667 100%)';
                simpleSidebar.style.backgroundImage = 'linear-gradient(255deg, #43468a 0%, #2a2667 100%)';
            }
            
            // Fix simple mode amount text gradient (background-clip: text doesn't work with html2canvas)
            const simpleAmount = tempWrapper.querySelector('.income-tax-simple-amount');
            if (simpleAmount) {
                // Store original
                originalStyles.set(simpleAmount, {
                    background: simpleAmount.style.background || '',
                    backgroundImage: simpleAmount.style.backgroundImage || '',
                    webkitBackgroundClip: simpleAmount.style.webkitBackgroundClip || '',
                    webkitTextFillColor: simpleAmount.style.webkitTextFillColor || '',
                    color: simpleAmount.style.color || ''
                });
                
                // Remove gradient text effect and use solid color instead
                simpleAmount.style.background = 'none';
                simpleAmount.style.backgroundImage = 'none';
                simpleAmount.style.webkitBackgroundClip = 'unset';
                simpleAmount.style.webkitTextFillColor = 'unset';
                simpleAmount.style.color = '#1e293b'; // Use dark grey color instead of gradient
            }
            
                // Fix Trustpilot banner gradient if it uses var(--income-tax-primary)
            const trustpilotBanner = tempWrapper.querySelector('.income-tax-cta-banner');
            if (trustpilotBanner) {
                const computedStyle = window.getComputedStyle(trustpilotBanner);
                const bg = computedStyle.background || computedStyle.backgroundImage || '';
                    if (bg.includes('var(--income-tax-primary)')) {
                    originalStyles.set(trustpilotBanner, {
                        background: trustpilotBanner.style.background || '',
                        backgroundImage: trustpilotBanner.style.backgroundImage || ''
                    });
                    trustpilotBanner.style.background = 'linear-gradient(255deg, #43468a 0%, #2a2667 100%)';
                    trustpilotBanner.style.backgroundImage = 'linear-gradient(255deg, #43468a 0%, #2a2667 100%)';
                }
            }
            
            // Also check for any other elements with gradient backgrounds using computed styles
            const allElements = tempWrapper.querySelectorAll('*');
            allElements.forEach(el => {
                if (!originalStyles.has(el)) {
                    const computedStyle = window.getComputedStyle(el);
                    const bg = computedStyle.background || computedStyle.backgroundImage || '';
                    
                    // Check if background uses CSS variable or is a gradient
                        if (bg.includes('var(--income-tax-primary)') || (bg.includes('linear-gradient') && bg.includes('43468a'))) {
                        originalStyles.set(el, {
                            background: el.style.background || '',
                            backgroundImage: el.style.backgroundImage || ''
                        });
                        
                        // Only apply if it's actually using the primary gradient
                            if (bg.includes('var(--income-tax-primary)') || el.classList.contains('income-tax-tax-card') || el.classList.contains('income-tax-simple-sidebar')) {
                            el.style.background = 'linear-gradient(255deg, #43468a 0%, #2a2667 100%)';
                            el.style.backgroundImage = 'linear-gradient(255deg, #43468a 0%, #2a2667 100%)';
                        }
                    }
                }
            });
            
                // Pre-process tempWrapper to convert any lab() colors before html2canvas processes it
                // This is a proactive step before html2canvas even starts parsing
                try {
                    const preProcessElements = tempWrapper.querySelectorAll('*');
                    preProcessElements.forEach(el => {
                        try {
                            const computedStyle = window.getComputedStyle(el);
                            const colorProps = ['color', 'backgroundColor', 'borderColor'];
                            colorProps.forEach(prop => {
                                const value = computedStyle[prop];
                                if (value && value.match(/(lab|oklch|lch|var)\(/i)) {
                                    // Force convert to RGB by creating temp element
                                    const tempDiv = document.createElement('div');
                                    tempDiv.style.cssText = `${prop}: ${value}; position: absolute; visibility: hidden;`;
                                    document.body.appendChild(tempDiv);
                                    const rgbValue = window.getComputedStyle(tempDiv)[prop];
                                    document.body.removeChild(tempDiv);
                                    if (rgbValue && rgbValue.match(/^(rgb|rgba|#)/i)) {
                                        el.style[prop] = rgbValue;
                                    }
                                } else if (value && value.match(/^(rgb|rgba|#)/i)) {
                                    // Set explicitly to override CSS variables
                                    el.style[prop] = value;
                                }
                            });
                        } catch (e) {
                            // Silently continue
                        }
                    });
                } catch (e) {
                    // Silently continue
                }
            
            html2canvas(tempWrapper, {
                scale: 2, // Higher quality (Retina)
                backgroundColor: '#ffffff',
                logging: false,
                useCORS: true,
                allowTaint: true,
                width: 820, // Explicitly set width
                windowWidth: 820, // Ensure html2canvas respects the width
                onclone: (clonedDoc) => {
                        // Convert ALL colors to explicit RGB/hex for html2canvas compatibility
                        // html2canvas doesn't support lab(), oklch(), or other modern color functions
                        // This is critical when embedded in Next.js or other frameworks that may use modern CSS
                        const allElements = clonedDoc.querySelectorAll('*');
                        const originalDoc = document;
                        
                        // First, remove all external stylesheets and link tags that might contain lab() colors
                        // This prevents html2canvas from parsing parent page styles (critical for Next.js embedding)
                        try {
                            // Remove all link tags for external stylesheets
                            const linkTags = clonedDoc.querySelectorAll('link[rel="stylesheet"]');
                            linkTags.forEach(link => {
                                // Only keep stylesheets that are part of the calculator
                                const href = link.getAttribute('href') || '';
                                if (href && !href.includes('sdlt') && !href.includes('calculator')) {
                                    link.remove();
                                }
                            });
                            
                            // Also try to access and remove from styleSheets collection
                            try {
                                const styleSheets = Array.from(clonedDoc.styleSheets || []);
                                styleSheets.forEach((sheet) => {
                                    try {
                                        if (sheet.href && !sheet.href.includes('sdlt') && !sheet.href.includes('calculator')) {
                                            // Try to find and remove the link element
                                            const linkEl = clonedDoc.querySelector(`link[href*="${sheet.href.split('/').pop()}"]`);
                                            if (linkEl) {
                                                linkEl.remove();
                                            }
                                        }
                                    } catch (e) {
                                        // Cross-origin stylesheets will throw, skip them
                                    }
                                });
                            } catch (e) {
                                // Silently continue
                            }
                        } catch (e) {
                            // Silently continue
                        }
                        
                        // Function to convert any color to RGB using canvas (most reliable method)
                        const convertColorToRGB = (colorValue, prop) => {
                            if (!colorValue || colorValue === 'transparent' || colorValue === 'rgba(0, 0, 0, 0)') {
                                return colorValue;
                            }
                            
                            // If it's already RGB/RGBA/HEX, return as is
                            if (colorValue.match(/^(rgb|rgba|#)/i)) {
                                return colorValue;
                            }
                            
                            // If it contains unsupported color functions, convert using canvas
                            if (colorValue.includes('lab(') || colorValue.includes('LAB(') || 
                                colorValue.includes('oklch(') || colorValue.includes('OKLCH(') ||
                                colorValue.includes('lch(') || colorValue.includes('LCH(')) {
                                
                                try {
                                    // Create a temporary element to get computed RGB
                                    const tempDiv = originalDoc.createElement('div');
                                    tempDiv.style.cssText = `${prop}: ${colorValue}; position: absolute; visibility: hidden;`;
                                    originalDoc.body.appendChild(tempDiv);
                                    const computedRGB = window.getComputedStyle(tempDiv)[prop];
                                    originalDoc.body.removeChild(tempDiv);
                                    
                                    if (computedRGB && !computedRGB.match(/(lab|oklch|lch)\(/i) && 
                                        computedRGB !== 'transparent' && computedRGB !== 'rgba(0, 0, 0, 0)') {
                                        return computedRGB;
                                    }
                                } catch (e) {
                                    // Fallback if conversion fails
                                }
                            }
                            
                            return colorValue;
                        };
                        
                        allElements.forEach(clonedEl => {
                            try {
                                // Try to find the original element in the main document
                                let originalEl = null;
                                if (clonedEl.id) {
                                    originalEl = originalDoc.getElementById(clonedEl.id);
                                }
                                
                                // Get computed style from original element if found, otherwise from cloned
                                const sourceEl = originalEl || clonedEl;
                                let computedStyle;
                                try {
                                    computedStyle = window.getComputedStyle(sourceEl);
                                } catch (e) {
                                    return; // Skip if can't get computed style
                                }
                                
                                if (!computedStyle) return;
                                
                                // Convert ALL color properties to explicit RGB values
                                const colorProps = ['color', 'backgroundColor', 'borderColor', 'borderTopColor', 
                                                   'borderRightColor', 'borderBottomColor', 'borderLeftColor',
                                                   'outlineColor', 'textDecorationColor', 'fill', 'stroke'];
                                
                                colorProps.forEach(prop => {
                                    try {
                                        const computedValue = computedStyle[prop];
                                        
                                        if (computedValue && computedValue !== 'transparent' && computedValue !== 'rgba(0, 0, 0, 0)') {
                                            // Always convert ALL colors to explicit RGB/hex format
                                            // This ensures html2canvas never sees lab(), oklch(), or CSS variables
                                            let rgbValue = computedValue;
                                            
                                            // Check if it's already in a safe format
                                            const isSafeFormat = rgbValue.match(/^(rgb|rgba|#|transparent)/i);
                                            
                                            if (!isSafeFormat || rgbValue.match(/(lab|oklch|lch|var)\(/i)) {
                                                // Need to convert - use temporary element method
                                                try {
                                                    const tempDiv = originalDoc.createElement('div');
                                                    tempDiv.style.cssText = `${prop}: ${computedValue}; position: absolute; visibility: hidden; pointer-events: none;`;
                                                    originalDoc.body.appendChild(tempDiv);
                                                    const computedRGB = window.getComputedStyle(tempDiv)[prop];
                                                    originalDoc.body.removeChild(tempDiv);
                                                    
                                                    if (computedRGB && computedRGB.match(/^(rgb|rgba|#|transparent)/i) && 
                                                        !computedRGB.match(/(lab|oklch|lch|var)\(/i)) {
                                                        rgbValue = computedRGB;
                                                    } else {
                                                        // Fallback to safe defaults
                                                        if (prop === 'color') {
                                                            rgbValue = '#1f2937';
                                                        } else if (prop.includes('background')) {
                                                            rgbValue = '#ffffff';
                                                        } else if (prop.includes('border') || prop.includes('outline')) {
                                                            rgbValue = '#e5e7eb';
                                                        } else {
                                                            rgbValue = '#000000';
                                                        }
                                                    }
                                                } catch (e) {
                                                    // Use fallback if conversion fails
                                                    if (prop === 'color') {
                                                        rgbValue = '#1f2937';
                                                    } else if (prop.includes('background')) {
                                                        rgbValue = '#ffffff';
                                                    } else {
                                                        rgbValue = '#e5e7eb';
                                                    }
                                                }
                                            }
                                            
                                            // Always set explicitly to override any CSS variables or computed styles
                                            clonedEl.style[prop] = rgbValue;
                                        }
                                    } catch (e) {
                                        // Silently continue
                                    }
                                });
                                
                                // Handle background-image (gradients might contain lab() colors)
                                try {
                                    const bgImage = computedStyle.backgroundImage;
                                    const bgImageValue = computedStyle.getPropertyValue('background-image');
                                    
                                    if (bgImage && bgImage !== 'none') {
                                        // Check if background-image contains unsupported color functions
                                        if (bgImage.match(/(lab|oklch|lch)\(/i) || 
                                            (bgImageValue && bgImageValue.match(/(lab|oklch|lch)\(/i))) {
                                            // Remove background-image and use background-color instead
                                            clonedEl.style.backgroundImage = 'none';
                                            const bgColor = computedStyle.backgroundColor;
                                            const rgbBgColor = convertColorToRGB(bgColor, 'backgroundColor');
                                            if (rgbBgColor && rgbBgColor !== 'transparent') {
                                                clonedEl.style.backgroundColor = rgbBgColor;
                                            } else {
                                                clonedEl.style.backgroundColor = '#ffffff';
                                            }
                                        } else {
                                            // Set background-image explicitly to avoid CSS variable issues
                                            clonedEl.style.backgroundImage = bgImage;
                                        }
                                    }
                                } catch (e) {
                                    // Silently continue
                                }
                                
                                // Preserve all layout-related computed styles to maintain exact appearance
                                // This ensures padding, margin, borders, etc. are exactly as displayed
                                try {
                                    const layoutProps = [
                                        'padding', 'paddingTop', 'paddingRight', 'paddingBottom', 'paddingLeft',
                                        'margin', 'marginTop', 'marginRight', 'marginBottom', 'marginLeft',
                                        'border', 'borderTop', 'borderRight', 'borderBottom', 'borderLeft',
                                        'borderWidth', 'borderStyle', 'borderColor',
                                        'borderRadius', 'borderTopLeftRadius', 'borderTopRightRadius',
                                        'borderBottomLeftRadius', 'borderBottomRightRadius',
                                        'width', 'height', 'minWidth', 'minHeight', 'maxWidth', 'maxHeight',
                                        'display', 'position', 'top', 'right', 'bottom', 'left',
                                        'flex', 'flexDirection', 'flexWrap', 'justifyContent', 'alignItems', 'alignContent',
                                        'grid', 'gridTemplateColumns', 'gridTemplateRows', 'gridGap',
                                        'gap', 'rowGap', 'columnGap',
                                        'boxSizing', 'overflow', 'overflowX', 'overflowY'
                                    ];
                                    
                                    layoutProps.forEach(prop => {
                                        try {
                                            const value = computedStyle[prop];
                                            if (value && value !== 'auto' && value !== 'normal' && value !== 'none') {
                                                // Only set if it's a meaningful value
                                                if (prop.includes('border') && value === '0px') {
                                                    // Skip zero borders to avoid unwanted outlines
                                                    return;
                                                }
                                                clonedEl.style[prop] = value;
                                            }
                                        } catch (e) {
                                            // Silently continue
                                        }
                                    });
                                    
                                    // Explicitly remove unwanted outlines that might appear
                                    clonedEl.style.outline = 'none';
                                    clonedEl.style.outlineWidth = '0';
                                    clonedEl.style.outlineColor = 'transparent';
                                    clonedEl.style.outlineStyle = 'none';
                                    
                                    // Ensure box-sizing is preserved
                                    if (!clonedEl.style.boxSizing) {
                                        clonedEl.style.boxSizing = computedStyle.boxSizing || 'border-box';
                                    }
                                } catch (e) {
                                    // Silently continue
                                }
                                
                                // Also handle SVG fill and stroke attributes
                                if (clonedEl.tagName && (clonedEl.tagName.toLowerCase() === 'svg' || 
                                    clonedEl.tagName.toLowerCase() === 'path' || 
                                    clonedEl.tagName.toLowerCase() === 'circle' ||
                                    clonedEl.tagName.toLowerCase() === 'rect' ||
                                    clonedEl.tagName.toLowerCase() === 'ellipse')) {
                                    try {
                                        const fill = computedStyle.fill || clonedEl.getAttribute('fill');
                                        const stroke = computedStyle.stroke || clonedEl.getAttribute('stroke');
                                        
                                        if (fill && fill !== 'none') {
                                            const rgbFill = convertColorToRGB(fill, 'fill');
                                            if (rgbFill) {
                                                clonedEl.setAttribute('fill', rgbFill);
                                                clonedEl.style.fill = rgbFill;
                                            }
                                        }
                                        
                                        if (stroke && stroke !== 'none') {
                                            const rgbStroke = convertColorToRGB(stroke, 'stroke');
                                            if (rgbStroke) {
                                                clonedEl.setAttribute('stroke', rgbStroke);
                                                clonedEl.style.stroke = rgbStroke;
                                            }
                                        }
                                    } catch (e) {
                                        // Silently continue
                                    }
                                }
                            } catch (e) {
                                // Silently continue if element processing fails
                            }
                        });
                        
                        // Inject a global style override to prevent any lab() colors from being used
                        // This is a safety net that forces all colors to be computed as RGB
                        try {
                            const styleOverride = clonedDoc.createElement('style');
                            styleOverride.id = 'income-tax-html2canvas-color-override';
                            styleOverride.textContent = `
                                * {
                                    color: inherit !important;
                                    background-color: inherit !important;
                                    border-color: inherit !important;
                                }
                            `;
                            const head = clonedDoc.head || clonedDoc.querySelector('head') || clonedDoc.documentElement;
                            if (head) {
                                head.appendChild(styleOverride);
                            }
                        } catch (e) {
                            // Silently continue
                        }
                        
                        // Also process all stylesheets in the cloned document
                        try {
                            const clonedStylesheets = clonedDoc.styleSheets;
                            if (clonedStylesheets) {
                                for (let i = 0; i < clonedStylesheets.length; i++) {
                                    try {
                                        const sheet = clonedStylesheets[i];
                                        if (sheet && sheet.cssRules) {
                                            for (let j = 0; j < sheet.cssRules.length; j++) {
                                                try {
                                                    const rule = sheet.cssRules[j];
                                                    if (rule.style) {
                                                        // Check and convert color properties in CSS rules
                                                        const colorProps = ['color', 'background-color', 'border-color', 
                                                                           'border-top-color', 'border-right-color', 
                                                                           'border-bottom-color', 'border-left-color',
                                                                           'outline-color', 'text-decoration-color'];
                                                        colorProps.forEach(prop => {
                                                            const value = rule.style.getPropertyValue(prop);
                                                            if (value && value.match(/(lab|oklch|lch|var)\(/i)) {
                                                                // Remove the rule to prevent html2canvas from parsing it
                                                                rule.style.removeProperty(prop);
                                                            }
                                                        });
                                                    }
                                                } catch (e) {
                                                    // Cross-origin stylesheets will throw errors, skip them
                                                }
                                            }
                                        }
                                    } catch (e) {
                                        // Skip inaccessible stylesheets
                                    }
                                }
                            }
                        } catch (e) {
                            // Silently continue
                        }
                        
                        // Final pass: ensure ALL elements have explicit RGB colors set
                        // This is the most aggressive approach - convert every single color property
                        allElements.forEach(clonedEl => {
                            try {
                                const originalEl = clonedEl.id ? originalDoc.getElementById(clonedEl.id) : null;
                                const sourceEl = originalEl || clonedEl;
                                const computedStyle = window.getComputedStyle(sourceEl);
                                
                                if (!computedStyle) return;
                                
                                // Force convert ALL color-related properties one more time
                                const allColorProps = ['color', 'backgroundColor', 'borderColor', 'borderTopColor',
                                                      'borderRightColor', 'borderBottomColor', 'borderLeftColor',
                                                      'outlineColor', 'textDecorationColor', 'fill', 'stroke'];
                                
                                allColorProps.forEach(prop => {
                                    try {
                                        const value = computedStyle[prop];
                                        if (value && value !== 'transparent' && value !== 'rgba(0, 0, 0, 0)') {
                                            // Force set as inline style to override everything
                                            if (value.match(/^(rgb|rgba|#)/i) && !value.match(/(lab|oklch|lch|var)\(/i)) {
                                                clonedEl.style[prop] = value;
                                            }
                                        }
                                    } catch (e) {
                                        // Silently continue
                                    }
                                });
                            } catch (e) {
                                // Silently continue
                            }
                        });
                        
                    // Hide all loaders in cloned document
                    const clonedLoaders = clonedDoc.querySelectorAll('.income-tax-card-loader, .income-tax-loader-container');
                    clonedLoaders.forEach(loader => {
                        loader.style.display = 'none';
                        loader.classList.remove('active');
                    });
                    
                    // Ensure AI card is visible in cloned document and its content is displayed
                    const clonedAICard = clonedDoc.querySelector('.income-tax-ai-card');
                    if (clonedAICard) {
                        clonedAICard.style.display = 'block';
                        clonedAICard.style.visibility = 'visible';
                        clonedAICard.style.opacity = '1';
                        clonedAICard.style.position = 'relative';
                        clonedAICard.style.zIndex = '1';
                        
                        // Ensure AI card header and content are visible
                        const aiCardHeader = clonedAICard.querySelector('.income-tax-ai-card-header');
                        if (aiCardHeader) {
                            aiCardHeader.style.display = 'flex';
                            aiCardHeader.style.visibility = 'visible';
                            aiCardHeader.style.opacity = '1';
                        }
                        const aiCardContent = clonedAICard.querySelector('.income-tax-ai-content');
                        if (aiCardContent) {
                            aiCardContent.style.display = 'flex';
                            aiCardContent.style.visibility = 'visible';
                            aiCardContent.style.opacity = '1';
                        }
                    }
                    
                    // Ensure gradients are properly rendered in the cloned document
                    const clonedTaxCard = clonedDoc.querySelector('.income-tax-tax-card');
                    if (clonedTaxCard) {
                        clonedTaxCard.style.background = 'linear-gradient(255deg, #43468a 0%, #2a2667 100%)';
                        clonedTaxCard.style.backgroundImage = 'linear-gradient(255deg, #43468a 0%, #2a2667 100%)';
                        clonedTaxCard.style.display = 'block';
                        clonedTaxCard.style.visibility = 'visible';
                        clonedTaxCard.style.opacity = '1';
                    }
                    
                    // Fix simple mode sidebar in cloned document
                    const clonedSimpleSidebar = clonedDoc.querySelector('.income-tax-simple-sidebar');
                    if (clonedSimpleSidebar) {
                        clonedSimpleSidebar.style.background = 'linear-gradient(255deg, #43468a 0%, #2a2667 100%)';
                        clonedSimpleSidebar.style.backgroundImage = 'linear-gradient(255deg, #43468a 0%, #2a2667 100%)';
                    }
                    
                    // Fix simple mode amount text in cloned document
                    const clonedSimpleAmount = clonedDoc.querySelector('.income-tax-simple-amount');
                    if (clonedSimpleAmount) {
                        clonedSimpleAmount.style.background = 'none';
                        clonedSimpleAmount.style.backgroundImage = 'none';
                        clonedSimpleAmount.style.webkitBackgroundClip = 'unset';
                        clonedSimpleAmount.style.webkitTextFillColor = 'unset';
                        clonedSimpleAmount.style.color = '#1e293b'; // Use dark grey color instead of gradient
                    }
                    
                    // Force dashboard grid to use 3-column layout in export (override media query)
                    const clonedDashboardGrid = clonedDoc.querySelector('.income-tax-dashboard-grid');
                    if (clonedDashboardGrid) {
                        clonedDashboardGrid.style.display = 'grid';
                        clonedDashboardGrid.style.gridTemplateColumns = 'repeat(3, 1fr)';
                        clonedDashboardGrid.style.gap = '24px';
                        clonedDashboardGrid.style.maxWidth = '100%';
                        clonedDashboardGrid.style.width = '100%';
                    }
                    
                    // Force column spans in cloned document
                    const clonedTaxCardSpan = clonedDoc.querySelector('.income-tax-tax-card.income-tax-dashboard-col-span-2');
                    if (clonedTaxCardSpan) {
                        clonedTaxCardSpan.style.gridColumn = 'span 2';
                    }
                    const clonedExplanationCardSpan = clonedDoc.querySelector('.income-tax-explanation-card.income-tax-dashboard-col-span-3');
                    if (clonedExplanationCardSpan) {
                        clonedExplanationCardSpan.style.gridColumn = 'span 3';
                    }
                    const clonedDisclaimerSpan = clonedDoc.querySelector('.income-tax-disclaimer.income-tax-dashboard-col-span-3');
                    if (clonedDisclaimerSpan) {
                        clonedDisclaimerSpan.style.gridColumn = 'span 3';
                    }
                    
                    // Fix Trustpilot banner in cloned document
                    const clonedTrustpilot = clonedDoc.querySelector('.income-tax-cta-banner');
                    if (clonedTrustpilot) {
                        const computedStyle = window.getComputedStyle(clonedTrustpilot);
                        const bg = computedStyle.background || computedStyle.backgroundImage || '';
                            if (bg.includes('var(--income-tax-primary)')) {
                            clonedTrustpilot.style.background = 'linear-gradient(255deg, #43468a 0%, #2a2667 100%)';
                            clonedTrustpilot.style.backgroundImage = 'linear-gradient(255deg, #43468a 0%, #2a2667 100%)';
                        }
                        // Ensure it's visible and constrained
                        clonedTrustpilot.style.display = 'block';
                        clonedTrustpilot.style.visibility = 'visible';
                        clonedTrustpilot.style.opacity = '1';
                        clonedTrustpilot.style.maxWidth = '100%';
                        clonedTrustpilot.style.width = '100%';
                        clonedTrustpilot.style.marginTop = '20px';
                        clonedTrustpilot.style.marginBottom = '20px';
                        clonedTrustpilot.style.boxSizing = 'border-box';
                        clonedTrustpilot.style.position = 'relative';
                        clonedTrustpilot.style.zIndex = '1';
                        clonedTrustpilot.classList.remove('income-tax-hidden');
                        
                        // Hide CTA buttons in exported image
                        const clonedCtaButtons = clonedTrustpilot.querySelector('.income-tax-cta-buttons');
                        if (clonedCtaButtons) {
                            clonedCtaButtons.style.display = 'none';
                        }
                    } else {
                        console.warn('onclone: Trustpilot section not found');
                    }
                    
                    // Ensure disclaimer is visible and constrained
                    const clonedDisclaimer = clonedDoc.querySelector('.income-tax-disclaimer');
                    if (clonedDisclaimer) {
                        clonedDisclaimer.style.display = 'block';
                        clonedDisclaimer.style.visibility = 'visible';
                        clonedDisclaimer.style.opacity = '1';
                        clonedDisclaimer.style.maxWidth = '100%';
                        clonedDisclaimer.style.width = '100%';
                        clonedDisclaimer.style.marginTop = '20px';
                        clonedDisclaimer.style.marginBottom = '20px';
                        clonedDisclaimer.style.boxSizing = 'border-box';
                        clonedDisclaimer.style.position = 'relative';
                        clonedDisclaimer.style.zIndex = '1';
                        clonedDisclaimer.classList.remove('income-tax-hidden');
                    } else {
                        console.warn('onclone: Disclaimer section not found');
                    }
                    
                    // Constrain explanation card width
                    const clonedExplanationCard = clonedDoc.querySelector('.income-tax-explanation-card');
                    if (clonedExplanationCard) {
                        clonedExplanationCard.style.maxWidth = '100%';
                        clonedExplanationCard.style.width = '100%';
                        clonedExplanationCard.style.boxSizing = 'border-box';
                        clonedExplanationCard.style.overflow = 'hidden';
                        clonedExplanationCard.style.wordWrap = 'break-word';
                    }
                    
                    // Constrain all text content to prevent overflow
                    const allTextElements = clonedDoc.querySelectorAll('p, div, span, h1, h2, h3, h4');
                    allTextElements.forEach(el => {
                        el.style.maxWidth = '100%';
                        el.style.wordWrap = 'break-word';
                        el.style.overflowWrap = 'break-word';
                    });
                    
                    // Show attribution watermarks in cloned document (for export only)
                    const clonedAttribution = clonedDoc.querySelector('.income-tax-attribution');
                    if (clonedAttribution) {
                        clonedAttribution.style.display = 'block';
                    }
                    const clonedSimpleAttribution = clonedDoc.querySelector('.income-tax-simple-attribution');
                    if (clonedSimpleAttribution) {
                        clonedSimpleAttribution.style.display = 'block';
                    }
                }
            }).then(canvas => {
                // Clean up temporary wrapper
                document.body.removeChild(tempWrapper);
                
                const imgData = canvas.toDataURL('image/png');
                state.lastGeneratedImage = imgData;
                
                if (imgPreview) {
                    imgPreview.src = imgData;
                    imgPreview.onload = () => {
                        if (loader) loader.style.display = 'none';
                        imgPreview.style.display = 'block';
                        updateShareButtonsState();
                    };
                } else {
                    // Ensure buttons are enabled even if preview element is missing
                    if (loader) loader.style.display = 'none';
                    updateShareButtonsState();
                }
            }).catch(err => {
                // Clean up temporary wrapper
                if (tempWrapper && tempWrapper.parentNode) {
                document.body.removeChild(tempWrapper);
                }
                
                console.error('Image generation failed:', err);
                
                // Check if error is related to lab() colors
                const isLabColorError = err && err.message && err.message.includes('lab');
                
                if (loader) loader.style.display = 'none';
                const preview = document.getElementById('income-tax-sharePreview');
                if (preview) {
                    let errorMsg = 'Failed to generate image preview.';
                    if (isLabColorError) {
                        errorMsg = 'Image generation failed due to unsupported color format. Please try again or contact support.';
                        console.warn('Lab() color error detected - this may be due to parent page CSS. Retrying with more aggressive color conversion...');
                        
                        // Retry once with a delay to ensure all styles are processed
                        setTimeout(() => {
                            generateOverviewImage();
                        }, 500);
                        return;
                    }
                    preview.innerHTML = `<p style="color: #ef4444; padding: 20px;">${errorMsg}</p>`;
                }
                updateShareButtonsState();
            });
        }

        // Simplified, isolated image generation to avoid parent-page lab() colors
        function generateOverviewImage() {
            const loader = document.getElementById('income-tax-shareLoader');
            const imgPreview = document.getElementById('income-tax-shareImage');
            const preview = document.getElementById('income-tax-sharePreview');

            if (loader) loader.style.display = 'flex';
            if (imgPreview) {
                imgPreview.style.display = 'none';
                imgPreview.src = '';
            }
            if (preview) {
                preview.style.background = 'transparent';
            }

            // html2canvas must be available
            if (typeof html2canvas === 'undefined') {
                console.error('html2canvas is not defined. Make sure the library is loaded.');
                if (preview) {
                    preview.innerHTML = '<p style="color: #ef4444; padding: 20px; text-align: center;">Error: Image generation library not loaded. Please refresh page.</p>';
                }
                if (loader) loader.style.display = 'none';
                updateShareButtonsState();
                return;
            }

            // Decide which part of the calculator to export
            // In AI mode, export the AI results directly (not the whole overview which contains both modes)
            // In simple mode, export the simple results grid
            let exportSource = null;
            
            // Check actual visibility in DOM to determine mode
            const aiResultsEl = document.getElementById('income-tax-aiResults');
            const simpleResultsEl = document.getElementById('income-tax-simpleResults');
            const isAIModeVisible = aiResultsEl && !aiResultsEl.classList.contains('income-tax-hidden') && 
                                   window.getComputedStyle(aiResultsEl).display !== 'none';
            const isSimpleModeVisible = simpleResultsEl && !simpleResultsEl.classList.contains('income-tax-hidden') && 
                                       window.getComputedStyle(simpleResultsEl).display !== 'none';
            
            // Debug: Log current mode
            console.log('Export - state.aiMode:', state.aiMode);
            console.log('Export - AI Results visible in DOM:', isAIModeVisible);
            console.log('Export - Simple Results visible in DOM:', isSimpleModeVisible);
            
            // Use AI mode if state says so OR if AI results are actually visible
            const shouldUseAIMode = state.aiMode || (isAIModeVisible && !isSimpleModeVisible);
            
            if (shouldUseAIMode && aiResultsEl) {
                // Export AI results directly - this contains the dashboard grid with tax card and AI card
                exportSource = aiResultsEl;
                console.log('Export - Using AI mode, exporting income-tax-aiResults directly');
            } else {
                // Export simple results
                exportSource =
                    document.getElementById('income-tax-simpleResultsGrid') ||
                    document.getElementById('income-tax-simpleResults');
                console.log('Export - Using simple mode, exporting simple results');
            }

            // Fallback: whole container
            if (!exportSource) {
                exportSource = document.querySelector('.income-tax-container');
            }

            if (!exportSource) {
                console.error('No export source found for image generation.');
                if (preview) {
                    preview.innerHTML = '<p style="color: #ef4444; padding: 20px; text-align: center;">Error: Could not find content to export. Please ensure you have calculated results.</p>';
                }
                if (loader) loader.style.display = 'none';
                updateShareButtonsState();
                return;
            }

            // Create hidden iframe so parent (Next.js) CSS cannot affect export
            const iframe = document.createElement('iframe');
            iframe.style.position = 'absolute';
            iframe.style.left = '-9999px';
            iframe.style.top = '0';
            iframe.style.width = '900px';
            iframe.style.height = '2000px';
            iframe.setAttribute('aria-hidden', 'true');
            document.body.appendChild(iframe);

            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            iframeDoc.open();

            // Get font-family from main document body to ensure consistency
            const mainBodyFont = window.getComputedStyle(document.body).fontFamily || 
                                '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif';
            
            // Grab this file's inline styles (all <style> tags inside this HTML)
            // Replace CSS variables with actual values to ensure colors render correctly
            let calculatorCSS = '';
            const styleTags = document.querySelectorAll('style');
            styleTags.forEach(tag => {
                if (tag && tag.textContent) {
                    let css = tag.textContent;
                    // Replace CSS variables with their actual values
                    css = css.replace(/var\(--income-tax-primary\)/g, 'linear-gradient(255deg, #43468a 0%, #2a2667 100%)');
                    css = css.replace(/var\(--income-tax-primary-dark\)/g, 'linear-gradient(255deg, #43468a 0%, #121826 100%)');
                    css = css.replace(/var\(--income-tax-primary-light\)/g, '#f0fdfa');
                    css = css.replace(/var\(--income-tax-background\)/g, '#ffffff');
                    css = css.replace(/var\(--income-tax-foreground\)/g, '#1f2937');
                    css = css.replace(/var\(--income-tax-card\)/g, '#f9fafb');
                    css = css.replace(/var\(--income-tax-border\)/g, '#e5e7eb');
                    css = css.replace(/var\(--income-tax-red\)/g, '#dc2626');
                    css = css.replace(/var\(--income-tax-green\)/g, '#16a34a');
                    css = css.replace(/var\(--income-tax-blue\)/g, '#2563eb');
                    css = css.replace(/var\(--income-tax-purple\)/g, '#a855f7');
                    css = css.replace(/var\(--income-tax-yellow\)/g, '#eab308');
                    calculatorCSS += css + '\\n';
                }
            });

            iframeDoc.write('<!DOCTYPE html><html><head><meta charset="utf-8"><title>SDLT Export</title>');
            if (calculatorCSS) {
                iframeDoc.write('<style>');
                iframeDoc.write(calculatorCSS);
                // Override media queries to force 3-column grid layout in export
                // Also ensure typography inheritance
                iframeDoc.write(`
                    * {
                        font-family: inherit;
                        line-height: inherit;
                    }
                    body {
                        font-family: ${mainBodyFont};
                        line-height: 1.6;
                    }
                    .income-tax-dashboard-grid {
                        display: grid !important;
                        grid-template-columns: repeat(3, 1fr) !important;
                        gap: 20px !important;
                        justify-content: space-between;
                    }
                    .income-tax-dashboard-col-span-2 {
                        grid-column: span 2 !important;
                    }
                    .income-tax-dashboard-col-span-3 {
                        grid-column: span 3 !important;
                    }
                    .income-tax-simple-input-item {
                        display: flex !important;
                        align-items: center !important;
                        flex-direction: row !important;
                        gap: 12px !important;
                    }
                    .income-tax-simple-input-label {
                        margin: 0 !important;
                    }
                    .income-tax-simple-input-value {
                        margin: 0 !important;
                    }
                    .income-tax-cta-banner {
                        display: flex !important;
                        align-items: center !important;
                    }
                    .income-tax-cta-content {
                        display: flex !important;
                        align-items: center !important;
                        justify-content: space-between !important;
                        line-height: 1.2 !important;
                    }
                    /* Let inner layout control child alignment; don't force flex on every child to avoid text clipping */
                    .income-tax-cta-content > *:not(button):not(.income-tax-cta-buttons):not(.income-tax-button-outline):not(.income-tax-button-solid) {
                        line-height: 1.2 !important;
                    }
                    .income-tax-cta-buttons {
                        /* Hidden in exported image */
                        display: none !important;
                    }
                    /* Protect ALL buttons from parent CSS interference - be very specific */
                    .income-tax-cta-content button,
                    .income-tax-cta-banner button,
                    .income-tax-cta-buttons button,
                    .income-tax-cta-content .income-tax-button-outline,
                    .income-tax-cta-content .income-tax-button-solid,
                    .income-tax-cta-banner .income-tax-button-outline,
                    .income-tax-cta-banner .income-tax-button-solid {
                        display: inline-block !important;
                        align-items: initial !important;
                        line-height: initial !important;
                        flex: none !important;
                    }

                    /* Fine-tune Trustpilot texts vertical alignment */
                    .income-tax-cta-content .trustforMobile {
                        display: inline-flex !important;
                        align-items: center !important;
                        line-height: 1 !important;
                        margin-top: -1px !important; /* nudge slightly upwards */
                        white-space: normal !important; /* preserve space in "reviews on" */
                    }
                    /* Fine-tune Trustpilot desktop text alignment for image generation */
                    .income-tax-cta-content .trustforDesktop {
                        bottom: 5px !important;
                        position: relative !important;
                        white-space: normal !important; /* preserve space in "reviews on" */
                    }
                    /* Ensure space is preserved in Trustpilot text spans */
                    .income-tax-cta-content span.trustforMobile,
                    .income-tax-cta-content span.trustforDesktop {
                        white-space: normal !important;
                    }
                    /* Ensure disclaimer text is vertically centered */
                    .income-tax-disclaimer {
                        display: flex !important;
                        align-items: center !important;
                        min-height: auto !important;
                    }
                    .income-tax-disclaimer-text {
                        display: block !important;
                        line-height: 1.6 !important;
                        margin: 0 !important;
                        padding: 0 !important;
                    }
                    /* Hide icon box in exported image */
                    .income-tax-icon-box {
                        display: none !important;
                    }
                `);
                iframeDoc.write('</style>');
            }
            
            // Use zero padding so we don't introduce extra white space around the exported content.
            // This helps the image height and inner padding match the original results more closely.
            iframeDoc.write(`</head><body style="margin:0; padding:0; background:#f9fafb; font-family: ${mainBodyFont}; line-height: 1.6;">`);

            // Build export root
            const exportRoot = iframeDoc.createElement('div');
            exportRoot.style.maxWidth = '820px';
            exportRoot.style.margin = '0 auto';
            // Let the inner cards control their own backgrounds / radii so we don't add extra padding/height
            exportRoot.style.background = 'transparent';
            exportRoot.style.borderRadius = '0';
            exportRoot.style.overflow = 'hidden';

            const clonedContent = exportSource.cloneNode(true);
            clonedContent.classList.remove('income-tax-hidden');
            clonedContent.style.display = 'block';
            clonedContent.style.visibility = 'visible';
            clonedContent.style.opacity = '1';
            
            // Since we're now exporting the correct source directly (aiResults or simpleResults),
            // we just need to ensure it's visible and handle the "How We Calculated" section
            if (shouldUseAIMode) {
                // We're exporting aiResults directly, so ensure it's visible
                clonedContent.classList.remove('income-tax-hidden');
                clonedContent.style.display = 'block';
                clonedContent.style.visibility = 'visible';
                clonedContent.style.opacity = '1';
                
                // Ensure "How We Calculated" section visibility matches original
                const originalHowWeCalculated = document.getElementById('income-tax-howWeCalculatedContent');
                const clonedHowWeCalculated = clonedContent.querySelector('#income-tax-howWeCalculatedContent');
                
                if (originalHowWeCalculated && clonedHowWeCalculated) {
                    const isExpanded = originalHowWeCalculated.style.display !== 'none' && 
                                     window.getComputedStyle(originalHowWeCalculated).display !== 'none';
                    if (isExpanded) {
                        // Show details content inside the explanation card
                        clonedHowWeCalculated.style.display = 'block';
                        clonedHowWeCalculated.style.visibility = 'visible';
                    } else {
                        // If collapsed in the UI, hide the entire explanation card from the export
                        const clonedExplanationCard = clonedContent.querySelector('.income-tax-explanation-card');
                        if (clonedExplanationCard) {
                            clonedExplanationCard.style.display = 'none';
                        }
                    }
                }
                
                // Hide icon box in exported image
                const iconBoxes = clonedContent.querySelectorAll('.income-tax-icon-box');
                iconBoxes.forEach(box => {
                    box.style.setProperty('display', 'none', 'important');
                });
            }
            
            // Hide all loaders in the cloned content
            const clonedLoaders = clonedContent.querySelectorAll('.income-tax-card-loader, .income-tax-loader-container, .income-tax-loader-wrapper');
            clonedLoaders.forEach(loader => {
                loader.style.display = 'none';
            });
            
            // Fix dashboard grid layout for export - force 3-column layout
            const dashboardGrid = clonedContent.querySelector('.income-tax-dashboard-grid');
            if (dashboardGrid) {
                dashboardGrid.style.display = 'grid';
                dashboardGrid.style.gridTemplateColumns = 'repeat(3, 1fr)';
                dashboardGrid.style.gap = '24px';
                dashboardGrid.style.maxWidth = '100%';
                dashboardGrid.style.width = '100%';
            }
            
            // Ensure column spans are correct
            const taxCardSpan = clonedContent.querySelector('.income-tax-tax-card.income-tax-dashboard-col-span-2');
            if (taxCardSpan) {
                taxCardSpan.style.gridColumn = 'span 2';
            }
            
            const explanationCardSpan = clonedContent.querySelector('.income-tax-explanation-card.income-tax-dashboard-col-span-3');
            if (explanationCardSpan) {
                explanationCardSpan.style.gridColumn = 'span 3';
            }
            
            const disclaimerSpan = clonedContent.querySelector('.income-tax-disclaimer.income-tax-dashboard-col-span-3');
            if (disclaimerSpan) {
                disclaimerSpan.style.gridColumn = 'span 3';
            }
            
            // Fix shadows and styling issues in cloned content
            // Remove or reduce box-shadows that might render as black in html2canvas
            const elementsWithShadows = clonedContent.querySelectorAll('.income-tax-tax-card, .income-tax-ai-card, .income-tax-cta-banner, .income-tax-disclaimer');
            elementsWithShadows.forEach(el => {
                // Remove box-shadow from tax card to prevent black shadow behind amount
                if (el.classList.contains('income-tax-tax-card')) {
                    el.style.boxShadow = 'none';
                    el.style.background = 'linear-gradient(255deg, #43468a 0%, #2a2667 100%)';
                    el.style.backgroundImage = 'linear-gradient(255deg, #43468a 0%, #2a2667 100%)';
                }
                // Ensure CTA banner has proper background (not CSS variable)
                if (el.classList.contains('income-tax-cta-banner')) {
                    el.style.background = 'linear-gradient(255deg, #43468a 0%, #2a2667 100%)';
                    el.style.backgroundImage = 'linear-gradient(255deg, #43468a 0%, #2a2667 100%)';
                    el.style.color = 'white';
                }
                // Ensure disclaimer has proper styling
                if (el.classList.contains('income-tax-disclaimer')) {
                    el.style.background = '#fffbeb';
                    el.style.border = '1px solid #fde68a';
                    el.style.borderRadius = '8px';
                    el.style.padding = '12px';
                    el.style.marginTop = '20px';
                }
            });
            
            // Ensure tax amount (AI mode) has no text-shadow and has proper spacing from the transaction date
            const taxAmount = clonedContent.querySelector('.income-tax-tax-amount');
            const taxDate = clonedContent.querySelector('.income-tax-tax-date');
            if (taxAmount) {
                taxAmount.style.textShadow = 'none';
                taxAmount.style.color = 'white';
                // Give the amount a bit more bottom margin so it doesn't stick to the date
                taxAmount.style.marginBottom = '12px';
            }
            if (taxDate) {
                // Ensure there is at least some top margin on the date for readability
                taxDate.style.marginTop = '6px';
            }

            // Fix simple mode main amount text gradient, which html2canvas doesn't render well
            // Gradient + background-clip:text can appear as a dark/black shadow in the export
            const simpleAmountEl = clonedContent.querySelector('.income-tax-simple-amount');
            if (simpleAmountEl) {
                simpleAmountEl.style.background = 'none';
                simpleAmountEl.style.backgroundImage = 'none';
                simpleAmountEl.style.webkitBackgroundClip = 'unset';
                simpleAmountEl.style.backgroundClip = 'unset';
                simpleAmountEl.style.webkitTextFillColor = 'unset';
                simpleAmountEl.style.color = '#1e293b'; // solid dark text
                simpleAmountEl.style.textShadow = 'none';
            }
            
            // Fine-tune vertical alignment for AI badge, review section, and disclaimer in the export
            // AI badge
            const aiBadge = clonedContent.querySelector('.income-tax-ai-badge');
            if (aiBadge) {
                aiBadge.style.display = 'inline-flex';
                aiBadge.style.alignItems = 'center';
                aiBadge.style.justifyContent = 'center';
            }
            const aiCardHeader = clonedContent.querySelector('.income-tax-ai-card-header');
            if (aiCardHeader) {
                aiCardHeader.style.display = 'flex';
                aiCardHeader.style.alignItems = 'center';
                aiCardHeader.style.justifyContent = 'center';
            }

            // Review / Trustpilot banner
            const clonedTrustpilotBanner = clonedContent.querySelector('.income-tax-cta-banner');
            if (clonedTrustpilotBanner) {
                clonedTrustpilotBanner.style.setProperty('display', 'flex', 'important');
                clonedTrustpilotBanner.style.setProperty('align-items', 'center', 'important');
                
                const ctaContent = clonedTrustpilotBanner.querySelector('.income-tax-cta-content');
                if (ctaContent) {
                    ctaContent.style.setProperty('display', 'flex', 'important');
                    ctaContent.style.setProperty('align-items', 'center', 'important');
                    ctaContent.style.setProperty('justify-content', 'space-between', 'important');
                    ctaContent.style.setProperty('gap', '16px', 'important');
                    ctaContent.style.setProperty('line-height', '1', 'important');
                    
                    // Fix all direct children to be vertically centered (but exclude buttons)
                    const ctaChildren = ctaContent.children;
                    for (let i = 0; i < ctaChildren.length; i++) {
                        const child = ctaChildren[i];
                        // Check if it's a button or button container
                        const isButton = child.tagName === 'BUTTON' || 
                                        child.classList.contains('income-tax-cta-buttons') ||
                                        child.classList.contains('income-tax-button-outline') ||
                                        child.classList.contains('income-tax-button-solid') ||
                                        child.classList.contains('income-tax-button');
                        if (!isButton) {
                            child.style.setProperty('display', 'flex', 'important');
                            child.style.setProperty('align-items', 'center', 'important');
                            child.style.setProperty('line-height', '1', 'important');
                        } else {
                            // Explicitly reset button styles to prevent interference
                            child.style.setProperty('display', 'inline-block', 'important');
                            child.style.setProperty('align-items', 'initial', 'important');
                            child.style.setProperty('line-height', 'initial', 'important');
                        }
                    }
                }
                const ctaButtons = clonedTrustpilotBanner.querySelector('.income-tax-cta-buttons');
                if (ctaButtons) {
                    // Hide CTA buttons in exported image
                    ctaButtons.style.setProperty('display', 'none', 'important');
                }
                
                // Fix "reviews on" text - replace space with non-breaking space to prevent "reviewson"
                const trustpilotTexts = clonedTrustpilotBanner.querySelectorAll('.trustforMobile, .trustforDesktop');
                trustpilotTexts.forEach(text => {
                    // Replace regular space with non-breaking space in text content
                    if (text.textContent && text.textContent.includes('reviews on')) {
                        text.textContent = text.textContent.replace(/reviews on/g, 'reviews\u00A0on');
                    }
                    text.style.setProperty('white-space', 'normal', 'important');
                });
            }

            // Disclaimer: fix vertical alignment - remove flex from text, keep it on container
            const clonedDisclaimer = clonedContent.querySelector('.income-tax-disclaimer');
            if (clonedDisclaimer) {
                clonedDisclaimer.style.setProperty('display', 'flex', 'important');
                clonedDisclaimer.style.setProperty('align-items', 'center', 'important');
                clonedDisclaimer.style.setProperty('min-height', 'auto', 'important');
            }
            const clonedDisclaimerText = clonedContent.querySelector('.income-tax-disclaimer-text');
            if (clonedDisclaimerText) {
                // Remove flex from text itself - let it flow naturally
                clonedDisclaimerText.style.setProperty('display', 'block', 'important');
                clonedDisclaimerText.style.setProperty('line-height', '1.6', 'important');
                clonedDisclaimerText.style.setProperty('margin', '0', 'important');
                clonedDisclaimerText.style.setProperty('padding', '0', 'important');
            }

            // Ensure AI card is visible and properly styled
            const aiCard = clonedContent.querySelector('.income-tax-ai-card');
            if (aiCard) {
                aiCard.style.display = 'block';
                aiCard.style.visibility = 'visible';
                aiCard.style.opacity = '1';
            }
            
            // Copy computed typography and alignment styles from original elements to cloned elements
            // This ensures fonts, line-heights, text-align, etc. match exactly
            const allClonedElements = clonedContent.querySelectorAll('*');
            allClonedElements.forEach(clonedEl => {
                try {
                    // Find the corresponding original element
                    let originalEl = null;
                    if (clonedEl.id) {
                        originalEl = document.getElementById(clonedEl.id);
                    } else if (clonedEl.className) {
                        // Try to find by matching class and position in DOM
                        const classList = Array.from(clonedEl.classList);
                        if (classList.length > 0) {
                            const possibleMatches = document.querySelectorAll('.' + classList[0]);
                            // If there's only one match, use it
                            if (possibleMatches.length === 1) {
                                originalEl = possibleMatches[0];
                            } else if (possibleMatches.length > 1) {
                                // Try to match by parent structure
                                const clonedParent = clonedEl.parentElement;
                                if (clonedParent && clonedParent.id) {
                                    const parentEl = document.getElementById(clonedParent.id);
                                    if (parentEl) {
                                        const matches = parentEl.querySelectorAll('.' + classList[0]);
                                        if (matches.length === 1) {
                                            originalEl = matches[0];
                                        }
                                    }
                                }
                            }
                        }
                    }
                    
                    if (originalEl) {
                        const computedStyle = window.getComputedStyle(originalEl);
                        
                        // Copy typography styles
                        const typographyProps = [
                            'fontFamily', 'fontSize', 'fontWeight', 'fontStyle',
                            'letterSpacing', 'textAlign', 'textDecoration',
                            'textTransform', 'color', 'opacity'
                        ];
                        
                        typographyProps.forEach(prop => {
                            try {
                                const value = computedStyle[prop];
                                if (value && value !== 'normal' && value !== 'none') {
                                    clonedEl.style[prop] = value;
                                }
                            } catch (e) {
                                // Silently continue
                            }
                        });
                        
                        // Handle lineHeight separately - normalize for p tags
                        if (clonedEl.tagName === 'P') {
                            // Set normalized line height for p tags (remove excessive line heights)
                            clonedEl.style.lineHeight = '1.5';
                        } else {
                            // For non-p tags, copy lineHeight but normalize if it's too large
                            try {
                                const lineHeight = computedStyle.lineHeight;
                                if (lineHeight && lineHeight !== 'normal') {
                                    // If lineHeight is a pixel value > 30px, normalize it
                                    const lineHeightNum = parseFloat(lineHeight);
                                    if (!isNaN(lineHeightNum) && lineHeightNum > 30) {
                                        // Normalize to a reasonable multiplier based on font size
                                        const fontSize = parseFloat(computedStyle.fontSize) || 16;
                                        clonedEl.style.lineHeight = (fontSize * 1.5) + 'px';
                                    } else {
                                        clonedEl.style.lineHeight = lineHeight;
                                    }
                                }
                            } catch (e) {
                                // Silently continue
                            }
                        }
                        
                        // Copy spacing and alignment
                        const spacingProps = [
                            'padding', 'paddingTop', 'paddingRight', 'paddingBottom', 'paddingLeft',
                            'margin', 'marginTop', 'marginRight', 'marginBottom', 'marginLeft',
                            'textAlign', 'verticalAlign'
                        ];
                        
                        spacingProps.forEach(prop => {
                            try {
                                const value = computedStyle[prop];
                                if (value && value !== 'auto' && value !== '0px') {
                                    clonedEl.style[prop] = value;
                                }
                            } catch (e) {
                                // Silently continue
                            }
                        });
                    }
                } catch (e) {
                    // Silently continue if element processing fails
                }
            });
            
            // Set default padding of 25px for container elements
            const containerSelectors = [
                '.income-tax-card',
                '.income-tax-simple-main-content',
                '.income-tax-simple-sidebar',
                '.income-tax-tax-card',
                '.income-tax-ai-card',
                '.income-tax-explanation-card',
                '.income-tax-breakdown-card'
            ];
            
            containerSelectors.forEach(selector => {
                const clonedContainers = clonedContent.querySelectorAll(selector);
                clonedContainers.forEach(clonedContainer => {
                    // Find the corresponding original element to check its padding
                    let originalContainer = null;
                    if (clonedContainer.id) {
                        originalContainer = document.getElementById(clonedContainer.id);
                    } else if (clonedContainer.className) {
                        const classList = Array.from(clonedContainer.classList);
                        if (classList.length > 0) {
                            const matches = document.querySelectorAll('.' + classList[0]);
                            // Try to find matching element by position or unique identifier
                            if (matches.length === 1) {
                                originalContainer = matches[0];
                            } else if (matches.length > 1) {
                                // Try to match by parent structure
                                const clonedParent = clonedContainer.parentElement;
                                if (clonedParent && clonedParent.id) {
                                    const parentEl = document.getElementById(clonedParent.id);
                                    if (parentEl) {
                                        const parentMatches = parentEl.querySelectorAll('.' + classList[0]);
                                        if (parentMatches.length === 1) {
                                            originalContainer = parentMatches[0];
                                        }
                                    }
                                }
                            }
                        }
                    }
                    
                    if (originalContainer) {
                        const computedStyle = window.getComputedStyle(originalContainer);
                        const paddingTop = parseFloat(computedStyle.paddingTop) || 0;
                        const paddingBottom = parseFloat(computedStyle.paddingBottom) || 0;
                        const paddingLeft = parseFloat(computedStyle.paddingLeft) || 0;
                        const paddingRight = parseFloat(computedStyle.paddingRight) || 0;
                        
                        // Set to 25px if current padding is less than 20px
                        if (paddingTop < 20) clonedContainer.style.paddingTop = '25px';
                        if (paddingBottom < 20) clonedContainer.style.paddingBottom = '25px';
                        if (paddingLeft < 20) clonedContainer.style.paddingLeft = '25px';
                        if (paddingRight < 20) clonedContainer.style.paddingRight = '25px';
                    } else {
                        // If we can't find the original, just set default padding
                        clonedContainer.style.padding = '25px';
                    }
                });
            });
            
            // Set margin to 0 for simple input label and value in exported image
            const simpleInputLabels = clonedContent.querySelectorAll('.income-tax-simple-input-label');
            simpleInputLabels.forEach(label => {
                label.style.margin = '0px';
                label.style.marginTop = '0px';
                label.style.marginBottom = '0px';
                label.style.marginLeft = '0px';
                label.style.marginRight = '0px';
            });
            
            const simpleInputValues = clonedContent.querySelectorAll('.income-tax-simple-input-value');
            simpleInputValues.forEach(value => {
                value.style.margin = '0px';
                value.style.marginTop = '0px';
                value.style.marginBottom = '0px';
                value.style.marginLeft = '0px';
                value.style.marginRight = '0px';
            });
            
            // Set display: flex and align-items: center !important for simple input items in exported image
            const simpleInputItems = clonedContent.querySelectorAll('.income-tax-simple-input-item');
            simpleInputItems.forEach(item => {
                item.style.setProperty('display', 'flex', 'important');
                item.style.setProperty('align-items', 'center', 'important');
                item.style.setProperty('flex-direction', 'row', 'important');
            });
            
            exportRoot.appendChild(clonedContent);

            // Append Trustpilot / disclaimer if present (only if not already in cloned content)
            // Check if they're already in the cloned content first
            const hasTrustpilotInContent = clonedContent.querySelector('.income-tax-cta-banner');
            const hasDisclaimerInContent = clonedContent.querySelector('.income-tax-disclaimer');
            
            if (!hasTrustpilotInContent) {
                const trustpilot = document.querySelector('.income-tax-cta-banner');
                if (trustpilot) {
                    const clonedTrustpilot = trustpilot.cloneNode(true);
                    clonedTrustpilot.style.marginTop = '20px';
                    clonedTrustpilot.style.setProperty('display', 'flex', 'important');
                    clonedTrustpilot.style.setProperty('align-items', 'center', 'important');
                    clonedTrustpilot.style.background = 'linear-gradient(255deg, #43468a 0%, #2a2667 100%)';
                    clonedTrustpilot.style.backgroundImage = 'linear-gradient(255deg, #43468a 0%, #2a2667 100%)';
                    clonedTrustpilot.style.color = 'white';
                    clonedTrustpilot.style.borderRadius = '12px';
                    clonedTrustpilot.style.padding = '10px';
                    clonedTrustpilot.style.boxShadow = 'none';
                    
                    // Fix CTA content vertical alignment
                    const ctaContent = clonedTrustpilot.querySelector('.income-tax-cta-content');
                    if (ctaContent) {
                        ctaContent.style.setProperty('display', 'flex', 'important');
                        ctaContent.style.setProperty('align-items', 'center', 'important');
                        ctaContent.style.setProperty('justify-content', 'space-between', 'important');
                        ctaContent.style.setProperty('line-height', '1.2', 'important');
                        
                        // Fix all direct children (but exclude buttons)
                        // Child layout is already correct in the original markup; avoid overriding it
                    }
                    
                    // Hide CTA buttons in exported image
                    const ctaButtons = clonedTrustpilot.querySelector('.income-tax-cta-buttons');
                    if (ctaButtons) {
                        ctaButtons.style.display = 'none';
                        
                        // Also explicitly reset any visible buttons
                        const buttons = clonedTrustpilot.querySelectorAll('button, .income-tax-button-outline, .income-tax-button-solid, .income-tax-button');
                        buttons.forEach(btn => {
                            btn.style.setProperty('display', 'inline-block', 'important');
                            btn.style.setProperty('align-items', 'initial', 'important');
                            btn.style.setProperty('line-height', 'initial', 'important');
                        });
                    }
                    
                    // Fix "reviews on" text - replace space with non-breaking space to prevent "reviewson"
                    const trustpilotTexts = clonedTrustpilot.querySelectorAll('.trustforMobile, .trustforDesktop');
                    trustpilotTexts.forEach(text => {
                        // Replace regular space with non-breaking space in text content
                        if (text.textContent && text.textContent.includes('reviews on')) {
                            text.textContent = text.textContent.replace(/reviews on/g, 'reviews\u00A0on');
                        }
                        text.style.setProperty('white-space', 'normal', 'important');
                    });
                    
                    exportRoot.appendChild(clonedTrustpilot);
                }
            }
            
            if (!hasDisclaimerInContent) {
                const disclaimer = document.querySelector('.income-tax-disclaimer');
                if (disclaimer) {
                    const clonedDisclaimer = disclaimer.cloneNode(true);
                    clonedDisclaimer.style.marginTop = '20px';
                    clonedDisclaimer.style.setProperty('display', 'flex', 'important');
                    clonedDisclaimer.style.setProperty('align-items', 'center', 'important');
                    clonedDisclaimer.style.setProperty('min-height', 'auto', 'important');
                    clonedDisclaimer.style.background = '#fffbeb';
                    clonedDisclaimer.style.border = '1px solid #fde68a';
                    clonedDisclaimer.style.borderRadius = '8px';
                    clonedDisclaimer.style.padding = '12px';
                    clonedDisclaimer.style.boxShadow = 'none';
                    
                    const disclaimerText = clonedDisclaimer.querySelector('.income-tax-disclaimer-text');
                    if (disclaimerText) {
                        // Remove flex from text itself - let it flow naturally
                        disclaimerText.style.setProperty('display', 'block', 'important');
                        disclaimerText.style.setProperty('line-height', '1.6', 'important');
                        disclaimerText.style.setProperty('margin', '0', 'important');
                        disclaimerText.style.setProperty('padding', '0', 'important');
                    }
                    
                    exportRoot.appendChild(clonedDisclaimer);
                }
            }

            iframeDoc.body.appendChild(exportRoot);
            iframeDoc.close();

            // Log the full HTML code used for image generation
            console.log('=== FULL HTML CODE USED FOR IMAGE GENERATION ===');
            console.log('Complete iframe document HTML:');
            console.log(iframeDoc.documentElement.outerHTML);
            console.log('=== END OF HTML CODE ===');
            
            // Also log just the export root HTML for easier inspection
            console.log('=== EXPORT ROOT HTML (main content) ===');
            console.log(exportRoot.outerHTML);
            console.log('=== END OF EXPORT ROOT HTML ===');

            // Force re-apply styles directly to elements right before html2canvas
            // This ensures html2canvas reads the correct computed styles
            const forceStyleApplication = () => {
                const simpleInputItems = exportRoot.querySelectorAll('.income-tax-simple-input-item');
                simpleInputItems.forEach(item => {
                    // Force style application with !important
                    item.style.cssText += '; display: flex !important; align-items: center !important; flex-direction: row !important; gap: 12px !important;';
                });
                
                const simpleInputLabels = exportRoot.querySelectorAll('.income-tax-simple-input-label');
                simpleInputLabels.forEach(label => {
                    label.style.cssText += '; margin: 0px !important; margin-top: 0px !important; margin-bottom: 0px !important; margin-left: 0px !important; margin-right: 0px !important;';
                });
                
                const simpleInputValues = exportRoot.querySelectorAll('.income-tax-simple-input-value');
                simpleInputValues.forEach(value => {
                    value.style.cssText += '; margin: 0px !important; margin-top: 0px !important; margin-bottom: 0px !important; margin-left: 0px !important; margin-right: 0px !important;';
                });
                
                // Fix Trustpilot/CTA banner vertical alignment
                const ctaBanners = exportRoot.querySelectorAll('.income-tax-cta-banner');
                ctaBanners.forEach(banner => {
                    banner.style.cssText += '; display: flex !important; align-items: center !important;';
                    
                    const ctaContent = banner.querySelector('.income-tax-cta-content');
                    if (ctaContent) {
                        ctaContent.style.cssText += '; display: flex !important; align-items: center !important; justify-content: space-between !important; line-height: 1 !important;';
                        
                        // Fix all direct children (but exclude buttons)
                        const ctaChildren = ctaContent.children;
                        for (let i = 0; i < ctaChildren.length; i++) {
                            const child = ctaChildren[i];
                            // Check if it's a button or button container
                            const isButton = child.tagName === 'BUTTON' || 
                                            child.classList.contains('income-tax-cta-buttons') ||
                                            child.classList.contains('income-tax-button-outline') ||
                                            child.classList.contains('income-tax-button-solid') ||
                                            child.classList.contains('income-tax-button');
                            if (!isButton) {
                                child.style.cssText += '; display: flex !important; align-items: center !important; line-height: 1 !important;';
                            } else {
                                // Explicitly reset button styles
                                child.style.cssText += '; display: inline-block !important; align-items: initial !important; line-height: initial !important;';
                            }
                        }
                    }
                    
                    const ctaButtons = banner.querySelector('.income-tax-cta-buttons');
                    if (ctaButtons) {
                        // Hide CTA buttons in exported image
                        ctaButtons.style.cssText += '; display: none !important;';
                    }
                });
                
                // Fix "reviews on" text - replace space with non-breaking space to prevent "reviewson"
                const trustpilotTexts = exportRoot.querySelectorAll('.trustforMobile, .trustforDesktop');
                trustpilotTexts.forEach(text => {
                    // Replace regular space with non-breaking space in text content
                    if (text.textContent && text.textContent.includes('reviews on')) {
                        text.textContent = text.textContent.replace(/reviews on/g, 'reviews\u00A0on');
                    }
                    text.style.cssText += '; white-space: normal !important;';
                });
                
                // Fix disclaimer vertical alignment
                const disclaimers = exportRoot.querySelectorAll('.income-tax-disclaimer');
                disclaimers.forEach(disclaimer => {
                    disclaimer.style.cssText += '; display: flex !important; align-items: center !important; min-height: auto !important;';
                });
                
                const disclaimerTexts = exportRoot.querySelectorAll('.income-tax-disclaimer-text');
                disclaimerTexts.forEach(text => {
                    // Remove flex from text itself - let it flow naturally
                    text.style.cssText += '; display: block !important; line-height: 1.6 !important; margin: 0 !important; padding: 0 !important;';
                });
                
                // Hide icon box in exported image
                const iconBoxes = exportRoot.querySelectorAll('.income-tax-icon-box');
                iconBoxes.forEach(box => {
                    box.style.cssText += '; display: none !important;';
                });
                
                // Force a reflow by accessing layout properties
                void exportRoot.offsetHeight;
            };

            // Wait for iframe to be ready, then force style application and render
            const renderImage = () => {
                // Get iframe's window for proper timing context
                const iframeWindow = iframe.contentWindow || iframe.contentDocument?.defaultView || window;
                const raf = iframeWindow.requestAnimationFrame || window.requestAnimationFrame;
                
                // Apply styles one more time right before rendering
                forceStyleApplication();
                
                // Force multiple reflows to ensure styles are computed
                void exportRoot.offsetHeight;
                void exportRoot.offsetWidth;
                
                // Use multiple requestAnimationFrame calls to ensure rendering is complete
                // This is especially important when embedded in parent pages with conflicting CSS
                raf.call(iframeWindow, () => {
                    raf.call(iframeWindow, () => {
                        // Apply styles one final time after all frames
                        forceStyleApplication();
                        void exportRoot.offsetHeight;
                        
                        html2canvas(exportRoot, {
                scale: 2,
                backgroundColor: '#ffffff',
                logging: false,
                useCORS: true,
                allowTaint: true,
                width: 820,
                windowWidth: 820
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                state.lastGeneratedImage = imgData;

                if (imgPreview) {
                    imgPreview.onload = () => {
                        imgPreview.style.display = 'block';
                        if (loader) loader.style.display = 'none';
                        updateShareButtonsState();
                    };
                    imgPreview.onerror = () => {
                        console.error('Image preview failed to load');
                        if (loader) loader.style.display = 'none';
                        updateShareButtonsState();
                    };
                    imgPreview.src = imgData;
                } else {
                    if (loader) loader.style.display = 'none';
                    updateShareButtonsState();
                }
                    }).catch(err => {
                        console.error('Image generation failed:', err);
                        if (preview) {
                            const msg = (err && err.message && err.message.toLowerCase().includes('lab'))
                                ? 'Image generation failed because the parent page uses unsupported lab() colors. Please refresh the page and try again.'
                                : 'Image generation failed. Please try again.';
                            preview.innerHTML = `<p style="color: #ef4444; padding: 20px; text-align: center;">${msg}</p>`;
                        }
                        if (loader) loader.style.display = 'none';
                        updateShareButtonsState();
                        }).finally(() => {
                            if (iframe && iframe.parentNode) {
                                iframe.parentNode.removeChild(iframe);
                            }
                        });
                    });
                });
            };

            // Wait for iframe to be fully ready, especially important when embedded
            // Increased delay to ensure styles are computed before html2canvas runs
            // This helps when parent page CSS might interfere
            setTimeout(() => {
                renderImage();
            }, 250);
        }

        function updateShareButtonsState() {
            const hasImage = !!state.lastGeneratedImage;
            const isLoading = document.getElementById('income-tax-shareLoader')?.style.display !== 'none';
            
            const shareBtn = document.getElementById('income-tax-shareBtn');
            const downloadBtn = document.getElementById('income-tax-downloadBtn');
            const copyBtn = document.getElementById('income-tax-copyBtn');
            
            const shouldDisable = !hasImage || isLoading;
            
            [shareBtn, downloadBtn, copyBtn].forEach(btn => {
                if (!btn) return;
                btn.disabled = shouldDisable;
                btn.classList.toggle('income-tax-button-disabled', shouldDisable);
            });
        }

        function downloadResultImage() {
            if (!state.lastGeneratedImage) return;
            
            const a = document.createElement('a');
            a.href = state.lastGeneratedImage;
            a.download = 'income-tax-calculation-result.png';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        async function copyResultImage() {
            if (!state.lastGeneratedImage) return;
            
            try {
                const res = await fetch(state.lastGeneratedImage);
                const blob = await res.blob();
                
                if (navigator.clipboard && window.ClipboardItem) {
                    const item = new ClipboardItem({ [blob.type]: blob });
                    await navigator.clipboard.write([item]);
                    // Optional: brief visual feedback
                    const copyBtn = document.getElementById('income-tax-copyBtn');
                    if (copyBtn) {
                        const originalText = copyBtn.innerText;
                        copyBtn.innerText = 'Copied';
                        setTimeout(() => {
                            copyBtn.innerText = originalText;
                        }, 1500);
                    }
                } else {
                    // Fallback: download if clipboard API not available
                    downloadResultImage();
                }
            } catch (err) {
                console.error('Failed to copy image to clipboard', err);
            }
        }

            // Helper function to detect mobile device
            function isMobileDevice() {
                return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                       (navigator.maxTouchPoints && navigator.maxTouchPoints > 2 && /MacIntel/.test(navigator.platform));
            }
    
            // Helper function to convert base64 image to File
            async function getImageFile() {
                if (!state.lastGeneratedImage) {
                    return null;
                }
                
                try {
                    // Convert base64 to blob
            const res = await fetch(state.lastGeneratedImage);
            const blob = await res.blob();
                    const file = new File([blob], 'income-tax-calculation-result.png', { type: 'image/png' });
                    return file;
                } catch (error) {
                    console.error('Error converting image to file:', error);
                    return null;
                }
            }
    
            // Native share function - shows all available apps and shares the image
            async function shareViaNativeShare() {
                if (!state.lastGeneratedImage) {
                    alert('‚ö†Ô∏è Please wait for the image to generate.');
                    return;
                }
                
                // Get the image file
                const file = await getImageFile();
                if (!file) {
                    alert('‚ö†Ô∏è Error preparing image for sharing. Please try downloading it instead.');
                    return;
                }
                
                // Use Web Share API with image file - shows all available sharing options
            if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                try {
                    await navigator.share({
                        files: [file],
                        title: 'My SDLT Calculation',
                            text: 'Check out my Stamp Duty Land Tax calculation result!'
                    });
                        return;
                } catch (err) {
                        // User cancelled - don't show error
                        if (err.name === 'AbortError') {
                            return;
                        }
                    console.error('Share failed:', err);
                        // Fall through to try text-only sharing
                    }
                }
                
                // Fallback: Try Web Share API without file (text only) if file sharing not supported
                if (navigator.share) {
                    try {
                        await navigator.share({
                            title: 'My SDLT Calculation',
                            text: 'Check out my Stamp Duty Land Tax calculation result! ' + window.location.href
                        });
                        return;
                    } catch (err) {
                        if (err.name !== 'AbortError') {
                            console.error('Share failed:', err);
                        }
                    }
                }
                
                // Final fallback: Download image and show instructions
                downloadResultImage();
                setTimeout(() => {
                    alert('üì• Image downloaded! You can now attach it manually to your social media post.');
                }, 500);
            }
            function isMobileDevice() {
                return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                       (window.innerWidth <= 768 && window.innerHeight <= 1024);
            }
    
            // Helper function to open popup window (desktop) or app (mobile)
            function openSharePopup(url, mobileAppUrl, width = 600, height = 400) {
                if (isMobileDevice() && mobileAppUrl) {
                    // On mobile, try to open native app first, fallback to web
                    window.location.href = mobileAppUrl;
                    // Fallback to web URL after a short delay if app doesn't open
                    setTimeout(() => {
                        window.open(url, '_blank');
                    }, 500);
                } else {
                    // Desktop: open in popup
                    const left = (screen.width - width) / 2;
                    const top = (screen.height - height) / 2;
                    const popup = window.open(
                        url,
                        'share',
                        `width=${width},height=${height},left=${left},top=${top},toolbar=no,menubar=no,scrollbars=yes,resizable=yes,location=no,directories=no,status=no`
                    );
                    
                    // Focus the popup window
                    if (popup) {
                        popup.focus();
                    }
                }
            }
    
            // Get share text and URL
            function getShareText() {
                const calc = state.currentCalculation;
                if (!calc) return 'Check out my Income Tax calculation!';
                
                // ‚úÖ Rental Income Tax uses annualRentalIncome or netIncome, not propertyValue
                const displayValue = calc.annualRentalIncome || calc.netIncome || 0;
                const propertyValue = displayValue ? `¬£${(displayValue || 0).toLocaleString('en-GB')}` : '';
                // ‚úÖ Rental Income Tax uses totalTax, not totalTaxLiability
                const taxAmount = calc.totalTax ? `¬£${(calc.totalTax || 0).toLocaleString('en-GB')}` : '';
                return `Income Tax Calculator Result: Annual Rental Income ${propertyValue}, Tax Due: ${taxAmount}`;
            }
    
            function getShareUrl() {
                return window.location.href;
            }
    
            async function shareToFacebook() {
                const shareText = encodeURIComponent(getShareText());
                const shareUrl = encodeURIComponent(getShareUrl());
                const facebookWebUrl = `https://www.facebook.com/sharer/sharer.php?u=${shareUrl}&quote=${shareText}`;
                // Facebook app deep link
                const facebookAppUrl = `fb://share?href=${shareUrl}&quote=${shareText}`;
                openSharePopup(facebookWebUrl, facebookAppUrl, 600, 400);
            }
    
            async function shareToTwitter() {
                const shareText = encodeURIComponent(getShareText());
                const shareUrl = encodeURIComponent(getShareUrl());
                const twitterWebUrl = `https://twitter.com/intent/tweet?text=${shareText}&url=${shareUrl}`;
                // Twitter app deep link
                const twitterAppUrl = `twitter://post?message=${shareText} ${shareUrl}`;
                openSharePopup(twitterWebUrl, twitterAppUrl, 600, 400);
            }
    
            async function shareToWhatsApp() {
                const shareText = encodeURIComponent(getShareText() + ' ' + getShareUrl());
                const whatsappWebUrl = `https://wa.me/?text=${shareText}`;
                // WhatsApp app deep link (works on both iOS and Android)
                const whatsappAppUrl = `whatsapp://send?text=${shareText}`;
                openSharePopup(whatsappWebUrl, whatsappAppUrl, 600, 700);
            }
    
            async function shareToLinkedIn() {
                const shareUrl = encodeURIComponent(getShareUrl());
                const shareText = encodeURIComponent(getShareText());
                const linkedInWebUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${shareUrl}&summary=${shareText}`;
                // LinkedIn app deep link
                const linkedInAppUrl = `linkedin://sharing/share-offsite/?url=${shareUrl}`;
                openSharePopup(linkedInWebUrl, linkedInAppUrl, 600, 500);
            }
    
            async function shareToMessenger() {
                const shareUrl = encodeURIComponent(getShareUrl());
                const shareText = encodeURIComponent(getShareText());
                const messengerWebUrl = `https://www.facebook.com/dialog/send?link=${shareUrl}&redirect_uri=${encodeURIComponent(window.location.href)}`;
                // Messenger app deep link
                const messengerAppUrl = `fb-messenger://share?link=${shareUrl}`;
                openSharePopup(messengerWebUrl, messengerAppUrl, 600, 500);
            }
    
            async function shareViaNative() {
                // This is the main native share function - shares the image file
                await shareViaNativeShare();
        }

        function shareCalculation() {
            if (!state.currentCalculation) {
                alert('‚ö†Ô∏è No calculation to share. Please perform a calculation first.');
                return;
            }
            
                // Open the share modal instead of direct sharing
                openShareModal();
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('üì§ Calculation copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('‚ö†Ô∏è Failed to copy to clipboard. Please copy manually.');
            });
        }

        function startFreeTrial() {
            alert('üöÄ Starting your free trial!\n\nYou\'ll get:\n‚Ä¢ Unlimited calculations\n‚Ä¢ Advanced AI insights\n‚Ä¢ Expert consultation discount\n‚Ä¢ Priority support');
        }

        function clearHistory() {
                // Open custom confirmation modal
                openClearHistoryModal();
            }
    
            function openClearHistoryModal() {
                const modal = document.getElementById('income-tax-clearHistoryModal');
                if (modal) {
                    modal.classList.add('active');
                }
            }
    
            function closeClearHistoryModal() {
                const modal = document.getElementById('income-tax-clearHistoryModal');
                if (modal) {
                    modal.classList.remove('active');
                }
            }
    
            function confirmClearHistory() {
                // Clear calculations from state
                state.calculations = [];
                
                // Clear both localStorage and sessionStorage
                try {
                    localStorage.removeItem('sdlt_calculations_history');
                    sessionStorage.removeItem('sdlt_calculations_history');
                } catch (error) {
                    console.error('Error clearing history:', error);
                }
                
                // Update UI
                renderHistory();
                
                // Close modal
                closeClearHistoryModal();
                
                // Show success message (using a simple notification)
                showSuccessMessage('üóëÔ∏è History cleared successfully!');
            }
    
            function showSuccessMessage(message) {
                // Create a temporary success notification
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #10b981;
                    color: white;
                    padding: 16px 24px;
                    border-radius: 12px;
                    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
                    z-index: 10000;
                    font-size: 15px;
                    font-weight: 500;
                    animation: slideInRight 0.3s ease-out;
                    max-width: 350px;
                `;
                notification.textContent = message;
                document.body.appendChild(notification);
                
                // Remove after 3 seconds
                setTimeout(() => {
                    notification.style.animation = 'slideOutRight 0.3s ease-out';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
        }

        // Prevent copying from result sections
        // Use a Set to track which elements already have listeners to avoid duplicates
        const protectedElements = new WeakSet();
        
        function preventCopyFromResults() {
            // Get all result sections
            const resultSections = [
                document.getElementById('income-tax-resultsGrid'),
                document.getElementById('income-tax-aiResults'),
                document.getElementById('income-tax-simpleResults'),
                document.getElementById('income-tax-simpleResultsGrid'),
                document.getElementById('income-tax-breakdownTable'),
                ...document.querySelectorAll('.income-tax-ai-insights'),
                ...document.querySelectorAll('.income-tax-breakdown-card'),
                ...document.querySelectorAll('.income-tax-result-box'),
                ...document.querySelectorAll('.income-tax-simple-result-row')
            ].filter(el => el !== null && !protectedElements.has(el));

            // Prevent copy, cut, and context menu events
            const preventAction = (e) => {
                e.preventDefault();
                e.stopPropagation();
                return false;
            };

            resultSections.forEach(section => {
                // Mark as protected to avoid duplicate listeners
                protectedElements.add(section);
                
                // Prevent copy
                section.addEventListener('copy', preventAction, { passive: false });
                // Prevent cut
                section.addEventListener('cut', preventAction, { passive: false });
                // Prevent context menu (right-click)
                section.addEventListener('contextmenu', preventAction, { passive: false });
                // Prevent drag start (prevents dragging text)
                section.addEventListener('dragstart', preventAction, { passive: false });
                // Prevent select start
                section.addEventListener('selectstart', preventAction, { passive: false });
            });
        }
        
        // Prevent keyboard shortcuts globally (only once)
        if (!window.copyPreventionInitialized) {
            window.copyPreventionInitialized = true;
            document.addEventListener('keydown', (e) => {
                const target = e.target;
                // Check if target is in a result section
                const resultSelectors = [
                    '#income-tax-resultsGrid', '#income-tax-aiResults', '#income-tax-simpleResults', 
                    '#income-tax-simpleResultsGrid', '#income-tax-breakdownTable',
                    '.income-tax-ai-insights', '.income-tax-breakdown-card', 
                    '.income-tax-result-box', '.income-tax-simple-result-row'
                ];
                
                const isResultSection = resultSelectors.some(selector => {
                    const element = document.querySelector(selector);
                    return element && (element.contains(target) || element === target);
                });
                
                if (isResultSection) {
                    // Prevent Ctrl+C, Ctrl+A, Ctrl+X, Ctrl+V
                    if ((e.ctrlKey || e.metaKey) && (e.key === 'c' || e.key === 'C' || 
                        e.key === 'x' || e.key === 'X' || e.key === 'a' || e.key === 'A' ||
                        e.key === 'v' || e.key === 'V')) {
                        e.preventDefault();
                        e.stopPropagation();
                        return false;
                    }
                }
            }, { passive: false });
        }

        // Initialize
        // Initialize tooltip positioning for viewport awareness
        function initializeTooltips() {
            const tooltipIcons = document.querySelectorAll('.income-tax-label .income-tax-tooltip-icon:not([data-tooltip-initialized])');
            
            tooltipIcons.forEach(icon => {
                // Mark as initialized to prevent duplicate listeners
                icon.setAttribute('data-tooltip-initialized', 'true');
                
                icon.addEventListener('mouseenter', function() {
                    const rect = this.getBoundingClientRect();
                    const tooltipWidth = Math.min(300, window.innerWidth - 40);
                    const tooltipHeight = 150; // Approximate height
                    const spacing = 8;
                    
                    // Calculate available space in each direction
                    const spaceTop = rect.top;
                    const spaceBottom = window.innerHeight - rect.bottom;
                    const spaceLeft = rect.left;
                    const spaceRight = window.innerWidth - rect.right;
                    
                    // Determine best position
                    let position = 'top';
                    let adjust = '';
                    
                    // Check if tooltip fits above
                    if (spaceTop >= tooltipHeight + spacing) {
                        position = 'top';
                    } 
                    // Check if tooltip fits below
                    else if (spaceBottom >= tooltipHeight + spacing) {
                        position = 'bottom';
                    }
                    // Check if tooltip fits to the left
                    else if (spaceLeft >= tooltipWidth + spacing) {
                        position = 'left';
                    }
                    // Check if tooltip fits to the right
                    else if (spaceRight >= tooltipWidth + spacing) {
                        position = 'right';
                    }
                    // Default to bottom if no space
                    else {
                        position = 'bottom';
                    }
                    
                    // Adjust horizontal position if tooltip would overflow
                    if (position === 'top' || position === 'bottom') {
                        const tooltipLeft = rect.left + (rect.width / 2) - (tooltipWidth / 2);
                        const tooltipRight = tooltipLeft + tooltipWidth;
                        
                        if (tooltipLeft < 20) {
                            adjust = 'left';
                        } else if (tooltipRight > window.innerWidth - 20) {
                            adjust = 'right';
                        }
                    }
                    
                    // Apply position classes
                    this.setAttribute('data-tooltip-pos', position);
                    if (adjust) {
                        this.setAttribute('data-tooltip-adj', adjust);
                    } else {
                        this.removeAttribute('data-tooltip-adj');
                    }
                });
            });
        }

        // Initialize custom dropdowns
        function initializeCustomDropdowns() {
            const dropdowns = [
                { selectId: 'income-tax-propertyType', optionsId: 'income-tax-propertyType-options' },
                { selectId: 'income-tax-residencyStatus', optionsId: 'income-tax-residencyStatus-options' },
                { selectId: 'income-tax-chartTypeSelect', optionsId: 'income-tax-chartTypeSelect-options' }
            ];

            dropdowns.forEach(({ selectId, optionsId }) => {
                const select = document.getElementById(selectId);
                const optionsContainer = document.getElementById(optionsId);
                
                if (!select || !optionsContainer) return;

                // Build options from select element
                function buildOptions() {
                    optionsContainer.innerHTML = '';
                    Array.from(select.options).forEach((option, index) => {
                        const optionDiv = document.createElement('div');
                        optionDiv.className = 'income-tax-dropdown-option';
                        if (option.selected) optionDiv.classList.add('selected');
                        optionDiv.textContent = option.textContent;
                        optionDiv.dataset.value = option.value;
                        
                        optionDiv.addEventListener('click', () => {
                            // Update select value
                            select.value = option.value;
                            
                            // Update selected state
                            optionsContainer.querySelectorAll('.income-tax-dropdown-option').forEach(opt => {
                                opt.classList.remove('selected');
                            });
                            optionDiv.classList.add('selected');
                            
                            // Trigger change event
                            select.dispatchEvent(new Event('change', { bubbles: true }));
                            
                            // Close dropdown
                            optionsContainer.classList.remove('show');
                            const dropdown = select.closest('.income-tax-custom-dropdown');
                            if (dropdown) dropdown.classList.remove('active');
                            
                            // Update select display
                            updateSelectDisplay(select);
                        });
                        
                        optionsContainer.appendChild(optionDiv);
                    });
                }

                // Update select display text
                function updateSelectDisplay(selectEl) {
                    const selectedOption = selectEl.options[selectEl.selectedIndex];
                    if (selectedOption) {
                            selectEl.style.color = 'var(--income-tax-foreground)';
                    }
                }

                // Toggle dropdown
                function toggleDropdown() {
                    const isOpen = optionsContainer.classList.contains('show');
                    const dropdown = select.closest('.income-tax-custom-dropdown');
                    
                    // Close all other dropdowns
                    document.querySelectorAll('.income-tax-dropdown-options').forEach(opt => {
                        if (opt !== optionsContainer) {
                            opt.classList.remove('show');
                            const otherDropdown = opt.closest('.income-tax-custom-dropdown');
                            if (otherDropdown) otherDropdown.classList.remove('active');
                        }
                    });
                    
                    // Toggle this dropdown
                    optionsContainer.classList.toggle('show', !isOpen);
                    if (dropdown) {
                        dropdown.classList.toggle('active', !isOpen);
                    }
                }

                // Prevent native dropdown from opening
                select.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    select.focus();
                    toggleDropdown();
                    return false;
                });

                // Also handle click as backup
                select.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                });

                // Focus handler
                select.addEventListener('focus', () => {
                        select.style.borderColor = 'var(--income-tax-primary)';
                });

                select.addEventListener('blur', () => {
                    // Delay closing to allow option click
                    setTimeout(() => {
                        optionsContainer.classList.remove('show');
                        const dropdown = select.closest('.income-tax-custom-dropdown');
                        if (dropdown) dropdown.classList.remove('active');
                    }, 200);
                });

                // Keyboard navigation
                select.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        toggleDropdown();
                    } else if (e.key === 'Escape') {
                        optionsContainer.classList.remove('show');
                    }
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!select.contains(e.target) && !optionsContainer.contains(e.target)) {
                        optionsContainer.classList.remove('show');
                        const dropdown = select.closest('.income-tax-custom-dropdown');
                        if (dropdown) dropdown.classList.remove('active');
                    }
                });

                // Initial build
                buildOptions();
                updateSelectDisplay(select);

                // Rebuild when select value changes programmatically
                const observer = new MutationObserver(() => {
                    buildOptions();
                    updateSelectDisplay(select);
                });
                observer.observe(select, { attributes: true, attributeFilter: ['value'] });
            });
        }
    
            // Initialize date field immediately if DOM is ready, or wait for load
            // Fetch CSRF token on page load
            fetchCsrfToken().catch(err => {
                console.warn('‚ö†Ô∏è Failed to fetch CSRF token on page load:', err);
            });

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                    initializeTransactionDate();
                });
            } else {
                // DOM is already ready, initialize immediately
                initializeTransactionDate();
        }

        window.addEventListener('load', async () => {
            console.log('üöÄ Page load event fired - resetting all calculation state');
            
            // CRITICAL: Reset all calculation state FIRST (before anything else)
            // This is essential when navigating from another page where state might be stuck
            state.isCalculating = false;
            state.calculatingStartTime = null;
            state.isInitialLoad = true; // Set to true initially, will be set to false after initial calculation
            state.currentCalculation = null; // Clear any stale calculation data
            state.isInitialized = false; // Track if calculator is ready to use
            
            console.log('‚úÖ Calculation state reset:', {
                isCalculating: state.isCalculating,
                calculatingStartTime: state.calculatingStartTime,
                isInitialLoad: state.isInitialLoad
            });
            
            // Hide any stuck loaders
            hideLoader();
            
            // Show loading state for "How We Calculated" section
            showHowWeCalculatedLoading();
                
            // Initialize custom dropdowns
            initializeCustomDropdowns();
            
            // Initialize comparison toggle state (ensure dropdown is disabled by default)
            const comparisonSelect = document.getElementById('income-tax-comparisonTaxYear');
            if (comparisonSelect) {
                comparisonSelect.disabled = true;
                comparisonSelect.style.opacity = '0.5';
                comparisonSelect.style.cursor = 'not-allowed';
            }
            
            // Initialize property income visibility based on tax year
            updatePropertyIncomeVisibility();
            
            // Initialize overview comparison toggle state (ensure dropdown is disabled by default)
            const overviewComparisonSelect = document.getElementById('income-tax-overviewComparisonTaxYear');
            if (overviewComparisonSelect) {
                overviewComparisonSelect.disabled = true;
                overviewComparisonSelect.style.opacity = '0.5';
                overviewComparisonSelect.style.cursor = 'not-allowed';
            }
            
            // Initialize breakdown comparison toggle state (ensure dropdown is disabled by default)
            const breakdownComparisonSelect = document.getElementById('income-tax-breakdownComparisonTaxYear');
            if (breakdownComparisonSelect) {
                breakdownComparisonSelect.disabled = true;
                breakdownComparisonSelect.style.opacity = '0.5';
                breakdownComparisonSelect.style.cursor = 'not-allowed';
            }
            
            // Initialize overview layout based on initial state
            updateOverviewLayout();
            
            // Initialize tooltip positioning
            initializeTooltips();
            
            // Re-initialize tooltips when DOM changes (e.g., when tabs switch)
            const observer = new MutationObserver(() => {
                initializeTooltips();
            });
            observer.observe(document.body, { childList: true, subtree: true });
            
            // Load creative loading messages (only once, cached after first load)
            loadLoadingMessages();
            
            // Check if user has used AI mode before
            checkAIModeUsage();
            
            // Load storage consent preference
            loadStorageConsent();
            
            // Load history from localStorage
            loadHistoryFromStorage();
            
            // Initialize transaction date picker (set max to today, default to today)
            initializeTransactionDate();
            
            // Initialize property value input with formatted display
            const propertyValueInput = document.getElementById('income-tax-propertyValue');
            if (propertyValueInput) {
                propertyValueInput.value = state.propertyValue.toLocaleString('en-GB');
                propertyValueInput.dataset.rawValue = state.propertyValue.toString();
            }
            
            // Update tooltip with initial state
            updatePropertyValueTooltip();
            
            // Apply fallback results for initial view (in case initial calculation is delayed or fails)
            setInitialFallbackResults();
            
            // Set initial mode based on state.aiMode (don't toggle, just set the UI)
            const toggle = document.getElementById('income-tax-modeToggle');
            const simpleResults = document.getElementById('income-tax-simpleResults');
            const aiResults = document.getElementById('income-tax-aiResults');
            const headerSubtitle = document.getElementById('income-tax-headerSubtitle');
            const simpleModeLabel = document.getElementById('income-tax-simpleModeLabel');
            const aiModeLabel = document.getElementById('income-tax-aiModeLabel');
            
            if (state.aiMode) {
                // Show AI mode
                if (toggle) toggle.classList.add('active');
                if (simpleResults) simpleResults.classList.add('income-tax-hidden');
                if (aiResults) aiResults.classList.remove('income-tax-hidden');
                if (headerSubtitle) headerSubtitle.textContent = 'AI-powered calculations with real-time insights';
                if (simpleModeLabel) {
                    simpleModeLabel.style.fontWeight = '400';
                    simpleModeLabel.style.color = '#6b7280';
                }
                if (aiModeLabel) {
                    aiModeLabel.style.fontWeight = '700';
                        aiModeLabel.style.color = 'var(--income-tax-foreground)';
                }
                document.querySelectorAll('.income-tax-ai-only').forEach(el => {
                    el.classList.remove('income-tax-hidden');
                    el.style.display = '';
                });
            } else {
                // Show simple mode
                if (toggle) toggle.classList.remove('active');
                if (simpleResults) simpleResults.classList.remove('income-tax-hidden');
                if (aiResults) aiResults.classList.add('income-tax-hidden');
                if (headerSubtitle) headerSubtitle.textContent = 'Quick and simple tax calculations';
                if (simpleModeLabel) {
                    simpleModeLabel.style.fontWeight = '700';
                        simpleModeLabel.style.color = 'var(--income-tax-foreground)';
                }
                if (aiModeLabel) {
                    aiModeLabel.style.fontWeight = '400';
                    aiModeLabel.style.color = '#6b7280';
                }
                document.querySelectorAll('.income-tax-ai-only').forEach(el => {
                    el.classList.add('income-tax-hidden');
                    el.style.display = 'none';
                });
            }
            preventCopyFromResults();
            
                // Add click-outside-to-close for clear history modal
                const clearHistoryModal = document.getElementById('income-tax-clearHistoryModal');
                if (clearHistoryModal) {
                    clearHistoryModal.addEventListener('click', (e) => {
                        if (e.target === clearHistoryModal) {
                            closeClearHistoryModal();
                        }
                    });
                }
                
                // Ensure date field is initialized before checking for calculation
                // Re-initialize to make sure it has a value (especially important for hard refresh)
                initializeTransactionDate();
                
                // Use a more reliable approach: wait for date field to be ready
                const checkAndCalculate = () => {
                    // Get property value from input, fallback to state if input is empty or not found
                    let propertyValue = getSanitizedCurrencyValue('income-tax-propertyValue');
                    if (!propertyValue || propertyValue === 0) {
                        propertyValue = state.propertyValue || 500000; // Use state value as fallback
                        // Also ensure the input field has the value
                        const propertyValueInput = document.getElementById('income-tax-propertyValue');
                        if (propertyValueInput) {
                            propertyValueInput.value = propertyValue.toLocaleString('en-GB');
                            propertyValueInput.dataset.rawValue = propertyValue.toString();
                        }
                    }
                    
                    const taxYearInput = document.getElementById('income-tax-transactionDate');
                    
                    // Ensure date field has a value
                    if (taxYearInput && (!taxYearInput.value || taxYearInput.value.trim() === '')) {
                        const today = new Date().toISOString().split('T')[0];
                        taxYearInput.value = today;
                        taxYearInput.setAttribute('value', today);
                        state.taxYear = today;
                    }
                    
                    // Get taxYear from input or state
                    let taxYear = taxYearInput ? taxYearInput.value : '';
                    if (!taxYear && state.taxYear) {
                        taxYear = state.taxYear;
                    }
                    
                    // Final fallback: use today's date
                    if (!taxYear || taxYear.trim() === '') {
                        const today = new Date().toISOString().split('T')[0];
                        taxYear = today;
                        if (taxYearInput) {
                            taxYearInput.value = today;
                            taxYearInput.setAttribute('value', today);
                        }
                        state.taxYear = today;
                    }
                    
                    const calculatorType = state.calculatorType;
                    const propertyTypeEl = document.getElementById('income-tax-propertyType');
                    const propertyType = propertyTypeEl ? propertyTypeEl.value : '';
                    const residencyStatusEl = document.getElementById('income-tax-residencyStatus');
                    const residencyStatus = residencyStatusEl ? residencyStatusEl.value : '';
                    
                    if (propertyValue && taxYear && (calculatorType !== 'Residential' || residencyStatus)) {
                        console.log('‚úÖ All required fields present, calling calculation API...', {
                            propertyValue,
                            taxYear,
                            calculatorType,
                            propertyType,
                            residencyStatus,
                            isCalculating: state.isCalculating,
                            calculatingStartTime: state.calculatingStartTime
                        });
                        
                        // CRITICAL: Don't set isCalculating here - let calculateTax() set it
                        // This prevents the race condition where isCalculating is set before calculateTax() is called
                        // calculateTax() will check and set the flag itself
                        
                        // Don't show loader on initial load - user already sees fallback results
                        if (!state.isInitialLoad) {
                            showLoader();
                        }
                        
                        // Explicitly call calculateTax to trigger API call
                        // calculateTax() will set isCalculating and calculatingStartTime itself
                        console.log('üìû Calling calculateTax() API...', {
                            isCalculating: state.isCalculating,
                            calculatingStartTime: state.calculatingStartTime
                        });
                        calculateTax();
                    } else {
                        console.log('‚ö†Ô∏è Initial calculation skipped: missing required fields', {
                            propertyValue,
                            taxYear,
                            calculatorType,
                            residencyStatus,
                            hasTaxYearInput: !!taxYearInput,
                            taxYearInputValue: taxYearInput ? taxYearInput.value : 'N/A'
                        });
                        // Mark initial load as complete even if calculation is skipped
                        state.isInitialLoad = false;
                    }
                };
                
                // Ensure all global functions are attached to window (important when navigating from another page)
                window.recalculate = recalculate;
                window.formatCurrencyInput = formatCurrencyInput;
                window.handleTaxYearChange = handleTaxYearChange;
                window.toggleDetailedExpenses = toggleDetailedExpenses;
                
                console.log('‚úÖ Global functions attached to window:', {
                    recalculate: typeof window.recalculate,
                    formatCurrencyInput: typeof window.formatCurrencyInput,
                    handleTaxYearChange: typeof window.handleTaxYearChange,
                    toggleDetailedExpenses: typeof window.toggleDetailedExpenses,
                    debouncedCalculateTax: typeof debouncedCalculateTax,
                    calculateTax: typeof calculateTax
                });
                
                // Wait 2 seconds after page load before calling calculation API
                // This ensures all state is reset and the page is fully ready
                setTimeout(() => {
                    console.log('‚úÖ 2 seconds passed after page load, now calling calculation API...');
                    console.log('üìä Current state before calculation:', {
                        isCalculating: state.isCalculating,
                        calculatingStartTime: state.calculatingStartTime,
                        isInitialLoad: state.isInitialLoad,
                        propertyValue: state.propertyValue,
                        taxYear: state.taxYear,
                        calculatorType: state.calculatorType,
                        documentReady: document.readyState,
                        inputsReady: {
                            propertyValue: !!document.getElementById('income-tax-propertyValue'),
                            transactionDate: !!document.getElementById('income-tax-transactionDate'),
                            propertyType: !!document.getElementById('income-tax-propertyType'),
                            residencyStatus: !!document.getElementById('income-tax-residencyStatus')
                        }
                    });
                    
                    // Final safety check: ensure calculation state is reset before calling
                    if (state.isCalculating) {
                        console.warn('‚ö†Ô∏è Calculation flag still set after 2s delay, resetting now...');
                        state.isCalculating = false;
                        state.calculatingStartTime = null;
                        hideLoader();
                    }
                    
                    // Call calculation API after 2 second delay
                    checkAndCalculate();
                    
                    // After calculation attempt, mark initial load as complete
                    // This ensures that subsequent user input changes will show the loader
                    setTimeout(() => {
                        state.isInitialLoad = false;
                        console.log('‚úÖ Initial load complete, calculations will now show loader');
                    }, 1500); // Give calculation time to start and complete
                }, 2000); // Wait 2 seconds after page load
        });
    </script>

</head>
<body>
    <style>
        body{font-family: 'Lato', sans-serif;}
        :root {
            --income-tax-primary: linear-gradient(
                255deg, #43468a 0%, #2a2667 100%);
            --income-tax-primary-dark:linear-gradient(
                255deg, #43468a 0%, #121826 100%);
            --income-tax-primary-light: #f0fdfa;
            --income-tax-background: #ffffff;
            --income-tax-foreground: #1f2937;
            --income-tax-card: #f9fafb;
            --income-tax-border: #e5e7eb;
            --income-tax-red: #dc2626;
            --income-tax-green: #16a34a;
            --income-tax-blue: #2563eb;
            --income-tax-purple: #a855f7;
            --income-tax-yellow: #eab308;
        }
        .income-tax-wrapper {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            color: var(--income-tax-foreground);
            margin: -50px 0px;
            padding: 50px 0px;
        }
        /* body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            color: var(--income-tax-foreground);
            line-height: 1.6;
            min-height: 100vh;
        } */
        h1#income-tax-headerTitle{
            color: var(--income-tax-primary);
            line-height: 1;
        }
        .income-tax-container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 20px;
        }

        .income-tax-save-tooltip {
            position: fixed;
            background: #111827;
            color: white;
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            z-index: 10000;
            pointer-events: none;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            white-space: nowrap;
            min-width: 100px;
            text-align: center;
        }
        
        .income-tax-save-tooltip.visible {
            opacity: 1;
            transform: translateY(0);
        }
        /* .trustforDesktop{
            bottom:5px;
            position:relative;
        } */
        /* Header */
        .income-tax-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
            background: white;
            padding: 10px 20px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .income-tax-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .income-tax-calculations-overview{
            padding: 16px; 
            background: #f6f6ff; 
            border-radius: 8px;
        }
        .income-tax-header-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--income-tax-primary) 0%, #06b6d4 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 6px rgba(13, 148, 136, 0.2);
        }

        h1 .income-tax-header-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 4px;
            color: var(--income-tax-primary);
            background: linear-gradient(135deg, var(--income-tax-primary) 0%, #06b6d4 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .income-tax-header-title p {
            font-size: 14px;
            color: #6b7280;
        }

        .income-tax-header-right {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .income-tax-mode-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background: #f3f4f6;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 500;
        }

        .income-tax-toggle-switch {
            width: 48px;
            height: 24px;
            background: #d1d5db;
            border-radius: 12px;
            cursor: pointer;
            position: relative;
            transition: background 0.3s;
            margin: 0 6px;
        }

        .income-tax-toggle-switch.active {
            background: var(--income-tax-primary);
        }

        .income-tax-toggle-switch::after {
            content: "";
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 10px;
            top: 2px;
            left: 2px;
            transition: left 0.3s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .income-tax-toggle-switch.active::after {
            left: 26px;
        }

        .income-tax-button {
            padding: 10px 16px;
            border: 1px solid var(--income-tax-border);
            background: white;
            color: var(--income-tax-foreground);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }
        
        .income-tax-button:hover {
            background: var(--income-tax-card);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        /* Primary (filled) button style */
        .income-tax-button-primary,
        .income-tax-button.primary {
            background: #16a34a;
            color: #ffffff;
            border-color: #16a34a;
        }
        
        .income-tax-button-primary:hover,
        .income-tax-button.primary:hover {
            background: #15803d;
            border-color: #15803d;
        }

        .income-tax-button-secondary {
            background: #f3f4f6;
            color: #6b7280;
            border-color: #e5e7eb;
        }

        .income-tax-button-secondary:hover {
            background: #e5e7eb;
            color: #374151;
        }

        .income-tax-button-small {
            padding: 8px 12px;
            font-size: 13px;
        }

        .income-tax-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .income-tax-button:disabled:hover {
            transform: none;
            box-shadow: none;
        }

        /* Main Grid */
        .income-tax-main-grid {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 20px;
        }

        /* Keep inputs and results side by side on most screens.
           Only stack vertically on smaller (tablet/mobile) widths. */
        @media (max-width: 900px) {
            .income-tax-main-grid {
                grid-template-columns: 1fr;
            }
        }

        .income-tax-card {
            background: white;
            border: 1px solid var(--income-tax-border);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            width: 100%;
            box-sizing: border-box;
        }

        .income-tax-card-header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--income-tax-border);
        }

        .income-tax-card-title {
            font-size: 16px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Left Panel */
        .income-tax-left-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Right Panel */
        .income-tax-right-panel {
            display: flex;
            flex-direction: column;
            min-width: 0; /* Prevents overflow issues */
        }

        .income-tax-form-group {
            margin-bottom: 16px;
            width: 100%;
            box-sizing: border-box; /* Prevent overflow */
        }

        .income-tax-label {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
            color: var(--income-tax-foreground);
        }

        .income-tax-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid var(--income-tax-border);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s;
            box-sizing: border-box; /* Prevent overflow from padding and border */
        }

        .income-tax-input:focus {
            outline: none;
            border-color: var(--income-tax-primary);
            box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1);
        }

        .income-tax-input-with-icon {
            position: relative;
            width: 100%;
            box-sizing: border-box; /* Prevent overflow */
        }

        .income-tax-input-with-icon .income-tax-currency {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            font-size: 14px;
            font-weight: 600;
        }

        .income-tax-input-with-icon input {
            padding-left: 28px;
            box-sizing: border-box; /* Ensure box-sizing is applied */
        }

        .income-tax-button-group {
            display: grid;
            gap: 8px;
        }

        .income-tax-button-group.income-tax-three-col {
            grid-template-columns: repeat(2, 1fr);
        }

        .income-tax-button-group.income-tax-four-col {
            grid-template-columns: repeat(4, 1fr);
        }
        .income-tax-button-group-right{
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }
        .income-tax-button-group .income-tax-button {
            padding: 10px;
            background:#f6f6ff;
            font-size: 12px;
            justify-content: center;
        }

        .income-tax-button-group .income-tax-button.active {
            background: var(--income-tax-primary);
            color: white;
            border-color: var(--income-tax-primary);
        }

        .income-tax-separator {
            height: 1px;
            background: var(--income-tax-border);
            margin: 0px 0;
        }

        .income-tax-select {
            width: 100%;
            padding: 12px 40px 12px 14px;
            border: 2px solid var(--income-tax-border);
            border-radius: 10px;
            font-size: 14px;
            font-family: inherit;
            background: white;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23122166' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 14px center;
            background-size: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            position: relative;
            box-sizing: border-box; /* Prevent overflow from padding and border */
        }

        .income-tax-select:hover {
            border-color: var(--income-tax-primary);
            box-shadow: 0 2px 8px rgba(18, 33, 102, 0.12);
            transform: translateY(-1px);
        }

        .income-tax-select:focus {
            outline: none;
            border-color: var(--income-tax-primary);
            box-shadow: 0 0 0 4px rgba(18, 33, 102, 0.1), 0 4px 12px rgba(18, 33, 102, 0.15);
            transform: translateY(-1px);
        }

        .income-tax-select:active {
            transform: translateY(0);
        }

        /* Custom Dropdown Wrapper */
        .income-tax-custom-dropdown {
            position: relative;
            width: 100%;
            box-sizing: border-box; /* Prevent overflow */
        }

        .income-tax-custom-dropdown-select {
            width: 100%;
            padding: 12px 40px 12px 14px;
            border: 2px solid var(--income-tax-border);
            border-radius: 10px;
            font-size: 14px;
            font-family: inherit;
            background: white;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23122166' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 14px center;
            background-size: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            pointer-events: auto;
            box-sizing: border-box; /* Prevent overflow from padding and border */
        }
        .income-tax-tax-card-content{
            width:100%
        }
        /* Prevent native dropdown from opening */
        .income-tax-custom-dropdown-select::-ms-expand {
            display: none;
        }

        .income-tax-custom-dropdown.active .income-tax-custom-dropdown-select {
            border-color: var(--income-tax-primary);
            box-shadow: 0 0 0 4px rgba(18, 33, 102, 0.1), 0 4px 12px rgba(18, 33, 102, 0.15);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23122166' d='M6 3L11 8H1z'/%3E%3C/svg%3E");
        }

        .income-tax-custom-dropdown-select:hover {
            border-color: var(--income-tax-primary);
            box-shadow: 0 2px 8px rgba(18, 33, 102, 0.12);
            transform: translateY(-1px);
        }

        .income-tax-custom-dropdown-select:focus {
            outline: none;
            border-color: var(--income-tax-primary);
            box-shadow: 0 0 0 4px rgba(18, 33, 102, 0.1), 0 4px 12px rgba(18, 33, 102, 0.15);
        }

        /* Custom Dropdown Options Container */
        .income-tax-dropdown-options {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12), 0 4px 8px rgba(0, 0, 0, 0.08);
            z-index: 1000;
            max-height: 240px;
            overflow-y: auto;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-8px) scale(0.98);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
            scrollbar-width: thin;
            scrollbar-color: #d1d5db #f1f1f1;
        }

        .income-tax-dropdown-options.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
            pointer-events: auto;
        }

        /* Custom Dropdown Option Items */
        .income-tax-dropdown-option {
            padding: 12px 16px;
            font-size: 14px;
            color: var(--income-tax-foreground); 
            cursor: pointer;
            transition: all 0.15s ease;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            position: relative;
            display: flex;
            align-items: center;
        }

        .income-tax-dropdown-option:first-child {
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }

        .income-tax-dropdown-option:last-child {
            border-bottom: none;
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
        }

        .income-tax-dropdown-option:hover {
            background: linear-gradient(135deg, rgba(67, 70, 138, 0.08) 0%, rgba(42, 38, 103, 0.12) 100%);
            color: #43468a;
            padding-left: 20px;
            border-bottom: 1px solid transparent;
        }

        .income-tax-dropdown-option.selected {
            background: linear-gradient(255deg, #43468a 0%, #2a2667 100%);
            color: white;
            font-weight: 600;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
            border-bottom: 1px solid transparent;
        }

        .income-tax-dropdown-option.selected:hover {
            background: linear-gradient(255deg, #2a2667 0%, #43468a 100%);
            padding-left: 20px;
            color: white;
            border-bottom: 1px solid transparent;
        }

        /* Scrollbar styling for dropdown */
        .income-tax-dropdown-options::-webkit-scrollbar {
            width: 6px;
        }

        .income-tax-dropdown-options::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .income-tax-dropdown-options::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 10px;
        }

        .income-tax-dropdown-options::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        /* Small select variant for chart type selector */
        .income-tax-select-small {
            padding: 8px 32px 8px 10px;
            font-size: 12px;
            background-size: 10px;
            background-position: right 10px center;
        }

        .income-tax-custom-dropdown-select.income-tax-select-small {
            padding: 8px 28px 8px 10px;
            font-size: 12px;
            background-size: 10px;
            background-position: right 10px center;
        }

        .income-tax-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        /* Mobile form row - single column on desktop, 2 columns on mobile */
        .income-tax-form-row-mobile {
            display: flex;
            flex-direction: column;
        }

        /* Tabs */
        .income-tax-tabs {
            margin-bottom: 20px;
        }

        .income-tax-tab-list {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            background: white;
            border: 1px solid var(--income-tax-border);
            border-radius: 10px;
            padding: 6px;
        }

        .income-tax-tab-trigger {
            padding: 12px 16px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: #1a1a1a;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            border-radius: 6px;
        }

        .income-tax-tab-trigger:hover {
            background: var(--income-tax-card);
        }

        .income-tax-tab-trigger.active {
            background: var(--income-tax-primary);
            color: white;
        }

        .income-tax-tab-trigger.income-tax-ai-only-tab:not(.active) {
            position: relative;
        }
        .inner-ai-saving-summary{
            margin-bottom: 16px;
            margin-left: 16px;
        }
        .income-tax-tab-trigger.income-tax-ai-only-tab[style*="opacity: 0.5"] {
            color: #9ca3af;
        }

        .income-tax-tab-trigger.income-tax-ai-only-tab[style*="opacity: 0.5"]:hover {
            color: var(--income-tax-primary);
        }

        .income-tax-tab-content {
            display: none;
        }

        .income-tax-tab-content.active {
            display: block;
        }

        /* Results Grid */
        .income-tax-results-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        @media (min-width: 768px) {
            .income-tax-results-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .income-tax-result-box {
            text-align: center;
            padding: 20px 16px;
            border-radius: 10px;
            font-size: 13px;
            transition: transform 0.2s;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .income-tax-result-box:hover {
            transform: translateY(-2px);
        }

        .income-tax-result-box.income-tax-red {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: var(--income-tax-red);
            border: 2px solid #fca5a5;
        }
        .income-tax-green,.income-tax-blue,.income-tax-purple{
            background: #f1f6fe;
            color: #2e40ab;
            border: 2px solid #d8d8d8;
        }

        .income-tax-result-box-label {
            font-size: 12px;
            margin-bottom: 8px;
            opacity: 0.9;
            font-weight: 600;
        }

        .income-tax-result-box-value {
            font-size: 24px;
            font-weight: bold;
            color: #2e40ab;
        }

        /* AI Insights */
        .income-tax-ai-insights {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border: 2px solid #93c5fd;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .income-tax-ai-insights-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
            font-weight: 700;
            font-size: 15px;
            color: #1e40af;
        }

        .income-tax-ai-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        .income-tax-metric {
            text-align: center;
            background: rgba(255, 255, 255, 0.7);
            padding: 12px;
            border-radius: 8px;
        }

        .income-tax-metric-label {
            font-size: 12px;
            color: #1e40af;
            margin-bottom: 4px;
            font-weight: 600;
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .income-tax-metric-label .income-tax-tooltip-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #3b82f6;
            color: white;
            font-size: 10px;
            font-weight: bold;
            cursor: help;
            position: relative;
        }

        .income-tax-metric-label .income-tax-tooltip-icon:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 8px;
            padding: 8px 12px;
            background: #1f2937;
            color: white;
            border-radius: 6px;
            font-size: 11px;
            font-weight: normal;
            white-space: normal;
            width: 280px;
            text-align: left;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            pointer-events: none;
        }

        .income-tax-metric-label .income-tax-tooltip-icon:hover::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 2px;
            border: 5px solid transparent;
            border-top-color: #1f2937;
            z-index: 1000;
            pointer-events: none;
        }

        /* General tooltip for form labels */
        .income-tax-label {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .income-tax-label .income-tax-tooltip-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--income-tax-primary);
            color: white;
            font-size: 11px;
            font-weight: bold;
            cursor: help;
            position: relative;
            flex-shrink: 0;
            transition: all 0.2s;
            vertical-align: middle;
        }

        .income-tax-label .income-tax-tooltip-icon:hover {
            background: var(--income-tax-primary-dark);
            transform: scale(1.1);
            z-index: 3;
        }

        .income-tax-label .income-tax-tooltip-icon:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-30%);
            padding: 10px 14px;
            background: #1f2937;
            color: white;
            border-radius: 8px;
            font-size: 12px;
            font-weight: normal;
            white-space: normal;
            width: 300px;
            max-width: calc(100vw - 40px);
            text-align: left;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            pointer-events: none;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .income-tax-label .income-tax-tooltip-icon:hover::before {
            content: '';
            position: absolute;
            bottom: calc(100% + 2px);
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #1f2937;
            z-index: 10001;
            pointer-events: none;
        }

        /* Dynamic positioning classes for viewport-aware tooltips */
        .income-tax-label .income-tax-tooltip-icon[data-tooltip-pos="top"]:hover::after {
            bottom: calc(100% + 8px);
            top: auto;
            left: 10%;
            right: auto;
            transform: translateX(-10%);
        }

        .income-tax-label .income-tax-tooltip-icon[data-tooltip-pos="top"]:hover::before {
            bottom: calc(100% + 2px);
            top: auto;
            left: 50%;
            right: auto;
            transform: translateX(-50%);
            border-top-color: #1f2937;
            border-bottom-color: transparent;
            border-left-color: transparent;
            border-right-color: transparent;
        }

        .income-tax-label .income-tax-tooltip-icon[data-tooltip-pos="bottom"]:hover::after {
            top: calc(100% + 8px);
            bottom: auto;
            left: 50%;
            right: auto;
            transform: translateX(-50%);
        }

        .income-tax-label .income-tax-tooltip-icon[data-tooltip-pos="bottom"]:hover::before {
            top: calc(100% + 2px);
            bottom: auto;
            left: 50%;
            right: auto;
            transform: translateX(-50%);
            border-bottom-color: #1f2937;
            border-top-color: transparent;
            border-left-color: transparent;
            border-right-color: transparent;
        }
        .income-tax-label .income-tax-tooltip-icon[data-tooltip-pos="left"]:hover::after {
            right: calc(100% + 8px);
            left: auto;
            top: 50%;
            bottom: auto;
            transform: translateY(-50%);
        }

        .income-tax-label .income-tax-tooltip-icon[data-tooltip-pos="left"]:hover::before {
            right: calc(100% + 2px);
            left: auto;
            top: 50%;
            bottom: auto;
            transform: translateY(-50%);
            border-left-color: #1f2937;
            border-right-color: transparent;
            border-top-color: transparent;
            border-bottom-color: transparent;
        }

        .income-tax-label .income-tax-tooltip-icon[data-tooltip-pos="right"]:hover::after {
            left: calc(100% + 8px);
            right: auto;
            top: 50%;
            bottom: auto;
            transform: translateY(-50%);
        }

        .income-tax-label .income-tax-tooltip-icon[data-tooltip-pos="right"]:hover::before {
            left: calc(100% + 2px);
            right: auto;
            top: 50%;
            bottom: auto;
            transform: translateY(-50%);
            border-right-color: #1f2937;
            border-left-color: transparent;
            border-top-color: transparent;
            border-bottom-color: transparent;
        }

        /* Adjust tooltip position to stay within viewport */
        .income-tax-label .income-tax-tooltip-icon[data-tooltip-adj="left"]:hover::after {
            left: -20vw !important;
            right: auto;
            transform: translateX(0) !important;
        }

        .income-tax-label .income-tax-tooltip-icon[data-tooltip-adj="left"]:hover::before {
            left: 20px;
            right: auto;
            transform: translateX(0);
        }

        .income-tax-label .income-tax-tooltip-icon[data-tooltip-adj="right"]:hover::after {
            right: 20px;
            left: auto;
            transform: translateX(0);
        }

        .income-tax-label .income-tax-tooltip-icon[data-tooltip-adj="right"]:hover::before {
            right: 20px;
            left: auto;
            transform: translateX(0);
        }

        .income-tax-metric-value {
            font-size: 20px;
            font-weight: bold;
            color: #1e40af;
        }

        .income-tax-ai-savings-summary {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 16px;
            margin-top: 16px;
            border: 1px solid rgba(147, 197, 253, 0.3);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .income-tax-ai-savings-summary-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 16px;
        }

        .income-tax-ai-savings-summary-content {
            display:flex;
            align-items: center;
            justify-content: space-between;
        }

        .income-tax-ai-savings-summary-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 13px;
            color: #1e40af;
        }

        .income-tax-ai-savings-summary-title .income-tax-icon {
            font-size: 16px;
        }

        .income-tax-ai-savings-summary-text {
            color: #4b5563;
            font-size: 12px;
            line-height: 1.7;
            letter-spacing: 0.01em;
        }

        .income-tax-ai-savings-summary-text strong {
            color: #1e40af;
            font-weight: 600;
        }

        .income-tax-ai-savings-summary-disclaimer {
            width: 100%;
            padding-top: 12px;
            border-top: 1px solid rgba(147, 197, 253, 0.2);
            font-size: 11px;
            color: #6b7280;
            line-height: 1.5;
            font-style: italic;
        }

        .income-tax-ai-savings-summary-button {
            flex-shrink: 0;
            align-self: center;
        }

        /* Conversion Box */
        .income-tax-conversion-box {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            border: 2px solid #86efac;
            border-radius: 10px;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .income-tax-conversion-info {
            font-size: 13px;
        }

        .income-tax-conversion-title {
            font-weight: 700;
            margin-bottom: 4px;
            color: #1f2937;
            font-size: 16px;
        }

        .income-tax-conversion-subtitle {
            font-size: 12px;
            color: #6b7280;
        }

        .income-tax-conversion-buttons {
            display: flex;
            gap: 8px;
        }

        /* Breakdown Section */
        .income-tax-breakdown-card {
            background: var(--income-tax-card);
            border: 1px solid var(--income-tax-border);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 16px;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            height:auto;
            /* min-height:300px; */
        }

        .income-tax-breakdown-card.income-tax-collapsible {
            padding: 0;
            overflow: hidden;
            height:auto;
        }

        .income-tax-breakdown-card-header {
            padding: 14px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            gap: 8px;
        }

        .income-tax-breakdown-card-header-title {
            font-weight: 700;
            font-size: 15px;
            color: var(--income-tax-foreground);
        }

        .income-tax-breakdown-card-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #6b7280;
        }

        .income-tax-breakdown-card-toggle-icon {
            width: 18px;
            height: 18px;
            border-radius: 999px;
            border: 1px solid #d1d5db;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            background: white;
        }

        .income-tax-breakdown-card-body {
            padding: 12px 16px 16px 16px;
            border-top: 1px solid rgba(148, 163, 184, 0.3);
        }

        .income-tax-breakdown-card.income-tax-collapsed .income-tax-breakdown-card-body {
            display: none;
        }

        .income-tax-breakdown-title {
            font-weight: 700;
            font-size: 15px;
            margin-bottom: 16px;
            color: var(--income-tax-foreground);
        }

        .income-tax-bracket-row {
            display: grid;
            grid-template-columns: 80px 1fr 120px 120px;
            gap: 12px;
            padding: 12px;
            background: white;
            border-radius: 6px;
            font-size: 13px;
            margin-bottom: 8px;
            border: 1px solid var(--income-tax-border);
            min-width: 0; /* Prevent grid overflow */
        }

        .income-tax-bracket-row-label {
            font-weight: 700;
            color: #6b7280;
            font-size: 12px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .income-tax-bracket-row-header {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 1px solid #a4c4c1;
            font-weight: 700;
            color: var(--income-tax-primary);
            font-size: 13px;
            padding: 14px 12px;
            margin-bottom: 12px;
        }

        /* Comparison table (Breakdown tab) */
        .income-tax-comparison-table-wrapper {
            border-radius: 10px;
            border: 1px solid var(--income-tax-border);
            background: #ffffff;
            box-shadow: 0 8px 18px rgba(15, 23, 42, 0.06);
            overflow: hidden; /* Ensure content respects border radius */
        }

        /* Header container to merge Category and Difference cells */
        .income-tax-comparison-header-container {
            display: grid;
            grid-template-rows: auto auto;
            /* Columns must mirror .income-tax-comparison-row for perfect alignment */
            grid-template-columns:
                minmax(180px, 1.6fr)
                minmax(90px, 1.1fr)
                minmax(30px, 0.5fr)
                minmax(110px, 1.1fr)
                minmax(90px, 1.1fr)
                minmax(30px, 0.5fr)
                minmax(110px, 1.1fr)
                minmax(90px, 1fr);
            background: #ede9fe;
            border-bottom: 1px solid #bfdbfe;
        }

        .income-tax-comparison-header-row {
            display: contents;
            font-size: 12px;
            font-weight: 600;
            color: #1e40af;
        }

        /* Single-year mode: 4 columns (Category, Income, Rate, Tax) */
        .income-tax-comparison-header-container.income-tax-single-year {
            grid-template-columns: minmax(180px, 1.6fr) minmax(90px, 1.1fr) minmax(40px, 0.5fr) minmax(110px, 1.1fr);
        }

        .income-tax-comparison-header-row.income-tax-single-year {
            display: contents;
        }
        
        /* Single-year mode: Category cell positioning */
        .income-tax-comparison-header-row-top.income-tax-single-year .income-tax-comparison-header-cell-top-category {
            grid-column: 1;
            grid-row: 1 / 3;
        }
        
        .income-tax-comparison-header-row-top.income-tax-single-year .income-tax-comparison-header-cell-top-year {
            grid-column: 2 / 5;
            grid-row: 1;
        }
        
        /* Single-year mode: Sub-header row cells positioning */
        .income-tax-comparison-header-row-sub.income-tax-single-year .income-tax-comparison-header-cell:nth-child(1) {
            grid-column: 2;
            grid-row: 2;
        }
        .income-tax-comparison-header-row-sub.income-tax-single-year .income-tax-comparison-header-cell:nth-child(2) {
            grid-column: 3;
            grid-row: 2;
        }
        .income-tax-comparison-header-row-sub.income-tax-single-year .income-tax-comparison-header-cell:nth-child(3) {
            grid-column: 4;
            grid-row: 2;
        }

        .income-tax-comparison-header-row-top {
            border-bottom: none;
        }

        .income-tax-comparison-header-row-sub {
            border-top: 1px solid #bfdbfe;
        }

        .income-tax-comparison-header-cell-top-category {
            text-align: center;
        }

        .income-tax-comparison-header-cell-top-year {
            text-align: center;
        }

        /* Center all labels in the top header row (Category, years, Diff) */
        .income-tax-comparison-header-row-top .income-tax-comparison-header-cell {
            text-align: center;
        }

        /* Merged cells for Category and Difference - span both rows and center vertically */
        .income-tax-comparison-header-cell-merged {
            grid-row: 1 / 3;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 10px 12px;
            border-right: 1px solid #bfdbfe;
        }

        /* Top header row cells positioning */
        .income-tax-comparison-header-row-top .income-tax-comparison-header-cell-top-category {
            grid-column: 1;
            grid-row: 1 / 3;
        }
        .income-tax-comparison-header-row-top .income-tax-comparison-header-cell-top-year[style*="grid-column: 2 / 5"] {
            grid-column: 2 / 5;
            grid-row: 1;
        }
        .income-tax-comparison-header-row-top .income-tax-comparison-header-cell-top-year[style*="grid-column: 5 / 8"] {
            grid-column: 5 / 8;
            grid-row: 1;
        }
        .income-tax-comparison-header-row-top .income-tax-comparison-header-cell-top-year[style*="grid-column: 8 / 9"] {
            grid-column: 8;
            grid-row: 1 / 3;
        }

        /* Sub-header row cells positioning */
        .income-tax-comparison-header-row-sub .income-tax-comparison-header-cell:nth-child(1) {
            grid-column: 2;
            grid-row: 2;
        }
        .income-tax-comparison-header-row-sub .income-tax-comparison-header-cell:nth-child(2) {
            grid-column: 3;
            grid-row: 2;
        }
        .income-tax-comparison-header-row-sub .income-tax-comparison-header-cell:nth-child(3) {
            grid-column: 4;
            grid-row: 2;
        }
        .income-tax-comparison-header-row-sub .income-tax-comparison-header-cell:nth-child(4) {
            grid-column: 5;
            grid-row: 2;
        }
        .income-tax-comparison-header-row-sub .income-tax-comparison-header-cell:nth-child(5) {
            grid-column: 6;
            grid-row: 2;
        }
        .income-tax-comparison-header-row-sub .income-tax-comparison-header-cell:nth-child(6) {
            grid-column: 7;
            grid-row: 2;
        }

        .income-tax-comparison-header-cell {
            padding: 10px 12px;
            border-right: 1px solid #bfdbfe;
            text-align: right; /* default alignment for sub-header row */
        }

        .income-tax-comparison-header-cell:last-child {
            border-right: none;
        }

        /* Ensure all header cells have borders */
        .income-tax-comparison-header-cell {
            border-right: 1px solid #bfdbfe;
        }

        /* Remove border from last column (Difference) */
        .income-tax-comparison-header-cell-top-year[style*="grid-column: 8"] {
            border-right: none;
        }

        /* Ensure top year headers have borders and proper divider between years */
        /* Add border between the two tax year headers (between column 4 and 5) */
        .income-tax-comparison-header-cell-top-year[style*="grid-column: 2 / 5"] {
            border-right: 1px solid #bfdbfe;
        }
        


        /* Ensure divider between tax years is visible in sub-header row - column 4 (Tax of first year) */
        .income-tax-comparison-header-row-sub .income-tax-comparison-header-cell:nth-child(3) {
            border-right: 1px solid #bfdbfe;
        }

        /* Corner cells border radius */
        .income-tax-comparison-header-row-top .income-tax-comparison-header-cell:first-child {
            border-top-left-radius: 10px;
        }

        .income-tax-comparison-header-row-top .income-tax-comparison-header-cell:last-child {
            border-top-right-radius: 10px;
        }

        .income-tax-comparison-row-grand-total .income-tax-comparison-cell:first-child {
            border-bottom-left-radius: 10px;
        }

        .income-tax-comparison-row-grand-total .income-tax-comparison-cell:last-child {
            border-bottom-right-radius: 10px;
        }

        .income-tax-comparison-row {
            display: grid;
            /* Columns: Category | Main Income | Main Rate | Main Tax | Comp Income | Comp Rate | Comp Tax | Difference */
            grid-template-columns:
                minmax(180px, 1.6fr)   /* Category */
                minmax(90px, 1.1fr)    /* Main Income */
                minmax(40px, 0.5fr)    /* Main Rate */
                minmax(110px, 1.1fr)   /* Main Tax */
                minmax(90px, 1.1fr)    /* Comparison Income */
                minmax(40px, 0.5fr)    /* Comparison Rate */
                minmax(110px, 1.1fr)   /* Comparison Tax */
                minmax(90px, 1fr);     /* Difference */
            font-size: 12px;
            border-bottom: 1px solid #f3f4f6;
        }

        /* Single-year mode: 4 columns (Category, Income, Rate, Tax) */
        .income-tax-comparison-table-wrapper.income-tax-single-year .income-tax-comparison-row {
            grid-template-columns: minmax(180px, 1.6fr) minmax(90px, 1.1fr) minmax(40px, 0.5fr) minmax(110px, 1.1fr);
        }

        .income-tax-comparison-cell {
            padding: 8px 12px;
            border-right: 1px solid #f3f4f6;
            text-align: right;
            white-space: normal;
            word-break: break-word;
        }

        .income-tax-comparison-cell:last-child {
            border-right: none;
        }

        .income-tax-comparison-cell-category {
            font-weight: 600;
            text-align: left;
            color: #111827;
            padding: 8px 6px !important;
        }
        
        .income-tax-comparison-cell-category-value {
            text-align: right;
        }
        
        .income-tax-comparison-cell-not-applicable {
            padding: 2px 2px !important;
        }

        .income-tax-comparison-row-category {
            cursor: pointer;
            -webkit-user-select: none;
            user-select: none;
        }

        .income-tax-comparison-cell-band {
            text-align: left;
            padding-left: 32px;
            color: #4b5563;
        }

        .income-tax-comparison-cell-rate {
            text-align: center;
            font-size: 11px;
            padding: 8px 0px;
            color: #555555;
            min-width: 40px;
        }
        
        .income-tax-comparison-header-cell-rate {
            text-align: center;
            font-size: 11px;
            padding: 10px 0px;
            color: #1e40af;
            min-width: 40px;
        }

        .income-tax-comparison-toggle-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 8px;
            margin-right: 6px;
            font-size: 10px;
            color: #4b5563;
        }

        /* Band row backgrounds are now set via inline styles per category */

        .income-tax-comparison-row-spacer {
            height: 8px;
            border-bottom: none;
            background: transparent;
        }

        /* Empty row before grand total - ensure no border */
        .income-tax-comparison-row[style*="background-color: transparent"] {
            border-bottom: none !important;
        }

        .income-tax-comparison-row-spacer .income-tax-comparison-cell {
            padding: 0;
            border: none;
        }

        .income-tax-comparison-row-grand-total {
            background: #ede9fe;
            font-weight: 700;
            border-top: 2px solid var(--income-tax-primary);
            border-bottom: none; /* Remove bottom border for corner radius */
        }

        .income-tax-comparison-cell-grand-label {
            text-align: left;
            font-weight: 700;
            color: var(--income-tax-primary);
        }

        /* Base Difference colours: default to neutral (black). */
        .income-tax-comparison-diff-positive {
            color: #111827;
            font-weight: 600;
        }
        
        .income-tax-comparison-diff-negative {
            color: #111827;
            font-weight: 600;
        }
        
        .income-tax-comparison-diff-neutral {
            color: #111827;
            font-weight: 600;
        }


        .income-tax-comparison-category-total {
            font-weight: 600;
            color: #111827;
        }

        /* Mobile comparison cards */
        .income-tax-comparison-mobile-wrapper {
            display: flex;
            flex-direction: column;
            gap: 16px;
            width: 100%;
        }

        .income-tax-comparison-mobile-card {
            background: #ffffff;
            border-radius: 10px;
            border: 1px solid var(--income-tax-border);
            box-shadow: 0 2px 8px rgba(15, 23, 42, 0.06);
            overflow: hidden;
        }

        .income-tax-comparison-mobile-card-header {
            display: flex;
            align-items: center;
            padding: 16px;
            background: #f9fafb;
            cursor: pointer;
            -webkit-user-select: none;
            user-select: none;
            gap: 10px;
        }

        .income-tax-comparison-mobile-toggle-icon {
            font-size: 14px;
            color: #6b7280;
            transition: transform 0.2s;
        }

        .income-tax-comparison-mobile-card-title {
            font-weight: 600;
            font-size: 15px;
            color: #111827;
            flex: 1;
        }

        .income-tax-comparison-mobile-card-summary {
            padding: 16px;
        }

        .income-tax-comparison-mobile-summary-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }

        .income-tax-comparison-mobile-summary-row:last-child {
            margin-bottom: 0;
        }

        .income-tax-comparison-mobile-year {
            font-size: 12px;
            font-weight: 600;
            color: var(--income-tax-primary);
            text-align: center;
            margin-bottom: 8px;
        }

        .income-tax-comparison-mobile-value-group {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .income-tax-comparison-mobile-label {
            font-size: 11px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .income-tax-comparison-mobile-value {
            font-size: 14px;
            font-weight: 600;
            color: #111827;
        }

        .income-tax-comparison-mobile-tax {
            color: var(--income-tax-red);
        }

        .income-tax-comparison-mobile-difference {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e5e7eb;
        }

        .income-tax-comparison-mobile-diff-label {
            font-size: 13px;
            font-weight: 600;
            color: #374151;
        }

        .income-tax-comparison-mobile-diff-value {
            font-size: 14px;
            font-weight: 700;
        }

        .income-tax-comparison-mobile-diff-positive {
            color: #16a34a;
        }

        .income-tax-comparison-mobile-diff-negative {
            color: var(--income-tax-red);
        }

        .income-tax-comparison-mobile-diff-neutral {
            color: #6b7280;
        }

        .income-tax-comparison-mobile-card-details {
            padding: 0 16px 16px 16px;
            border-top: 1px solid #f3f4f6;
        }

        .income-tax-comparison-mobile-band-row {
            padding: 12px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .income-tax-comparison-mobile-band-row:last-child {
            border-bottom: none;
        }

        .income-tax-comparison-mobile-band-label {
            font-size: 13px;
            font-weight: 600;
            color: #4b5563;
            margin-bottom: 8px;
        }

        .income-tax-comparison-mobile-band-values {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .income-tax-comparison-mobile-band-year-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .income-tax-comparison-mobile-band-year {
            font-size: 11px;
            color: #6b7280;
            font-weight: 500;
        }

        .income-tax-comparison-mobile-band-value {
            font-size: 12px;
            color: #111827;
        }

        .income-tax-comparison-mobile-total-card {
            background: #ede9fe;
            border: 2px solid var(--income-tax-primary);
        }

        .income-tax-comparison-mobile-total-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--income-tax-primary);
            padding: 16px;
            text-align: center;
        }

        .income-tax-comparison-mobile-total-value {
            font-size: 18px;
        }

        .income-tax-comparison-mobile-total-diff {
            font-size: 16px;
        }

        @media (max-width: 768px) {
            .income-tax-comparison-table-wrapper {
                display: none;
            }
            
            /* Stack comparison charts vertically on mobile */
            .income-tax-comparison-charts-container {
                flex-direction: column !important;
                height: auto !important;
                gap: 30px !important;
                align-items: stretch !important;
            }
            
            .income-tax-comparison-chart-item {
                max-width: 100% !important;
                width: 100% !important;
                flex: 0 0 auto !important;
                height: 350px !important;
                min-height: 350px !important;
            }
            
            .income-tax-comparison-chart-item canvas {
                width: 100% !important;
                height: 100% !important;
            }
        }
        .income-tax-comparison-cell.income-tax-comparison-cell-category-value {
            font-weight: 600;
        }
        @media (min-width: 769px) {
            .income-tax-comparison-mobile-wrapper {
                display: none;
            }
        }

        .income-tax-comparison-row-subtotal {
            font-weight: 600;
            /* Background and border colors are now set via inline styles per category */
        }

        .income-tax-comparison-cell-subtotal-label {
            text-align: left;
            font-weight: 600;
            color: #374151;
            padding-left: 16px;
        }

        .income-tax-comparison-cell-subtotal {
            font-weight: 600;
            color: #111827;
        }

        /* Only subtotal and grand-total Difference cells are coloured green/red/neutral */
        .income-tax-comparison-cell-subtotal.income-tax-comparison-diff-positive {
            color: #16a34a;
        }

        .income-tax-comparison-cell-subtotal.income-tax-comparison-diff-negative {
            color: var(--income-tax-red);
        }

        .income-tax-comparison-cell-subtotal.income-tax-comparison-diff-neutral {
            color: #6b7280;
        }

        .income-tax-comparison-cell-grand-diff.income-tax-comparison-diff-positive {
            color: #16a34a;
            font-weight: 700;
        }

        .income-tax-comparison-cell-grand-diff.income-tax-comparison-diff-negative {
            color: var(--income-tax-red);
            font-weight: 700;
        }

        .income-tax-comparison-cell-grand-diff.income-tax-comparison-diff-neutral {
            color: #6b7280;
            font-weight: 700;
        }

        /* Breakdown table container - prevent horizontal scroll */
        #income-tax-breakdownTable {
            overflow-x: auto;
            width: 100%;
        }

        /* Mobile responsive styles for breakdown table */
        @media (max-width: 768px) {
            /* Minimize header on mobile */
            .income-tax-header {
                padding: 12px 16px;
                margin-bottom: 16px;
                gap: 12px;
            }
            .income-tax-container {
                padding:0px !important;
            }
            .income-tax-header-icon {
                width: 36px;
                height: 36px;
                font-size: 18px;
                border-radius: 8px;
            }

            .income-tax-header-title h1 {
                font-size: 18px;
                margin-bottom: 2px;
            }

            .income-tax-header-title p {
                font-size: 11px;
                line-height: 1.3;
            }

            .income-tax-header-right {
                gap: 8px;
            }

            .income-tax-mode-toggle {
                padding: 6px 10px;
                font-size: 11px;
                gap: 6px;
                border-radius: 8px;
            }

            .income-tax-toggle-switch {
                width: 40px;
                height: 20px;
                margin: 0 4px;
            }

            .income-tax-toggle-switch::after {
                width: 16px;
                height: 16px;
                top: 2px;
                left: 2px;
            }

            .income-tax-toggle-switch.active::after {
                left: 22px;
            }

            .income-tax-button.income-tax-button-small {
                padding: 6px 10px;
                font-size: 11px;
            }

            /* Minimize input elements on mobile */
            .income-tax-form-group {
                margin-bottom: 12px;
            }

            .income-tax-label {
                font-size: 12px;
                margin-bottom: 6px;
            }

            .income-tax-input {
                padding: 8px 10px;
                font-size: 14px;
                border-radius: 6px;
                box-sizing: border-box; /* Ensure box-sizing in responsive mode */
            }

            .income-tax-input-with-icon {
                box-sizing: border-box; /* Ensure box-sizing in responsive mode */
            }

            .income-tax-input-with-icon .income-tax-currency {
                left: 10px;
                font-size: 14px;
            }

            .income-tax-input-with-icon input {
                padding-left: 24px;
                box-sizing: border-box; /* Ensure box-sizing in responsive mode */
            }
            .income-tax-custom-dropdown-select {
            padding: 5px 6px 5px 20px;
            }
            .income-tax-tab-list{
                padding: 4px;
            }
            .income-tax-select {
                padding: 8px 10px;
                font-size: 14px;
                border-radius: 6px;
            }
            .income-tax-tab-trigger {
                padding: 4px 4px;
            }
            .income-tax-button-group {
                gap: 6px;
            }

            .income-tax-button-group .income-tax-button {
                padding: 8px;
                font-size: 12px;
            }

            .income-tax-separator {
                margin: 12px 0;
            }

            .income-tax-form-row {
                gap: 10px;
            }

            .income-tax-form-row-mobile {
                gap: 12px;
            }

            .income-tax-card {
                padding: 16px;
            }

            .income-tax-card-header {
                margin-bottom: 12px;
                padding-bottom: 12px;
            }

            /* Transaction date input overlay mobile styles */
            #income-tax-dateInputOverlay {
                top: 6px !important;
                left: 4px !important;
                right: 35px !important;
                padding: 2px 10px !important;
                font-size: 15px !important;
                height: 26px !important;
            }

            /* Transaction date helper text mobile */
            .income-tax-form-group > div[style*="font-size: 12px"] {
                font-size: 11px !important;
                margin-top: 3px !important;
            }

            .income-tax-bracket-row {
                grid-template-columns: 60px 1fr 100px 100px;
                gap: 8px;
                padding: 10px;
                font-size: 12px;
            }

            .income-tax-bracket-row-label {
                font-size: 11px;
            }

            .income-tax-bracket-row-header {
                font-size: 12px;
                padding: 12px 10px;
            }

            .income-tax-breakdown-card {
                overflow-x: hidden;
                padding: 12px;
            }

            #income-tax-breakdownTable {
                overflow-x: auto;
            }
            
            /* Breakdown comparison: stack columns vertically on mobile */
            #income-tax-breakdownTable > div[style*="grid-template-columns: 1fr 1fr"] {
                grid-template-columns: 1fr !important;
                gap: 24px !important;
            }

            /* Mobile form row - 2 columns on mobile */
            .income-tax-form-row-mobile {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 12px;
            }
        }

        @media (max-width: 640px) {
            /* Further minimize header on smaller mobile */
            .income-tax-header {
                padding: 10px 12px;
                margin-bottom: 12px;
                gap: 10px;
            }

            .income-tax-header-left {
                gap: 8px;
            }

            .income-tax-header-icon {
                width: 32px;
                height: 32px;
                font-size: 16px;
                border-radius: 6px;
            }

            .income-tax-header-title h1 {
                font-size: 16px;
                margin-bottom: 0;
            }

            .income-tax-header-title p {
                font-size: 10px;
                display: none; /* Hide subtitle on very small screens */
            }

            .income-tax-header-right {
                gap: 6px;
            }

            .income-tax-mode-toggle {
                padding: 5px 8px;
                font-size: 10px;
                gap: 4px;
            }

            .income-tax-mode-toggle span {
                font-size: 12px;
            }

            .income-tax-toggle-switch {
                width: 36px;
                height: 18px;
                margin: 0 3px;
            }

            .income-tax-toggle-switch::after {
                width: 14px;
                height: 14px;
            }

            .income-tax-toggle-switch.active::after {
                left: 20px;
            }

            .income-tax-button.income-tax-button-small {
                padding: 5px 8px;
                font-size: 10px;
            }

            /* Further minimize input elements on smaller mobile */
            .income-tax-form-group {
                margin-bottom: 10px;
            }

            .income-tax-label {
                font-size: 11px;
                margin-bottom: 5px;
            }

            .income-tax-input {
                padding: 6px 8px;
                font-size: 13px;
                border-radius: 6px;
            }

            .income-tax-input-with-icon .income-tax-currency {
                left: 8px;
                font-size: 13px;
            }

            .income-tax-input-with-icon input {
                padding-left: 22px;
            }

            .income-tax-select {
                padding: 6px 8px;
                font-size: 13px;
                border-radius: 6px;
            }

            .income-tax-button-group {
                gap: 5px;
            }

            .income-tax-button-group .income-tax-button {
                padding: 6px;
                font-size: 11px;
            }

            .income-tax-separator {
                margin: 10px 0;
            }

            .income-tax-form-row {
                gap: 8px;
            }

            .income-tax-form-row-mobile {
                gap: 10px;
            }

            .income-tax-card {
                padding: 12px;
            }

            .income-tax-card-header {
                margin-bottom: 10px;
                padding-bottom: 10px;
            }

            /* Transaction date input overlay smaller mobile styles */
            #income-tax-dateInputOverlay {
                top: 5px !important;
                left: 3px !important;
                right: 30px !important;
                padding: 2px 10px !important;
                font-size: 14px !important;
                height: 24px !important;
            }
            #income-tax-dateInputFormatted {
                line-height: normal !important;
                }
            /* Transaction date helper text smaller mobile */
            .income-tax-form-group > div[style*="font-size: 12px"] {
                font-size: 10px !important;
                margin-top: 2px !important;
            }

            .income-tax-bracket-row {
                grid-template-columns: 50px 1fr 90px 90px;
                gap: 6px;
                padding: 8px;
                font-size: 11px;
            }

            .income-tax-bracket-row-label {
                font-size: 10px;
            }

            .income-tax-bracket-row-header {
                font-size: 11px;
                padding: 10px 8px;
            }

            .income-tax-breakdown-title {
                font-size: 14px;
            }
        }

        /* Very small screens - use horizontal scroll within table container */
        @media (max-width: 480px) {
            /* Ultra-compact header for very small screens */
            .income-tax-header {
                padding: 8px 10px;
                margin-bottom: 10px;
                gap: 8px;
            }

            .income-tax-header-left {
                gap: 6px;
            }

            .income-tax-header-icon {
                width: 28px;
                height: 28px;
                font-size: 14px;
                border-radius: 6px;
            }

            .income-tax-header-title h1 {
                font-size: 20px;
            }

            .income-tax-header-right {
                gap: 4px;
                flex-wrap: nowrap;
            }

            .income-tax-mode-toggle {
                padding: 4px 6px;
                font-size: 12px;
                gap: 3px;
            }

            .income-tax-mode-toggle span {
                font-size: 14px;
            }

            .income-tax-toggle-switch {
                width: 32px;
                height: 16px;
                margin: 0 2px;
            }

            .income-tax-toggle-switch::after {
                width: 12px;
                height: 12px;
            }

            .income-tax-toggle-switch.active::after {
                left: 18px;
            }

            .income-tax-button.income-tax-button-small {
                padding: 4px 6px;
                font-size: 14px;
                min-width: auto;
            }

            /* Ultra-compact input elements for very small screens */
            .income-tax-form-group {
                margin-bottom: 8px;
            }

            .income-tax-label {
                font-size: 13px;
                margin-bottom: 4px;
            }

            .income-tax-input {
                padding: 6px 6px;
                font-size: 12px;
                border-radius: 5px;
            }

            .income-tax-input-with-icon .income-tax-currency {
                left: 6px;
                font-size: 12px;
            }

            .income-tax-input-with-icon input {
                padding-left: 20px;
            }

            .income-tax-select {
                padding: 5px 6px;
                font-size: 12px;
                border-radius: 5px;
            }

            .income-tax-button-group {
                gap: 4px;
            }

            .income-tax-button-group .income-tax-button {
                padding: 5px;
                font-size: 13px;
            }

            .income-tax-separator {
                margin: 8px 0;
            }

            .income-tax-form-row {
                gap: 6px;
            }

            .income-tax-form-row-mobile {
                gap: 8px;
            }

            .income-tax-card {
                padding: 10px;
            }

            .income-tax-card-header {
                margin-bottom: 8px;
                padding-bottom: 8px;
            }

            /* Transaction date input overlay ultra-compact mobile styles */
            #income-tax-dateInputOverlay {
                top: 6px !important;
                left: 2px !important;
                right: 28px !important;
                padding: 6px 5px !important;
                font-size: 13px !important;
                height: 22px !important;
            }

            /* Transaction date helper text ultra-compact mobile */
            .income-tax-form-group > div[style*="font-size: 12px"] {
                font-size: 11px !important;
                margin-top: 2px !important;
            }

            .income-tax-bracket-row {
                grid-template-columns: 45px minmax(100px, 1fr) 85px 85px;
                gap: 4px;
                padding: 8px 6px;
                font-size: 10px;
                min-width: 350px; /* Minimum width for readability */
            }

            #income-tax-breakdownTable {
                overflow-x: auto;
                display: block;
                width: 100%;
                margin: 0 -12px; /* Extend scroll area to card edges */
                padding: 0 12px;
            }

            .income-tax-breakdown-card {
                overflow: hidden;
                padding: 12px 5; /* Adjust padding to accommodate scroll */
            }

            .income-tax-breakdown-title {
                padding: 0 12px; /* Keep title aligned */
            }
        }

        /* Empty State */
        .income-tax-empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
        }

        .income-tax-empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .income-tax-empty-state-text {
            font-size: 14px;
            color: #6b7280;
        }

        /* Modal */
        .income-tax-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s;
            padding: 10px;
        }

        @media (max-width: 480px) {
            .income-tax-modal {
                padding: 0;
                align-items: flex-start;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .income-tax-modal.active {
            display: flex;
        }

        .income-tax-modal-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .income-tax-modal-header {
            margin-bottom: 24px;
        }

        .income-tax-modal-title {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .income-tax-modal-subtitle {
            font-size: 14px;
            color: #6b7280;
        }

        .income-tax-modal-body {
            margin-bottom: 24px;
        }

        /* Scrollbar styling for share preview */
        #income-tax-sharePreview {
            height: 400px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        #income-tax-sharePreview::-webkit-scrollbar {
            width: 8px;
        }

        #income-tax-sharePreview::-webkit-scrollbar-track {
            background: #f3f4f6;
            border-radius: 4px;
        }

        #income-tax-sharePreview::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        #income-tax-sharePreview::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Share modal specific styles */
        #income-tax-shareModal .income-tax-modal-content {
            max-height: 85vh;
        }

        /* Responsive styles for share modal */
        @media (max-width: 640px) {
            #income-tax-shareModal .income-tax-modal-content {
                width: 95%;
                max-width: 95%;
                padding: 20px 16px;
                margin: 10px;
                max-height: 90vh;
            }

            #income-tax-shareModal .income-tax-close-button {
                top: 12px;
                right: 12px;
                width: 32px;
                height: 32px;
                font-size: 20px;
            }

            #income-tax-shareModal .income-tax-modal-header {
                margin-bottom: 16px;
            }

            #income-tax-shareModal .income-tax-modal-title {
                font-size: 18px;
            }

            #income-tax-shareModal .income-tax-modal-subtitle {
                font-size: 12px;
            }

            #income-tax-shareModal .income-tax-modal-body {
                margin-bottom: 16px;
            }

            #income-tax-sharePreview {
                height: 350px !important;
                margin-bottom: 16px !important;
            }

            #income-tax-downloadBtn {
                padding: 12px 16px !important;
                font-size: 14px !important;
            }

            #income-tax-downloadBtn svg {
                width: 18px !important;
                height: 18px !important;
            }

            .income-tax-share-actions {
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 8px !important;
            }

            .income-tax-social-share-btn {
                padding: 10px 8px !important;
                min-height: 70px !important;
                font-size: 11px !important;
            }

            .income-tax-social-share-btn svg {
                width: 20px !important;
                height: 20px !important;
            }

            #income-tax-copyBtn {
                padding: 12px 16px !important;
                font-size: 14px !important;
            }

            #income-tax-csvBtn {
                padding: 10px 14px !important;
                font-size: 12px !important;
            }
        }

        @media (max-width: 480px) {
            #income-tax-shareModal .income-tax-modal-content {
                width: 100%;
                max-width: 100%;
                padding: 16px 12px;
                margin: 0;
                border-radius: 0;
                max-height: 95vh;
            }

            #income-tax-shareModal .income-tax-close-button {
                top: 10px;
                right: 10px;
                width: 36px;
                height: 36px;
                font-size: 22px;
            }

            #income-tax-shareModal .income-tax-modal-title {
                font-size: 16px;
            }

            #income-tax-shareModal .income-tax-modal-subtitle {
                font-size: 11px;
            }

            #income-tax-sharePreview {
                height: 300px !important;
                border-radius: 6px !important;
            }

            .income-tax-share-actions {
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 6px !important;
            }

            .income-tax-social-share-btn {
                padding: 8px 6px !important;
                min-height: 65px !important;
                font-size: 10px !important;
                border-radius: 6px !important;
            }

            .income-tax-social-share-btn svg {
                width: 18px !important;
                height: 18px !important;
            }

            .income-tax-social-share-btn span {
                font-size: 9px !important;
            }
        }

        .income-tax-consultation-option {
            padding: 20px;
            border: 2px solid var(--income-tax-border);
            border-radius: 10px;
            margin-bottom: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .income-tax-consultation-option:hover {
            border-color: var(--income-tax-primary);
            background: var(--income-tax-primary-light);
            transform: translateY(-2px);
        }

        .income-tax-consultation-option.income-tax-selected {
            border-color: var(--income-tax-primary);
            background: var(--income-tax-primary-light);
        }

        .income-tax-consultation-option-title {
            font-weight: 700;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .income-tax-consultation-option-desc {
            font-size: 13px;
            color: #6b7280;
            line-height: 1.5;
        }

        .income-tax-consultation-option-price {
            font-size: 15px;
            font-weight: 700;
            color: var(--income-tax-primary);
            margin-top: 12px;
        }

        .income-tax-modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .income-tax-close-button {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #6b7280;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .income-tax-close-button:hover {
            background: var(--income-tax-card);
            color: var(--income-tax-foreground);
        }

        /* Badge */
        .income-tax-badge {
            display: inline-block;
            padding: 6px 12px;
            background: var(--income-tax-primary-light);
            color: var(--income-tax-primary);
            border-radius: 6px;
            font-size: 12px;
            font-weight: 700;
            border: 1px solid var(--income-tax-border);
        }

        .income-tax-badge.success {
            background: #dcfce7;
            color: var(--income-tax-green);
            border-color: #86efac;
        }

        /* Utilities */
        .income-tax-hidden {
            display: none !important;
        }

        /* Completely redesigned simple mode */
        .income-tax-simple-mode-content {
            background: transparent;
            padding: 0;
        }

        .income-tax-simple-results-title {
            display: none;
        }

        .income-tax-simple-results-grid {
            display: flex;
            flex-direction: column;
            gap: 24px;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Hero Card - Main SDLT Result */
        /* Simple Results Container */
        .income-tax-simple-results-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .income-tax-simple-card {
            display: grid;
            grid-template-columns: 1fr;
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            overflow: hidden;
            background-color: white;
        }

        @media (min-width: 768px) {
            .income-tax-simple-card {
                grid-template-columns: 2fr 1fr;
            }
        }

        .income-tax-simple-main-content {
            padding: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            order: 2;
            background: #f6f6ff;
            position: relative;
        }

        @media (min-width: 768px) {
            .income-tax-simple-main-content {
                order: 1;
            }
            
        }

        .income-tax-simple-label {
            font-size: 18px;
            color: #6b7280;
            margin-bottom: 12px;
            letter-spacing: 0.5px;
        }

        .income-tax-simple-amount {
            font-size: 72px;
            font-weight: bold;
            margin-bottom: 16px;
            background: linear-gradient(to right, #1e293b, #64748b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1;
        }

        .income-tax-simple-description {
            color: #6b7280;
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .income-tax-simple-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #1e293b;
            background: none;
            border: none;
            cursor: pointer;
            transition: gap 0.2s;
            padding: 0;
            font-family: inherit;
        }

        .income-tax-simple-button:hover {
            gap: 12px;
        }

        .income-tax-simple-arrow {
            width: 16px;
            height: 16px;
        }

        .income-tax-simple-sidebar {
            background: var(--income-tax-primary);
            color: white;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 24px;
            order: 1;
        }

        @media (min-width: 768px) {
            .income-tax-simple-sidebar {
                order: 2;
            }
        }

        .income-tax-simple-sidebar-header {
            font-size: 12px;
            opacity: 0.7;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        .income-tax-simple-sidebar-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .income-tax-simple-input-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .income-tax-simple-input-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.1);
        }
        .get-expert-advice-button{
            margin:20px;
        }
        .income-tax-simple-icon {
            width: 35px;
            height: 35px;
            flex-shrink: 4;
        }

        .income-tax-simple-input-content {
            flex: 1;
        }

        .income-tax-simple-input-label {
            font-size: 12px;
            opacity: 0.7;
            margin-bottom: 2px;
        }

        .income-tax-simple-input-value {
            font-weight: bold;
            font-size: 14px;
        }

        .income-tax-simple-footer {
            padding-top: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .income-tax-simple-footer-text {
            font-size: 12px;
            opacity: 0.7;
        }

        /* Responsive design for simple mode */
        @media (max-width: 640px) {
            .income-tax-separator {
                margin: 5px 0;
            }
            .income-tax-simple-main-content {
                padding: 32px 24px;
            }

            .income-tax-simple-amount {
                font-size: 48px;
            }

            .income-tax-simple-sidebar {
                padding: 24px;
            }
            .income-tax-simple-card{
                display: flex;
                flex-direction: column-reverse;
            }
            .income-tax-tabs{
                margin-bottom: 10px;
            }
            .income-tax-main-grid{
                gap:10px;
            }
        }

        /* Loading Spinner */
        .income-tax-loader-container {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
        }

        .income-tax-loader-container.active {
            display: flex;
        }
        
        /* Inline loader for simple mode (no overlay) */
        .income-tax-simple-inline-loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -40%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            margin: 0;
            pointer-events: none; /* don't block clicks on the card */
            width: 100%;
            height: 133%;
            background: white;
        }
        
        /* Card-specific loader */
        .income-tax-card-loader {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
        }
        
        .income-tax-card-loader.active {
            display: flex;
        }
        
        /* Tax card loader - red overlay on red background */
        .income-tax-tax-card .income-tax-card-loader {
            background: var(--income-tax-primary);
        }
        
        /* AI card loader - white overlay on white background with border for visibility */
        .income-tax-ai-card .income-tax-card-loader {
            background: rgba(255, 255, 255, 0.98);
            border: 1px solid rgba(191, 219, 254, 0.5);
        }
        .income-tax-chart-type-selector{
            display: flex;
            gap: 8px;
            align-items: center;
            width: 230px;
        }
        .income-tax-chart-type-selector-label{
            font-size: 12px;
            color: #6b7280;
            width: 110px;
        }
        
        /* Chart container and wrapper styles */
        #income-tax-chartContainer {
            overflow: hidden;
            box-sizing: border-box;
        }
        
        .income-tax-chart-wrapper {
            position: relative;
            height: 400px;
            min-height: 400px;
            width: 100%;
            max-width: 100%;
            overflow: hidden;
            box-sizing: border-box;
        }
        
        .income-tax-chart-wrapper canvas {
            max-width: 100% !important;
            height: auto !important;
        }
        /* Dashboard Header Bar */
        .income-tax-dashboard-header-bar {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }
        
        .income-tax-dashboard-header-title {
            font-size: 24px;
            font-weight: 700;
            color: #111827;
            margin: 0;
        }
        
        .income-tax-ai-badge {
            background: linear-gradient(to right, #ec4899, #a855f7);
            color: white;
            padding: 8px 16px;
            border-radius: 9999px;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            position: absolute;
            z-index: 10;
        }
        
        .income-tax-ai-badge svg {
            width: 16px;
            height: 16px;
        }
        
        /* New Dashboard Layout Styles */
        .income-tax-dashboard-wrapper {
            position: relative;
        }
        
        .income-tax-dashboard-grid {
            display: flex;
            flex-wrap: wrap;
            min-height: 275px;
            gap: 24px;
            justify-content: space-between;
        }
        
        /* Default layout: Tax card 65%, Insights card 35% when comparison is NOT enabled */
        .income-tax-dashboard-grid:not(.income-tax-comparison-active) .income-tax-tax-card {
            flex: 0 0 calc(58% - 12px);
            max-width: calc(58% - 12px);
            min-width: 0;
        }
        
        .income-tax-dashboard-grid:not(.income-tax-comparison-active) .income-tax-ai-card {
            flex: 0 0 calc(30% - 12px);
            max-width: calc(30% - 12px);
            min-width: 0;
        }
        
        /* When comparison is enabled: Tax card 40%, Insights card 60% */
        .income-tax-dashboard-grid.income-tax-comparison-active .income-tax-tax-card {
            flex: 0 0 calc(33% - 12px);
            max-width: calc(33% - 12px);
            min-width: 0;
        }
        
        .income-tax-dashboard-grid.income-tax-comparison-active .income-tax-ai-card {
            flex: 0 0 calc(55% - 12px);
            max-width: calc(55% - 12px);
            min-width: 0;
        }
        
        /* Responsive: On smaller screens, stack vertically */
        @media (max-width: 768px) {
            .income-tax-dashboard-grid:not(.income-tax-comparison-active) .income-tax-tax-card,
            .income-tax-dashboard-grid:not(.income-tax-comparison-active) .income-tax-ai-card {
                flex: 0 0 100%;
                max-width: 100%;
            }
            .income-tax-dashboard-grid.income-tax-comparison-active .income-tax-tax-card {
            flex: 0 0 calc(33% - 12px);
            max-width: 100%;
            min-width: 0;
        }
        .income-tax-ai-card{
            max-width: 100% !important;
        }
        }
        
        
        .income-tax-dashboard-col-span-2 {
            grid-column: span 1;
        }
        
        @media (min-width: 1024px) {
            .income-tax-dashboard-col-span-2 {
                grid-column: span 2;
            }
        }
        
        .income-tax-dashboard-col-span-3 {
            grid-column: span 1;
        }
        
        @media (min-width: 1024px) {
            .income-tax-dashboard-col-span-3 {
                grid-column: span 3;
            }
        }
        
        .income-tax-tax-card {
            background: var(--income-tax-primary);
            border-radius: 12px;
            padding: 25px;
            color: white;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            position: relative;
            min-width:30%;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: stretch;
            max-width: 200px;
        }
        
        /* Tax Card Content Container */
        .income-tax-tax-card-content {
            display: flex;
            flex-direction: column;
            gap: 0;
        }
        
        /* Tax Card Columns (for comparison mode) */
        .income-tax-tax-card-column {
            flex: 1;
        }
        
        /* When comparison is enabled, show everything in single column */
        .income-tax-tax-card-content.income-tax-comparison-mode {
            flex-direction: column;
            gap: 16px;
        }
        
        .income-tax-tax-card-content.income-tax-comparison-mode .income-tax-tax-card-column {
            position: relative;
            width: 100%;
            flex: none;
        }
        
        /* Divider between tax liability sections in comparison mode - horizontal */
        .income-tax-tax-card-content.income-tax-comparison-mode .income-tax-tax-card-main::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            right: 0;
            height: 1px;
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* Comparison box styling in single column */
        #income-tax-taxCardComparisonBox {
            width: auto;
            box-sizing: border-box;
            margin-top: 16px;
            order: 2; /* Ensure it appears after tax card content */
        }
        
        /* Tax card content should come before comparison box */
        .income-tax-tax-card-content {
            order: 1;
        }
        
        /* Attribution should come last */
        .income-tax-attribution {
            order: 3;
        }
        
        /* Comparison box inside tax card - adjust styling for dark background */
        #income-tax-taxCardComparisonBox .income-tax-comparison-box {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        
        /* Mobile device styles */
        @media (max-width: 768px) {
            .income-tax-tax-card {
                width: auto;
            }
            .income-tax-dashboard-grid {
                flex-direction: column !important;
            }
            .income-tax-tax-card-content.income-tax-comparison-mode{
                flex-direction: column !important;
            }
            .income-tax-tax-card-content.income-tax-comparison-mode .income-tax-tax-card-main::after{
                display: block !important;
            }
            .income-tax-tax-card-column.income-tax-tax-card-comparison{
                border-top:1px solid rgba(255, 255, 255, 0.2);
                padding-top:20px;
                margin-top: 8px;
            }
            .income-tax-ai-card {
                width: 100% !important;
            }
            .income-tax-container {
                width: 100% !important;
            }
        }
        
        /* Attribution watermark - hidden by default, only shown in exported images */
        .income-tax-attribution {
            position: absolute;
            bottom: 12px;
            right: 16px;
            font-size: 10px;
            opacity: 0.6;
            color: inherit;
            font-weight: 400;
            letter-spacing: 0.3px;
            pointer-events: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            display: none; /* Hidden in regular UI */
        }
        
        .income-tax-simple-attribution {
            position: absolute;
            bottom: 12px;
            right: 16px;
            font-size: 10px;
            opacity: 0.5;
            color: #6b7280;
            font-weight: 400;
            letter-spacing: 0.3px;
            pointer-events: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            display: none; /* Hidden in regular UI */
        }
        
        .income-tax-tax-card-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        
        .income-tax-tax-label {
            font-size: 14px;
            font-weight: 500;
            opacity: 0.9;
            margin-bottom: 8px;
        }
        
        .income-tax-tax-amount {
            font-size: 56px;
            color: white;
            font-weight: 700;
            margin-bottom: 8px;
            line-height: 1;
        }
        
        .income-tax-tax-date {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .income-tax-icon-box {
            background: rgba(255, 255, 255, 0.2);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 12px;
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .income-tax-tax-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-top: 0px;
            padding-top: 24px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .income-tax-tax-detail-item {
            font-size: 12px;
            opacity: 0.75;
            margin-bottom: 4px;
        }
        
        .income-tax-tax-detail-value {
            font-size: 24px;
            font-weight: 700;
        }
        
        .income-tax-ai-card {
            background:#f6f6ff;
            border-radius: 12px;
            padding: 10px 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 2px solid #bfdbfe;
            width: 55%;
            
        }
        
        .income-tax-ai-card-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
            justify-content: center;
        }
        
        .income-tax-ai-badge-small {
            font-size: 12px;
            background: #dbeafe;
            color: #1d4ed8;
            padding: 4px 8px;
            border-radius: 9999px;
            font-weight: 500;
        }
        
        .income-tax-ai-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }
        
        /* Comparison Insights Section */
        .income-tax-comparison-insights-content {
            padding: 12px 0;
            width: 100%;
        }
        
        .income-tax-comparison-insights-wrapper {
            display: flex;
            flex-direction: column;
            gap: 16px;
            width: 100%;
        }
        
        .income-tax-comparison-header-section {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            padding: 20px;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            transition: all 0.3s ease;
        }
        
        .income-tax-comparison-header-section.income-tax-comparison-warning {
            background: linear-gradient(135deg, #fff5f5 0%, #fee2e2 100%);
            border: 1px solid #fecaca;
            border-left: 4px solid #ef4444;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.1);
        }
        
        .income-tax-comparison-header-section.income-tax-comparison-positive {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 1px solid #bbf7d0;
            border-left: 4px solid #16a34a;
            box-shadow: 0 4px 12px rgba(22, 163, 74, 0.1);
        }
        
        .income-tax-comparison-header-section.income-tax-comparison-neutral {
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            border: 1px solid #e5e7eb;
            border-left: 4px solid #6b7280;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }
        
        .income-tax-comparison-icon {
            font-size: 28px;
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border-radius: 14px;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.8);
        }
        
        .income-tax-comparison-icon-up {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
        }
        
        .income-tax-comparison-icon-down {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        }
        
        .income-tax-comparison-icon-positive {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            border-color: rgba(22, 163, 74, 0.2);
        }
        
        .income-tax-comparison-icon-warning {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border-color: rgba(239, 68, 68, 0.2);
        }
        
        .income-tax-comparison-icon-neutral {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            border-color: rgba(107, 114, 128, 0.2);
        }
        
        .income-tax-comparison-main-text {
            flex: 1;
            font-size: 16px;
            font-weight: 600;
            color: #0f172a;
            line-height: 1.6;
            letter-spacing: -0.01em;
        }
        
        .income-tax-comparison-year-highlight {
            color: #1e40af;
            font-weight: 700;
            font-size: 18px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: inline-block;
            margin: 0 2px;
        }
        
        .income-tax-comparison-year-compare {
            color: #64748b;
            font-weight: 500;
        }
        
        .income-tax-comparison-savings {
            color: #059669;
            font-weight: 700;
            font-size: 18px;
            margin: 0 6px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            display: inline-block;
            padding: 2px 8px;
            background: rgba(5, 150, 105, 0.1);
            border-radius: 4px;
        }
        
        .income-tax-comparison-increase {
            color: #dc2626;
            font-weight: 700;
            font-size: 18px;
            margin: 0 6px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            display: inline-block;
            padding: 2px 8px;
            background: rgba(220, 38, 38, 0.1);
            border-radius: 4px;
        }
        
        .income-tax-comparison-neutral-text {
            color: #64748b;
            font-weight: 600;
        }
        
        .income-tax-comparison-details {
            padding: 0;
            background: transparent;
            border-radius: 0;
            font-size: 14px;
            color: #374151;
            line-height: 1.7;
            border: none;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .income-tax-comparison-future-impact {
            padding: 16px 18px;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 10px;
            border-left: 4px solid #3b82f6;
            font-size: 14px;
            line-height: 1.7;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
            border-top: 1px solid #e2e8f0;
            border-right: 1px solid #e2e8f0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .income-tax-comparison-future-impact strong {
            color: #0f172a;
            font-weight: 700;
            font-size: 15px;
            display: block;
            margin-bottom: 8px;
            letter-spacing: -0.01em;
        }
        
        .income-tax-comparison-explanation {
            padding: 14px 18px;
            background: #f8fafc;
            border-radius: 8px;
            font-size: 13px;
            color: #64748b;
            line-height: 1.7;
            font-style: normal;
            border: 1px solid #e2e8f0;
            position: relative;
        }
        
        .income-tax-comparison-explanation::before {
            content: '‚ÑπÔ∏è';
            position: absolute;
            left: 18px;
            top: 14px;
            font-size: 16px;
            opacity: 0.6;
        }
        
        .income-tax-comparison-explanation {
            padding-left: 42px;
        }
        
        .income-tax-comparison-reason-badge {
            display: inline-block;
            padding: 4px 10px;
            background: #dbeafe;
            color: #1e40af;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin: 2px 4px 2px 0;
        }
        
        .income-tax-comparison-header {
            font-size: 14px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 16px;
            text-align: center;
        }
        
        /* New Professional Alert Card Design */
        .income-tax-comparison-alert-card {
            background: #fef7f0;
            border-radius: 12px;
            padding: 20px 24px;
            border: 1px solid #fed7aa;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            position: relative;
        }
        
        .income-tax-comparison-alert-card.income-tax-comparison-alert-warning {
            background: #fef2f2;
            border-color: #fecaca;
        }
        
        .income-tax-comparison-alert-card.income-tax-comparison-alert-positive {
            background: #f0fdf4;
            border-color: #bbf7d0;
        }
        
        .income-tax-comparison-alert-card.income-tax-comparison-alert-neutral {
            background: #f9fafb;
            border-color: #e5e7eb;
        }
        
        .income-tax-comparison-important-badge {
            display: inline-block;
            background: #dc2626;
            color: white;
            font-size: 11px;
            font-weight: 700;
            padding: 4px 12px;
            border-radius: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }
        
        .income-tax-comparison-main-headline {
            font-size: 22px;
            font-weight: 700;
            color: #0f172a;
            line-height: 1.3;
            margin-bottom: 8px;
            letter-spacing: -0.02em;
        }
        
        .income-tax-comparison-amount-highlight {
            color: #dc2626;
            font-weight: 800;
            font-size: 24px;
        }
        
        .income-tax-comparison-amount-highlight.positive {
            color: #059669;
        }
        
        .income-tax-comparison-subtitle {
            font-size: 14px;
            color: #64748b;
            line-height: 1.6;
            margin-top: 4px;
        }
        
        .income-tax-comparison-box {
            background: #ffffff;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            padding: 16px 20px;
            margin-top: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .income-tax-comparison-box-label {
            font-size: 10px;
            font-weight: 700;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        
        .income-tax-comparison-box-content {
            font-size: 14px;
            color: #0f172a;
            line-height: 1.7;
        }
        
        .income-tax-comparison-analysis {
            background: #f8fafc;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            padding: 16px 20px;
            margin-top: 4px;
        }
        
        .income-tax-comparison-analysis-title {
            font-size: 13px;
            font-weight: 700;
            color: #475569;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }
        
        .income-tax-comparison-analysis-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .income-tax-analysis-item {
            font-size: 13px;
            color: #475569;
            line-height: 1.7;
            padding-left: 12px;
            position: relative;
        }
        
        .income-tax-analysis-item::before {
            content: '‚Ä¢';
            position: absolute;
            left: 0;
            color: #3b82f6;
            font-weight: 700;
            font-size: 16px;
        }
        
        .income-tax-analysis-item strong {
            color: #0f172a;
            font-weight: 600;
        }
        
        /* Standardized Insights Section */
        .income-tax-score-section {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
            color: #4b5563;
            margin-bottom: 8px;
            text-align: center;
            line-height: 1.5;
        }
        
        .income-tax-score-value {
            font-size: 32px;
            font-weight: 700;
            color: #2563eb;
            margin: 8px 0;
            text-align: center;
            line-height: 1.2;
            display: block;
        }
        
        /* Normal Insights Container */
        #income-tax-normalInsightsSection {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 12px 0;
            min-height: 80px;
        }
        
        /* Comparison Insights Container */
        #income-tax-comparisonInsightsSection {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: center;
            padding: 0;
            min-height: 80px;
            width: 100%;
            margin-top: 20px;
        }
        
        #income-tax-comparisonInsightsText {
            font-size: 14px;
            line-height: 1.7;
            color: #374151;
            text-align: left;
            width: 100%;
            padding: 0;
        }
        
        #income-tax-comparisonInsightsText > div {
            padding: 0 !important;
        }
        
        /* Comparison insights content styling when below tax card */
        #income-tax-comparisonInsightsSection .income-tax-comparison-insights-content {
            width: 100%;
            padding: 0;
        }
        
        .income-tax-savings-section {
            padding-top: 16px;
            border-top: 1px solid #e5e7eb;
        }
        
        .income-tax-savings-label {
            font-size: 14px;
            color: #4b5563;
            margin-bottom: 4px;
        }
        
        .income-tax-savings-value {
            font-size: 25px;
            font-weight: 700;
            color: #16a34a;
        }
        
        .income-tax-savings-percent {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }
        
        .income-tax-explanation-card {
            background: white;
            border-radius: 12px;
            padding: 10px;
            box-shadow: -1px 0px 3px rgb(0 0 0 / 19%);
        }
        
        .income-tax-explanation-content {
            display: flex;
            gap: 16px;
            align-items: flex-start;
        }
        
        .income-tax-explanation-text {
            flex: 1;
        }
        
        .income-tax-explanation-title {
            font-size: 18px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 12px;
        }
        
        .income-tax-explanation-paragraph {
            font-size: 14px;
            color: #374151;
            line-height: 1.2;
            margin-bottom: 12px;
        }
        
        .income-tax-explanation-header {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        .income-tax-explanation-header:hover {
            opacity: 0.8;
        }
        
        .income-tax-explanation-collapsible {
            animation: slideDown 0.3s ease-out;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
            }
            to {
                opacity: 1;
                max-height: 2000px;
            }
        }
        
        #income-tax-howWeCalculatedToggleIcon {
            transition: transform 0.3s ease, color 0.3s ease;
            animation: bounceArrow 2s ease-in-out infinite;
            cursor: pointer;
        }
        
        #income-tax-howWeCalculatedToggleIcon.expanded {
            transform: rotate(180deg);
            animation: none; /* Stop animation when expanded */
        }
        
        @keyframes bounceArrow {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(6px);
            }
        }
        
        /* Add hover effect to indicate clickability */
        .income-tax-explanation-header:hover #income-tax-howWeCalculatedToggleIcon:not(.expanded) {
            color: #2563eb;
            animation-duration: 1s; /* Speed up on hover */
        }
        
        .income-tax-disclaimer {
            background: #fffbeb;
            border: 1px solid #fde68a;
            border-radius: 8px;
            margin-top: 20px;
            padding: 0px 10px;
        }
        
        .income-tax-disclaimer-text {
            font-size: 12px;
            color: #4b5563;
            font-style: italic;
            line-height: 1em;
        }
        
        .income-tax-disclaimer-label {
            font-weight: 600;
            color: #92400e;
            font-style: normal;
        }
        
        .income-tax-cta-banner {
            background: white;
            border-radius: 12px;
            padding: 10px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            background:var(--income-tax-primary);
        }
        
        .income-tax-cta-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            color: #111827;
        }
        
        @media (min-width: 768px) {
            .income-tax-cta-content {
                flex-direction: row;
            }
            .income-tax-ai-card .income-tax-card-loader {
                padding:20px;
            }
        }
        
        .income-tax-cta-text {
            text-align: center;
        }
        
        @media (min-width: 768px) {
            .income-tax-cta-text {
                text-align: left;
            }

        }
        
        .income-tax-cta-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .income-tax-cta-subtitle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
            opacity: 0.9;
        }
        
        @media (min-width: 768px) {
            .income-tax-cta-subtitle {
                justify-content: flex-start;
            }
            
        }
        
        .income-tax-cta-buttons {
            display: flex;
            gap: 12px;
        }
        
        .income-tax-button-outline {
            background: white;
            color: #16a34a;
            padding: 10px 20px;
            border-radius: 6px;
            border: 1px solid #16a34a;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            
        }
        
        .income-tax-button-outline:hover {
            background: #16a34a;
            color: #ffffff;
            border-color: #16a34a;
        }
        
        .income-tax-button-solid {
            background: #32b57d;
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            border: 1px solid #16a34a;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
        }
        
        .income-tax-button-solid:hover {
            background: #15803d;
        }
        
        .income-tax-star-icon {
            width: 20px;
            fill: white;
        }
        
        .income-tax-icon-lg {
            width: 36px; /* Increased slightly for complex icon */
            height: 36px;
        }
        
        /* Complex Icon Animations */
        .income-tax-anim-house {
            animation: houseSlideIn 1.2s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
            opacity: 0;
            transform-origin: bottom left;
        }
        
        
        .income-tax-coin-1 {
            animation: coinStack 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) 0.4s forwards;
            opacity: 0;
            transform-origin: bottom center;
            stroke-width: 1;
        }
        
        .income-tax-coin-2 {
            animation: coinStack 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) 0.6s forwards;
            opacity: 0;
            transform-origin: bottom center;
            stroke-width: 1;
        }
        
        .income-tax-coin-3 {
            animation: coinStack 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) 0.8s forwards;
            opacity: 0;
            transform-origin: bottom center;
            stroke-width: 1;
            transform: translateY(-2px);
        }
        
        /* Reduce stroke width for all coin elements */
        .income-tax-anim-coins path,
        .income-tax-anim-coins ellipse {
            stroke-width: 1 !important;
        }
        
        .income-tax-anim-symbol {
            animation: symbolFloat 3s ease-in-out infinite;
        }
        
        @keyframes houseSlideIn {
            from {
                opacity: 0;
                transform: translateX(-10px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }
        
        @keyframes coinStack {
            from {
                opacity: 0;
                transform: translateY(-10px) scale(0.8);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        @keyframes symbolFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }
        
        /* History list scrollable */
        #income-tax-historyList {
            max-height: 600px;
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        /* Custom scrollbar for history list */
        #income-tax-historyList::-webkit-scrollbar {
            width: 8px;
        }
        
        #income-tax-historyList::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        
        #income-tax-historyList::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        
        #income-tax-historyList::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        /* Dark mode support for loader overlay */
        @media (prefers-color-scheme: dark) {
            .income-tax-loader-container {
                background:var(--income-tax-primary);
            }
        }

        .income-tax-loader-wrapper {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .income-tax-loader {
            box-sizing: border-box;
            width: 100%;
            height: 100%;
            border: 10px solid #2e374d;
            border-top-color: #4bc8eb;
            border-bottom-color: #f13a8f;
            border-radius: 50%;
            animation: rotate0925 5s linear infinite;
        }

        .income-tax-loader-inner {
            border-top-color: #36f372;
            border-bottom-color: #fff;
            animation-duration: 2.5s;
        }

        @keyframes rotate0925 {
            0% {
                transform: scale(1) rotate(360deg);
            }
            50% {
                transform: scale(.8) rotate(-360deg);
            }
            100% {
                transform: scale(1) rotate(360deg);
            }
        }
        
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .income-tax-loader-text {
            margin-top: 12px;
            margin-left: 0;
            font-size: 14px;
            color: var(--income-tax-primary-light);
            font-weight: 600;
        }

        /* Inline loader for result boxes */
        .income-tax-result-loader {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(30, 64, 175, 0.2); /* #1e40af with 20% opacity */
            border-top: 2px solid #1e40af; /* Same blue as metric-value */
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            vertical-align: middle;
            margin-right: 6px;
        }

        /* Annotation Tooltips */
        .income-tax-annotation {
            position: absolute;
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border: 2px solid #93c5fd;
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 13px;
            color: #1e40af;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 100;
            max-width: 280px;
            animation: slideInRight 0.3s ease-out;
            pointer-events: auto;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .income-tax-annotation::before {
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            border-style: solid;
        }

        .income-tax-annotation.left::before {
            right: -8px;
            top: 50%;
            transform: translateY(-50%);
            border-width: 8px 0 8px 8px;
            border-color: transparent transparent transparent #93c5fd;
        }

        .income-tax-annotation.right::before {
            right: -8px;
            top: 50%;
            transform: translateY(-50%);
            border-width: 8px 0 8px 8px;
            border-color: transparent transparent transparent #93c5fd;
        }

        .income-tax-annotation.top::before {
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 0 8px 8px 8px;
            border-color: transparent transparent #93c5fd transparent;
        }

        .income-tax-annotation.bottom::before {
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 8px 8px 0 8px;
            border-color: #93c5fd transparent transparent transparent;
        }

        .income-tax-annotation-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .income-tax-annotation-title {
            font-weight: 700;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .income-tax-annotation-close {
            background: none;
            border: none;
            font-size: 18px;
            color: #1e40af;
            cursor: pointer;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .income-tax-annotation-close:hover {
            background: rgba(30, 64, 175, 0.1);
        }

        .income-tax-annotation-body {
            line-height: 1.5;
            font-size: 12px;
        }

        .income-tax-annotation-cta {
            margin-top: 8px;
            padding: 6px 12px;
            background: var(--income-tax-primary);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .income-tax-annotation-cta:hover {
            background: var(--income-tax-primary-dark);
            transform: translateY(-1px);
        }
        /* (income-tax-init-loader styles removed; simple mode now uses inline loader only) */
        /* Toggle switch styling for comparison mode */
        #income-tax-comparisonToggle:checked + span {
            background: linear-gradient(255deg, #43468a 0%, #2a2667 100%) !important;
            background-color: #43468a !important;
        }
        
        #income-tax-comparisonToggle:checked + span + span {
            transform: translateX(24px) !important;
        }
        
        /* Smooth transitions for toggle switch */
        #income-tax-comparisonToggle + span,
        #income-tax-comparisonToggle + span + span {
            transition: all 0.3s ease;
        }
        
        /* Toggle switch styling for breakdown comparison mode */
        #income-tax-breakdownComparisonToggle:checked + span {
            background: linear-gradient(255deg, #43468a 0%, #2a2667 100%) !important;
            background-color: #43468a !important;
        }
        
        #income-tax-breakdownComparisonToggle:checked + span + span {
            transform: translateX(24px) !important;
        }
        
        /* Smooth transitions for breakdown comparison toggle switch */
        #income-tax-breakdownComparisonToggle + span,
        #income-tax-breakdownComparisonToggle + span + span {
            transition: all 0.3s ease;
        }
    </style>
    <div class="income-tax-wrapper">
    <div class="income-tax-container" id="income-tax-calculatorContainer">
        <!-- Header -->
        <div class="income-tax-header">
            <div class="income-tax-header-left">
                <div class="income-tax-header-icon">üìä</div>
                <div class="income-tax-header-title">
                    <h1 id="income-tax-headerTitle">Income Tax Calculator</h1>
                    <p id="income-tax-headerSubtitle">AI-powered income tax calculations with real-time insights</p>
                </div>
            </div>
            <div class="income-tax-header-right">
                <!-- Updated toggle to properly control mode -->
                <div class="income-tax-mode-toggle">
                    <span id="income-tax-simpleModeLabel" style="font-weight: 400; color: #6b7280;">Simple</span>
                    <div class="income-tax-toggle-switch" id="income-tax-modeToggle" onclick="toggleMode()"></div>
                    <span id="income-tax-aiModeLabel" style="font-weight: 700;">AI Powered</span>
                </div>
                <button class="income-tax-button income-tax-button-small" id="income-tax-saveBtn" onclick="saveCalculation()">Save</button>
                <button class="income-tax-button income-tax-button-small" onclick="exportData()">Export</button>
                <button class="income-tax-button income-tax-button-small" onclick="shareCalculation()">Share</button>
                <button class="income-tax-button income-tax-button-small" id="income-tax-showEmailFormBtn" onclick="toggleEmailForm()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
                    üìß Get Results via Email
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="income-tax-main-grid">
            <!-- Left Panel -->
            <div class="income-tax-left-panel">
                <!-- Calculation Setup Card -->
                <div class="income-tax-card">
                    <div class="income-tax-card-header">
                        <div class="income-tax-card-title">Income Tax Inputs</div>
                    </div>
                    <div>
                        <!-- Tax Year -->
                        <div class="income-tax-form-group">
                            <label class="income-tax-label" for="income-tax-taxYear">
                                Tax Year
                                <span class="income-tax-tooltip-icon" data-tooltip="Select the tax year for which you want to calculate your income tax. Tax rates and allowances may vary by year.">?</span>
                            </label>
                            <div class="income-tax-custom-dropdown">
                                <select class="income-tax-custom-dropdown-select" id="income-tax-taxYear" name="taxYear" onchange="handleTaxYearChange(); recalculate();">
                                    <option value="2027">2027/2028</option>
                                    <option value="2026">2026/2027</option>
                                    <option value="2025" selected>2025/2026</option>
                                    <option value="2024">2024/2025</option>
                                    <option value="2023">2023/2024</option>
                                    <option value="2022">2022/2023</option>
                                    <option value="2021">2021/2022</option>
                                    <option value="2020">2020/2021</option>
                                    <option value="2019">2019/2020</option>
                                    <option value="2018">2018/2019</option>
                                    <option value="2017">2017/2018</option>
                                    <option value="2016">2016/2017</option>
                                </select>
                                <div class="income-tax-dropdown-options" id="income-tax-taxYear-options"></div>
                            </div>
                        </div>

                        <div class="income-tax-separator"></div>

                        <!-- Property Income - Separate for 2027, otherwise part of Non-Saving -->
                        <div id="income-tax-propertyIncomeSeparateGroup" style="display: none;">
                            <div class="income-tax-form-group">
                                <label class="income-tax-label" for="income-tax-propertyIncome2027">
                                    Property Income
                                    <span class="income-tax-tooltip-icon" data-tooltip="Enter your property income for the tax year.">?</span>
                                </label>
                                <div class="income-tax-input-with-icon">
                                    <span class="income-tax-currency">¬£</span>
                                    <input 
                                        type="text" 
                                        class="income-tax-input" 
                                        id="income-tax-propertyIncome2027" 
                                        name="propertyIncome"
                                        value="" 
                                        maxlength="15"
                                        oninput="formatCurrencyInput(this); recalculate();" 
                                        onblur="sanitizeCurrencyInput(this)"
                                        placeholder="60,000"
                                    >
                                </div>
                            </div>
                            <div class="income-tax-separator"></div>
                        </div>

                        <!-- Non-Saving Income Section -->
                        <div class="income-tax-form-group">
                            <h3 style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 12px;">Non-Saving Income</h3>

                            <!-- Property Income (Only shown when NOT 2027 - part of Non-Saving) -->
                            <div id="income-tax-propertyIncomeNonSavingGroup" style="display: block;">
                                <div id="income-tax-propertyIncomeLabel" style="display: none; margin-bottom: 8px;">
                                    <label class="income-tax-label" for="income-tax-propertyIncomeNonSaving" style="font-size: 14px;">
                                        Property Income
                                    </label>
                                </div>
                                <div class="income-tax-input-with-icon">
                                    <span class="income-tax-currency">¬£</span>
                                    <input 
                                        type="text" 
                                        class="income-tax-input" 
                                        id="income-tax-propertyIncomeNonSaving" 
                                        name="propertyIncome"
                                        value="120,000" 
                                        maxlength="15"
                                        oninput="formatCurrencyInput(this); recalculate();" 
                                        onblur="sanitizeCurrencyInput(this)"
                                        placeholder="60,000"
                                    >
                                </div>
                            </div>

                            <!-- Employment Income Field - Only for 2027, Always Visible but Label Only When Expanded -->
                            <div id="income-tax-employmentIncomeGroup2027" style="display: none; margin-top: 12px;">
                                <div id="income-tax-employmentIncomeLabel2027" style="display: none; margin-bottom: 8px;">
                                    <label class="income-tax-label" for="income-tax-employmentIncome" style="font-size: 14px;">
                                        Employment Income
                                    </label>
                                </div>
                                <div class="income-tax-input-with-icon">
                                    <span class="income-tax-currency">¬£</span>
                                    <input 
                                        type="text" 
                                        class="income-tax-input" 
                                        id="income-tax-employmentIncome" 
                                        name="employmentIncome"
                                        value="" 
                                        maxlength="15"
                                        oninput="formatCurrencyInput(this); recalculate();" 
                                        onblur="sanitizeCurrencyInput(this)"
                                        placeholder="5,000"
                                    >
                                </div>
                            </div>

                            <!-- Expandable Fields - Smooth Expand/Collapse -->
                            <div id="income-tax-nonSavingExpandableFields" style="max-height: 0; overflow: hidden; opacity: 0; transition: all 0.3s ease-in-out;">
                                <!-- Trading Income -->
                                <div class="income-tax-form-group" style="margin-top: 12px;">
                                    <label class="income-tax-label" for="income-tax-tradingIncome" style="font-size: 14px;">
                                        Trading Income
                                    </label>
                                    <div class="income-tax-input-with-icon">
                                        <span class="income-tax-currency">¬£</span>
                                        <input 
                                            type="text" 
                                        class="income-tax-input" 
                                        id="income-tax-tradingIncome" 
                                            name="tradingIncome"
                                        value="" 
                                            maxlength="15"
                                            oninput="formatCurrencyInput(this); recalculate();" 
                                            onblur="sanitizeCurrencyInput(this)"
                                            placeholder="5,000"
                                        >
                                    </div>
                                </div>

                                <!-- Employment Income - Only shown in expandable for non-2027 years -->
                                <div id="income-tax-employmentIncomeGroup" style="margin-top: 12px;">
                                    <label class="income-tax-label" for="income-tax-employmentIncome" style="font-size: 14px;">
                                        Employment Income
                                    </label>
                                    <div class="income-tax-input-with-icon">
                                        <span class="income-tax-currency">¬£</span>
                                        <input 
                                            type="text" 
                                        class="income-tax-input" 
                                        id="income-tax-employmentIncome" 
                                            name="employmentIncome"
                                        value="" 
                                            maxlength="15"
                                            oninput="formatCurrencyInput(this); recalculate();" 
                                            onblur="sanitizeCurrencyInput(this)"
                                            placeholder="5,000"
                                        >
                                    </div>
                                </div>
                            </div>

                            <!-- Expand Button -->
                            <p 
                                id="income-tax-expandNonSavingBtn"
                                style="margin-top: 12px; font-size: 14px; color: #43468a; cursor: pointer; text-decoration: underline; transition: all 0.2s;"
                                onclick="toggleNonSavingIncome()"
                            >
                                Click for more detailed Non-Saving Incomes
                            </p>
                        </div>

                        <div class="income-tax-separator"></div>

                        <!-- Saving Income -->
                        <div class="income-tax-form-group">
                            <label class="income-tax-label" for="income-tax-savingIncome">
                                Saving Income
                                <span class="income-tax-tooltip-icon" data-tooltip="Enter your saving income for the tax year.">?</span>
                            </label>
                            <div class="income-tax-input-with-icon">
                                <span class="income-tax-currency">¬£</span>
                                <input 
                                    type="text" 
                                    class="income-tax-input" 
                                    id="income-tax-savingIncome" 
                                    name="savingIncome"
                                    value="5,000" 
                                    maxlength="15"
                                    oninput="formatCurrencyInput(this); recalculate();" 
                                    onblur="sanitizeCurrencyInput(this)"
                                    placeholder="5,000"
                                >
                            </div>
                        </div>

                        <div class="income-tax-separator"></div>

                        <!-- Dividend Income -->
                        <div class="income-tax-form-group">
                            <label class="income-tax-label" for="income-tax-dividendIncome">
                                Dividend Income
                                <span class="income-tax-tooltip-icon" data-tooltip="Enter your dividend income for the tax year.">?</span>
                            </label>
                            <div class="income-tax-input-with-icon">
                                <span class="income-tax-currency">¬£</span>
                                <input 
                                    type="text" 
                                    class="income-tax-input" 
                                    id="income-tax-dividendIncome" 
                                    name="dividendIncome"
                                    value="5,000" 
                                    maxlength="15"
                                    oninput="formatCurrencyInput(this); recalculate();" 
                                    onblur="sanitizeCurrencyInput(this)"
                                    placeholder="5,000"
                                >
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel -->
            <div class="income-tax-right-panel">
                <!-- Results Section -->
                <div id="income-tax-resultsSection" class="income-tax-results-section">
                    <!-- Tabs -->
                    <div class="income-tax-tabs">
                        <div class="income-tax-tab-list">
                            <button class="income-tax-tab-trigger active" onclick="switchTab('income-tax-overview')">Overview</button>
                            <button class="income-tax-tab-trigger income-tax-ai-only-tab" id="income-tax-chartsTab" onclick="handleTabClick('income-tax-charts', event)">Charts</button>
                            <button class="income-tax-tab-trigger income-tax-ai-only-tab" id="income-tax-breakdownTab" onclick="handleTabClick('income-tax-breakdown', event)">Breakdown</button>
                            <button class="income-tax-tab-trigger income-tax-ai-only-tab" id="income-tax-historyTab" onclick="handleTabClick('income-tax-history', event)">History</button>
                        </div>
                    </div>

                    <!-- Overview Tab -->
                <div id="income-tax-overview" class="income-tax-tab-content active">
                    <div class="income-tax-card">
                        <!-- Added simple mode results view -->
                        <div id="income-tax-simpleResults" class="income-tax-simple-mode-content" style="position: relative;">
                            <!-- Simple Mode Loader -->
                            <div class="income-tax-loader-container" id="income-tax-simpleModeLoader">
                                <div class="income-tax-loader-wrapper">
                                    <div class="income-tax-loader">
                                        <div class="income-tax-loader income-tax-loader-inner"></div>
                                    </div>
                                </div>
                                <div class="income-tax-loader-text">Calculating...</div>
                            </div>
                            <!-- Annotation Container for Simple Mode (hidden - annotations are appended to body) -->
                            <div id="income-tax-annotationContainer" style="display: none;"></div>
                            <div class="income-tax-simple-results-container" id="income-tax-simpleResultsGrid">
                                <div class="income-tax-simple-card">
                                    <!-- Main Content (Left Side) -->
                                    <div class="income-tax-simple-main-content">
                                        <p class="income-tax-simple-label">TOTAL TAX LIABILITY</p>
                                        <h3 class="income-tax-simple-amount" id="income-tax-simpleTax">¬£44,231</h3>
                                        <!-- Inline loader for simple mode (non-blocking, no overlay) -->
                                        <div class="income-tax-simple-inline-loader" id="income-tax-simpleInlineLoader" style="display: none;">
                                            <div class="income-tax-loader-wrapper">
                                                <div class="income-tax-loader">
                                                    <div class="income-tax-loader income-tax-loader-inner"></div>
                                                </div>
                                            </div>
                                            <div class="income-tax-loader-text" style="color: #6b7280; margin-top: 8px; font-size: 12px; font-weight: 500;">
                                                Calculating...
                                            </div>
                                        </div>
                                        <p class="income-tax-simple-description" id="income-tax-simpleHeroSubtitle">
                                            Your calculated income tax based on the income details provided.
                                        </p>
                                        <button class="income-tax-simple-button" id="income-tax-viewBreakdownBtn" onclick="handleViewBreakdown()">
                                            View detailed breakdown
                                            <svg class="income-tax-simple-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                            </svg>
                                        </button>
                                        <div class="income-tax-simple-attribution">Generated by Rentalbux.com</div>
                                    </div>
                                    <!-- Sidebar (Right Side) -->
                                    <div class="income-tax-simple-sidebar">
                                        <div>
                                            <p class="income-tax-simple-sidebar-header">TAX BREAKDOWN</p>
                                            <h4 class="income-tax-simple-sidebar-title">Income Tax Breakdown</h4>
                                        </div>
                                        <div class="income-tax-simple-input-list">
                                            <div class="income-tax-simple-input-item">
                                                <svg class="income-tax-simple-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <text x="12" y="17" font-family="Arial, sans-serif" font-size="18" font-weight="bold" text-anchor="middle" fill="currentColor">¬£</text>
                                                </svg>
                                                <div class="income-tax-simple-input-content">
                                                    <p class="income-tax-simple-input-label">Non-Saving Income Tax</p>
                                                    <p class="income-tax-simple-input-value" id="income-tax-simpleNonSavingTax">¬£40,460</p>
                                                </div>
                                            </div>
                                            <div class="income-tax-simple-input-item" id="income-tax-simplePropertyTaxItem" style="display: none;">
                                                <svg class="income-tax-simple-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                                                </svg>
                                                <div class="income-tax-simple-input-content">
                                                    <p class="income-tax-simple-input-label">Property Income Tax</p>
                                                    <p class="income-tax-simple-input-value" id="income-tax-simplePropertyTax">¬£0</p>
                                                </div>
                                            </div>
                                            <div class="income-tax-simple-input-item">
                                                <!-- Savings Income Tax icon: piggy bank with lighter stroke -->
                                                <svg class="income-tax-simple-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path
                                                        stroke-linecap="round"
                                                        stroke-linejoin="round"
                                                        stroke-width="1.5"
                                                        d="M4.5 11.5c0-3.036 2.57-5.5 6-5.5 2.31 0 4.29 1.13 5.3 2.89l1.7.11a1 1 0 0 1 .93 1.06l-.2 2.5a3.5 3.5 0 0 1-2.2 2.88V17a1 1 0 0 1-1 1h-3.25a3 3 0 0 1-5.84-.5H4.75a1.25 1.25 0 0 1 0-2.5h.23A5.4 5.4 0 0 1 4.5 11.5z" />
                                                    <circle
                                                        cx="13.5"
                                                        cy="10.5"
                                                        r="0.7"
                                                        fill="currentColor"
                                                        stroke="none" />
                                                </svg>
                                                <div class="income-tax-simple-input-content">
                                                    <p class="income-tax-simple-input-label">Savings Income Tax</p>
                                                    <p class="income-tax-simple-input-value" id="income-tax-simpleSavingsTax">¬£2,000</p>
                                        </div>
                                        </div>
                                            <div class="income-tax-simple-input-item">
                                                <svg class="income-tax-simple-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                                </svg>
                                                <div class="income-tax-simple-input-content">
                                                    <p class="income-tax-simple-input-label">Dividend Income Tax</p>
                                                    <p class="income-tax-simple-input-value" id="income-tax-simpleDividendTax">¬£1,771</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="income-tax-simple-footer">
                                            <p class="income-tax-simple-footer-text" id="income-tax-simpleFooterText">Income Tax Calculator</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- End simple mode results view -->

                        <!-- Wrapped AI features in container for easy toggling -->
                        <div id="income-tax-aiResults" class="income-tax-hidden">
                            <div class="income-tax-card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                                <div class="income-tax-card-title">Income Tax Overview</div>
                                <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                                    <!-- Comparison Controls -->
                                    <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px; font-weight: 500; color: #374151; user-select: none;">
                                            <span style="white-space: nowrap;">Compare with:</span>
                                            <div style="position: relative; display: inline-block; width: 48px; height: 24px;">
                                                <input 
                                                    type="checkbox" 
                                                    id="income-tax-overviewComparisonToggle" 
                                                    onchange="toggleOverviewComparisonMode()"
                                                    style="opacity: 0; width: 0; height: 0; position: absolute;"
                                                />
                                                <span style="
                                                    position: absolute;
                                                    cursor: pointer;
                                                    top: 0;
                                                    left: 0;
                                                    right: 0;
                                                    bottom: 0;
                                                    background-color: #cbd5e1;
                                                    transition: 0.3s;
                                                    border-radius: 24px;
                                                    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
                                                "></span>
                                                <span style="
                                                    position: absolute;
                                                    content: '';
                                                    height: 18px;
                                                    width: 18px;
                                                    left: 3px;
                                                    bottom: 3px;
                                                    background-color: white;
                                                    transition: 0.3s;
                                                    border-radius: 50%;
                                                    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                                                "></span>
                                            </div>
                                        </label>
                                        <!-- Comparison Tax Year (Always visible, disabled by default) -->
                                        <div id="income-tax-overviewComparisonTaxYearGroup" style="display: block;">
                                            <div class="income-tax-custom-dropdown">
                                                <select 
                                                    class="income-tax-custom-dropdown-select income-tax-select-small" 
                                                    id="income-tax-overviewComparisonTaxYear" 
                                                    name="overviewComparisonTaxYear" 
                                                    onchange="handleOverviewComparisonTaxYearChange(); recalculate();"
                                                    style="min-width: 140px; opacity: 0.5; cursor: not-allowed;"
                                                    disabled
                                                >
                                                    <option value="2027" selected>2027/2028</option>
                                                    <option value="2026">2026/2027</option>
                                                    <option value="2025">2025/2026</option>
                                                    <option value="2024">2024/2025</option>
                                                    <option value="2023">2023/2024</option>
                                                    <option value="2022">2022/2023</option>
                                                    <option value="2021">2021/2022</option>
                                                    <option value="2020">2020/2021</option>
                                                    <option value="2019">2019/2020</option>
                                                    <option value="2018">2018/2019</option>
                                                    <option value="2017">2017/2018</option>
                                                    <option value="2016">2016/2017</option>
                                                </select>
                                                <div class="income-tax-dropdown-options" id="income-tax-overviewComparisonTaxYear-options"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- New Dashboard Layout -->
                            <div class="income-tax-dashboard-wrapper" style="position: relative;">
                                <!-- Main Grid Layout -->
                                <div class="income-tax-dashboard-grid" id="income-tax-overviewDashboardGrid">
                                    <!-- Large Tax Amount Card -->
                                    <!-- Main Tax Year Card with Comparison Support -->
                                    <div class="income-tax-tax-card" id="income-tax-mainTaxCard" style="position: relative;">
                                        <!-- Loader for Tax Card -->
                                        <div class="income-tax-card-loader" id="income-tax-taxCardLoader">
                                    <div class="income-tax-loader-wrapper">
                                        <div class="income-tax-loader">
                                            <div class="income-tax-loader income-tax-loader-inner"></div>
                                        </div>
                                    </div>
                                            <div class="income-tax-loader-text" style="color: white; margin-top: 16px; font-size: 14px; font-weight: 600;">Calculating...</div>
                                </div>
                                        
                                        <!-- Tax Card Content Container (will split into 2 columns when comparison is enabled) -->
                                        <div class="income-tax-tax-card-content" id="income-tax-taxCardContent">
                                            <!-- Main Column (Left) -->
                                            <div class="income-tax-tax-card-column income-tax-tax-card-main">
                                        <div class="income-tax-tax-card-header">
                                            <div>
                                                        <div class="income-tax-tax-label">TOTAL TAX LIABILITY</div>
                                                <div class="income-tax-tax-amount" id="income-tax-taxResult">¬£0</div>
                                                        <div class="income-tax-tax-date" id="income-tax-taxYearResult">Tax Year: -</div>
                                </div>

                                </div>
                                        <div class="income-tax-tax-details">
                                            <div>
                                                        <div class="income-tax-tax-detail-item">Non-Saving Income Tax</div>
                                                        <div class="income-tax-tax-detail-value" id="income-tax-nonSavingTaxResult">¬£0</div>
                                </div>
                                            <div id="income-tax-propertyTaxDetailItem" style="display: none;">
                                                        <div class="income-tax-tax-detail-item">Property Income Tax</div>
                                                        <div class="income-tax-tax-detail-value" id="income-tax-propertyTaxResult">¬£0</div>
                                </div>
                                            <div>
                                                        <div class="income-tax-tax-detail-item">Savings Income Tax</div>
                                                        <div class="income-tax-tax-detail-value" id="income-tax-savingsTaxResult">¬£0</div>
                                </div>
                                            <div>
                                                        <div class="income-tax-tax-detail-item">Dividend Income Tax</div>
                                                        <div class="income-tax-tax-detail-value" id="income-tax-dividendTaxResult">¬£0</div>
                                </div>
                            </div>
                                            </div>
                                            
                                            <!-- Comparison Column (Right) - Hidden by default -->
                                            <div class="income-tax-tax-card-column income-tax-tax-card-comparison" id="income-tax-comparisonColumn" style="display: none;">
                                                <div class="income-tax-tax-card-header">
                                                    <div>
                                                        <div class="income-tax-tax-label">TOTAL TAX LIABILITY</div>
                                                        <div class="income-tax-tax-amount" id="income-tax-comparisonTaxResult">¬£0</div>
                                                        <div class="income-tax-tax-date" id="income-tax-comparisonTaxYearResult">Tax Year: -</div>
                                                    </div>
                                                </div>
                                                <div class="income-tax-tax-details">
                                                    <div>
                                                        <div class="income-tax-tax-detail-item">Non-Saving Income Tax</div>
                                                        <div class="income-tax-tax-detail-value" id="income-tax-comparisonNonSavingTaxResult">¬£0</div>
                                                    </div>
                                                    <div id="income-tax-comparisonPropertyTaxDetailItem" style="display: none;">
                                                        <div class="income-tax-tax-detail-item">Property Income Tax</div>
                                                        <div class="income-tax-tax-detail-value" id="income-tax-comparisonPropertyTaxResult">¬£0</div>
                                                    </div>
                                                    <div>
                                                        <div class="income-tax-tax-detail-item">Savings Income Tax</div>
                                                        <div class="income-tax-tax-detail-value" id="income-tax-comparisonSavingsTaxResult">¬£0</div>
                                                    </div>
                                                    <div>
                                                        <div class="income-tax-tax-detail-item">Dividend Income Tax</div>
                                                        <div class="income-tax-tax-detail-value" id="income-tax-comparisonDividendTaxResult">¬£0</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Comparison Box (shown inside tax card when comparison is enabled) -->
                                        <div id="income-tax-taxCardComparisonBox" style="display: none; margin-top: 16px;">
                                            <!-- Comparison box content will be inserted here via JavaScript -->
                                        </div>
                                        
                                        <div class="income-tax-attribution">Generated by Rentalbux.com</div>
                            </div>

                                    <!-- AI Savings Card -->
                                        <div class="income-tax-ai-card" style="position: relative;">
                                            <!-- Loader for AI Card -->
                                            <div class="income-tax-card-loader" id="income-tax-aiCardLoader">
                                                <div class="income-tax-loader-wrapper">
                                                    <div class="income-tax-loader">
                                                        <div class="income-tax-loader income-tax-loader-inner"></div>
                                                    </div>
                                                </div>
                                                <div class="income-tax-loader-text" style="color: #374151; margin-top: 16px; font-size: 14px; font-weight: 600;">Analysing your Income Tax insights if there are any...</div>
                                            </div>
                                        <div class="income-tax-ai-card-header">
                                            <div class="income-tax-ai-badge">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path>
                                                    <path d="M19 3v4"></path>
                                                    <path d="M21 5h-4"></path>
                                                </svg>
                                                Insights
                                            </div>
                                        </div>
                                        <div class="income-tax-ai-content">
                                            <div>
                                                <!-- Commented out optimization score section
                                                <div class="income-tax-score-section">
                                            Optimization Score
                                            <span class="income-tax-tooltip-icon" data-tooltip="A score (0-100%) indicating how well-optimized your SDLT calculation is. Higher scores mean you're already using the most tax-efficient approach. Lower scores indicate potential savings opportunities through property type changes, residency status, or available reliefs."></span>
                                        </div>
                                                <div class="income-tax-score-value" id="income-tax-optimizationScore">0%</div>
                                    </div>
                                            <div class="income-tax-savings-section">
                                                <div class="income-tax-savings-label">Potential Savings</div>
                                                <div class="income-tax-savings-value" id="income-tax-potentialSavings">¬£0</div>
                                                <div class="income-tax-savings-percent" id="income-tax-savingsPercent"></div>
                                    </div>
                                                -->
                                                <!-- Normal Insights Section (shown when comparison is off) -->
                                                <div id="income-tax-normalInsightsSection">
                                                    <div class="income-tax-score-section">
                                                        <span>You have to pay</span>
                                                    </div>
                                                <div class="income-tax-score-value" id="income-tax-sdltPropertyValueRatio">0%</div>
                                                <div class="income-tax-score-section">
                                                        <span>of your Rental Income as Tax.</span>
                                                        <span class="income-tax-tooltip-icon" data-tooltip="The tax rate is calculated by dividing the total tax payable by the annual rental income, expressed as a percentage."></span>
                                                </div>
                                            </div>
                                                
                                                <!-- Comparison Insights Section (shown when comparison is enabled) -->
                                                <div id="income-tax-comparisonInsightsSection" style="display: none;">
                                                    <div class="income-tax-comparison-insights-content">
                                                        <div id="income-tax-comparisonInsightsText" style="min-height: 120px;">
                                                            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 120px; padding: 20px;">
                                                                <div class="income-tax-loader-wrapper">
                                                                    <div class="income-tax-loader">
                                                                        <div class="income-tax-loader income-tax-loader-inner"></div>
                                                        </div>
                                                    </div>
                                                                <div class="income-tax-loader-text" style="color: #6b7280; margin-top: 16px; font-size: 14px; font-weight: 500;">
                                                                    Generating insights...
                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                                </div>

                                    <!-- AI Explanation - Full Width (Moved below main result and insights) -->
                                    <div class="income-tax-explanation-card income-tax-dashboard-col-span-3 income-tax-ai-only income-tax-hidden" style="margin-top: 20px; display: none;">
                                        <div class="income-tax-explanation-header" onclick="toggleHowWeCalculated()" style="cursor: pointer; display: flex; align-items: center; justify-content: space-between; margin-bottom: 0;">
                                            <div class="income-tax-explanation-content" style="margin-bottom: 0; flex: 1;">
                                                <div class="income-tax-icon-circle">
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
                                                    </svg>
                                                </div>
                                                <div class="income-tax-explanation-text" style="flex: 1;">
                                                    <h3 class="income-tax-explanation-title" style="margin: 0 !important;">See how we calculated your Income Tax.</h3>
                                                </div>
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <span id="income-tax-howWeCalculatedToggleText" style="font-size: 14px; color: #6b7280;">Show details</span>
                                                <svg id="income-tax-howWeCalculatedToggleIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 20px; height: 20px; color: #6b7280; transition: transform 0.3s;">
                                                    <path d="M6 9l6 6 6-6"></path>
                                                </svg>
                                            </div>
                                        </div>
                                        <div class="income-tax-explanation-collapsible" id="income-tax-howWeCalculatedContent" style="display: none; margin-top: 16px;">
                                            
                                            <!-- AI-Powered Savings Analysis section - Hidden for now -->
                                            <div class="inner-ai-saving-summary" style="display: none;">
                                                <h4 style="font-size: 16px; font-weight: 600; color: #111827; margin-bottom: 12px;">AI-Powered Savings Analysis</h4>
                                                <p class="income-tax-explanation-paragraph" id="income-tax-aiSavingsSummaryText" style="margin-bottom: 0;">
                                                Analyzing your property details to identify optimization opportunities...
                                                </p>
                                            </div>
                                            
                                            <div class="income-tax-calculations-overview" id="income-tax-calculationMethodSection">
                                                <!-- <h4 style="font-size: 16px; font-weight: 600; color: #111827; margin-bottom: 12px;">Calculation Method</h4> -->
                                                <div id="income-tax-calculationMethodText" style="font-size: 14px; color: #374151; line-height: 1.6;">
                                                    
                                                </div>
                                            </div>
                                        </div>
                                        
                                    </div>
                                </div>
                        <!-- Disclaimer - At the very bottom -->
                        <div class="income-tax-disclaimer income-tax-dashboard-col-span-3">
                            <p class="income-tax-disclaimer-text">
                                <span class="income-tax-disclaimer-label">Disclaimer:</span> This analysis is for informational purposes only and should not be relied upon as professional tax advice. AI-generated insights may contain errors or inaccuracies. Tax laws and regulations are complex and subject to change. Please consult with your own qualified tax experts and discuss your specific circumstances before making any decisions.
                            </p>
                            </div>
                        <!-- Trustpilot Review Section - Visible in both Simple and AI modes -->
                        <div class="income-tax-cta-banner" style="margin-top: 20px;">
                            <div class="income-tax-cta-content">
                                <div style="display:flex;align-items:center;padding:4px 8px;font-family:Arial,sans-serif;font-size:14px;color:white;cursor:pointer;" onclick="openTrustpilotReviews();">
                                    <span class="trustforMobile trustforDesktop" style="font-weight:bold;">Excellent</span>
                                    <div style="display:flex;align-items:center;margin:0px 5px;">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 185.32 34.77" style="width:auto;height:20px;">
                                            <defs><style>.income-tax-trustpilot-star-bg{fill:#00b67a;}.income-tax-trustpilot-star{fill:#fff;}</style></defs>
                                            <rect class="income-tax-trustpilot-star-bg" width="34.77" height="34.77"></rect>
                                            <rect class="income-tax-trustpilot-star-bg" x="37.66" width="34.77" height="34.77"></rect>
                                            <rect class="income-tax-trustpilot-star-bg" x="75.32" width="34.77" height="34.77"></rect>
                                            <rect class="income-tax-trustpilot-star-bg" x="112.97" width="34.77" height="34.77"></rect>
                                            <rect class="income-tax-trustpilot-star-bg" x="150.55" width="34.77" height="34.77"></rect>
                                            <path class="income-tax-trustpilot-star" d="M17.34,23.45l5.29-1.32,2.23,6.77Zm12.22-8.83H20.23L17.34,5.86l-2.89,8.76H5.12l7.52,5.44-2.9,8.76,7.52-5.45,4.63-3.3Z"></path>
                                            <path class="income-tax-trustpilot-star" d="M55,23.45l5.29-1.32,2.23,6.77Zm12.22-8.83H57.89L55,5.86l-2.89,8.76H42.78l7.51,5.44L47.4,28.82l7.52-5.45,4.62-3.3Z"></path>
                                            <path class="income-tax-trustpilot-star" d="M92.66,23.45l5.28-1.32,2.24,6.77Zm12.14-8.83H95.47L92.58,5.86l-2.89,8.76H80.36l7.51,5.45L85,28.82l7.52-5.45,4.62-3.3Z"></path>
                                            <path class="income-tax-trustpilot-star" d="M130.32,23.45l5.28-1.32,2.23,6.77Zm12.14-8.83h-9.33l-2.9-8.76-2.89,8.76H118l7.52,5.45-2.89,8.75,7.51-5.45,4.63-3.3Z"></path>
                                            <path class="income-tax-trustpilot-star" d="M168,23.45l5.28-1.32,2.23,6.77Zm12.14-8.83h-9.34L167.9,5.86,165,14.62h-9.34l7.52,5.45-2.89,8.75,7.51-5.45,4.63-3.3Z"></path>
                                        </svg>
                        </div>
                                    <span class="trustforMobile trustforDesktop" style="font-weight:normal;min-width:67px">reviews on</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 142.79 35.74" style="width:100px;height:22px;margin-left:5px;position:relative;">
                                        <defs>
                                            <style>.income-tax-trustpilot-logo-1{fill:none;}.income-tax-trustpilot-logo-2{clip-path:url(#income-tax-trustpilot-clip-2);}.income-tax-trustpilot-logo-3{fill:#fcfcfc;}.income-tax-trustpilot-logo-4{fill:#00b67a;}.income-tax-trustpilot-logo-5{fill:#005128;}</style>
                                            <clipPath id="income-tax-trustpilot-clip-2"><rect class="income-tax-trustpilot-logo-1" width="142.89" height="38.61"></rect></clipPath>
                                        </defs>
                                        <g class="income-tax-trustpilot-logo-2">
                                            <g>
                                                <path class="income-tax-trustpilot-logo-3" d="M37.47,8.7H51.93v2.94H46.26V28.28H43.14V11.64H37.47Zm13.82,5.46H54v2.72H54a2.45,2.45,0,0,1,.51-1.11,3.79,3.79,0,0,1,.89-1,3.24,3.24,0,0,1,1.15-.7,2.54,2.54,0,0,1,1.27-.28h.7c.13,0,.25.07.38.07v3a1.94,1.94,0,0,0-.64-.07c-.19,0-.38-.07-.63-.07a3,3,0,0,0-1.34.28,3.62,3.62,0,0,0-1.15.91,5,5,0,0,0-.76,1.54,7.11,7.11,0,0,0-.25,2.1v6.79H51.23ZM72,28.36h-2.8v-2h-.07a4.92,4.92,0,0,1-1.59,1.74,4,4,0,0,1-2.1.63,4.32,4.32,0,0,1-3.69-1.4,6.41,6.41,0,0,1-1.15-4.2v-9h2.86V22.9a4.1,4.1,0,0,0,.64,2.66,2.36,2.36,0,0,0,1.85.77,3.68,3.68,0,0,0,1.53-.28,2,2,0,0,0,1-.84A3.68,3.68,0,0,0,69,24a5.7,5.7,0,0,0,.19-1.54V14.16h2.87Zm4.84-4.55a2.45,2.45,0,0,0,1,2,3.72,3.72,0,0,0,2,.56,4.55,4.55,0,0,0,.9-.07A5.43,5.43,0,0,0,81.6,26a1.58,1.58,0,0,0,.76-.56,1.61,1.61,0,0,0,.26-1,1.36,1.36,0,0,0-.38-1,3.62,3.62,0,0,0-1-.63c-.38-.14-.83-.28-1.33-.42a11.31,11.31,0,0,1-1.53-.35,11.84,11.84,0,0,1-1.53-.49,4.18,4.18,0,0,1-1.34-.77,3.34,3.34,0,0,1-1-1.19,3.67,3.67,0,0,1-.38-1.81,3.82,3.82,0,0,1,.5-2,4.13,4.13,0,0,1,1.34-1.26,5.7,5.7,0,0,1,1.78-.7,8.27,8.27,0,0,1,1.85-.21,8.8,8.8,0,0,1,1.91.21,5.13,5.13,0,0,1,1.66.77A4.66,4.66,0,0,1,84.47,16a6,6,0,0,1,.63,2h-3a2,2,0,0,0-1-1.53,3.25,3.25,0,0,0-1.72-.42,2.35,2.35,0,0,0-.7.07,2.59,2.59,0,0,0-.77.21,2,2,0,0,0-.63.42,1,1,0,0,0-.26.76,1.11,1.11,0,0,0,.38.91,6.11,6.11,0,0,0,1,.63c.38.14.83.28,1.34.42a13.37,13.37,0,0,1,1.52.35,13.62,13.62,0,0,1,1.53.49,4.58,4.58,0,0,1,1.34.77,3.43,3.43,0,0,1,.95,1.19A3.77,3.77,0,0,1,85.49,24,4.81,4.81,0,0,1,85,26.19a7.49,7.49,0,0,1-1.34,1.47,5.72,5.72,0,0,1-1.85.83,9.37,9.37,0,0,1-2,.28,7.73,7.73,0,0,1-2.29-.28,4.48,4.48,0,0,1-1.78-.9,4.75,4.75,0,0,1-1.21-1.54A5.61,5.61,0,0,1,74,23.88Zm9.42-9.65h2.16V9.89h2.87v4.27h2.55v2.3H91.28v7.63a3,3,0,0,0,.06.84,1.29,1.29,0,0,0,.19.63,1,1,0,0,0,.39.35,2.18,2.18,0,0,0,.76.14h.57c.19,0,.39-.07.58-.07v2.44a3.89,3.89,0,0,1-1,.07,3.77,3.77,0,0,1-1,.07,6,6,0,0,1-1.79-.21,2.47,2.47,0,0,1-1.08-.7,2.18,2.18,0,0,1-.51-1.12c-.06-.42-.13-1-.19-1.53V16.6h-2.1Zm9.61,0h2.68v2h.06a3.53,3.53,0,0,1,1.66-1.75,5.21,5.21,0,0,1,2.35-.56,5.64,5.64,0,0,1,4.59,2.24,7.17,7.17,0,0,1,1.14,2.38,10.72,10.72,0,0,1,.39,2.93,13.89,13.89,0,0,1-.32,2.8,8.65,8.65,0,0,1-1,2.38,5.12,5.12,0,0,1-1.72,1.68,4.77,4.77,0,0,1-2.48.63,7,7,0,0,1-1.21-.14,4.24,4.24,0,0,1-1.21-.42,4,4,0,0,1-1-.7,6,6,0,0,1-.83-1h-.06v7.06H96Zm9.94,7.13a6.32,6.32,0,0,0-.26-1.88,4.3,4.3,0,0,0-.7-1.61,3.49,3.49,0,0,0-1.14-1.12,2.76,2.76,0,0,0-1.53-.42,3.08,3.08,0,0,0-2.74,1.33,6.77,6.77,0,0,0-.89,3.63,6.43,6.43,0,0,0,.25,2,4.88,4.88,0,0,0,.7,1.54,4.42,4.42,0,0,0,1.15,1.05,2.85,2.85,0,0,0,1.53.42,3.08,3.08,0,0,0,1.65-.42A4.38,4.38,0,0,0,105,24.65a5.77,5.77,0,0,0,.64-1.61,7.89,7.89,0,0,0,.19-1.75m5-12.59h2.86v2.94h-2.86Zm0,5.46h2.86v14.2h-2.86Zm5.41-5.46h2.87V28.35h-2.87Zm11.59,20.08a6.79,6.79,0,0,1-2.74-.56,6.14,6.14,0,0,1-3.31-3.92,10.26,10.26,0,0,1,0-6,6.57,6.57,0,0,1,1.27-2.39,5.92,5.92,0,0,1,2-1.54,7,7,0,0,1,2.74-.56,6.66,6.66,0,0,1,2.74.56,5.92,5.92,0,0,1,2,1.54,6.93,6.93,0,0,1,1.27,2.38,11,11,0,0,1,.45,3,9,9,0,0,1-.45,3,7.59,7.59,0,0,1-1.27,2.38,5.92,5.92,0,0,1-2,1.54,6.32,6.32,0,0,1-2.74.56m0-2.52a3.14,3.14,0,0,0,1.66-.42,4.49,4.49,0,0,0,1.14-1.12,4.89,4.89,0,0,0,.64-1.61,8.88,8.88,0,0,0,0-3.63,5.77,5.77,0,0,0-.64-1.61,3,3,0,0,0-1.14-1.12,3.49,3.49,0,0,0-3.32,0A4.49,4.49,0,0,0,125,17.86a4.42,4.42,0,0,0-.64,1.61,9.21,9.21,0,0,0-.19,1.82,8.43,8.43,0,0,0,.19,1.81,7,7,0,0,0,.64,1.61,3.49,3.49,0,0,0,1.14,1.12,3.23,3.23,0,0,0,1.66.42m7.39-12.1h2.16V9.89h2.87v4.27h2.54v2.3h-2.54v7.63a3,3,0,0,0,.06.84,1.19,1.19,0,0,0,.19.63,1,1,0,0,0,.38.35,2.28,2.28,0,0,0,.77.14h.57c.19,0,.38-.07.57-.07v2.44a3.77,3.77,0,0,1-.95.07,3.89,3.89,0,0,1-1,.07,6,6,0,0,1-1.78-.21,2.41,2.41,0,0,1-1.08-.7,2.18,2.18,0,0,1-.51-1.12c-.07-.42-.13-1-.19-1.53V16.6h-2.17Z"></path>
                                                <path class="income-tax-trustpilot-logo-4" d="M34.19,13.64h-13L17.13,0,13.05,13.64H0L10.57,22.1,6.49,35.74l10.57-8.46,10.57,8.46-4-13.64Z"></path>
                                                <path class="income-tax-trustpilot-logo-5" d="M24.52,25.18l-.9-3.08-6.56,5.18Z"></path>
                                            </g>
                                        </g>
                                    </svg>
                                </div>
                                <div class="income-tax-cta-buttons">
                                    <button class="income-tax-button-outline" onclick="openReviewPage()">Review Us</button>
                                    <button class="income-tax-button-solid" onclick="openRentalbuxRegistration()">Get Rentalbux for Free</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Tab -->
                <div id="income-tax-charts" class="income-tax-tab-content">
                    <div class="income-tax-card">
                        <div class="income-tax-card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                            <div class="income-tax-card-title">Income Tax Breakdown Chart</div>
                            <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                                <!-- Comparison Controls -->
                                <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px; font-weight: 500; color: #374151; user-select: none;">
                                        <span style="white-space: nowrap;">Compare with:</span>
                                        <div style="position: relative; display: inline-block; width: 48px; height: 24px;">
                                            <input 
                                                type="checkbox" 
                                                id="income-tax-comparisonToggle" 
                                                onchange="toggleComparisonMode()"
                                                style="opacity: 0; width: 0; height: 0; position: absolute;"
                                            />
                                            <span style="
                                                position: absolute;
                                                cursor: pointer;
                                                top: 0;
                                                left: 0;
                                                right: 0;
                                                bottom: 0;
                                                background-color: #cbd5e1;
                                                transition: 0.3s;
                                                border-radius: 24px;
                                                box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
                                            "></span>
                                            <span style="
                                                position: absolute;
                                                content: '';
                                                height: 18px;
                                                width: 18px;
                                                left: 3px;
                                                bottom: 3px;
                                                background-color: white;
                                                transition: 0.3s;
                                                border-radius: 50%;
                                                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                                            "></span>
                                        </div>
                                    </label>
                                    <!-- Comparison Tax Year (Always visible, disabled by default) -->
                                    <div id="income-tax-comparisonTaxYearGroup" style="display: block;">
                                        <div class="income-tax-custom-dropdown">
                                    <select 
                                                class="income-tax-custom-dropdown-select income-tax-select-small" 
                                                id="income-tax-comparisonTaxYear" 
                                                name="comparisonTaxYear" 
                                                onchange="handleComparisonTaxYearChange(); recalculate();"
                                                style="min-width: 140px; opacity: 0.5; cursor: not-allowed;"
                                                disabled
                                            >
                                                <option value="2027">2027/2028</option>
                                                <option value="2026">2026/2027</option>
                                                <option value="2025" selected>2025/2026</option>
                                                <option value="2024">2024/2025</option>
                                                <option value="2023">2023/2024</option>
                                                <option value="2022">2022/2023</option>
                                                <option value="2021">2021/2022</option>
                                                <option value="2020">2020/2021</option>
                                                <option value="2019">2019/2020</option>
                                                <option value="2018">2018/2019</option>
                                                <option value="2017">2017/2018</option>
                                                <option value="2016">2016/2017</option>
                                            </select>
                                            <div class="income-tax-dropdown-options" id="income-tax-comparisonTaxYear-options"></div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Chart Type Selector -->
                            <div class="income-tax-chart-type-selector">
                                <label class="income-tax-chart-type-selector-label">Chart Type:</label>
                                <div class="income-tax-custom-dropdown">
                                    <select 
                                        id="income-tax-chartTypeSelect" 
                                        class="income-tax-custom-dropdown-select income-tax-select-small"
                                        onchange="changeChartType(this.value)"
                                    >
                                        <option value="bar" selected>Bar Chart</option>
                                        <option value="horizontalBar">Horizontal Bar</option>
                                        <option value="pie">Pie Chart</option>
                                        <option value="doughnut">Donut Chart</option>
                                        <option value="line">Line Chart</option>
                                        <option value="area">Area Chart</option>
                                        <option value="radar">Radar Chart</option>
                                        <option value="polarArea">Polar Area</option>
                                        <option value="bubble">Bubble Chart</option>
                                    </select>
                                    <div class="income-tax-dropdown-options" id="income-tax-chartTypeSelect-options"></div>
                                </div>
                            </div>
                        </div>
                        </div>
                        <div style="padding: 20px; min-height: 450px; height: 460px; position: relative; overflow: hidden; box-sizing: border-box;" id="income-tax-chartContainer" hx-trigger="load" hx-swap="innerHTML">
                            <div style="
                                display: flex; 
                                flex-direction: column; 
                                align-items: center; 
                                justify-content: center; 
                                position: absolute; 
                                top: 0; 
                                left: 0; 
                                width: 100%; 
                                height: 100%; 
                                background: rgba(255, 255, 255, 0.95); 
                                z-index: 10;
                            ">
                                <div class="income-tax-loader-wrapper">
                                    <div class="income-tax-loader">
                                        <div class="income-tax-loader income-tax-loader-inner"></div>
                                    </div>
                                </div>
                                <div style="margin-top: 16px; color: var(--income-tax-primary); font-size: 14px; font-weight: 500; text-align: center; max-width: 300px; padding: 0 20px;">
                                    Loading chart...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Breakdown Tab -->
                <div id="income-tax-breakdown" class="income-tax-tab-content">
                    <div class="income-tax-card">
                        <div class="income-tax-card-header">
                            <div class="income-tax-card-title">Tax Bracket Analysis</div>
                            <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                                <!-- Comparison Controls -->
                                <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px; font-weight: 500; color: #374151; user-select: none;">
                                        <span style="white-space: nowrap;">Compare with:</span>
                                        <div style="position: relative; display: inline-block; width: 48px; height: 24px;">
                                            <input 
                                                type="checkbox" 
                                                id="income-tax-breakdownComparisonToggle" 
                                                onchange="toggleBreakdownComparisonMode()"
                                                style="opacity: 0; width: 0; height: 0; position: absolute;"
                                            />
                                            <span style="
                                                position: absolute;
                                                cursor: pointer;
                                                top: 0;
                                                left: 0;
                                                right: 0;
                                                bottom: 0;
                                                background-color: #cbd5e1;
                                                transition: 0.3s;
                                                border-radius: 24px;
                                                box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
                                            "></span>
                                            <span style="
                                                position: absolute;
                                                content: '';
                                                height: 18px;
                                                width: 18px;
                                                left: 3px;
                                                bottom: 3px;
                                                background-color: white;
                                                transition: 0.3s;
                                                border-radius: 50%;
                                                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                                            "></span>
                        </div>
                                    </label>
                                    <!-- Comparison Tax Year (Always visible, disabled by default) -->
                                    <div id="income-tax-breakdownComparisonTaxYearGroup" style="display: block;">
                                        <div class="income-tax-custom-dropdown">
                                            <select 
                                                class="income-tax-custom-dropdown-select income-tax-select-small" 
                                                id="income-tax-breakdownComparisonTaxYear" 
                                                name="breakdownComparisonTaxYear" 
                                                onchange="handleBreakdownComparisonTaxYearChange(); recalculate();"
                                                style="min-width: 140px; opacity: 0.5; cursor: not-allowed;"
                                                disabled
                                            >
                                                <option value="2027" selected>2027/2028</option>
                                                <option value="2026">2026/2027</option>
                                                <option value="2025">2025/2026</option>
                                                <option value="2024">2024/2025</option>
                                                <option value="2023">2023/2024</option>
                                                <option value="2022">2022/2023</option>
                                                <option value="2021">2021/2022</option>
                                                <option value="2020">2020/2021</option>
                                                <option value="2019">2019/2020</option>
                                                <option value="2018">2018/2019</option>
                                                <option value="2017">2017/2018</option>
                                                <option value="2016">2016/2017</option>
                                            </select>
                                            <div class="income-tax-dropdown-options" id="income-tax-breakdownComparisonTaxYear-options"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="income-tax-breakdown-card" style="overflow-x: hidden; position: relative; min-height:300px;">
                            <!-- Breakdown Loader -->
                            <div class="income-tax-breakdown-loader" id="income-tax-breakdownLoader" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.95); border-radius: 8px; z-index: 10; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px;">
                                <div class="income-tax-loader-wrapper">
                                    <div class="income-tax-loader">
                                        <div class="income-tax-loader income-tax-loader-inner"></div>
                                    </div>
                                </div>
                                <div class="income-tax-loader-text" style="color: #111827; font-size: 14px; font-weight: 600;">Calculating breakdown...</div>
                            </div>
                            <div id="income-tax-breakdownTable" style="overflow-x: auto;">
                                <!-- Header row will be added dynamically -->
                            </div>
                        </div>
                        <!-- Calculation Description (collapsible, below breakdown) -->
                        <div class="income-tax-breakdown-card income-tax-collapsible income-tax-collapsed" id="income-tax-calculationDescription" style="background: linear-gradient(135deg, #f0fdfa 0%, #e0f2fe 100%); border-color: var(--income-tax-primary);">
                            <div class="income-tax-breakdown-card-header" onclick="toggleCalculationExplanation()">
                                <div class="income-tax-breakdown-card-header-title" style="color: var(--income-tax-primary);">
                                    Calculation Explanation
                                </div>
                                <div class="income-tax-breakdown-card-toggle">
                                    <span id="income-tax-calculationExplanationToggleText">Show explanation</span>
                                    <span class="income-tax-breakdown-card-toggle-icon" id="income-tax-calculationExplanationToggleIcon">+</span>
                                </div>
                            </div>
                            <div class="income-tax-breakdown-card-body" id="income-tax-calculationDescriptionText" style="font-size: 14px; line-height: 1.8; color: var(--income-tax-foreground); padding-top: 8px;">
                                <!-- Content will be populated by updateCalculationDescription() -->
                            </div>
                        </div>
                        <!-- <div class="income-tax-breakdown-card">
                            <div class="income-tax-breakdown-title">Calculation Summary</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; font-size: 13px;">
                                <div style="padding: 16px; background: white; border-radius: 8px; border: 1px solid var(--income-tax-border);">
                                    <div style="color: #6b7280; margin-bottom: 8px; font-weight: 600;">Property Value</div>
                                    <div style="font-weight: 700; font-size: 20px;" id="income-tax-summaryGrossIncome">¬£500,000</div>
                                </div>
                                <div style="padding: 16px; background: white; border-radius: 8px; border: 1px solid var(--income-tax-border);">
                                    <div style="color: #6b7280; margin-bottom: 8px; font-weight: 600;">Calculator Type</div>
                                    <div style="font-weight: 700; font-size: 20px;" id="income-tax-summaryDeductions">Residential</div>
                                </div>
                                <div style="padding: 16px; background: white; border-radius: 8px; border: 1px solid var(--income-tax-border);">
                                    <div style="color: #6b7280; margin-bottom: 8px; font-weight: 600;">Property Type</div>
                                    <div style="font-weight: 700; font-size: 20px;" id="income-tax-summaryTaxableIncome">Single Main Home</div>
                                </div>
                                <div style="padding: 16px; background: white; border-radius: 8px; border: 1px solid var(--income-tax-border);">
                                    <div style="color: #6b7280; margin-bottom: 8px; font-weight: 600;">Tax Liability</div>
                                    <div style="font-weight: 700; font-size: 20px; color: var(--income-tax-red);" id="income-tax-summaryFederalTax">¬£0</div>
                                </div>
                            </div>
                        </div> -->
                    </div>
                </div>

                <!-- History Tab -->
                <div id="income-tax-history" class="income-tax-tab-content">
                    <div class="income-tax-card">
                        <div class="income-tax-card-header">
                            <div class="income-tax-card-title">Calculation History</div>
                            <div class="income-tax-button-group-right">
                                <button class="income-tax-button income-tax-button-small" onclick="exportData()">Export</button>
                                <button class="income-tax-button income-tax-button-small" onclick="clearHistory()">Clear</button>
                            </div>
                        </div>
                        <div id="income-tax-historyList">
                            <div class="income-tax-empty-state">
                                <div class="income-tax-empty-state-icon">‚è±Ô∏è</div>
                                <div class="income-tax-empty-state-text">No calculations saved yet<br>Start calculating to see your history here</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Lead Form CTA Section -->
                <div id="income-tax-leadFormSection" class="income-tax-lead-form-section" style="display: none; margin-top: 24px;">
                    <div class="income-tax-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                        <div style="text-align: center; color: white; margin-bottom: 24px;">
                            <h3 style="margin: 0 0 8px 0; font-size: 24px; font-weight: 700;">üìß Get Your Results via Email</h3>
                            <p style="margin: 0; font-size: 16px; opacity: 0.95;">Enter your details to receive a detailed breakdown of your calculation</p>
                        </div>
                        <form id="income-tax-leadForm" onsubmit="handleLeadFormSubmit(event)" style="max-width: 500px; margin: 0 auto;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                                <div>
                                    <label for="income-tax-leadFullName" style="display: block; margin-bottom: 6px; font-size: 14px; font-weight: 600; color: white;">Full Name *</label>
                                    <input 
                                        type="text" 
                                        id="income-tax-leadFullName" 
                                        name="fullName" 
                                        required 
                                        placeholder="John Doe"
                                        style="width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"
                                    />
                                </div>
                                <div>
                                    <label for="income-tax-leadEmail" style="display: block; margin-bottom: 6px; font-size: 14px; font-weight: 600; color: white;">Email Address *</label>
                                    <input 
                                        type="email" 
                                        id="income-tax-leadEmail" 
                                        name="email" 
                                        required 
                                        placeholder="john@example.com"
                                        style="width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"
                                    />
                                </div>
                            </div>
                            <button 
                                type="submit" 
                                id="income-tax-leadFormSubmitBtn"
                                style="width: 100%; padding: 14px 24px; background: white; color: #667eea; border: none; border-radius: 8px; font-size: 16px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.2); transition: all 0.2s;"
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(0,0,0,0.3)';"
                                onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.2)';"
                            >
                                <span id="income-tax-leadFormSubmitText">Send My Results</span>
                                <span id="income-tax-leadFormSubmitLoader" style="display: none; margin-left: 8px;">‚è≥</span>
                            </button>
                            <div id="income-tax-leadFormMessage" style="margin-top: 12px; text-align: center; font-size: 14px; font-weight: 600; min-height: 20px; color: white;"></div>
                        </form>
                    </div>
                </div>
                </div>
            </div>
        </div>


                <!-- Expert Modal -->
        <!-- Storage Consent Modal -->
        <div id="income-tax-storageConsentModal" class="income-tax-modal">
            <div class="income-tax-modal-content">
                <button class="income-tax-close-button" onclick="closeStorageConsentModal(false)">√ó</button>
                <div class="income-tax-modal-header">
                    <div class="income-tax-modal-title" style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 24px;">üíæ</span>
                        <span>Save Calculation</span>
                    </div>
                    <div class="income-tax-modal-subtitle">Choose how you'd like to save your calculation</div>
                </div>
                <div class="income-tax-modal-body">
                    <p style="margin-bottom: 16px; line-height: 1.6;">
                        Would you like to save this calculation permanently in your browser?
                    </p>
                    <div style="background: var(--income-tax-primary-light); padding: 16px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid var(--income-tax-primary);">
                        <div style="font-weight: 600; margin-bottom: 8px; color: var(--income-tax-primary);">Permanent Storage (Recommended)</div>
                        <ul style="margin: 0; padding-left: 20px; color: #6b7280; font-size: 14px; line-height: 1.6;">
                            <li>Saved in browser's localStorage</li>
                            <li>Persists across page reloads</li>
                            <li>Access your calculation history anytime</li>
                        </ul>
                    </div>
                    <div style="background: #f9fafb; padding: 16px; border-radius: 8px; border-left: 4px solid #9ca3af;">
                        <div style="font-weight: 600; margin-bottom: 8px; color: #6b7280;">Temporary Storage</div>
                        <ul style="margin: 0; padding-left: 20px; color: #6b7280; font-size: 14px; line-height: 1.6;">
                            <li>Stored in session memory only</li>
                            <li>Cleared when you close the browser</li>
                            <li>No data saved permanently</li>
                        </ul>
                    </div>
                    <div style="margin-top: 20px; padding: 12px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
                        <p style="margin: 0; font-size: 13px; line-height: 1.6; color: #92400e;">
                            <strong>Cookies & Privacy:</strong> By clicking "Save Permanently", you accept our use of browser storage (localStorage) to save your calculation data. This helps us provide a better experience by remembering your calculation history. We do not share this data with third parties.
                        </p>
                    </div>
                </div>
                <div class="income-tax-modal-footer">
                    <button class="income-tax-button income-tax-button-secondary" onclick="closeStorageConsentModal(false)">Cancel and Save Temporarily</button>
                    <button class="income-tax-button" onclick="closeStorageConsentModal(true)">Save Permanently</button>
                </div>
            </div>
        </div>

        <div id="income-tax-expertModal" class="income-tax-modal">
            <div class="income-tax-modal-content">
                <button class="income-tax-close-button" onclick="closeExpertModal()">√ó</button>
                <div class="income-tax-modal-header">
                    <div class="income-tax-modal-title">üíº Tax Expert Consultation</div>
                    <div class="income-tax-modal-subtitle">Get professional advice to maximize your tax savings</div>
                </div>
                <div class="income-tax-modal-body">
                    <div class="income-tax-consultation-option" onclick="selectOption('discovery', this)">
                        <div class="income-tax-consultation-option-title">üéØ 15-Minute Discovery Call</div>
                        <div class="income-tax-consultation-option-desc">Understand if you need tax advisory and get personalised recommendations tailored to your financial situation</div>
                        <div class="income-tax-consultation-option-price">FREE - No Credit Card Required</div>
                    </div>
                    <div class="income-tax-consultation-option" onclick="selectOption('advisory', this)">
                        <div class="income-tax-consultation-option-title">üíº 60-Minute Tax Advisory</div>
                        <div class="income-tax-consultation-option-desc">Comprehensive tax advisory session with certified CPA experts to maximise your savings and optimsation your tax strategy</div>
                        <div class="income-tax-consultation-option-price">$149 - Money-Back Guarantee</div>
                    </div>
                </div>
                <div class="income-tax-modal-footer">
                    <button class="income-tax-button" onclick="closeExpertModal()">Cancel</button>
                    <button class="income-tax-button income-tax-primary" id="income-tax-selectBtn" onclick="bookConsultation()">Book Now</button>
                </div>
            </div>
        </div>


        <div id="income-tax-shareModal" class="income-tax-modal">
            <div class="income-tax-modal-content" style="max-width: 500px; overflow-y: visible; max-height: 85vh;">
                <button class="income-tax-close-button" onclick="closeShareModal()">√ó</button>
                <div class="income-tax-modal-header">
                    <div class="income-tax-modal-title">Share Result</div>
                    <div class="income-tax-modal-subtitle">Share your calculation as an image</div>
                </div>
                <div class="income-tax-modal-body">
                    <div id="income-tax-sharePreview" style="width: 100%; height: 400px; background: #f3f4f6; display: flex; align-items: flex-start; justify-content: center; border-radius: 8px; margin-bottom: 20px; overflow-y: auto; overflow-x: hidden; position: relative; scrollbar-width: thin; scrollbar-color: #cbd5e1 #f3f4f6;">
                        <div id="income-tax-shareLoader" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.95); border-radius: 8px; z-index: 10; flex-direction: column; align-items: center; justify-content: center; gap: 12px;">
                            <div class="income-tax-loader-wrapper">
                                <div class="income-tax-loader">
                                    <div class="income-tax-loader income-tax-loader-inner"></div>
                                </div>
                            </div>
                            <div style="color: #111827; font-size: 14px; font-weight: 600; margin-top: 12px;">Generating image...</div>
                        </div>
                        <img id="income-tax-shareImage" style="max-width: 100%; width: 100%; height: auto; display: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" />
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <button id="income-tax-downloadBtn" class="income-tax-button income-tax-button-primary" onclick="downloadResultImage()" style="width: 100%; padding: 14px 20px; font-size: 15px; font-weight: 600; justify-content: center;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="20" height="20" style="margin-right: 10px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                            Download Image
                        </button>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <div style="font-size: 12px; font-weight: 600; color: #6b7280; margin-bottom: 10px; text-align: center;">Share to Social Media</div>
                        <div class="income-tax-share-actions" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; margin-bottom: 8px;">
                            <button class="income-tax-social-share-btn" onclick="shareToFacebook()" style="background: #1877F2; color: white; border: none; padding: 8px 6px; border-radius: 8px; cursor: pointer; font-size: 10px; font-weight: 500; display: flex; flex-direction: column; align-items: center; gap: 4px; transition: all 0.2s; min-height: 60px; justify-content: center;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(24, 119, 242, 0.3)';" onmouseout="this.style.transform=''; this.style.boxShadow='';">
                                <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18" style="flex-shrink: 0;"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
                                <span style="line-height: 1.2;">Facebook</span>
                            </button>
                            <button class="income-tax-social-share-btn" onclick="shareToTwitter()" style="background: #1DA1F2; color: white; border: none; padding: 8px 6px; border-radius: 8px; cursor: pointer; font-size: 10px; font-weight: 500; display: flex; flex-direction: column; align-items: center; gap: 4px; transition: all 0.2s; min-height: 60px; justify-content: center;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(29, 161, 242, 0.3)';" onmouseout="this.style.transform=''; this.style.boxShadow='';">
                                <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18" style="flex-shrink: 0;"><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/></svg>
                                <span style="line-height: 1.2;">Twitter</span>
                            </button>
                            <button class="income-tax-social-share-btn" onclick="shareToWhatsApp()" style="background: #25D366; color: white; border: none; padding: 8px 6px; border-radius: 8px; cursor: pointer; font-size: 10px; font-weight: 500; display: flex; flex-direction: column; align-items: center; gap: 4px; transition: all 0.2s; min-height: 60px; justify-content: center;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(37, 211, 102, 0.3)';" onmouseout="this.style.transform=''; this.style.boxShadow='';">
                                <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18" style="flex-shrink: 0;"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
                                <span style="line-height: 1.2;">WhatsApp</span>
                            </button>
                            <button class="income-tax-social-share-btn" onclick="shareToLinkedIn()" style="background: #0077B5; color: white; border: none; padding: 8px 6px; border-radius: 8px; cursor: pointer; font-size: 10px; font-weight: 500; display: flex; flex-direction: column; align-items: center; gap: 4px; transition: all 0.2s; min-height: 60px; justify-content: center;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0, 119, 181, 0.3)';" onmouseout="this.style.transform=''; this.style.boxShadow='';">
                                <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18" style="flex-shrink: 0;"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
                                <span style="line-height: 1.2;">LinkedIn</span>
                            </button>
                            <button class="income-tax-social-share-btn" onclick="shareToMessenger()" style="background: #0084FF; color: white; border: none; padding: 8px 6px; border-radius: 8px; cursor: pointer; font-size: 10px; font-weight: 500; display: flex; flex-direction: column; align-items: center; gap: 4px; transition: all 0.2s; min-height: 60px; justify-content: center;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0, 132, 255, 0.3)';" onmouseout="this.style.transform=''; this.style.boxShadow='';">
                                <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18" style="flex-shrink: 0;"><path d="M12 0C5.373 0 0 4.925 0 11c0 2.51.9 4.822 2.4 6.624L.6 24l6.624-1.8c1.8.6 3.776.976 5.776.976 6.627 0 12-4.925 12-11S18.627 0 12 0zm0 19.2c-1.776 0-3.45-.45-4.926-1.2L2.4 20.4l2.4-4.8c-.75-1.35-1.2-2.85-1.2-4.4 0-4.5 3.75-8.2 8.4-8.2s8.4 3.7 8.4 8.2-3.75 8.2-8.4 8.2z"/></svg>
                                <span style="line-height: 1.2;">Messenger</span>
                            </button>
                            <button class="income-tax-social-share-btn" onclick="shareViaNative()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 8px 6px; border-radius: 8px; cursor: pointer; font-size: 10px; font-weight: 500; display: flex; flex-direction: column; align-items: center; gap: 4px; transition: all 0.2s; min-height: 60px; justify-content: center;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(102, 126, 234, 0.3)';" onmouseout="this.style.transform=''; this.style.boxShadow='';">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" style="flex-shrink: 0;"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" y1="2" x2="12" y2="15"></line></svg>
                                <span id="income-tax-moreShareText" style="line-height: 1.2;">More Apps</span>
                            </button>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <button id="income-tax-copyBtn" class="income-tax-button income-tax-button-secondary" onclick="copyResultImage()" style="width: 100%; padding: 12px 16px; justify-content: center;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" style="margin-right: 8px;"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                            Copy Image
                        </button>
                    </div>
                    
                    <div style="padding-top: 16px; border-top: 1px solid #e5e7eb;">
                        <button id="income-tax-csvBtn" class="income-tax-button" onclick="downloadCSV()" style="width: 100%; padding: 11px 16px; background: #f9fafb; border: 1px solid #e5e7eb; color: #6b7280; font-size: 13px; font-weight: 500; justify-content: center; transition: all 0.2s ease;" onmouseover="this.style.background='#f3f4f6'; this.style.borderColor='#d1d5db'; this.style.color='#374151';" onmouseout="this.style.background='#f9fafb'; this.style.borderColor='#e5e7eb'; this.style.color='#6b7280';">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="17" height="17" style="margin-right: 8px;">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            <span>Download history as CSV</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Clear History Confirmation Modal -->
        <div id="income-tax-clearHistoryModal" class="income-tax-modal">
            <div class="income-tax-modal-content" style="max-width: 450px;">
                <button class="income-tax-close-button" onclick="closeClearHistoryModal()">√ó</button>
                <div class="income-tax-modal-header">
                    <div class="income-tax-modal-title" style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 24px;">üóëÔ∏è</span>
                        <span>Clear History</span>
                    </div>
                    <div class="income-tax-modal-subtitle">This action cannot be undone</div>
                </div>
                <div class="income-tax-modal-body">
                    <p style="margin-bottom: 0; line-height: 1.6; color: #374151;">
                        Are you sure you want to clear all calculation history? All saved calculations will be permanently deleted.
                    </p>
                </div>
                <div class="income-tax-modal-footer">
                    <button class="income-tax-button income-tax-button-secondary" onclick="closeClearHistoryModal()">Cancel</button>
                    <button class="income-tax-button" onclick="confirmClearHistory()" style="background: #ef4444; color: white;">Clear History</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
